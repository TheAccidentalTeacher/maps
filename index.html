<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geographic Detective Academy</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #0a0e27;
            color: white;
        }
        
        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 1000;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #header h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .xp-display {
            background: rgba(0,0,0,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #game-modes {
            background: #0f1329;
            padding: 12px 20px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            border-bottom: 3px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .mode-btn {
            background: #1a1f3a;
            color: #aaa;
            border: 2px solid #2a2f4a;
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            transition: all 0.2s;
            position: relative;
        }
        
        .mode-btn:hover {
            background: #2a2f4a;
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .mode-btn.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .mode-btn.locked::after {
            content: "üîí";
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 16px;
        }
        
        #container {
            display: flex;
            height: calc(100vh - 110px);
        }
        
        #map {
            flex: 1;
            height: 100%;
            position: relative;
        }
        
        #sidebar {
            width: 380px;
            background: #0f1329;
            box-shadow: -4px 0 20px rgba(0,0,0,0.5);
            padding: 20px;
            overflow-y: auto;
            z-index: 999;
        }
        
        .game-panel {
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        
        .game-panel.active {
            display: block;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .section {
            background: linear-gradient(135deg, #1a1f3a 0%, #0f1329 100%);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 2px solid #2a2f4a;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .section h2 {
            font-size: 18px;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }
        
        .section h2:hover {
            color: #fff;
            transform: translateX(4px);
        }
        
        .section h2::after {
            content: '‚ñº';
            margin-left: auto;
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .section.collapsed h2::after {
            transform: rotate(-90deg);
        }
        
        .section-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.2s;
            opacity: 1;
        }
        
        .section.collapsed .section-content {
            max-height: 0;
            opacity: 0;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 15px;
            width: 100%;
            margin-top: 12px;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        .btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #2a2f4a;
            box-shadow: none;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #3a3f5a;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }
        
        .timer {
            font-size: 32px;
            font-weight: 900;
            color: #ffd700;
            text-align: center;
            padding: 16px;
            background: rgba(255, 215, 0, 0.1);
            border: 3px solid #ffd700;
            border-radius: 12px;
            margin: 12px 0;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .timer.warning {
            color: #ff6b6b;
            border-color: #ff6b6b;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .score-display {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            padding: 12px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            margin: 12px 0;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 12px 0;
        }
        
        .stat-box {
            background: rgba(102, 126, 234, 0.1);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .stat-label {
            font-size: 11px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #ffd700;
        }
        
        .progress-bar {
            width: 100%;
            height: 28px;
            background: #1a1f3a;
            border-radius: 14px;
            overflow: hidden;
            margin: 12px 0;
            border: 2px solid #2a2f4a;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 13px;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .challenge-item {
            background: rgba(102, 126, 234, 0.1);
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
            transition: all 0.2s;
        }
        
        .challenge-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }
        
        .challenge-item.completed {
            background: rgba(0, 255, 127, 0.1);
            border-left-color: #00ff7f;
        }
        
        .challenge-item.completed .challenge-text {
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .answer-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 12px 0;
        }
        
        .answer-btn {
            background: #1a1f3a;
            color: white;
            border: 2px solid #2a2f4a;
            padding: 14px 18px;
            border-radius: 10px;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            position: relative;
        }
        
        .answer-btn:hover:not(:disabled) {
            background: #2a2f4a;
            border-color: #667eea;
            transform: translateX(4px);
        }
        
        .answer-btn.correct {
            background: linear-gradient(135deg, #00ff7f 0%, #00d96f 100%);
            color: #000;
            border-color: #00ff7f;
            animation: correctPulse 0.5s;
        }
        
        .answer-btn.incorrect {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            border-color: #ff6b6b;
            animation: shake 0.5s;
        }
        
        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .hint-box {
            background: rgba(255, 215, 0, 0.15);
            border: 2px solid #ffd700;
            padding: 14px;
            border-radius: 10px;
            margin: 12px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .hint-box strong {
            color: #ffd700;
        }
        
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }
        
        .tutorial-overlay.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .tutorial-content {
            background: linear-gradient(135deg, #1a1f3a 0%, #0f1329 100%);
            padding: 32px;
            border-radius: 16px;
            max-width: 600px;
            border: 3px solid #667eea;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .tutorial-content h2 {
            font-size: 28px;
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .tutorial-content h3 {
            font-size: 20px;
            color: #667eea;
            margin: 20px 0 12px 0;
        }
        
        .tutorial-content p, .tutorial-content ul {
            font-size: 15px;
            line-height: 1.8;
            margin-bottom: 16px;
            color: #ddd;
        }
        
        .tutorial-content ul {
            margin-left: 20px;
        }
        
        .tutorial-content li {
            margin-bottom: 8px;
        }
        
        .tutorial-content strong {
            color: #ffd700;
        }
        
        .why-play {
            background: rgba(102, 126, 234, 0.2);
            padding: 16px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin: 16px 0;
        }
        
        .notification {
            position: fixed;
            top: 120px;
            right: 20px;
            background: linear-gradient(135deg, #00ff7f 0%, #00d96f 100%);
            color: #000;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 6px 20px rgba(0, 255, 127, 0.5);
            z-index: 10001;
            display: none;
            animation: slideInRight 0.3s ease-out;
        }
        
        .notification.active {
            display: block;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .coords-display {
            background: #1a1f3a;
            padding: 16px;
            border-radius: 10px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            color: #ffd700;
            border: 2px solid #667eea;
            margin: 12px 0;
            font-family: 'Courier New', monospace;
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background: #1a1f3a;
            border: 2px solid #2a2f4a;
            color: white;
            font-size: 14px;
            margin-top: 8px;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }
        
        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 700;
            margin: 6px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
        }
        
        .badge.locked {
            background: #2a2f4a;
            color: #666;
            box-shadow: none;
        }
        
        .badge.unlocked {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
            animation: badgeUnlock 0.5s ease-out;
        }
        
        @keyframes badgeUnlock {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        #sidebar::-webkit-scrollbar {
            width: 8px;
        }
        
        #sidebar::-webkit-scrollbar-track {
            background: #0f1329;
        }
        
        #sidebar::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        
        #sidebar::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
        
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            
            #sidebar {
                width: 100%;
                height: 350px;
            }
            
            #map {
                height: calc(100vh - 460px);
            }
        }
        
        /* Population Density Legend */
        .population-legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: rgba(10, 14, 39, 0.95);
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #667eea;
            z-index: 1000;
            font-size: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: none;
        }
        
        .population-legend.active {
            display: block;
        }
        
        .population-legend h4 {
            margin: 0 0 8px 0;
            font-size: 13px;
            color: #667eea;
            font-weight: 700;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
            gap: 8px;
        }
        
        .legend-color {
            width: 30px;
            height: 15px;
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .legend-label {
            font-size: 11px;
            color: #ccc;
        }
        
        /* Coordinate Finder Floating Panel */
        #coordinate-finder-panel {
            position: fixed;
            top: 100px;
            right: 30px;
            width: 450px;
            max-width: calc(100vw - 60px);
            background: rgba(10, 14, 39, 0.98);
            border: 3px solid #667eea;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            box-sizing: border-box;
        }
        
        #coordinate-finder-panel.active {
            display: block;
        }
        
        .cf-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 16px 20px;
            border-radius: 13px 13px 0 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .cf-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .cf-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            line-height: 1;
            padding: 0;
            flex-shrink: 0;
        }
        
        .cf-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .cf-content {
            padding: 20px;
            color: white;
            overflow-x: hidden;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
            box-sizing: border-box;
        }
        
        .cf-content * {
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            #coordinate-finder-panel {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
                top: 80px;
            }
        }
        
        /* ========================================
           FUN MODE STYLES - Phase 4
           ======================================== */
        
        /* Fun Mode Toggle Switch */
        .fun-mode-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }
        
        .toggle-label {
            font-size: 14px;
            font-weight: 600;
            color: #aaa;
            flex-grow: 1;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #2a2f4a;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #667eea;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-switch.active {
            background: linear-gradient(135deg, #00ff88, #00ccff);
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }
        
        .toggle-switch.active::after {
            left: 33px;
            background: #0a0e27;
        }
        
        /* Fun Mode - Body Changes */
        body.fun-mode {
            background: #0a0e27;
        }
        
        body.fun-mode #coordinate-finder-panel {
            background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(20, 14, 39, 0.98));
            border: 3px solid #00ff88;
            box-shadow: 0 8px 32px rgba(0, 255, 136, 0.4), 0 0 60px rgba(0, 204, 255, 0.2);
        }
        
        body.fun-mode .cf-header {
            background: linear-gradient(135deg, #00ff88 0%, #00ccff 100%);
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
        }
        
        body.fun-mode .cf-header h3 {
            color: #0a0e27;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        body.fun-mode .cf-close-btn {
            background: rgba(10, 14, 39, 0.6);
            color: #00ff88;
        }
        
        body.fun-mode .cf-close-btn:hover {
            background: rgba(10, 14, 39, 0.8);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
        }
        
        body.fun-mode .btn {
            background: linear-gradient(135deg, #00ff88 0%, #00ccff 100%);
            color: #0a0e27;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
            font-weight: 800;
        }
        
        body.fun-mode .btn:hover:not(:disabled) {
            box-shadow: 0 6px 25px rgba(0, 255, 136, 0.5);
            transform: translateY(-3px) scale(1.02);
        }
        
        body.fun-mode .btn:disabled {
            background: linear-gradient(135deg, #2a2f4a, #3a3f5a);
            color: #666;
        }
        
        body.fun-mode #cf-timer-overlay {
            background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(20, 14, 39, 0.98)) !important;
            border: 3px solid #00ff88 !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8), 0 0 40px rgba(0, 255, 136, 0.6) !important;
        }
        
        body.fun-mode #cf-timer-label {
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        
        body.fun-mode #cf-timer-countdown {
            color: #00ccff;
            text-shadow: 0 0 20px rgba(0, 204, 255, 0.8);
        }
        
        body.fun-mode #cf-timer-countdown.warning {
            color: #ff00ff;
            text-shadow: 0 0 20px rgba(255, 0, 255, 0.8);
        }
        
        body.fun-mode #cf-timer-countdown.danger {
            color: #ff0088;
            text-shadow: 0 0 20px rgba(255, 0, 136, 0.8);
        }
        
        body.fun-mode #cf-skip-hint {
            color: #00ff88;
        }
        
        /* Fun Mode Input Styling */
        body.fun-mode input[type="number"],
        body.fun-mode select {
            background: rgba(10, 14, 39, 0.8);
            border-color: #00ccff;
            color: #00ff88;
        }
        
        body.fun-mode input[type="number"]:focus,
        body.fun-mode select:focus {
            border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.4);
        }
        
        body.fun-mode input.valid {
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }
        
        body.fun-mode input.invalid {
            border-color: #ff0088;
            box-shadow: 0 0 10px rgba(255, 0, 136, 0.3);
        }
        
        /* ========================================
           CELEBRATION MESSAGE STYLES - Phase 5
           ======================================== */
        
        /* Success Message Popup */
        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(0, 255, 127, 0.95), rgba(0, 204, 255, 0.95));
            color: #0a0e27;
            padding: 40px 60px;
            border-radius: 20px;
            font-size: 36px;
            font-weight: 900;
            z-index: 10000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8), 0 0 40px rgba(0, 255, 127, 0.6);
            text-align: center;
            animation: popIn 0.3s ease-out;
        }
        
        .success-message.academic {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
            color: white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
        }
        
        @keyframes popIn {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        
        /* Six Seven Glitch Effect */
        .glitch-text {
            position: relative;
            font-size: 48px;
            font-weight: 900;
            color: #ff00ff;
            text-shadow: 
                2px 2px #00ffff,
                -2px -2px #ff00ff;
            animation: glitch 0.3s infinite;
        }
        
        @keyframes glitch {
            0% {
                text-shadow: 
                    2px 2px #00ffff,
                    -2px -2px #ff00ff;
            }
            25% {
                text-shadow: 
                    -2px 2px #ff00ff,
                    2px -2px #00ffff;
            }
            50% {
                text-shadow: 
                    2px -2px #00ffff,
                    -2px 2px #ff00ff;
            }
            75% {
                text-shadow: 
                    -2px -2px #00ffff,
                    2px 2px #ff00ff;
            }
            100% {
                text-shadow: 
                    2px 2px #00ffff,
                    -2px -2px #ff00ff;
            }
        }
        
        /* Fade out animation */
        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }
        
        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>üïµÔ∏è GEOGRAPHIC DETECTIVE ACADEMY</h1>
        <div class="xp-display">
            <span>‚≠ê</span>
            <span id="total-xp">0</span>
            <span>XP</span>
        </div>
    </div>
    
    <div id="game-modes">
        <button class="mode-btn active" onclick="switchMode('explore')">üó∫Ô∏è EXPLORE</button>
        <button class="mode-btn" onclick="switchMode('mystery')">üéØ MYSTERY</button>
        <button class="mode-btn" onclick="switchMode('scavenger')">üåç SCAVENGER</button>
        <button class="mode-btn" onclick="switchMode('guess')">üì∏ GUESS</button>
        <button class="mode-btn" onclick="switchMode('missions')">üèÜ MISSIONS</button>
        <button class="mode-btn" onclick="switchMode('create')">üó∫Ô∏è CREATE</button>
        <button class="mode-btn" onclick="switchMode('alaska')">üèîÔ∏è ALASKA</button>
    </div>
    
    <div id="container">
        <div id="map"></div>
        
        <!-- Population Density Legend -->
        <div class="population-legend" id="pop-legend">
            <h4>üë• Population Density</h4>
            <div class="legend-item">
                <div class="legend-color" style="background: #8B0000;"></div>
                <span class="legend-label">Very High (>1000/km¬≤)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FF4500;"></div>
                <span class="legend-label">High (250-1000/km¬≤)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFA500;"></div>
                <span class="legend-label">Medium (100-250/km¬≤)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFD700;"></div>
                <span class="legend-label">Low (25-100/km¬≤)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFFACD;"></div>
                <span class="legend-label">Very Low (<25/km¬≤)</span>
            </div>
        </div>
        
        <div id="sidebar">
            <!-- EXPLORE MODE -->
            <div id="explore-panel" class="game-panel active">
                <div class="section">
                    <h2>ÔøΩ COORDINATE FINDER</h2>
                    <div class="section-content">
                        <p style="color: #aaa; line-height: 1.6; margin-bottom: 12px;">
                            Have coordinates? Use our Coordinate Finder tool to navigate to any location on Earth!
                        </p>
                        <button class="btn" onclick="toggleCoordinateFinderPanel()" style="width: 100%; font-size: 16px;">
                            üìç OPEN COORDINATE FINDER
                        </button>
                    </div>
                </div>
                
                <div class="section">
                    <h2>ÔøΩüó∫Ô∏è FREE EXPLORE</h2>
                    <div class="section-content">
                        <p style="color: #aaa; line-height: 1.6; margin-bottom: 12px;">
                            Click anywhere on the map to see coordinates and location info. Use the layer control (top right) to switch between satellite, terrain, and street views.
                        </p>
                        <div class="stat-grid">
                            <div class="stat-box">
                                <div class="stat-label">Latitude</div>
                                <div class="stat-value" id="hover-lat">--</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Longitude</div>
                                <div class="stat-value" id="hover-lon">--</div>
                            </div>
                        </div>
                        <div id="location-info" style="color: #aaa; font-size: 14px; margin-top: 12px;">
                            Click on the map to investigate a location
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üìç DISTANCE FROM GLENNALLEN</h2>
                    <div class="section-content">
                        <div id="distance-display" style="color: #aaa; font-size: 14px; line-height: 1.6;">
                            Click anywhere on the map to see how far it is from your hometown!
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üéÆ GAME MODES</h2>
                    <div class="section-content">
                        <p style="color: #aaa; line-height: 1.6; margin-bottom: 12px;">
                            Choose a game mode above to start earning XP and completing challenges!
                        </p>
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.6; color: #ddd;">
                            <strong style="color: #ffd700;">üéØ MYSTERY:</strong> Find locations from coordinates<br>
                            <strong style="color: #ffd700;">üåç SCAVENGER:</strong> Complete geographic challenges<br>
                            <strong style="color: #ffd700;">üì∏ GUESS:</strong> Identify famous landmarks<br>
                            <strong style="color: #ffd700;">üèÜ MISSIONS:</strong> Track your progress<br>
                            <strong style="color: #ffd700;">üó∫Ô∏è CREATE:</strong> Make your own mysteries
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- MYSTERY CHALLENGE MODE -->
            <div id="mystery-panel" class="game-panel">
                <div class="section">
                    <h2>üéØ MYSTERY LOCATION CHALLENGE</h2>
                    
                    <div id="mystery-game" style="display: none;">
                        
                        <!-- Big, Beautiful Coordinate Display -->
                        <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.2)); border: 3px solid #ffd700; border-radius: 16px; padding: 30px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 14px; color: #ffd700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 2px; font-weight: bold;">üó∫Ô∏è Find This Location:</div>
                            <div class="coords-display" id="mystery-coords" style="font-size: 42px; font-weight: bold; color: #fff; text-shadow: 2px 2px 8px rgba(0,0,0,0.5); margin: 15px 0;">
                                --
                            </div>
                            <div style="font-size: 13px; color: #aaa; margin-top: 12px;">
                                üí° Tip: First number is North/South, Second is East/West
                            </div>
                        </div>
                        
                        <!-- Timer and Score Row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                            <div style="background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #66b3ff;" id="mystery-timer">60</div>
                                <div style="font-size: 11px; color: #888; margin-top: 4px;">SECONDS LEFT</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #00ff7f;" id="mystery-score">0</div>
                                <div style="font-size: 11px; color: #888; margin-top: 4px;">SCORE</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #ff6b6b;" id="mystery-streak">0</div>
                                <div style="font-size: 11px; color: #888; margin-top: 4px;">STREAK üî•</div>
                            </div>
                        </div>
                        
                        <!-- Hints Box -->
                        <div id="mystery-hints" style="display: none; margin-bottom: 16px;">
                            <div class="hint-box" style="background: rgba(102, 179, 255, 0.15); border: 2px solid rgba(102, 179, 255, 0.4); padding: 16px;">
                                <strong style="color: #66b3ff;">üîç HINT:</strong> <span id="hint-text" style="color: #ddd;"></span>
                            </div>
                        </div>
                        
                        <!-- Helper Guide -->
                        <div style="background: rgba(100, 149, 237, 0.1); border-left: 4px solid #6495ed; padding: 12px; margin-bottom: 16px; border-radius: 6px;">
                            <strong style="color: #6495ed;">üìç How to Read Coordinates:</strong><br>
                            <span style="font-size: 13px; color: #aaa; line-height: 1.6;">
                                ‚Ä¢ <strong>0¬∞-30¬∞</strong> = Near equator<br>
                                ‚Ä¢ <strong>30¬∞-60¬∞</strong> = Mid-latitudes (most cities)<br>
                                ‚Ä¢ <strong>60¬∞-90¬∞</strong> = Near poles<br>
                                ‚Ä¢ <strong>N/S</strong> = North or South of equator<br>
                                ‚Ä¢ <strong>E/W</strong> = East or West of Prime Meridian
                            </span>
                        </div>
                        
                        <!-- Your Current Mouse Position -->
                        <div style="background: rgba(0, 255, 127, 0.15); border: 2px solid rgba(0, 255, 127, 0.4); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                            <div style="font-size: 13px; color: #00ff7f; margin-bottom: 8px; font-weight: bold;">üëÜ YOUR MOUSE POSITION:</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: #888; margin-bottom: 4px;">LATITUDE</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #00ff7f;" id="mystery-hover-lat">--</div>
                                </div>
                                <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: #888; margin-bottom: 4px;">LONGITUDE</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #00ff7f;" id="mystery-hover-lon">--</div>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: #aaa; margin-top: 10px; text-align: center;">
                                üí° Move your mouse over the map to see coordinates
                            </div>
                        </div>
                        
                        <button class="btn btn-danger" onclick="skipMystery()" style="width: 100%; font-size: 16px; padding: 14px;">‚è≠Ô∏è SKIP THIS ONE (-5 XP)</button>
                    </div>
                    
                    <div id="mystery-intro">
                        <div class="why-play">
                            <strong style="font-size: 16px; color: #ffd700;">WHY PLAY THIS?</strong>
                            <p style="margin-top: 8px; color: #ddd;">
                                Learn to read coordinates while racing against time! Build your geography skills and compete for the highest streak!
                            </p>
                        </div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 16px; border-radius: 8px; margin: 12px 0; font-size: 14px; line-height: 2; color: #ddd;">
                            <strong style="color: #ffd700;">üìö QUICK COORDINATE GUIDE:</strong><br>
                            <div style="margin-top: 8px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                <strong style="color: #66b3ff;">Example: 40.71¬∞ N, 74.01¬∞ W</strong><br>
                                <span style="font-size: 13px; color: #aaa;">
                                    ‚Ä¢ <strong>40.71¬∞ N</strong> = 40 degrees North of equator (New York area)<br>
                                    ‚Ä¢ <strong>74.01¬∞ W</strong> = 74 degrees West of Prime Meridian<br>
                                    ‚Ä¢ This is New York City! üóΩ
                                </span>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255, 215, 0, 0.1); padding: 14px; border-radius: 8px; margin: 12px 0; font-size: 14px; line-height: 1.8; color: #ddd;">
                            <strong style="color: #ffd700;">üéÆ HOW TO PLAY:</strong><br>
                            1Ô∏è‚É£ You'll see coordinates like <strong>40.71¬∞ N, 74.01¬∞ W</strong><br>
                            2Ô∏è‚É£ Think about which region they point to<br>
                            3Ô∏è‚É£ Click on the map where you think it is<br>
                            4Ô∏è‚É£ You have 60 seconds - hints appear at 30s and 15s<br>
                            5Ô∏è‚É£ Get it right to build your streak for bonus XP!
                        </div>
                        
                        <div style="background: rgba(0, 255, 127, 0.1); border: 2px solid rgba(0, 255, 127, 0.3); padding: 12px; border-radius: 8px; margin: 12px 0;">
                            <strong style="color: #00ff7f;">üí° BEGINNER TIPS:</strong><br>
                            <span style="font-size: 13px; color: #aaa; line-height: 1.8;">
                                ‚Ä¢ Look at the first number (latitude) - is it close to 0¬∞ (equator) or 90¬∞ (poles)?<br>
                                ‚Ä¢ Check N/S/E/W to know which hemisphere<br>
                                ‚Ä¢ Don't stress about being exact - within 500km counts!<br>
                                ‚Ä¢ Use hints if you're stuck - learning is the goal!
                            </span>
                        </div>
                        
                        <button class="btn" onclick="startMysteryGame()">üéÆ START MYSTERY CHALLENGE</button>
                        <button class="btn btn-secondary" onclick="showTutorial('mystery')">üìñ FULL TUTORIAL</button>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üìä YOUR STATS</h2>
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-label">Total Solved</div>
                            <div class="stat-value" id="mysteries-solved">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Best Streak</div>
                            <div class="stat-value" id="best-streak">0</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SCAVENGER HUNT MODE -->
            <div id="scavenger-panel" class="game-panel">
                <div class="section">
                    <h2>üåç SCAVENGER HUNT</h2>
                    
                    <div id="scavenger-game" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="scavenger-progress" style="width: 0%">0/10</div>
                        </div>
                        
                        <div id="scavenger-list" style="margin: 16px 0;"></div>
                        
                        <button class="btn btn-secondary" onclick="resetScavenger()">üîÑ NEW HUNT</button>
                    </div>
                    
                    <div id="scavenger-intro">
                        <div class="why-play">
                            <strong style="font-size: 16px; color: #ffd700;">WHY PLAY THIS?</strong>
                            <p style="margin-top: 8px; color: #ddd;">
                                Explore the entire world! Find deserts, mountains, oceans, and cities. Unlock achievement badges and become a geography master.
                            </p>
                        </div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 14px; border-radius: 8px; margin: 12px 0; font-size: 14px; line-height: 1.8; color: #ddd;">
                            <strong style="color: #ffd700;">HOW TO PLAY:</strong><br>
                            1Ô∏è‚É£ You'll get 10 challenges (find a desert, find a mountain, etc.)<br>
                            2Ô∏è‚É£ Use map layers to help you find each one<br>
                            3Ô∏è‚É£ Click on the map when you find it<br>
                            4Ô∏è‚É£ Each correct answer = 20 XP<br>
                            5Ô∏è‚É£ Complete all 10 to unlock achievement badges!
                        </div>
                        
                        <button class="btn" onclick="startScavengerGame()">üéÆ START SCAVENGER HUNT</button>
                        <button class="btn btn-secondary" onclick="showTutorial('scavenger')">üìñ FULL TUTORIAL</button>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üèÜ ACHIEVEMENTS</h2>
                    <div id="achievement-badges">
                        <span class="badge locked">üèúÔ∏è Desert Explorer</span>
                        <span class="badge locked">‚õ∞Ô∏è Mountain Master</span>
                        <span class="badge locked">üåä Ocean Navigator</span>
                        <span class="badge locked">üèôÔ∏è City Finder</span>
                    </div>
                </div>
            </div>
            
            <!-- GUESS LOCATION MODE -->
            <div id="guess-panel" class="game-panel">
                <div class="section">
                    <h2>üì∏ GUESS THE LOCATION</h2>
                    
                    <div id="guess-game" style="display: none;">
                        <div class="score-display">
                            Round: <span id="guess-round">1</span>/5 | Score: <span id="guess-score">0</span>
                        </div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px; text-align: center; margin: 12px 0;">
                            <strong style="color: #ffd700; font-size: 16px;" id="guess-prompt">Look at the satellite view. Where is this?</strong>
                        </div>
                        
                        <div id="guess-options" class="answer-options"></div>
                        
                        <button class="btn btn-secondary" onclick="nextGuessRound()" id="next-guess-btn" style="display: none;">‚û°Ô∏è NEXT LOCATION</button>
                    </div>
                    
                    <div id="guess-intro">
                        <div class="why-play">
                            <strong style="font-size: 16px; color: #ffd700;">WHY PLAY THIS?</strong>
                            <p style="margin-top: 8px; color: #ddd;">
                                Test your world knowledge! Identify famous landmarks from satellite view. Perfect your visual geography skills and impress your friends.
                            </p>
                        </div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 14px; border-radius: 8px; margin: 12px 0; font-size: 14px; line-height: 1.8; color: #ddd;">
                            <strong style="color: #ffd700;">HOW TO PLAY:</strong><br>
                            1Ô∏è‚É£ The map will zoom to a famous location<br>
                            2Ô∏è‚É£ Look at the satellite/terrain view carefully<br>
                            3Ô∏è‚É£ Choose the correct country from 4 options<br>
                            4Ô∏è‚É£ Earn 30 XP for each correct answer<br>
                            5Ô∏è‚É£ Play 5 rounds per game!
                        </div>
                        
                        <button class="btn" onclick="startGuessGame()">üéÆ START GUESS GAME</button>
                        <button class="btn btn-secondary" onclick="showTutorial('guess')">üìñ FULL TUTORIAL</button>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üìä YOUR STATS</h2>
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-label">Correct</div>
                            <div class="stat-value" id="guess-correct">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Total Played</div>
                            <div class="stat-value" id="guess-total">0</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- DETECTIVE MISSIONS MODE -->
            <div id="missions-panel" class="game-panel">
                <div class="section">
                    <h2>üèÜ DETECTIVE MISSIONS</h2>
                    <p style="color: #aaa; margin-bottom: 16px;">
                        Complete missions to level up your detective skills and earn massive XP rewards!
                    </p>
                    <div id="missions-list"></div>
                </div>
            </div>
            
            <!-- CREATE HEIST MODE -->
            <div id="create-panel" class="game-panel">
                <div class="section">
                    <h2>üó∫Ô∏è CREATE YOUR OWN HEIST</h2>
                    
                    <div class="why-play" style="margin-bottom: 16px;">
                        <strong style="font-size: 16px; color: #ffd700;">WHY CREATE?</strong>
                        <p style="margin-top: 8px; color: #ddd;">
                            Challenge your classmates! Create tricky mysteries and share them. Earn 50 XP for each heist you create!
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="color: #aaa; font-size: 12px; text-transform: uppercase; font-weight: 600;">Heist Name</label>
                        <input type="text" id="heist-name" class="input-field" placeholder="The Mystery of...">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="color: #aaa; font-size: 12px; text-transform: uppercase; font-weight: 600;">Target Location</label>
                        <div class="coords-display" id="heist-coords" style="font-size: 14px;">
                            Click on map to set location
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="color: #aaa; font-size: 12px; text-transform: uppercase; font-weight: 600;">Clue 1</label>
                        <input type="text" id="clue1" class="input-field" placeholder="Hint about the location...">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="color: #aaa; font-size: 12px; text-transform: uppercase; font-weight: 600;">Clue 2 (Optional)</label>
                        <input type="text" id="clue2" class="input-field" placeholder="Another hint...">
                    </div>
                    
                    <button class="btn" onclick="saveHeist()">üíæ SAVE HEIST (+50 XP)</button>
                    <button class="btn btn-secondary" onclick="loadHeists()">üìÇ VIEW SAVED HEISTS</button>
                </div>
                
                <div class="section" id="saved-heists-section" style="display: none;">
                    <h2>üìÇ YOUR HEISTS</h2>
                    <div id="saved-heists-list"></div>
                </div>
            </div>
            
            <!-- ALASKA ADVENTURE MODE -->
            <div id="alaska-panel" class="game-panel">
                <div class="section">
                    <h2>üèîÔ∏è ALASKA ADVENTURE</h2>
                    
                    <div id="alaska-game" style="display: none;">
                        
                        <!-- Round Info Header -->
                        <div style="background: linear-gradient(135deg, rgba(100, 149, 237, 0.15), rgba(65, 105, 225, 0.15)); border: 2px solid rgba(100, 149, 237, 0.4); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div>
                                    <div id="round-name" style="font-size: 18px; font-weight: bold; color: #66b3ff; margin-bottom: 4px;">Round 1: Home Territory</div>
                                    <div id="round-description" style="font-size: 13px; color: #aaa;">Explore the Copper River Basin around your hometown</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 28px; font-weight: bold; color: #00ff7f;" id="round-score">0/10</div>
                                    <div style="font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1px;">This Round</div>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="progress-bar" style="margin-bottom: 12px;">
                                <div class="progress-fill" id="alaska-progress" style="width: 0%">0/10</div>
                            </div>
                            
                            <!-- Stats Row -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 12px;">
                                <div style="text-align: center; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                                    <div style="font-size: 20px; font-weight: bold; color: #ffd700;" id="total-found">0</div>
                                    <div style="font-size: 11px; color: #888;">Total Found</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                                    <div style="font-size: 20px; font-weight: bold; color: #66b3ff;" id="current-round">1</div>
                                    <div style="font-size: 11px; color: #888;">Current Round</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                                    <div style="font-size: 20px; font-weight: bold; color: #ff69b4;" id="distance-home">--</div>
                                    <div style="font-size: 11px; color: #888;">Miles from Home</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Locations List -->
                        <div id="alaska-list" style="margin: 16px 0;"></div>
                        
                        <div class="hint-box" style="margin-top: 16px;">
                            <strong>üéØ PRO TIP:</strong> Use Satellite and Terrain layers to help find mountains and rivers!
                        </div>
                        
                        <button class="btn btn-secondary" onclick="resetAlaska()">üîÑ NEW ADVENTURE</button>
                    </div>
                    
                    <div id="alaska-intro">
                        <div class="why-play">
                            <strong style="font-size: 16px; color: #ffd700;">WHY PLAY THIS?</strong>
                            <p style="margin-top: 8px; color: #ddd;">
                                Explore YOUR home state! Start from Glennallen and discover Alaska's incredible geography. See how your hometown connects to the Last Frontier's most amazing places!
                            </p>
                        </div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 14px; border-radius: 8px; margin: 12px 0; font-size: 14px; line-height: 1.8; color: #ddd;">
                            <strong style="color: #ffd700;">HOW TO PLAY:</strong><br>
                            1Ô∏è‚É£ Find 10 famous Alaska locations starting from Glennallen<br>
                            2Ô∏è‚É£ Click on each location when you find it<br>
                            3Ô∏è‚É£ Learn cool facts about each place<br>
                            4Ô∏è‚É£ See how far everything is from home!<br>
                            5Ô∏è‚É£ Earn 30 XP for each location + bonus for completing all!
                        </div>
                        
                        <div style="background: rgba(255, 215, 0, 0.15); border: 2px solid #ffd700; padding: 14px; border-radius: 10px; margin: 12px 0; font-size: 13px; line-height: 1.6; color: #ddd;">
                            <strong style="color: #ffd700;">üè† STARTING FROM HOME:</strong><br>
                            Glennallen, Alaska<br>
                            Population: ~500<br>
                            Gateway to Wrangell-St. Elias National Park<br>
                            Crossroads of Glenn & Richardson Highways
                        </div>
                        
                        <button class="btn" onclick="startAlaskaGame()">üéÆ START ALASKA ADVENTURE</button>
                        <button class="btn btn-secondary" onclick="showTutorial('alaska')">üìö FULL TUTORIAL</button>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üèÜ ALASKA ACHIEVEMENTS</h2>
                    <div id="alaska-badges">
                        <span class="badge locked">üèîÔ∏è Mountain Master</span>
                        <span class="badge locked">üåä River Runner</span>
                        <span class="badge locked">üèûÔ∏è Park Explorer</span>
                        <span class="badge locked">üèõÔ∏è City Finder</span>
                        <span class="badge locked">‚ùÑÔ∏è Alaska Expert</span>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- Coordinate Finder Floating Panel -->
    <div id="coordinate-finder-panel">
        <div class="cf-header">
            <h3>üìç Coordinate Finder</h3>
            <button class="cf-close-btn" onclick="closeCoordinateFinderPanel()">√ó</button>
        </div>
        <div class="cf-content">
            <p style="color: #aaa; margin-bottom: 12px; line-height: 1.6;">
                Enter coordinates to find any location on Earth!
            </p>
            
            <!-- Fun Mode Toggle - Phase 4 -->
            <div class="fun-mode-toggle">
                <span class="toggle-label">
                    <span id="fun-mode-label">üìö Academic Mode</span>
                </span>
                <div class="toggle-switch" id="fun-mode-switch" onclick="toggleFunMode()"></div>
            </div>
            
            <!-- Format Toggle -->
            <div style="display: flex; gap: 8px; margin-bottom: 16px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px;">
                <button 
                    id="format-decimal" 
                    class="format-toggle-btn active" 
                    onclick="switchCoordinateFormat('decimal')"
                    style="flex: 1; padding: 10px 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    üìä Decimal
                </button>
                <button 
                    id="format-cardinal" 
                    class="format-toggle-btn" 
                    onclick="switchCoordinateFormat('cardinal')"
                    style="flex: 1; padding: 10px 8px; background: rgba(102, 126, 234, 0.2); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 6px; color: #aaa; font-weight: 600; cursor: pointer; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    üß≠ N/S/E/W
                </button>
            </div>
            
            <!-- Decimal Format Inputs (default) -->
            <div id="decimal-inputs" style="display: block;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; color: #888; font-size: 12px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Latitude</label>
                        <input 
                            type="number" 
                            id="cf-latitude-decimal" 
                            placeholder="40.71" 
                            step="0.01" 
                            min="-90" 
                            max="90"
                            style="width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: white; font-size: 16px; font-weight: bold;"
                            oninput="validateCoordinateInputs()"
                        >
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">(-90 to 90)</div>
                    </div>
                    <div>
                        <label style="display: block; color: #888; font-size: 12px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Longitude</label>
                        <input 
                            type="number" 
                            id="cf-longitude-decimal" 
                            placeholder="-74.01" 
                            step="0.01" 
                            min="-180" 
                            max="180"
                            style="width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: white; font-size: 16px; font-weight: bold;"
                            oninput="validateCoordinateInputs()"
                        >
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">(-180 to 180)</div>
                    </div>
                </div>
            </div>
            
            <!-- Cardinal Format Inputs (N/S/E/W) -->
            <div id="cardinal-inputs" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; color: #888; font-size: 12px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Latitude</label>
                        <div style="display: flex; gap: 8px;">
                            <input 
                                type="number" 
                                id="cf-latitude-cardinal" 
                                placeholder="40.71" 
                                step="0.01" 
                                min="0" 
                                max="90"
                                style="flex: 1; padding: 12px; background: rgba(0,0,0,0.3); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: white; font-size: 16px; font-weight: bold;"
                                oninput="validateCoordinateInputs()"
                            >
                            <select 
                                id="cf-lat-direction" 
                                style="padding: 12px; background: rgba(0,0,0,0.3); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: white; font-size: 16px; font-weight: bold; cursor: pointer;"
                                onchange="validateCoordinateInputs()">
                                <option value="N">N</option>
                                <option value="S">S</option>
                            </select>
                        </div>
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">(0 to 90)</div>
                    </div>
                    <div>
                        <label style="display: block; color: #888; font-size: 12px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Longitude</label>
                        <div style="display: flex; gap: 8px;">
                            <input 
                                type="number" 
                                id="cf-longitude-cardinal" 
                                placeholder="74.01" 
                                step="0.01" 
                                min="0" 
                                max="180"
                                style="flex: 1; padding: 12px; background: rgba(0,0,0,0.3); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: white; font-size: 16px; font-weight: bold;"
                                oninput="validateCoordinateInputs()"
                            >
                            <select 
                                id="cf-lon-direction" 
                                style="padding: 12px; background: rgba(0,0,0,0.3); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: white; font-size: 16px; font-weight: bold; cursor: pointer;"
                                onchange="validateCoordinateInputs()">
                                <option value="E">E</option>
                                <option value="W" selected>W</option>
                            </select>
                        </div>
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">(0 to 180)</div>
                    </div>
                </div>
            </div>
            
            <!-- Error Message -->
            <div id="cf-error" style="display: none; background: rgba(255, 107, 107, 0.2); border: 2px solid rgba(255, 107, 107, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 16px; color: #ff6b6b; font-size: 14px;"></div>
            
            <!-- Helper Guide -->
            <div style="background: rgba(102, 179, 255, 0.1); border-left: 4px solid #66b3ff; padding: 12px; margin-bottom: 16px; border-radius: 6px; word-wrap: break-word; overflow-wrap: break-word;">
                <strong style="color: #66b3ff; font-size: 13px;">üí° Quick Guide:</strong><br>
                <span style="font-size: 12px; color: #aaa; line-height: 1.8;">
                    ‚Ä¢ <strong>Latitude:</strong> North (+) or South (-)<br>
                    ‚Ä¢ <strong>Longitude:</strong> East (+) or West (-)<br>
                    ‚Ä¢ <strong>Examples:</strong> NYC (40.71, -74.01),<br>&nbsp;&nbsp;Sydney (-33.87, 151.21)
                </span>
            </div>
            
            <!-- Find Location Button -->
            <button 
                id="cf-find-btn" 
                class="btn" 
                onclick="findCoordinateLocation()" 
                disabled
                style="width: 100%; font-size: 16px; padding: 14px; opacity: 0.5; cursor: not-allowed;">
                üó∫Ô∏è FIND LOCATION!
            </button>
        </div>
    </div>
    
    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay" class="tutorial-overlay">
        <div class="tutorial-content" id="tutorial-content">
            <!-- Tutorial content will be inserted here -->
        </div>
    </div>
    
    <!-- Coordinate Finder Timer Overlay (Fun & Draggable!) -->
    <div id="cf-timer-overlay" style="display: none; position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95)); border: 3px solid #ffd700; border-radius: 16px; padding: 20px 24px; z-index: 3000; text-align: center; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8), 0 0 20px rgba(255, 215, 0, 0.3); cursor: move; user-select: none; min-width: 200px;">
        <div style="font-size: 13px; color: #ffd700; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; font-weight: bold;" id="cf-stage-label">üåç Stage 1: Hemisphere</div>
        <div style="font-size: 48px; font-weight: 900; color: #fff; text-shadow: 0 0 15px rgba(255, 255, 255, 0.5), 0 2px 4px rgba(0, 0, 0, 0.5); margin-bottom: 8px; font-family: 'Arial Black', sans-serif;" id="cf-timer-display">20</div>
        <div style="font-size: 11px; color: #ffeb3b; font-weight: 600; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">üëÜ Click map to skip fr fr</div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded event fired');
        // v2.0 - Alaska Adventure Edition
        // Initialize map
        const geoMap = L.map('map', {
            preferCanvas: true,
            zoomControl: true,
            maxBounds: [[-90, -180], [90, 180]], // Prevent map from repeating
            maxBoundsViscosity: 1.0, // Makes it "stick" to the bounds
            minZoom: 2, // Prevent zooming out too far
            worldCopyJump: false // Disable world wrapping
        }).setView([20, 0], 2);
        
        // Force map to load
        setTimeout(() => {
            if (geoMap && geoMap.invalidateSize) {
                geoMap.invalidateSize();
            }
        }, 100);
        
        // BASE LAYERS (Choose ONE)
        const streetMapEnglish = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd'
        });
        
        const streetMapLocal = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap'
        });
        
        const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Tiles &copy; Esri'
        });
        
        const topoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 17,
            attribution: '&copy; OpenStreetMap, SRTM'
        });
        
        const terrainMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 13,
            attribution: 'Tiles &copy; Esri'
        });
        
        const physicalMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 8,
            attribution: 'Tiles &copy; Esri'
        });
        
        const darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd'
        });
        
        const watercolorMap = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_watercolor/{z}/{x}/{y}.jpg', {
            maxZoom: 16,
            attribution: '&copy; Stamen Design &copy; OpenStreetMap'
        });
        
        const oceanBaseMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 16,
            attribution: 'Ocean Base &copy; Esri'
        });
        
        const natGeoMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 16,
            attribution: 'National Geographic &copy; Esri'
        });
        
        const terrainBaseMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 13,
            attribution: 'Terrain &copy; Esri'
        });
        
        // OVERLAY LAYERS (Toggle ON/OFF)
        const englishLabelsOverlay = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            subdomains: 'abcd',
            opacity: 1.0
        });
        
        const boundariesOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Boundaries &copy; Esri',
            opacity: 0.7
        });
        
        const transportOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Transport &copy; Esri',
            opacity: 0.7
        });
        
        const hillshadeOverlay = L.tileLayer('https://tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Hillshading: OpenTopoMap',
            opacity: 0.5
        });
        
        const railwayOverlay = L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Railway: OpenRailwayMap',
            opacity: 0.7
        });
        
        const oceanReferenceOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Reference/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 16,
            attribution: 'Ocean Reference &copy; Esri',
            opacity: 0.8
        });
        
        const worldReferenceOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Reference &copy; Esri',
            opacity: 0.7
        });
        
        const lightGrayReferenceOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 16,
            attribution: 'Reference &copy; Esri',
            opacity: 0.8
        });
        
        const watercolorLabelsOverlay = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_terrain_labels/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; Stamen Design',
            opacity: 1.0
        });
        
        const populationDensityOverlay = L.tileLayer('https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/GPW_Population_Density_2020/default/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png', {
            maxZoom: 18,
            maxNativeZoom: 7,
            attribution: 'Population Density: NASA SEDAC GPW v4',
            opacity: 0.65
        });
        
        // Show/hide legend when population density layer is toggled
        populationDensityOverlay.on('add', function() {
            document.getElementById('pop-legend').classList.add('active');
        });
        populationDensityOverlay.on('remove', function() {
            document.getElementById('pop-legend').classList.remove('active');
        });
        
        streetMapEnglish.addTo(geoMap);
        
        const baseMaps = {
            "üó∫Ô∏è Street (English) ‚≠ê": streetMapEnglish,
            "üó∫Ô∏è Street (Local Language)": streetMapLocal,
            "üõ∞Ô∏è Satellite": satelliteMap,
            "‚õ∞Ô∏è Topographic": topoMap,
            "üèîÔ∏è Terrain Relief": terrainMap,
            "üåç Physical Map": physicalMap,
            "üåä Ocean Base": oceanBaseMap,
            "üåé National Geographic": natGeoMap,
            "üé® Watercolor": watercolorMap,
            "üèûÔ∏è Terrain Base": terrainBaseMap,
            "üåô Dark Mode": darkMap
        };
        
        const overlayMaps = {
            "üî§ English Labels": englishLabelsOverlay,
            "üèõÔ∏è Boundaries & Places": boundariesOverlay,
            "üìù World Reference (All Labels)": worldReferenceOverlay,
            "üìä Light Gray Labels": lightGrayReferenceOverlay,
            "üöó Transportation": transportOverlay,
            "üöÇ Railways": railwayOverlay,
            "‚õ∞Ô∏è Hillshade": hillshadeOverlay,
            "üåä Ocean Features & Names": oceanReferenceOverlay,
            "üé® Terrain Labels": watercolorLabelsOverlay,
            "üë• Population Density": populationDensityOverlay
        };
        
        L.control.layers(baseMaps, overlayMaps, {
            collapsed: true,
            position: 'topright'
        }).addTo(geoMap);
        
        L.control.scale({
            imperial: true,
            metric: true
        }).addTo(geoMap);
        
        // Game state
        let gameState = {
            totalXP: 0,
            currentMode: 'explore',
            mystery: {
                score: 0,
                streak: 0,
                bestStreak: 0,
                solved: 0,
                current: null,
                timer: null,
                active: false
            },
            scavenger: {
                challenges: [],
                completed: 0,
                active: false
            },
            guess: {
                score: 0,
                correct: 0,
                total: 0,
                round: 0,
                current: null,
                active: false
            },
            missions: [
                { id: 1, name: "Master Coordinates", desc: "Complete 10 Mystery Challenges", progress: 0, target: 10, xp: 100 },
                { id: 2, name: "Terrain Expert", desc: "Complete a Scavenger Hunt", progress: 0, target: 1, xp: 150 },
                { id: 3, name: "Visual Detective", desc: "Get 5 correct in Guess Game", progress: 0, target: 5, xp: 200 },
                { id: 4, name: "Master Creator", desc: "Create 3 heists", progress: 0, target: 3, xp: 250 }
            ],
            heists: [],
            alaska: {
                currentRound: 0,
                roundProgress: [0, 0, 0, 0, 0], // Track found locations per round
                totalFound: 0,
                active: false,
                foundLocations: [] // Track which locations have been found
            }
        };
        
        // Glennallen home coordinates
        const GLENNALLEN = { lat: 62.1089, lon: -145.5467 };
        
        // Alaska Adventure locations - 5 ROUNDS of 10 locations each!
        const alaskaRounds = [
            // ROUND 1: HOME TERRITORY - Around Glennallen
            {
                name: "Round 1: Home Territory",
                description: "Explore the area around your hometown of Glennallen",
                locations: [
                    { name: "Glennallen", lat: 62.1089, lon: -145.5467, clue: "üè† Your hometown! At the junction of two major highways", fact: "Gateway to Wrangell-St. Elias National Park, population ~500", type: "city" },
                    { name: "Copper River", lat: 61.0444, lon: -145.4064, clue: "üåä A major river south of Glennallen, famous for salmon", fact: "290 miles long, world-famous for Copper River salmon", type: "river" },
                    { name: "Mount Wrangell", lat: 62.0059, lon: -144.0187, clue: "üåã Active volcano east of Glennallen, over 14,000 feet", fact: "One of the largest active volcanoes in North America - 14,163 ft", type: "mountain" },
                    { name: "Wrangell-St. Elias National Park", lat: 61.7104, lon: -142.9857, clue: "üèûÔ∏è Largest US National Park, southeast of Glennallen", fact: "6 times bigger than Yellowstone! 13.2 million acres", type: "park" },
                    { name: "Gulkana", lat: 62.2794, lon: -145.4553, clue: "üèòÔ∏è Small village north of Glennallen on the Richardson Highway", fact: "Native Ahtna village, population ~100", type: "city" },
                    { name: "Tazlina Glacier", lat: 61.4333, lon: -146.5167, clue: "üßä Glacier west of Glennallen, feeds into a river", fact: "One of many glaciers in the Copper River Basin", type: "glacier" },
                    { name: "Chitina", lat: 61.5156, lon: -144.4406, clue: "üöÇ Historic mining town southeast on the Copper River", fact: "Gateway to McCarthy, old railroad town", type: "city" },
                    { name: "Liberty Falls", lat: 61.0842, lon: -146.2867, clue: "üíß Scenic waterfall south of Glennallen on Richardson Highway", fact: "Popular roadside stop, 300-foot cascading waterfall", type: "landmark" },
                    { name: "Tonsina", lat: 61.6572, lon: -145.1728, clue: "üèòÔ∏è Tiny community south of Glennallen", fact: "Small settlement along the Richardson Highway", type: "city" },
                    { name: "Mentasta Lake", lat: 62.9167, lon: -143.7500, clue: "üèîÔ∏è Lake northeast of Glennallen near Tok cutoff", fact: "Native village in the Alaska Range foothills", type: "landmark" }
                ]
            },
            // ROUND 2: MAJOR CITIES - Alaska's Urban Centers
            {
                name: "Round 2: Major Cities",
                description: "Find Alaska's most important urban centers",
                locations: [
                    { name: "Anchorage", lat: 61.2181, lon: -149.9003, clue: "üèõÔ∏è Alaska's largest city, on the coast west of Glennallen", fact: "Population 290,000 - 40% of all Alaskans live here!", type: "city" },
                    { name: "Fairbanks", lat: 64.8378, lon: -147.7164, clue: "‚ùÑÔ∏è Second-largest city, far north in Interior Alaska", fact: "Golden Heart City - best place to see Northern Lights!", type: "city" },
                    { name: "Juneau", lat: 58.3019, lon: -134.4197, clue: "üèõÔ∏è State capital in Southeast Alaska, no road access", fact: "Only US capital inaccessible by car - boat or plane only!", type: "city" },
                    { name: "Sitka", lat: 57.0531, lon: -135.3300, clue: "üåä Historic coastal city on an island in Southeast", fact: "Former Russian capital of Alaska, rich Native heritage", type: "city" },
                    { name: "Ketchikan", lat: 55.3422, lon: -131.6461, clue: "üé£ Southernmost major city, 'Salmon Capital of the World'", fact: "Averages 152 inches of rain per year!", type: "city" },
                    { name: "Kenai", lat: 60.5544, lon: -151.2583, clue: "üé£ City on the Kenai Peninsula, southwest of Anchorage", fact: "Famous for world-record king salmon fishing", type: "city" },
                    { name: "Valdez", lat: 61.1308, lon: -146.3483, clue: "‚öì Ice-free port south of Glennallen, end of oil pipeline", fact: "Terminal of the Trans-Alaska Pipeline System", type: "city" },
                    { name: "Homer", lat: 59.6425, lon: -151.5483, clue: "ü¶Ö Coastal town on Kachemak Bay, 'Halibut Capital'", fact: "End of the road system on Kenai Peninsula", type: "city" },
                    { name: "Seward", lat: 60.1042, lon: -149.4422, clue: "üö¢ Port city south of Anchorage, gateway to Kenai Fjords", fact: "Start of the historic Iditarod Trail", type: "city" },
                    { name: "Bethel", lat: 60.7922, lon: -161.7558, clue: "‚úàÔ∏è Hub city in Southwest Alaska on the Kuskokwim River", fact: "Largest town in Western Alaska, only accessible by air", type: "city" }
                ]
            },
            // ROUND 3: NATURAL WONDERS - Mountains, Rivers, Glaciers
            {
                name: "Round 3: Natural Wonders",
                description: "Discover Alaska's incredible natural features",
                locations: [
                    { name: "Denali (Mt. McKinley)", lat: 63.0692, lon: -151.0070, clue: "üèîÔ∏è North America's highest peak, north of Anchorage", fact: "20,310 feet - the tallest mountain in North America!", type: "mountain" },
                    { name: "Mendenhall Glacier", lat: 58.4202, lon: -134.5503, clue: "üßä Famous glacier near Juneau, easily accessible", fact: "13 miles long, retreating due to climate change", type: "glacier" },
                    { name: "Yukon River", lat: 64.5011, lon: -164.9936, clue: "üåä One of longest rivers in North America, flows through Interior", fact: "1,980 miles long - third longest river in US", type: "river" },
                    { name: "Matanuska Glacier", lat: 61.7667, lon: -147.7500, clue: "üßä Accessible glacier northeast of Anchorage", fact: "27 miles long, one of few you can drive to!", type: "glacier" },
                    { name: "Prince William Sound", lat: 60.7831, lon: -147.0681, clue: "üåä Large sound south of Valdez, known for wildlife", fact: "Site of 1989 Exxon Valdez oil spill, now recovered", type: "landmark" },
                    { name: "Brooks Falls", lat: 58.5592, lon: -155.8742, clue: "üêª Famous waterfall where bears catch salmon, Katmai area", fact: "World-famous for brown bears fishing for salmon", type: "landmark" },
                    { name: "Malaspina Glacier", lat: 59.9500, lon: -140.5333, clue: "üßä Largest piedmont glacier in world, Southeast Alaska", fact: "Larger than Rhode Island at 1,500 square miles!", type: "glacier" },
                    { name: "Harding Icefield", lat: 59.9667, lon: -150.0167, clue: "üßä Massive icefield in Kenai Fjords, feeds many glaciers", fact: "300 square miles of ice, over 40 glaciers flow from it", type: "glacier" },
                    { name: "Turnagain Arm", lat: 60.9667, lon: -149.7000, clue: "üåä Scenic waterway south of Anchorage with huge tidal bore", fact: "Has one of the highest tidal ranges in world - 40 feet!", type: "landmark" },
                    { name: "Knik Glacier", lat: 61.4500, lon: -148.6167, clue: "üßä Glacier northeast of Palmer, accessible by hiking", fact: "25 miles long, part of the massive Knik Glacier system", type: "glacier" }
                ]
            },
            // ROUND 4: PARKS & WILDLIFE - Protected Areas
            {
                name: "Round 4: Parks & Wildlife",
                description: "Explore Alaska's incredible national parks and refuges",
                locations: [
                    { name: "Denali National Park", lat: 63.1148, lon: -151.1926, clue: "üèûÔ∏è Famous park surrounding North America's highest peak", fact: "6 million acres, home to grizzlies, wolves, caribou", type: "park" },
                    { name: "Kenai Fjords National Park", lat: 59.8117, lon: -149.9594, clue: "üßä Park on Kenai Peninsula, famous for glaciers and fjords", fact: "607,000 acres of ice, mountains, and wildlife", type: "park" },
                    { name: "Glacier Bay National Park", lat: 58.6658, lon: -136.9006, clue: "üßä Southeast Alaska park, UNESCO World Heritage Site", fact: "1,000+ glaciers, amazing whale watching!", type: "park" },
                    { name: "Katmai National Park", lat: 58.5969, lon: -155.0617, clue: "üêª Southwest park famous for brown bears fishing", fact: "Over 2,000 brown bears - densest population in world!", type: "park" },
                    { name: "Lake Clark National Park", lat: 60.4127, lon: -154.3267, clue: "üèûÔ∏è Remote park west of Anchorage, active volcanoes", fact: "4 million acres, two active volcanoes", type: "park" },
                    { name: "Gates of the Arctic National Park", lat: 67.7873, lon: -153.2967, clue: "üèîÔ∏è Northernmost park, entirely above Arctic Circle", fact: "Second-largest US park, no roads or trails!", type: "park" },
                    { name: "Arctic National Wildlife Refuge", lat: 69.3556, lon: -145.0000, clue: "ü¶å Massive refuge in far northeast, caribou calving grounds", fact: "19.6 million acres - largest wildlife refuge in US", type: "park" },
                    { name: "Tongass National Forest", lat: 57.0000, lon: -135.0000, clue: "üå≤ Largest US national forest, covers most of Southeast", fact: "17 million acres - largest temperate rainforest in world!", type: "park" },
                    { name: "Chugach National Forest", lat: 60.8972, lon: -148.0000, clue: "üå≤ Forest east of Anchorage, second-largest in US", fact: "6.9 million acres, most-visited forest in America", type: "park" },
                    { name: "Kodiak National Wildlife Refuge", lat: 57.4333, lon: -153.9667, clue: "üêª Island refuge famous for giant brown bears", fact: "Home to 3,000+ Kodiak bears - largest bears on Earth!", type: "park" }
                ]
            },
            // ROUND 5: HISTORIC & CULTURAL SITES
            {
                name: "Round 5: Historic Sites",
                description: "Discover Alaska's rich history and cultural landmarks",
                locations: [
                    { name: "Barrow (Utqiaƒ°vik)", lat: 71.2906, lon: -156.7886, clue: "‚ùÑÔ∏è Northernmost US city, on the Arctic Ocean", fact: "Furthest north you can go in USA! 65 days of darkness", type: "city" },
                    { name: "Nome", lat: 64.5011, lon: -165.4064, clue: "‚õèÔ∏è Historic gold rush town on Seward Peninsula", fact: "End of the famous Iditarod dog sled race!", type: "city" },
                    { name: "Skagway", lat: 59.4586, lon: -135.3136, clue: "üöÇ Historic gold rush town in Southeast, White Pass railroad", fact: "Gateway to Klondike Gold Rush in 1890s", type: "city" },
                    { name: "Sitka National Historical Park", lat: 57.0467, lon: -135.3194, clue: "üóø Park in Sitka with Native totem poles and history", fact: "Site of 1804 Battle of Sitka between Russians and Tlingit", type: "landmark" },
                    { name: "Russian Bishop's House", lat: 57.0522, lon: -135.3300, clue: "‚õ™ Historic Russian Orthodox building in Sitka", fact: "One of few surviving Russian colonial buildings in US", type: "landmark" },
                    { name: "Klondike Gold Rush National Park", lat: 59.4583, lon: -135.3150, clue: "‚õèÔ∏è Historic park in Skagway about gold rush", fact: "Commemorates 1897-98 gold rush that changed Alaska", type: "landmark" },
                    { name: "Totem Bight State Park", lat: 55.3733, lon: -131.7461, clue: "üóø Park near Ketchikan with traditional totem poles", fact: "14 restored totem poles from abandoned villages", type: "landmark" },
                    { name: "Alaska Native Heritage Center", lat: 61.2186, lon: -149.8089, clue: "üé≠ Cultural center in Anchorage showcasing Native culture", fact: "Celebrates 11 major Alaska Native cultural groups", type: "landmark" },
                    { name: "McCarthy", lat: 61.4344, lon: -142.9033, clue: "üèöÔ∏è Historic mining town in Wrangell Mountains", fact: "Gateway to Kennicott Mines, abandoned copper mining town", type: "city" },
                    { name: "Iditarod Trail Sled Dog Race HQ", lat: 61.5833, lon: -149.4428, clue: "üêï Headquarters in Wasilla for famous dog sled race", fact: "1,000-mile race from Anchorage to Nome every March!", type: "landmark" }
                ]
            }
        ];
        
        // Load saved state
        if (localStorage.getItem('geoDetectiveState')) {
            const saved = JSON.parse(localStorage.getItem('geoDetectiveState'));
            gameState = { ...gameState, ...saved };
            
            // Always deactivate all games on page load - user must start them manually
            gameState.mystery.active = false;
            gameState.scavenger.active = false;
            gameState.guess.active = false;
            gameState.alaska.active = false;
            
            // Clear any timers
            if (gameState.mystery.timer) {
                gameState.mystery.timer = null;
            }
        }
        
        // Save state
        window.saveState = function() {
            localStorage.setItem('geoDetectiveState', JSON.stringify(gameState));
        }
        
        // Add XP with notification
        window.addXP = function(amount, reason) {
            gameState.totalXP += amount;
            document.getElementById('total-xp').textContent = gameState.totalXP;
            showNotification(`+${amount} XP! ${reason}`);
            saveState();
        }
        
        // Show notification
        window.showNotification = function(message) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.classList.add('active');
            setTimeout(() => {
                notif.classList.remove('active');
            }, 2000);
        }
        
        // Update all displays
        window.updateAllDisplays = function() {
            document.getElementById('total-xp').textContent = gameState.totalXP;
            document.getElementById('mystery-score').textContent = gameState.mystery.score;
            document.getElementById('mystery-streak').textContent = gameState.mystery.streak;
            document.getElementById('best-streak').textContent = gameState.mystery.bestStreak;
            document.getElementById('mysteries-solved').textContent = gameState.mystery.solved;
            document.getElementById('guess-score').textContent = gameState.guess.score;
            document.getElementById('guess-correct').textContent = gameState.guess.correct;
            document.getElementById('guess-total').textContent = gameState.guess.total;
        }
        
        // Switch mode
        window.switchMode = function(mode) {
            // CRITICAL FIX: Stop all timers and cleanup before switching
            stopAllGameTimers();
            cleanupGameMarkers();
            
            gameState.currentMode = mode;
            
            // Deactivate all active games when switching modes
            gameState.mystery.active = false;
            gameState.scavenger.active = false;
            gameState.guess.active = false;
            gameState.alaska.active = false;
            
            // Update mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                // Find the button for the new mode and activate it
                if (btn.textContent.toLowerCase().includes(mode.toLowerCase()) || 
                    (mode === 'explore' && btn.textContent.includes('EXPLORE'))) {
                    btn.classList.add('active');
                }
            });
            
            // Switch panels
            document.querySelectorAll('.game-panel').forEach(panel => panel.classList.remove('active'));
            const targetPanel = document.getElementById(mode + '-panel');
            if (targetPanel) {
                targetPanel.classList.add('active');
            }
            
            if (mode === 'missions') {
                renderMissions();
            }
            
            saveState();
        }
        
        // CRITICAL FIX: Centralized timer cleanup function
        function stopAllGameTimers() {
            // Clear Mystery Challenge timer
            if (gameState.mystery.timer) {
                clearInterval(gameState.mystery.timer);
                gameState.mystery.timer = null;
            }
            
            // Clear any other game timers here as they're added
            // Example: if (gameState.guess.timer) clearInterval(gameState.guess.timer);
        }
        
        // CRITICAL FIX #3: Centralized marker cleanup function
        function cleanupGameMarkers() {
            // Remove current marker if it exists
            if (currentMarker) {
                try {
                    geoMap.removeLayer(currentMarker);
                    console.log('üßπ Removed current marker');
                } catch (e) {
                    console.warn('‚ö†Ô∏è Could not remove current marker:', e);
                }
                currentMarker = null;
            }
            
            // Remove Coordinate Finder reveal marker
            if (typeof revealMarker !== 'undefined' && revealMarker) {
                try {
                    geoMap.removeLayer(revealMarker);
                    console.log('üßπ Removed reveal marker');
                } catch (e) {
                    console.warn('‚ö†Ô∏è Could not remove reveal marker:', e);
                }
                revealMarker = null;
            }
            
            // Clear any orphaned markers (markers without proper tracking)
            // This catches any markers that weren't properly tracked
            geoMap.eachLayer(function(layer) {
                // Keep the base tile layer, but remove any markers
                if (layer instanceof L.Marker) {
                    try {
                        geoMap.removeLayer(layer);
                        console.log('üßπ Removed orphaned marker');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Could not remove marker:', e);
                    }
                }
            });
        }
        
        // ========================================
        // COORDINATE FINDER FUNCTIONS - Phase 1
        // ========================================
        
        // Toggle Coordinate Finder Panel
        window.toggleCoordinateFinderPanel = function() {
            const panel = document.getElementById('coordinate-finder-panel');
            panel.classList.toggle('active');
            
            // Make panel draggable if not already initialized
            if (!panel.dataset.draggableInitialized) {
                makePanelDraggable();
                panel.dataset.draggableInitialized = 'true';
            }
        }
        
        // Close Coordinate Finder Panel
        window.closeCoordinateFinderPanel = function() {
            const panel = document.getElementById('coordinate-finder-panel');
            panel.classList.remove('active');
        }
        
        // Make Panel Draggable
        function makePanelDraggable() {
            const panel = document.getElementById('coordinate-finder-panel');
            const header = panel.querySelector('.cf-header');
            
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;
            
            header.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            
            function dragStart(e) {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
                
                if (e.target === header || e.target.parentElement === header) {
                    isDragging = true;
                }
            }
            
            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    
                    xOffset = currentX;
                    yOffset = currentY;
                    
                    setTranslate(currentX, currentY, panel);
                }
            }
            
            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
            }
            
            function setTranslate(xPos, yPos, el) {
                el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
            }
        }
        
        // ========================================
        // COLLAPSIBLE SECTIONS FUNCTIONALITY
        // ========================================
        
        // Make all sidebar sections collapsible by clicking h2
        document.querySelectorAll('.section h2').forEach(header => {
            header.addEventListener('click', function() {
                const section = this.parentElement;
                section.classList.toggle('collapsed');
            });
        });
        
        // ========================================
        // FUN MODE TOGGLE - Phase 4
        // ========================================
        
        // Check localStorage for Fun Mode preference on page load
        function initFunMode() {
            const funModeEnabled = localStorage.getItem('funModeEnabled') === 'true';
            if (funModeEnabled) {
                document.body.classList.add('fun-mode');
                document.getElementById('fun-mode-switch').classList.add('active');
                document.getElementById('fun-mode-label').textContent = 'üéÆ Fun Mode';
            }
        }
        
        // Toggle Fun Mode
        window.toggleFunMode = function() {
            const body = document.body;
            const toggleSwitch = document.getElementById('fun-mode-switch');
            const label = document.getElementById('fun-mode-label');
            
            // Toggle the fun-mode class on body
            body.classList.toggle('fun-mode');
            toggleSwitch.classList.toggle('active');
            
            // Update label
            if (body.classList.contains('fun-mode')) {
                label.textContent = 'üéÆ Fun Mode';
                localStorage.setItem('funModeEnabled', 'true');
            } else {
                label.textContent = 'üìö Academic Mode';
                localStorage.setItem('funModeEnabled', 'false');
            }
        }
        
        // Initialize Fun Mode on page load
        initFunMode();
        
        // ========================================
        // CELEBRATION MESSAGES - Phase 5
        // ========================================
        
        // Academic Mode messages - simple and professional
        const ACADEMIC_MESSAGES = [
            'üìç Location Found!',
            '‚úÖ Target Reached!',
            'üéØ Success!',
            '‚úì Coordinates Verified!'
        ];
        
        // Fun Mode messages - Gen Alpha approved
        const FUN_MESSAGES = [
            'üî• W!',
            '‚ú® SLAY!',
            'üíØ NO CAP!',
            'üéÆ LOCKED IN!',
            '‚ö° BUSSIN!',
            'üöÄ SHEESH!',
            'üëë GET GOOD!',
            'üí™ COOKED!',
            'üéØ LET HIM COOK!',
            'üåü FIRE!'
        ];
        
        // Six Seven easter egg messages (4.5% chance)
        const SIX_SEVEN_MESSAGES = [
            'SIIIIX SEEEEVVEN! üéâ',
            '6-7 GANG! üí™',
            'DOOT DOOT 6-7! üéÆ',
            '67 NO CAP! ‚ú®'
        ];
        
        // Get celebration message based on Fun Mode state
        function getCelebrationMessage() {
            const funModeEnabled = document.body.classList.contains('fun-mode');
            
            if (!funModeEnabled) {
                // Academic mode - simple messages
                return ACADEMIC_MESSAGES[Math.floor(Math.random() * ACADEMIC_MESSAGES.length)];
            }
            
            // Fun mode - check for six seven easter egg (4.5% chance)
            const random = Math.random() * 100;
            if (random < 4.5) {
                // SIX SEVEN EASTER EGG!
                return SIX_SEVEN_MESSAGES[Math.floor(Math.random() * SIX_SEVEN_MESSAGES.length)];
            }
            
            // Regular fun message
            return FUN_MESSAGES[Math.floor(Math.random() * FUN_MESSAGES.length)];
        }
        
        // Show celebration message popup
        function showCelebrationMessage(message) {
            const isSixSeven = message.includes('6') || message.includes('SIX');
            const messageDiv = document.createElement('div');
            
            // Check if Fun Mode for styling
            const funModeEnabled = document.body.classList.contains('fun-mode');
            messageDiv.className = funModeEnabled ? 'success-message' : 'success-message academic';
            
            // Add glitch effect for six seven
            if (isSixSeven && funModeEnabled) {
                messageDiv.innerHTML = `<div class="glitch-text">${message}</div>`;
            } else {
                messageDiv.textContent = message;
            }
            
            document.body.appendChild(messageDiv);
            
            // Remove after 3 seconds with fade
            setTimeout(() => {
                messageDiv.classList.add('fade-out');
                setTimeout(() => messageDiv.remove(), 500);
            }, 3000);
        }
        
        // ========================================
        // COORDINATE FINDER FUNCTIONS - Phase 2
        // ========================================
        
        // Track current format
        let coordinateFormat = 'decimal';
        
        // Switch between decimal and cardinal format
        window.switchCoordinateFormat = function(format) {
            coordinateFormat = format;
            
            // Update button styles
            document.getElementById('format-decimal').style.background = 
                format === 'decimal' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'rgba(102, 126, 234, 0.2)';
            document.getElementById('format-decimal').style.border = 
                format === 'decimal' ? 'none' : '2px solid rgba(102, 126, 234, 0.3)';
            document.getElementById('format-decimal').style.color = 
                format === 'decimal' ? 'white' : '#aaa';
                
            document.getElementById('format-cardinal').style.background = 
                format === 'cardinal' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'rgba(102, 126, 234, 0.2)';
            document.getElementById('format-cardinal').style.border = 
                format === 'cardinal' ? 'none' : '2px solid rgba(102, 126, 234, 0.3)';
            document.getElementById('format-cardinal').style.color = 
                format === 'cardinal' ? 'white' : '#aaa';
            
            // Show/hide input sections
            document.getElementById('decimal-inputs').style.display = format === 'decimal' ? 'block' : 'none';
            document.getElementById('cardinal-inputs').style.display = format === 'cardinal' ? 'block' : 'none';
            
            // Reset validation
            validateCoordinateInputs();
        }
        
        // Validate coordinate inputs in real-time (FIXED VERSION)
        window.validateCoordinateInputs = function() {
            const errorDiv = document.getElementById('cf-error');
            const findBtn = document.getElementById('cf-find-btn');
            
            let lat, lon, latInput, lonInput;
            let latValid = false;
            let lonValid = false;
            let errorMessage = '';
            
            if (coordinateFormat === 'decimal') {
                latInput = document.getElementById('cf-latitude-decimal');
                lonInput = document.getElementById('cf-longitude-decimal');
                lat = parseFloat(latInput.value);
                lon = parseFloat(lonInput.value);
            } else {
                latInput = document.getElementById('cf-latitude-cardinal');
                lonInput = document.getElementById('cf-longitude-cardinal');
                const latDir = document.getElementById('cf-lat-direction').value;
                const lonDir = document.getElementById('cf-lon-direction').value;
                
                let latNum = parseFloat(latInput.value);
                let lonNum = parseFloat(lonInput.value);
                
                // Convert cardinal to decimal
                lat = latDir === 'S' ? -Math.abs(latNum) : Math.abs(latNum);
                lon = lonDir === 'W' ? -Math.abs(lonNum) : Math.abs(lonNum);
            }
            
            // Reset all styles first
            if (latInput) latInput.style.borderColor = 'rgba(102, 126, 234, 0.3)';
            if (lonInput) lonInput.style.borderColor = 'rgba(102, 126, 234, 0.3)';
            errorDiv.style.display = 'none';
            
            // Check if both fields have values
            if (!latInput.value || !lonInput.value) {
                findBtn.disabled = true;
                findBtn.style.opacity = '0.5';
                findBtn.style.cursor = 'not-allowed';
                return;
            }
            
            // Validate latitude independently
            if (coordinateFormat === 'decimal') {
                if (isNaN(lat) || lat < -90 || lat > 90) {
                    latInput.style.borderColor = '#ff6b6b';
                    errorMessage = '‚ùå Latitude must be between -90 and 90';
                } else {
                    latInput.style.borderColor = '#00ff7f';
                    latValid = true;
                }
            } else {
                if (isNaN(lat) || Math.abs(lat) < 0 || Math.abs(lat) > 90) {
                    latInput.style.borderColor = '#ff6b6b';
                    errorMessage = '‚ùå Latitude must be between 0 and 90';
                } else {
                    latInput.style.borderColor = '#00ff7f';
                    latValid = true;
                }
            }
            
            // Validate longitude independently
            if (coordinateFormat === 'decimal') {
                if (isNaN(lon) || lon < -180 || lon > 180) {
                    lonInput.style.borderColor = '#ff6b6b';
                    if (!errorMessage) errorMessage = '‚ùå Longitude must be between -180 and 180';
                } else {
                    lonInput.style.borderColor = '#00ff7f';
                    lonValid = true;
                }
            } else {
                if (isNaN(lon) || Math.abs(lon) < 0 || Math.abs(lon) > 180) {
                    lonInput.style.borderColor = '#ff6b6b';
                    if (!errorMessage) errorMessage = '‚ùå Longitude must be between 0 and 180';
                } else {
                    lonInput.style.borderColor = '#00ff7f';
                    lonValid = true;
                }
            }
            
            // Show error if any validation failed
            if (errorMessage) {
                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
            }
            
            // Enable button only if BOTH are valid
            if (latValid && lonValid) {
                findBtn.disabled = false;
                findBtn.style.opacity = '1';
                findBtn.style.cursor = 'pointer';
            } else {
                findBtn.disabled = true;
                findBtn.style.opacity = '0.5';
                findBtn.style.cursor = 'not-allowed';
            }
        }
        
        // ========================================
        // COORDINATE FINDER FUNCTIONS - Phase 3
        // ========================================
        
        // Track progressive reveal state
        let progressiveRevealActive = false;
        let progressiveRevealTimer = null;
        let currentStage = 0;
        let targetLat, targetLon;
        let revealMarker = null;
        
        // Find location from coordinates - START PROGRESSIVE REVEAL
        window.findCoordinateLocation = function() {
            if (coordinateFormat === 'decimal') {
                targetLat = parseFloat(document.getElementById('cf-latitude-decimal').value);
                targetLon = parseFloat(document.getElementById('cf-longitude-decimal').value);
            } else {
                const latNum = parseFloat(document.getElementById('cf-latitude-cardinal').value);
                const lonNum = parseFloat(document.getElementById('cf-longitude-cardinal').value);
                const latDir = document.getElementById('cf-lat-direction').value;
                const lonDir = document.getElementById('cf-lon-direction').value;
                
                targetLat = latDir === 'S' ? -Math.abs(latNum) : Math.abs(latNum);
                targetLon = lonDir === 'W' ? -Math.abs(lonNum) : Math.abs(lonNum);
            }
            
            // Close the panel
            closeCoordinateFinderPanel();
            
            // Start progressive reveal
            startProgressiveReveal(targetLat, targetLon);
        }
        
        // Start the progressive reveal sequence
        function startProgressiveReveal(lat, lon) {
            progressiveRevealActive = true;
            currentStage = 1;
            
            // Remove any existing marker
            if (revealMarker) {
                geoMap.removeLayer(revealMarker);
                revealMarker = null;
            }
            
            // Make timer overlay draggable (if not already done)
            makeTimerDraggable();
            
            // Start Stage 1: Hemisphere (20 seconds)
            startStage1Hemisphere(lat, lon);
        }
        
        // Make timer overlay draggable
        function makeTimerDraggable() {
            const timerOverlay = document.getElementById('cf-timer-overlay');
            if (timerOverlay.dataset.draggableInit) return; // Already initialized
            
            let isDragging = false;
            let currentX = 0;
            let currentY = 0;
            let initialX = 0;
            let initialY = 0;
            
            timerOverlay.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            
            function dragStart(e) {
                initialX = e.clientX - currentX;
                initialY = e.clientY - currentY;
                isDragging = true;
            }
            
            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    timerOverlay.style.transform = `translate(${currentX}px, ${currentY}px)`;
                }
            }
            
            function dragEnd() {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
            }
            
            timerOverlay.dataset.draggableInit = 'true';
        }
        
        // Stage 1: Show Quadrant (zoom to show the correct quarter of Earth)
        function startStage1Hemisphere(lat, lon) {
            currentStage = 1;
            
            // Determine quadrant
            const latHemisphere = lat >= 0 ? 'N' : 'S';
            const lonHemisphere = lon >= 0 ? 'E' : 'W';
            const quadrant = `${latHemisphere}${lonHemisphere}`;
            
            // Quadrant names for display
            const quadrantNames = {
                'NE': 'üåè NE Quadrant (Asia/Pacific)',
                'NW': 'üåé NW Quadrant (Americas)',
                'SE': 'üåè SE Quadrant (Australia/Africa)',
                'SW': 'üåç SW Quadrant (S. America/Antarctica)'
            };
            
            document.getElementById('cf-stage-label').textContent = quadrantNames[quadrant] || 'üåç Stage 1: Quadrant';
            document.getElementById('cf-timer-overlay').style.display = 'block';
            
            // Zoom to center of the quadrant
            // Each quadrant is centered at ¬±45¬∞ lat, ¬±90¬∞ lon
            const quadrantCenters = {
                'NE': [30, 90],    // Asia/Pacific region
                'NW': [30, -90],   // North America
                'SE': [-30, 90],   // Australia/Southeast Asia
                'SW': [-30, -90]   // South America/South Atlantic
            };
            
            const [centerLat, centerLon] = quadrantCenters[quadrant] || [lat / 2, lon / 2];
            const quadrantZoom = 3; // Zoom level to show a quarter of Earth
            
            geoMap.setView([centerLat, centerLon], quadrantZoom, { animate: true, duration: 1 });
            
            // Start 20-second timer
            startStageTimer(20, () => startStage2Continent(lat, lon));
        }
        
        // Stage 2: Show Continent (zoom level 4-5)
        function startStage2Continent(lat, lon) {
            if (!progressiveRevealActive) return;
            
            currentStage = 2;
            document.getElementById('cf-stage-label').textContent = 'üó∫Ô∏è Stage 2: Continent';
            
            // Zoom to continent level
            const continentZoom = 4;
            geoMap.setView([lat, lon], continentZoom, { animate: true, duration: 1 });
            
            // Start 20-second timer
            startStageTimer(20, () => startStage3Region(lat, lon));
        }
        
        // Stage 3: Show Region (zoom level 7-8)
        function startStage3Region(lat, lon) {
            if (!progressiveRevealActive) return;
            
            currentStage = 3;
            document.getElementById('cf-stage-label').textContent = 'üìç Stage 3: Region';
            document.getElementById('cf-stage-label').textContent = 'Stage 3: Region';
            
            // Zoom to region level
            const regionZoom = 7;
            geoMap.setView([lat, lon], regionZoom, { animate: true, duration: 1 });
            
            // Start 20-second timer
            startStageTimer(20, () => dropPinAtTarget(lat, lon));
        }
        
        // Final: Drop pin at exact location
        function dropPinAtTarget(lat, lon) {
            if (!progressiveRevealActive) return;
            
            currentStage = 4;
            document.getElementById('cf-stage-label').textContent = 'üéØ FOUND IT! NO CAP';
            document.getElementById('cf-timer-display').textContent = '‚úì';
            document.getElementById('cf-timer-display').style.color = '#00ff7f';
            document.getElementById('cf-timer-display').style.textShadow = '0 0 20px rgba(0, 255, 127, 0.8)';
            
            // Zoom to exact location
            geoMap.setView([lat, lon], 13, { animate: true, duration: 1 });
            
            // Drop a pin marker
            setTimeout(() => {
                revealMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="font-size: 32px;">üìç</div>',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32]
                    })
                }).addTo(geoMap);
                
                revealMarker.bindPopup(`
                    <strong>üìç Target Location</strong><br>
                    ${formatCoord(lat, true)}, ${formatCoord(lon, false)}
                `).openPopup();
                
                // Show celebration message!
                const celebrationMessage = getCelebrationMessage();
                showCelebrationMessage(celebrationMessage);
                
                // Hide timer overlay after 2 seconds
                setTimeout(() => {
                    document.getElementById('cf-timer-overlay').style.display = 'none';
                    progressiveRevealActive = false;
                }, 2000);
            }, 500);
        }
        
        // Timer function for each stage
        function startStageTimer(seconds, callback) {
            let timeLeft = seconds;
            const timerDisplay = document.getElementById('cf-timer-display');
            timerDisplay.textContent = timeLeft;
            timerDisplay.style.color = '#fff';
            timerDisplay.style.textShadow = '0 0 15px rgba(255, 255, 255, 0.5)';
            
            if (progressiveRevealTimer) {
                clearInterval(progressiveRevealTimer);
            }
            
            progressiveRevealTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                
                // Color changes as time runs out (more dramatic!)
                if (timeLeft <= 5) {
                    timerDisplay.style.color = '#ff6b6b';
                    timerDisplay.style.textShadow = '0 0 20px rgba(255, 107, 107, 0.8)';
                } else if (timeLeft <= 10) {
                    timerDisplay.style.color = '#ffd700';
                    timerDisplay.style.textShadow = '0 0 20px rgba(255, 215, 0, 0.8)';
                }
                
                if (timeLeft <= 0) {
                    clearInterval(progressiveRevealTimer);
                    progressiveRevealTimer = null;
                    callback();
                }
            }, 1000);
        }
        
        // Skip to final location when map is clicked during progressive reveal
        // Only works if click is within acceptable distance of target
        function skipToLocation(clickLat, clickLon) {
            if (!progressiveRevealActive) return;
            
            // Calculate distance from click to target (in degrees)
            const latDiff = Math.abs(clickLat - targetLat);
            const lonDiff = Math.abs(clickLon - targetLon);
            
            // Define "close enough" thresholds based on current stage
            // Stage 1 (Quadrant): Within 30 degrees
            // Stage 2 (Continent): Within 10 degrees
            // Stage 3 (Region): Within 3 degrees
            let threshold;
            if (currentStage === 1) {
                threshold = 30; // Pretty generous for quadrant stage
            } else if (currentStage === 2) {
                threshold = 10; // Continental accuracy
            } else if (currentStage === 3) {
                threshold = 3; // Regional accuracy
            } else {
                return; // Already at final stage
            }
            
            // Check if click is within threshold
            if (latDiff <= threshold && lonDiff <= threshold) {
                // Clear timer
                if (progressiveRevealTimer) {
                    clearInterval(progressiveRevealTimer);
                    progressiveRevealTimer = null;
                }
                
                // Jump straight to pin drop
                dropPinAtTarget(targetLat, targetLon);
            } else {
                // Not close enough - give feedback
                const feedback = document.createElement('div');
                feedback.textContent = '‚ùå Not quite! Keep searching...';
                feedback.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(255, 0, 0, 0.9);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 12px;
                    font-size: 20px;
                    font-weight: bold;
                    z-index: 10000;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
                `;
                document.body.appendChild(feedback);
                
                // Remove feedback after 1.5 seconds
                setTimeout(() => {
                    feedback.remove();
                }, 1500);
            }
        }
        
        // ========================================
        // END COORDINATE FINDER FUNCTIONS
        // ========================================
        
        // Format coordinates
        window.formatCoord = function(value, isLat) {
            const dir = isLat ? (value >= 0 ? 'N' : 'S') : (value >= 0 ? 'E' : 'W');
            return `${Math.abs(value).toFixed(2)}¬∞ ${dir}`;
        }
        
        // Mouse move
        geoMap.on('mousemove', function(e) {
            // Update Free Explore hover displays
            document.getElementById('hover-lat').textContent = formatCoord(e.latlng.lat, true);
            document.getElementById('hover-lon').textContent = formatCoord(e.latlng.lng, false);
            
            // Update Mystery Challenge hover displays (if elements exist)
            const mysteryLat = document.getElementById('mystery-hover-lat');
            const mysteryLon = document.getElementById('mystery-hover-lon');
            if (mysteryLat && mysteryLon) {
                mysteryLat.textContent = formatCoord(e.latlng.lat, true);
                mysteryLon.textContent = formatCoord(e.latlng.lng, false);
            }
        });
        
        // Click handler
        let currentMarker = null;
        geoMap.on('click', function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            
            // COORDINATE FINDER: Skip to location if progressive reveal is active
            if (progressiveRevealActive && currentStage < 4) {
                skipToLocation(lat, lon); // Pass clicked coordinates
                return; // Don't process other click handlers
            }
            
            // Always show distance from Glennallen (useful in all modes)
            const distFromHome = calculateDistance(GLENNALLEN.lat, GLENNALLEN.lon, lat, lon);
            const distDisplay = document.getElementById('distance-display');
            if (distDisplay) {
                distDisplay.innerHTML = `
                    <strong style="color: #ffd700;">üè† Distance from Glennallen:</strong><br>
                    <span style="font-size: 24px; color: #00ff7f;">${distFromHome.toLocaleString()}</span> miles<br>
                    <span style="font-size: 12px; color: #888;">Coordinates: ${formatCoord(lat, true)}, ${formatCoord(lon, false)}</span>
                `;
            }
            
            // Handle based on active game mode
            if (gameState.mystery.active) {
                checkMysteryAnswer(lat, lon);
            } else if (gameState.scavenger.active) {
                checkScavengerAnswer(lat, lon);
            } else if (gameState.alaska.active) {
                checkAlaskaLocation(lat, lon);
            } else if (gameState.currentMode === 'create') {
                setHeistLocation(lat, lon);
            } else {
                // Free Explore mode or any other mode - show location info
                showLocationInfo(lat, lon);
            }
        });
        
        // CRITICAL FIX #2: Race condition prevention
        let currentFetchController = null;
        let lastFetchTime = 0;
        const FETCH_DELAY = 1000; // 1 second minimum between API calls (Nominatim rate limit)
        
        async function showLocationInfo(lat, lon) {
            // Cancel previous fetch if still running
            if (currentFetchController) {
                currentFetchController.abort();
                console.log('üö´ Cancelled previous location fetch');
            }
            
            // Rate limiting: Ensure minimum delay between requests
            const now = Date.now();
            const timeSinceLastFetch = now - lastFetchTime;
            if (timeSinceLastFetch < FETCH_DELAY) {
                const waitTime = FETCH_DELAY - timeSinceLastFetch;
                await new Promise(resolve => setTimeout(resolve, waitTime));
            }
            
            // Create new abort controller for this request
            currentFetchController = new AbortController();
            const signal = currentFetchController.signal;
            
            // Update marker
            if (currentMarker) geoMap.removeLayer(currentMarker);
            currentMarker = L.marker([lat, lon]).addTo(geoMap);
            
            const locationInfoEl = document.getElementById('location-info');
            locationInfoEl.innerHTML = '<span style="color: #888;">üìç Loading location...</span>';
            
            try {
                lastFetchTime = Date.now();
                
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1&accept-language=en`,
                    { 
                        headers: { 'User-Agent': 'Geographic Detective Academy' },
                        signal: signal  // Allow aborting this request
                    }
                );
                
                // Check if request was aborted
                if (signal.aborted) {
                    console.log('‚ö†Ô∏è Request was aborted');
                    return;
                }
                
                // Check response status
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const addr = data.address || {};
                
                // Build location info
                let info = `<strong>${formatCoord(lat, true)}, ${formatCoord(lon, false)}</strong><br>`;
                if (addr.city || addr.town) {
                    info += `üìç ${addr.city || addr.town}`;
                }
                if (addr.state || addr.province) {
                    info += `, ${addr.state || addr.province}`;
                }
                if (addr.country) {
                    info += `<br>üåç ${addr.country}`;
                }
                
                // Only update if this request wasn't aborted
                if (!signal.aborted) {
                    locationInfoEl.innerHTML = info;
                }
                
            } catch (error) {
                // Don't show error if request was deliberately aborted
                if (error.name === 'AbortError') {
                    console.log('‚úÖ Location fetch cancelled (user clicked elsewhere)');
                    return;
                }
                
                // Show user-friendly error message
                console.error('‚ùå Location fetch error:', error);
                if (!signal.aborted) {
                    locationInfoEl.innerHTML = `
                        <span style="color: #ff6b6b;">‚ö†Ô∏è Location service temporarily unavailable</span><br>
                        <span style="color: #888; font-size: 11px;">Try again in a moment</span>
                    `;
                }
            } finally {
                // Clear the controller reference
                if (currentFetchController && currentFetchController.signal === signal) {
                    currentFetchController = null;
                }
            }
        }
        
        // MYSTERY CHALLENGE
        const mysteryLocations = [
            // NORTH AMERICA (15 locations)
            { lat: 40.7128, lon: -74.0060, name: "New York City, USA", hint: "Major US city, financial capital, Statue of Liberty", continent: "North America", zoom: 10 },
            { lat: 19.4326, lon: -99.1332, name: "Mexico City, Mexico", hint: "Aztec heritage, high altitude capital", continent: "North America", zoom: 10 },
            { lat: 34.0522, lon: -118.2437, name: "Los Angeles, USA", hint: "Hollywood, Pacific coast, entertainment capital", continent: "North America", zoom: 10 },
            { lat: 41.8781, lon: -87.6298, name: "Chicago, USA", hint: "Windy City, Great Lakes, deep-dish pizza", continent: "North America", zoom: 10 },
            { lat: 43.6532, lon: -79.3832, name: "Toronto, Canada", hint: "CN Tower, largest Canadian city, multicultural", continent: "North America", zoom: 10 },
            { lat: 49.2827, lon: -123.1207, name: "Vancouver, Canada", hint: "Pacific coast, mountains meet ocean", continent: "North America", zoom: 10 },
            { lat: 21.3099, lon: -157.8581, name: "Honolulu, Hawaii", hint: "Pacific island paradise, Pearl Harbor", continent: "North America", zoom: 10 },
            { lat: 29.7604, lon: -95.3698, name: "Houston, USA", hint: "Space City, NASA Mission Control", continent: "North America", zoom: 10 },
            { lat: 37.7749, lon: -122.4194, name: "San Francisco, USA", hint: "Golden Gate Bridge, Silicon Valley neighbor", continent: "North America", zoom: 10 },
            { lat: 25.7617, lon: -80.1918, name: "Miami, USA", hint: "Tropical beaches, cruise capital, Cuban culture", continent: "North America", zoom: 10 },
            { lat: 38.9072, lon: -77.0369, name: "Washington DC, USA", hint: "US capital, White House, monuments", continent: "North America", zoom: 10 },
            { lat: 45.4215, lon: -75.6972, name: "Ottawa, Canada", hint: "Canadian capital, Parliament Hill", continent: "North America", zoom: 10 },
            { lat: 51.0447, lon: -114.0719, name: "Calgary, Canada", hint: "Canadian Rockies gateway, Stampede city", continent: "North America", zoom: 10 },
            { lat: 20.9674, lon: -89.5926, name: "M√©rida, Mexico", hint: "Mayan heritage, Yucat√°n Peninsula", continent: "North America", zoom: 10 },
            { lat: 32.7157, lon: -117.1611, name: "San Diego, USA", hint: "Perfect weather, Mexico border, naval base", continent: "North America", zoom: 10 },
            
            // SOUTH AMERICA (10 locations)
            { lat: -23.5505, lon: -46.6333, name: "S√£o Paulo, Brazil", hint: "Largest city in South America, financial hub", continent: "South America", zoom: 10 },
            { lat: -22.9068, lon: -43.1729, name: "Rio de Janeiro, Brazil", hint: "Christ the Redeemer, Copacabana Beach, Carnival", continent: "South America", zoom: 10 },
            { lat: -34.6037, lon: -58.3816, name: "Buenos Aires, Argentina", hint: "Tango, Paris of South America, steakhouses", continent: "South America", zoom: 10 },
            { lat: -12.0464, lon: -77.0428, name: "Lima, Peru", hint: "Pacific coast, ancient Incan connections", continent: "South America", zoom: 10 },
            { lat: -33.4489, lon: -70.6693, name: "Santiago, Chile", hint: "Andes Mountains backdrop, wine country", continent: "South America", zoom: 10 },
            { lat: 4.7110, lon: -74.0721, name: "Bogot√°, Colombia", hint: "High altitude capital, Andean culture", continent: "South America", zoom: 10 },
            { lat: -0.1807, lon: -78.4678, name: "Quito, Ecuador", hint: "Equator line city, colonial architecture", continent: "South America", zoom: 10 },
            { lat: -3.7172, lon: -38.5433, name: "Fortaleza, Brazil", hint: "Northeastern beaches, tropical coast", continent: "South America", zoom: 10 },
            { lat: -16.5000, lon: -68.1500, name: "La Paz, Bolivia", hint: "Highest capital city, Andean culture", continent: "South America", zoom: 10 },
            { lat: -25.2637, lon: -57.5759, name: "Asunci√≥n, Paraguay", hint: "River port, Guaran√≠ culture", continent: "South America", zoom: 10 },
            
            // EUROPE (15 locations)
            { lat: 51.5074, lon: -0.1278, name: "London, United Kingdom", hint: "UK capital, River Thames, Big Ben", continent: "Europe", zoom: 10 },
            { lat: 48.8566, lon: 2.3522, name: "Paris, France", hint: "City of Light, Eiffel Tower, Louvre Museum", continent: "Europe", zoom: 10 },
            { lat: 55.7558, lon: 37.6173, name: "Moscow, Russia", hint: "Russia's capital, Red Square, Kremlin", continent: "Europe", zoom: 10 },
            { lat: 41.9028, lon: 12.4964, name: "Rome, Italy", hint: "Eternal City, Colosseum, Vatican nearby", continent: "Europe", zoom: 10 },
            { lat: 52.5200, lon: 13.4050, name: "Berlin, Germany", hint: "Brandenburg Gate, historic wall location", continent: "Europe", zoom: 10 },
            { lat: 40.4168, lon: -3.7038, name: "Madrid, Spain", hint: "Spanish capital, Royal Palace, museums", continent: "Europe", zoom: 10 },
            { lat: 59.3293, lon: 18.0686, name: "Stockholm, Sweden", hint: "Built on 14 islands, Nobel Prize home", continent: "Europe", zoom: 10 },
            { lat: 60.1699, lon: 24.9384, name: "Helsinki, Finland", hint: "Baltic Sea port, midnight sun in summer", continent: "Europe", zoom: 10 },
            { lat: 50.0755, lon: 14.4378, name: "Prague, Czech Republic", hint: "City of a Hundred Spires, medieval charm", continent: "Europe", zoom: 10 },
            { lat: 47.4979, lon: 19.0402, name: "Budapest, Hungary", hint: "Danube River divides Buda and Pest", continent: "Europe", zoom: 10 },
            { lat: 38.7223, lon: -9.1393, name: "Lisbon, Portugal", hint: "Westernmost European capital, Age of Discovery", continent: "Europe", zoom: 10 },
            { lat: 59.9139, lon: 10.7522, name: "Oslo, Norway", hint: "Fjord city, Viking heritage, Nobel Peace Prize", continent: "Europe", zoom: 10 },
            { lat: 55.6761, lon: 12.5683, name: "Copenhagen, Denmark", hint: "Little Mermaid statue, bicycle culture", continent: "Europe", zoom: 10 },
            { lat: 53.3498, lon: -6.2603, name: "Dublin, Ireland", hint: "Emerald Isle capital, literary heritage", continent: "Europe", zoom: 10 },
            { lat: 64.1466, lon: -21.9426, name: "Reykjavik, Iceland", hint: "Northernmost capital, geothermal energy, midnight sun", continent: "Europe", zoom: 10 },
            
            // AFRICA (10 locations)
            { lat: 30.0444, lon: 31.2357, name: "Cairo, Egypt", hint: "Ancient capital, pyramids nearby, Nile River", continent: "Africa", zoom: 10 },
            { lat: -26.2041, lon: 28.0473, name: "Johannesburg, South Africa", hint: "Gold mining history, largest SA city", continent: "Africa", zoom: 10 },
            { lat: -33.9249, lon: 18.4241, name: "Cape Town, South Africa", hint: "Table Mountain, southern tip of Africa", continent: "Africa", zoom: 10 },
            { lat: -1.2921, lon: 36.8219, name: "Nairobi, Kenya", hint: "Safari capital, East African hub", continent: "Africa", zoom: 10 },
            { lat: 6.5244, lon: 3.3792, name: "Lagos, Nigeria", hint: "West African megacity, Atlantic coast", continent: "Africa", zoom: 10 },
            { lat: 33.5731, lon: -7.5898, name: "Casablanca, Morocco", hint: "Atlantic port, famous movie namesake", continent: "Africa", zoom: 10 },
            { lat: -4.0435, lon: 39.6682, name: "Mombasa, Kenya", hint: "Indian Ocean port, historic Swahili coast", continent: "Africa", zoom: 10 },
            { lat: 9.0320, lon: 38.7469, name: "Addis Ababa, Ethiopia", hint: "High altitude capital, African Union headquarters", continent: "Africa", zoom: 10 },
            { lat: 15.5007, lon: 32.5599, name: "Khartoum, Sudan", hint: "Where Blue and White Nile meet", continent: "Africa", zoom: 10 },
            { lat: -18.8792, lon: 47.5079, name: "Antananarivo, Madagascar", hint: "Island nation capital, unique wildlife nearby", continent: "Africa", zoom: 10 },
            
            // ASIA (15 locations)
            { lat: 35.6762, lon: 139.6503, name: "Tokyo, Japan", hint: "Japan's capital, largest metro area, tech hub", continent: "Asia", zoom: 10 },
            { lat: 39.9042, lon: 116.4074, name: "Beijing, China", hint: "Chinese capital, Forbidden City, Great Wall nearby", continent: "Asia", zoom: 10 },
            { lat: 31.2304, lon: 121.4737, name: "Shanghai, China", hint: "Largest Chinese city, futuristic skyline", continent: "Asia", zoom: 10 },
            { lat: 28.6139, lon: 77.2090, name: "New Delhi, India", hint: "Indian capital, Red Fort, historic monuments", continent: "Asia", zoom: 10 },
            { lat: 19.0760, lon: 72.8777, name: "Mumbai, India", hint: "Bollywood, India's financial capital, Arabian Sea", continent: "Asia", zoom: 10 },
            { lat: 1.3521, lon: 103.8198, name: "Singapore", hint: "Island city-state, garden city, global finance hub", continent: "Asia", zoom: 11 },
            { lat: 13.7563, lon: 100.5018, name: "Bangkok, Thailand", hint: "Golden temples, floating markets, Chao Phraya River", continent: "Asia", zoom: 10 },
            { lat: 25.0330, lon: 121.5654, name: "Taipei, Taiwan", hint: "Island tech hub, Taipei 101 skyscraper", continent: "Asia", zoom: 10 },
            { lat: 37.5665, lon: 126.9780, name: "Seoul, South Korea", hint: "K-pop capital, palaces meet technology", continent: "Asia", zoom: 10 },
            { lat: 21.0285, lon: 105.8542, name: "Hanoi, Vietnam", hint: "Vietnamese capital, thousand-year history", continent: "Asia", zoom: 10 },
            { lat: -6.2088, lon: 106.8456, name: "Jakarta, Indonesia", hint: "Island nation capital, massive megacity", continent: "Asia", zoom: 10 },
            { lat: 14.5995, lon: 120.9842, name: "Manila, Philippines", hint: "Island capital, Spanish colonial history", continent: "Asia", zoom: 10 },
            { lat: 3.1390, lon: 101.6869, name: "Kuala Lumpur, Malaysia", hint: "Petronas Towers, multicultural Southeast Asian hub", continent: "Asia", zoom: 10 },
            { lat: 23.8103, lon: 90.4125, name: "Dhaka, Bangladesh", hint: "River delta megacity, historic textile trade", continent: "Asia", zoom: 10 },
            { lat: 33.3152, lon: 44.3661, name: "Baghdad, Iraq", hint: "Ancient Mesopotamian heritage, Tigris River", continent: "Asia", zoom: 10 },
            
            // OCEANIA (5 locations)
            { lat: -33.8688, lon: 151.2093, name: "Sydney, Australia", hint: "Famous harbor, Opera House, Harbour Bridge", continent: "Oceania", zoom: 10 },
            { lat: -37.8136, lon: 144.9631, name: "Melbourne, Australia", hint: "Cultural capital, Australian Rules Football, coffee culture", continent: "Oceania", zoom: 10 },
            { lat: -41.2865, lon: 174.7762, name: "Wellington, New Zealand", hint: "Windy city, southernmost capital, Lord of the Rings", continent: "Oceania", zoom: 10 },
            { lat: -36.8485, lon: 174.7633, name: "Auckland, New Zealand", hint: "City of Sails, volcanic field, largest NZ city", continent: "Oceania", zoom: 10 },
            { lat: -17.7134, lon: 178.0650, name: "Suva, Fiji", hint: "Pacific island capital, coral reefs, tropical paradise", continent: "Oceania", zoom: 10 }
        ];
        
        window.startMysteryGame = function() {
            document.getElementById('mystery-intro').style.display = 'none';
            document.getElementById('mystery-game').style.display = 'block';
            gameState.mystery.active = true;
            startMystery();
        }
        
        window.startMystery = function() {
            if (gameState.mystery.timer) clearInterval(gameState.mystery.timer);
            
            gameState.mystery.current = mysteryLocations[Math.floor(Math.random() * mysteryLocations.length)];
            
            document.getElementById('mystery-coords').textContent = 
                `${formatCoord(gameState.mystery.current.lat, true)}, ${formatCoord(gameState.mystery.current.lon, false)}`;
            
            document.getElementById('mystery-hints').style.display = 'none';
            
            let timeLeft = 60;
            const timerEl = document.getElementById('mystery-timer');
            timerEl.textContent = timeLeft;
            timerEl.classList.remove('warning');
            
            gameState.mystery.timer = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                
                if (timeLeft <= 10) {
                    timerEl.classList.add('warning');
                }
                
                if (timeLeft === 30) {
                    document.getElementById('mystery-hints').style.display = 'block';
                    document.getElementById('hint-text').textContent = `Continent: ${gameState.mystery.current.continent}`;
                }
                
                if (timeLeft === 15) {
                    document.getElementById('hint-text').textContent = gameState.mystery.current.hint;
                }
                
                if (timeLeft <= 0) {
                    clearInterval(gameState.mystery.timer);
                    showNotification('‚è∞ Time\'s up! Streak reset.');
                    gameState.mystery.streak = 0;
                    updateAllDisplays();
                    startMystery();
                }
            }, 1000);
        }
        
        window.checkMysteryAnswer = function(lat, lon) {
            if (!gameState.mystery.current) return;
            
            const distance = Math.sqrt(
                Math.pow((lat - gameState.mystery.current.lat) * 111, 2) + 
                Math.pow((lon - gameState.mystery.current.lon) * 111 * Math.cos(lat * Math.PI / 180), 2)
            );
            
            if (distance < 500) { // Within 500km
                clearInterval(gameState.mystery.timer);
                const baseXP = 50;
                const streakBonus = gameState.mystery.streak * 10;
                const totalXP = baseXP + streakBonus;
                
                addXP(totalXP, `Correct! ${gameState.mystery.current.name}`);
                gameState.mystery.score += totalXP;
                gameState.mystery.streak++;
                gameState.mystery.solved++;
                
                if (gameState.mystery.streak > gameState.mystery.bestStreak) {
                    gameState.mystery.bestStreak = gameState.mystery.streak;
                }
                
                // Update mission progress
                gameState.missions[0].progress++;
                
                updateAllDisplays();
                saveState();
                
                setTimeout(() => startMystery(), 1500);
            } else {
                showNotification('‚ùå Not quite! Keep trying!');
            }
        }
        
        window.skipMystery = function() {
            if (!gameState.mystery.current) return;
            clearInterval(gameState.mystery.timer);
            addXP(-5, 'Mystery skipped');
            gameState.mystery.streak = 0;
            updateAllDisplays();
            startMystery();
        }
        
        // SCAVENGER HUNT
        const scavengerChallenges = [
            { desc: "Find the Sahara Desert", lat: 23.4162, lon: 25.6628, tolerance: 1000, type: "desert" },
            { desc: "Find Mount Everest", lat: 27.9881, lon: 86.9250, tolerance: 200, type: "mountain" },
            { desc: "Find the Amazon River", lat: -3.4653, lon: -62.2159, tolerance: 500, type: "river" },
            { desc: "Find Paris, France", lat: 48.8566, lon: 2.3522, tolerance: 100, type: "city" },
            { desc: "Find the Great Barrier Reef", lat: -18.2871, lon: 147.6992, tolerance: 300, type: "reef" },
            { desc: "Find Tokyo, Japan", lat: 35.6762, lon: 139.6503, tolerance: 100, type: "city" },
            { desc: "Find the Grand Canyon", lat: 36.1069, lon: -112.1129, tolerance: 200, type: "canyon" },
            { desc: "Find the Nile River", lat: 26.8206, lon: 30.8025, tolerance: 500, type: "river" },
            { desc: "Find Antarctica", lat: -82.8628, lon: 135.0000, tolerance: 2000, type: "continent" },
            { desc: "Find the Great Wall of China", lat: 40.4319, lon: 116.5704, tolerance: 200, type: "landmark" }
        ];
        
        window.startScavengerGame = function() {
            document.getElementById('scavenger-intro').style.display = 'none';
            document.getElementById('scavenger-game').style.display = 'block';
            gameState.scavenger.active = true;
            gameState.scavenger.challenges = scavengerChallenges.map(c => ({ ...c, completed: false }));
            gameState.scavenger.completed = 0;
            renderScavengerList();
        }
        
        window.renderScavengerList = function() {
            const html = gameState.scavenger.challenges.map((c, idx) => `
                <div class="challenge-item ${c.completed ? 'completed' : ''}">
                    <span class="challenge-text">${c.completed ? '‚úÖ' : '‚≠ï'} ${c.desc}</span>
                    ${c.completed ? '<span style="color: #00ff7f; font-weight: 700;">+20 XP</span>' : ''}
                </div>
            `).join('');
            document.getElementById('scavenger-list').innerHTML = html;
            
            const progress = (gameState.scavenger.completed / gameState.scavenger.challenges.length) * 100;
            document.getElementById('scavenger-progress').style.width = progress + '%';
            document.getElementById('scavenger-progress').textContent = 
                `${gameState.scavenger.completed}/${gameState.scavenger.challenges.length}`;
        }
        
        window.checkScavengerAnswer = function(lat, lon) {
            for (let i = 0; i < gameState.scavenger.challenges.length; i++) {
                const c = gameState.scavenger.challenges[i];
                if (c.completed) continue;
                
                const distance = Math.sqrt(
                    Math.pow((lat - c.lat) * 111, 2) + 
                    Math.pow((lon - c.lon) * 111 * Math.cos(lat * Math.PI / 180), 2)
                );
                
                if (distance < c.tolerance) {
                    c.completed = true;
                    gameState.scavenger.completed++;
                    addXP(20, c.desc + ' found!');
                    renderScavengerList();
                    
                    if (gameState.scavenger.completed === gameState.scavenger.challenges.length) {
                        addXP(100, 'Scavenger Hunt Complete!');
                        gameState.missions[1].progress = 1;
                        saveState();
                    }
                    return;
                }
            }
            
            showNotification('‚ùå Not quite! Try another location.');
        }
        
        window.resetScavenger = function() {
            gameState.scavenger.challenges = scavengerChallenges.map(c => ({ ...c, completed: false }));
            gameState.scavenger.completed = 0;
            renderScavengerList();
        }
        
        // GUESS GAME
        const guessLocations = [
            { lat: 27.1751, lon: 78.0421, name: "Taj Mahal", country: "India", zoom: 15, options: ["India", "Pakistan", "Bangladesh", "Nepal"] },
            { lat: 41.8902, lon: 12.4922, name: "Colosseum", country: "Italy", zoom: 16, options: ["Italy", "Greece", "Spain", "France"] },
            { lat: -13.1631, lon: -72.5450, name: "Machu Picchu", country: "Peru", zoom: 14, options: ["Peru", "Chile", "Bolivia", "Ecuador"] },
            { lat: 29.9792, lon: 31.1342, name: "Pyramids of Giza", country: "Egypt", zoom: 15, options: ["Egypt", "Sudan", "Libya", "Tunisia"] },
            { lat: -22.9519, lon: -43.2105, name: "Christ the Redeemer", country: "Brazil", zoom: 15, options: ["Brazil", "Argentina", "Colombia", "Venezuela"] },
            { lat: 40.6892, lon: -74.0445, name: "Statue of Liberty", country: "USA", zoom: 16, options: ["USA", "Canada", "France", "UK"] },
            { lat: 25.1972, lon: 55.2744, name: "Burj Khalifa", country: "UAE", zoom: 16, options: ["UAE", "Saudi Arabia", "Qatar", "Kuwait"] },
            { lat: -25.3444, lon: 131.0369, name: "Uluru", country: "Australia", zoom: 13, options: ["Australia", "New Zealand", "South Africa", "Namibia"] },
            { lat: 43.7230, lon: 10.3966, name: "Leaning Tower of Pisa", country: "Italy", zoom: 17, options: ["Italy", "France", "Spain", "Greece"] },
            { lat: 51.1789, lon: -1.8262, name: "Stonehenge", country: "UK", zoom: 16, options: ["UK", "Ireland", "France", "Germany"] }
        ];
        
        window.startGuessGame = function() {
            document.getElementById('guess-intro').style.display = 'none';
            document.getElementById('guess-game').style.display = 'block';
            gameState.guess.active = true;
            gameState.guess.round = 0;
            gameState.guess.score = 0;
            document.getElementById('guess-score').textContent = '0';
            nextGuessRound();
        }
        
        window.nextGuessRound = function() {
            if (gameState.guess.round >= 5) {
                gameState.guess.active = false;
                addXP(50, 'Guess Game Complete!');
                document.getElementById('guess-intro').style.display = 'block';
                document.getElementById('guess-game').style.display = 'none';
                return;
            }
            
            gameState.guess.round++;
            gameState.guess.current = guessLocations[Math.floor(Math.random() * guessLocations.length)];
            
            document.getElementById('guess-round').textContent = gameState.guess.round;
            document.getElementById('next-guess-btn').style.display = 'none';
            
            geoMap.setView([gameState.guess.current.lat, gameState.guess.current.lon], gameState.guess.current.zoom);
            
            const optionsHtml = gameState.guess.current.options.map(option => 
                `<button class="answer-btn" onclick="checkGuess('${option}')">${option}</button>`
            ).join('');
            document.getElementById('guess-options').innerHTML = optionsHtml;
        }
        
        window.checkGuess = function(answer) {
            if (!gameState.guess.current) return;
            
            const buttons = document.querySelectorAll('#guess-options .answer-btn');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === gameState.guess.current.country) {
                    btn.classList.add('correct');
                } else if (btn.textContent === answer) {
                    btn.classList.add('incorrect');
                }
            });
            
            if (answer === gameState.guess.current.country) {
                addXP(30, 'Correct!');
                gameState.guess.score += 30;
                gameState.guess.correct++;
                gameState.missions[2].progress++;
                document.getElementById('guess-score').textContent = gameState.guess.score;
            }
            
            gameState.guess.total++;
            updateAllDisplays();
            saveState();
            
            document.getElementById('next-guess-btn').style.display = 'block';
        }
        
        // MISSIONS
        window.renderMissions = function() {
            const html = gameState.missions.map(m => {
                const progress = Math.min((m.progress / m.target) * 100, 100);
                const isComplete = m.progress >= m.target;
                return `
                    <div class="section" style="margin-bottom: 12px;">
                        <h3 style="color: ${isComplete ? '#00ff7f' : '#ffd700'}; font-size: 16px; margin-bottom: 8px;">
                            ${isComplete ? '‚úÖ' : 'üéØ'} ${m.name}
                        </h3>
                        <p style="color: #aaa; font-size: 13px; margin-bottom: 10px;">${m.desc}</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%">${m.progress}/${m.target}</div>
                        </div>
                        <div style="text-align: right; margin-top: 8px; color: ${isComplete ? '#00ff7f' : '#ffd700'}; font-weight: 700;">
                            ${isComplete ? 'COMPLETE!' : `Reward: ${m.xp} XP`}
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('missions-list').innerHTML = html;
        }
        
        // CREATE HEIST
        let heistLocation = null;
        
        window.setHeistLocation = function(lat, lon) {
            heistLocation = { lat, lon };
            document.getElementById('heist-coords').textContent = `${formatCoord(lat, true)}, ${formatCoord(lon, false)}`;
            if (currentMarker) geoMap.removeLayer(currentMarker);
            currentMarker = L.marker([lat, lon]).addTo(geoMap);
        }
        
        window.saveHeist = function() {
            const name = document.getElementById('heist-name').value;
            const clue1 = document.getElementById('clue1').value;
            const clue2 = document.getElementById('clue2').value;
            
            if (!name || !heistLocation || !clue1) {
                showNotification('‚ö†Ô∏è Fill in name, location, and clue 1!');
                return;
            }
            
            const heist = {
                id: Date.now(),
                name,
                location: heistLocation,
                clues: [clue1, clue2].filter(c => c),
                created: new Date().toLocaleDateString()
            };
            
            gameState.heists.push(heist);
            gameState.missions[3].progress++;
            addXP(50, 'Heist created!');
            saveState();
            
            document.getElementById('heist-name').value = '';
            document.getElementById('clue1').value = '';
            document.getElementById('clue2').value = '';
            document.getElementById('heist-coords').textContent = 'Click on map to set location';
            heistLocation = null;
            if (currentMarker) geoMap.removeLayer(currentMarker);
        }
        
        window.loadHeists = function() {
            if (gameState.heists.length === 0) {
                showNotification('No saved heists yet!');
                return;
            }
            
            const html = gameState.heists.map(h => `
                <div class="challenge-item">
                    <div>
                        <strong style="color: #ffd700;">${h.name}</strong><br>
                        <span style="font-size: 12px; color: #aaa;">Created: ${h.created}</span>
                    </div>
                    <button class="btn" style="width: auto; padding: 8px 16px; margin: 0;" onclick="viewHeist(${h.id})">VIEW</button>
                </div>
            `).join('');
            
            document.getElementById('saved-heists-list').innerHTML = html;
            document.getElementById('saved-heists-section').style.display = 'block';
        }
        
        window.viewHeist = function(id) {
            const heist = gameState.heists.find(h => h.id === id);
            if (!heist) return;
            
            geoMap.setView([heist.location.lat, heist.location.lon], 10);
            if (currentMarker) geoMap.removeLayer(currentMarker);
            currentMarker = L.marker([heist.location.lat, heist.location.lon]).addTo(geoMap);
            
            showNotification(`üìç ${heist.name}`);
        }
        
        // ============ ALASKA ADVENTURE FUNCTIONS ============
        
        window.calculateDistance = function(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return Math.round(R * c);
        }
        
        window.startAlaskaGame = function() {
            gameState.alaska.active = true;
            gameState.alaska.currentRound = 0;
            gameState.alaska.roundProgress = [0, 0, 0, 0, 0];
            gameState.alaska.totalFound = 0;
            gameState.alaska.foundLocations = [];
            
            document.getElementById('alaska-intro').style.display = 'none';
            document.getElementById('alaska-game').style.display = 'block';
            
            // Zoom to Alaska
            geoMap.setView([64, -152], 5);
            
            updateAlaskaDisplay();
            const roundInfo = alaskaRounds[0];
            showNotification(`üèîÔ∏è ${roundInfo.name} Started! ${roundInfo.description}`);
        }
        
        window.updateAlaskaDisplay = function() {
            const currentRound = gameState.alaska.currentRound;
            const roundInfo = alaskaRounds[currentRound];
            const roundFound = gameState.alaska.roundProgress[currentRound];
            const roundTotal = roundInfo.locations.length;
            const totalFound = gameState.alaska.totalFound;
            const grandTotal = alaskaRounds.reduce((sum, r) => sum + r.locations.length, 0);
            
            // Update round header
            document.getElementById('round-name').textContent = roundInfo.name;
            document.getElementById('round-description').textContent = roundInfo.description;
            document.getElementById('round-score').textContent = `${roundFound}/${roundTotal}`;
            
            // Update stats boxes
            document.getElementById('total-found').textContent = `${totalFound}/50`;
            document.getElementById('current-round').textContent = currentRound + 1;
            
            // Update progress bar
            const percent = (roundFound / roundTotal) * 100;
            document.getElementById('alaska-progress').style.width = percent + '%';
            document.getElementById('alaska-progress').textContent = `${roundFound}/${roundTotal}`;
            
            // Display locations for current round
            const html = roundInfo.locations.map((loc, i) => {
                const locId = `r${currentRound}_${i}`;
                const found = gameState.alaska.foundLocations.includes(locId);
                
                if (found) {
                    return `
                        <div class="challenge-item" style="background: rgba(0, 255, 127, 0.1); border-left: 4px solid #00ff7f;">
                            <div>
                                <strong style="color: #00ff7f;">‚úÖ ${loc.name}</strong><br>
                                <span style="font-size: 12px; color: #aaa;">${loc.fact}</span>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="challenge-item">
                            <div>
                                <strong style="color: #888;">‚ùì Location ${i + 1}</strong><br>
                                <span style="font-size: 12px; color: #66b3ff;">üó∫Ô∏è Clue: ${loc.clue}</span>
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            document.getElementById('alaska-list').innerHTML = html;
            
            // Check for achievements
            checkAlaskaAchievements();
        }
        
        window.checkAlaskaAchievements = function() {
            const badges = document.querySelectorAll('#alaska-badges .badge');
            const totalFound = gameState.alaska.totalFound;
            const grandTotal = alaskaRounds.reduce((sum, r) => sum + r.locations.length, 0);
            
            console.log('Checking Alaska achievements:', totalFound, 'locations found out of', grandTotal);
            
            // Count types across ALL found locations
            let mountains = 0, rivers = 0, parks = 0, cities = 0, glaciers = 0;
            
            alaskaRounds.forEach((round, roundIdx) => {
                round.locations.forEach((loc, locIdx) => {
                    const locId = `r${roundIdx}_${locIdx}`;
                    if (gameState.alaska.foundLocations.includes(locId)) {
                        if (loc.type === 'mountain') mountains++;
                        if (loc.type === 'river') rivers++;
                        if (loc.type === 'park') parks++;
                        if (loc.type === 'city') cities++;
                        if (loc.type === 'glacier') glaciers++;
                    }
                });
            });
            
            console.log('Mountains:', mountains, 'Rivers:', rivers, 'Parks:', parks, 'Cities:', cities, 'Glaciers:', glaciers);
            
            // Mountain Master - find 5+ mountains
            if (mountains >= 5) {
                badges[0].classList.remove('locked');
                badges[0].classList.add('unlocked');
            }
            
            // River Runner - find 3+ rivers
            if (rivers >= 3) {
                badges[1].classList.remove('locked');
                badges[1].classList.add('unlocked');
            }
            
            // Park Explorer - find 5+ parks
            if (parks >= 5) {
                badges[2].classList.remove('locked');
                badges[2].classList.add('unlocked');
            }
            
            // City Finder - find 8+ cities
            if (cities >= 8) {
                badges[3].classList.remove('locked');
                badges[3].classList.add('unlocked');
            }
            
            // Alaska Expert - find all 50 locations
            if (totalFound === grandTotal) {
                badges[4].classList.remove('locked');
                badges[4].classList.add('unlocked');
                showNotification('üèÜ ALASKA EXPERT UNLOCKED! +500 XP BONUS!');
                addXP(500);
            }
        }
        
        window.resetAlaska = function() {
            gameState.alaska.active = false;
            gameState.alaska.currentRound = 0;
            gameState.alaska.roundProgress = [0, 0, 0, 0, 0];
            gameState.alaska.totalFound = 0;
            gameState.alaska.foundLocations = [];
            
            document.getElementById('alaska-intro').style.display = 'block';
            document.getElementById('alaska-game').style.display = 'none';
            
            saveState();
        }
        
        window.checkAlaskaLocation = function(lat, lon) {
            const TOLERANCE = 50; // miles
            const currentRound = gameState.alaska.currentRound;
            const roundInfo = alaskaRounds[currentRound];
            
            // Check locations in current round
            for (let i = 0; i < roundInfo.locations.length; i++) {
                const loc = roundInfo.locations[i];
                const locId = `r${currentRound}_${i}`;
                
                if (gameState.alaska.foundLocations.includes(locId)) continue;
                
                const dist = calculateDistance(lat, lon, loc.lat, loc.lon);
                
                if (dist <= TOLERANCE) {
                    // Found it!
                    gameState.alaska.foundLocations.push(locId);
                    gameState.alaska.roundProgress[currentRound]++;
                    gameState.alaska.totalFound++;
                    
                    if (currentMarker) geoMap.removeLayer(currentMarker);
                    currentMarker = L.marker([loc.lat, loc.lon]).addTo(geoMap);
                    
                    showNotification(`‚úÖ FOUND: ${loc.name}! +30 XP`);
                    addXP(30, loc.name);
                    
                    // Update distance display
                    const distFromHome = calculateDistance(GLENNALLEN.lat, GLENNALLEN.lon, loc.lat, loc.lon);
                    document.getElementById('distance-home').textContent = distFromHome.toLocaleString() + ' mi';
                    
                    updateAlaskaDisplay();
                    saveState();
                    
                    // Check if round is complete
                    if (gameState.alaska.roundProgress[currentRound] === roundInfo.locations.length) {
                        setTimeout(() => {
                            if (currentRound < alaskaRounds.length - 1) {
                                // More rounds to go
                                showRoundComplete();
                            } else {
                                // All rounds complete!
                                showGameComplete();
                            }
                        }, 1500);
                    }
                    
                    return;
                }
            }
            
            // Not found - show hint
            let closest = null;
            let closestDist = Infinity;
            
            for (let i = 0; i < roundInfo.locations.length; i++) {
                const loc = roundInfo.locations[i];
                const locId = `r${currentRound}_${i}`;
                if (gameState.alaska.foundLocations.includes(locId)) continue;
                
                const dist = calculateDistance(lat, lon, loc.lat, loc.lon);
                if (dist < closestDist) {
                    closestDist = dist;
                    closest = loc;
                }
            }
            
            if (closest) {
                showNotification(`‚ùå Not quite! You're ${Math.round(closestDist)} miles from the nearest location. Hint: ${closest.clue}`);
            }
        }
        
        window.showRoundComplete = function() {
            const currentRound = gameState.alaska.currentRound;
            const roundInfo = alaskaRounds[currentRound];
            const nextRound = alaskaRounds[currentRound + 1];
            
            const html = `
                <div style="text-align: center; padding: 30px;">
                    <h2 style="color: #00ff7f; font-size: 36px; margin-bottom: 20px;">üéâ ROUND COMPLETE!</h2>
                    <p style="font-size: 20px; margin-bottom: 10px;">${roundInfo.name}</p>
                    <p style="font-size: 16px; color: #aaa; margin-bottom: 30px;">You found all ${roundInfo.locations.length} locations!</p>
                    <div style="background: rgba(0, 255, 127, 0.1); border: 2px solid #00ff7f; border-radius: 10px; padding: 20px; margin: 20px 0;">
                        <p style="font-size: 18px; color: #00ff7f; margin: 0;">+100 XP Round Bonus!</p>
                    </div>
                    <p style="font-size: 18px; margin-top: 30px; margin-bottom: 20px;"><strong>Next Round:</strong></p>
                    <p style="font-size: 16px; color: #66b3ff; margin-bottom: 30px;">${nextRound.name}</p>
                    <p style="font-size: 14px; color: #aaa; margin-bottom: 30px;">${nextRound.description}</p>
                    <button class="btn" onclick="startNextRound()" style="font-size: 18px; padding: 15px 30px;">
                        üöÄ START NEXT ROUND
                    </button>
                </div>
            `;
            
            document.getElementById('alaska-list').innerHTML = html;
            addXP(100);
        }
        
        window.showGameComplete = function() {
            const totalFound = gameState.alaska.totalFound;
            
            const html = `
                <div style="text-align: center; padding: 30px;">
                    <h2 style="color: #ffd700; font-size: 42px; margin-bottom: 20px;">üèÜ ALASKA EXPERT!</h2>
                    <p style="font-size: 24px; margin-bottom: 10px;">ALL 5 ROUNDS COMPLETE!</p>
                    <p style="font-size: 18px; color: #aaa; margin-bottom: 30px;">You discovered all ${totalFound} locations across Alaska!</p>
                    <div style="background: rgba(255, 215, 0, 0.1); border: 2px solid #ffd700; border-radius: 10px; padding: 20px; margin: 20px 0;">
                        <p style="font-size: 20px; color: #ffd700; margin: 0;">üéâ +500 XP Grand Prize!</p>
                    </div>
                    <p style="font-size: 16px; margin-top: 30px; color: #aaa;">You've mastered Alaska geography and earned the prestigious Alaska Expert badge!</p>
                    <button class="btn" onclick="resetAlaska()" style="font-size: 18px; padding: 15px 30px; margin-top: 30px;">
                        üîÑ PLAY AGAIN
                    </button>
                </div>
            `;
            
            document.getElementById('alaska-list').innerHTML = html;
        }
        
        window.startNextRound = function() {
            gameState.alaska.currentRound++;
            const roundInfo = alaskaRounds[gameState.alaska.currentRound];
            
            showNotification(`üèîÔ∏è ${roundInfo.name} Started! ${roundInfo.description}`);
            updateAlaskaDisplay();
            saveState();
        }
        
        // TUTORIALS
        window.showTutorial = function(mode) {
            const tutorials = {
                mystery: `
                    <h2>üéØ MYSTERY CHALLENGE TUTORIAL</h2>
                    <div class="why-play">
                        <strong>WHY PLAY THIS?</strong>
                        <p>Master coordinate reading while racing against time. Build massive streaks for huge XP bonuses. Compete with friends for the highest score!</p>
                    </div>
                    <h3>HOW TO PLAY:</h3>
                    <ul>
                        <li><strong>Step 1:</strong> Click "START MYSTERY CHALLENGE"</li>
                        <li><strong>Step 2:</strong> You'll see coordinates like <code>40.7128¬∞N, 74.0060¬∞W</code></li>
                        <li><strong>Step 3:</strong> Find that location on the map and click it</li>
                        <li><strong>Step 4:</strong> You have 60 seconds - hints unlock at 30s and 15s</li>
                        <li><strong>Step 5:</strong> Get it right to earn XP and build your streak!</li>
                    </ul>
                    <h3>TIPS:</h3>
                    <ul>
                        <li>üß≠ Use the coordinates to narrow down the region first</li>
                        <li>üó∫Ô∏è Switch map layers to see terrain/satellite views</li>
                        <li>üî• Build streaks for bonus XP (each streak adds +10 XP)</li>
                        <li>‚è±Ô∏è Don't wait for hints - faster = more practice!</li>
                    </ul>
                    <button class="btn" onclick="closeTutorial()">GOT IT! LET'S PLAY</button>
                `,
                scavenger: `
                    <h2>üåç SCAVENGER HUNT TUTORIAL</h2>
                    <div class="why-play">
                        <strong>WHY PLAY THIS?</strong>
                        <p>Explore the entire world! Learn where major geographic features are located. Unlock achievement badges and become a geography expert!</p>
                    </div>
                    <h3>HOW TO PLAY:</h3>
                    <ul>
                        <li><strong>Step 1:</strong> Click "START SCAVENGER HUNT"</li>
                        <li><strong>Step 2:</strong> You'll get 10 challenges (find deserts, mountains, cities, etc.)</li>
                        <li><strong>Step 3:</strong> Use different map layers to help you find each one</li>
                        <li><strong>Step 4:</strong> Click on the map when you think you found it</li>
                        <li><strong>Step 5:</strong> Each correct answer = 20 XP!</li>
                    </ul>
                    <h3>TIPS:</h3>
                    <ul>
                        <li>üõ∞Ô∏è Use Satellite view to see terrain features</li>
                        <li>‚õ∞Ô∏è Use Topographic view to find mountains</li>
                        <li>üèôÔ∏è Use Street view to find cities</li>
                        <li>üåç Zoom out to see continents, zoom in for precision</li>
                    </ul>
                    <button class="btn" onclick="closeTutorial()">GOT IT! LET'S HUNT</button>
                `,
                guess: `
                    <h2>üì∏ GUESS THE LOCATION TUTORIAL</h2>
                    <div class="why-play">
                        <strong>WHY PLAY THIS?</strong>
                        <p>Test your world knowledge! Identify famous landmarks from satellite view. Perfect your visual geography skills and impress everyone!</p>
                    </div>
                    <h3>HOW TO PLAY:</h3>
                    <ul>
                        <li><strong>Step 1:</strong> Click "START GUESS GAME"</li>
                        <li><strong>Step 2:</strong> The map zooms to a famous location</li>
                        <li><strong>Step 3:</strong> Look at the satellite/terrain view carefully</li>
                        <li><strong>Step 4:</strong> Choose the correct country from 4 options</li>
                        <li><strong>Step 5:</strong> Earn 30 XP for each correct answer!</li>
                    </ul>
                    <h3>TIPS:</h3>
                    <ul>
                        <li>üëÄ Look for distinctive features (rivers, coastlines, deserts)</li>
                        <li>üó∫Ô∏è Try switching to Terrain view for elevation clues</li>
                        <li>üèõÔ∏è Famous landmarks have unique shapes from above</li>
                        <li>üåç Use continent knowledge to eliminate wrong answers</li>
                    </ul>
                    <button class="btn" onclick="closeTutorial()">GOT IT! LET'S GUESS</button>
                `,
                alaska: `
                    <h2>üèîÔ∏è ALASKA ADVENTURE TUTORIAL</h2>
                    <div class="why-play">
                        <strong>WHY PLAY THIS?</strong>
                        <p>Explore YOUR home state from a global perspective! Discover Alaska's incredible geography and see how Glennallen connects to the Last Frontier's most amazing places. Build local pride and geographic literacy!</p>
                    </div>
                    <h3>HOW TO PLAY:</h3>
                    <ul>
                        <li><strong>Step 1:</strong> Click "START ALASKA ADVENTURE" to begin</li>
                        <li><strong>Step 2:</strong> The map zooms to Alaska - your home state!</li>
                        <li><strong>Step 3:</strong> Find all 10 famous Alaska locations on the map</li>
                        <li><strong>Step 4:</strong> Click on each location when you find it (within 50 miles)</li>
                        <li><strong>Step 5:</strong> Learn cool facts about each place!</li>
                        <li><strong>Step 6:</strong> See how far everything is from Glennallen</li>
                        <li><strong>Step 7:</strong> Earn 30 XP per location + bonuses for completing rounds!</li>
                    </ul>
                    <h3>5 EXCITING ROUNDS:</h3>
                    <ul>
                        <li>üè† <strong>Round 1: Home Territory</strong> - 10 locations around Glennallen</li>
                        <li>ÔøΩÔ∏è <strong>Round 2: Major Cities</strong> - 10 important Alaskan cities</li>
                        <li>ÔøΩÔ∏è <strong>Round 3: Natural Wonders</strong> - 10 mountains, rivers, and glaciers</li>
                        <li>ÔøΩÔ∏è <strong>Round 4: Parks & Refuges</strong> - 10 protected wilderness areas</li>
                        <li>üìú <strong>Round 5: Historic Sites</strong> - 10 culturally significant locations</li>
                    </ul>
                    <h3>PRO TIPS:</h3>
                    <ul>
                        <li>üó∫Ô∏è <strong>Read the clues carefully</strong> - they point to geographical features</li>
                        <li>üõ∞Ô∏è Switch to Satellite view to see real imagery</li>
                        <li>‚õ∞Ô∏è Use Terrain or Topographic layers to find mountains</li>
                        <li>üåä Rivers show up well on satellite view</li>
                        <li>üèõÔ∏è Cities are easier to spot with Street or Boundaries layers</li>
                        <li>üîç Zoom in close to find exact locations</li>
                        <li>üéØ Click within 50 miles to count as "found"</li>
                    </ul>
                    <h3>ACHIEVEMENTS:</h3>
                    <ul>
                        <li>üèîÔ∏è <strong>Mountain Master</strong> - Find 5+ mountains</li>
                        <li>üåä <strong>River Runner</strong> - Find 3+ rivers</li>
                        <li>üèûÔ∏è <strong>Park Explorer</strong> - Find 5+ national parks</li>
                        <li>üèõÔ∏è <strong>City Finder</strong> - Find 8+ cities</li>
                        <li>‚ùÑÔ∏è <strong>Alaska Expert</strong> - Complete all 50 locations!</li>
                    </ul>
                    <h3>REWARDS:</h3>
                    <ul>
                        <li>‚≠ê 30 XP per location found</li>
                        <li>üéâ 100 XP bonus per round completed</li>
                        <li>üèÜ 500 XP grand prize for Alaska Expert!</li>
                    </ul>
                    <button class="btn" onclick="closeTutorial()">GOT IT! LET'S EXPLORE ALASKA</button>
                `
            };
            
            document.getElementById('tutorial-content').innerHTML = tutorials[mode];
            document.getElementById('tutorial-overlay').classList.add('active');
        }
        
        window.closeTutorial = function() {
            document.getElementById('tutorial-overlay').classList.remove('active');
        }
        
        // Initialize
        updateAllDisplays();
        renderMissions();
        
        console.log('üïµÔ∏è Geographic Detective Academy initialized!');
        console.log('üéÆ All game modes ready!');
        console.log('üèÜ Mission system active!');
        }); // end DOMContentLoaded
        
        // CRITICAL FIX: Cleanup on page unload to prevent memory leaks
        window.addEventListener('beforeunload', function() {
            stopAllGameTimers();
            cleanupGameMarkers();
            console.log('üßπ Cleaned up all timers and markers');
        });
    </script>
</body>
</html>

