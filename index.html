<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geographic Detective Academy</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #0a0e27;
            color: white;
        }
        
        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 1000;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #header h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .xp-display {
            background: rgba(0,0,0,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #game-modes {
            background: #0f1329;
            padding: 12px 20px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            border-bottom: 3px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .mode-btn {
            background: #1a1f3a;
            color: #aaa;
            border: 2px solid #2a2f4a;
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            transition: all 0.2s;
            position: relative;
        }
        
        .mode-btn:hover {
            background: #2a2f4a;
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .mode-btn.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .mode-btn.locked::after {
            content: "🔒";
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 16px;
        }
        
        #container {
            display: flex;
            height: calc(100vh - 110px);
        }
        
        #map {
            flex: 1;
            height: 100%;
            position: relative;
        }
        
        #sidebar {
            width: 380px;
            background: #0f1329;
            box-shadow: -4px 0 20px rgba(0,0,0,0.5);
            padding: 20px;
            overflow-y: auto;
            z-index: 999;
        }
        
        .game-panel {
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        
        .game-panel.active {
            display: block;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .section {
            background: linear-gradient(135deg, #1a1f3a 0%, #0f1329 100%);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 2px solid #2a2f4a;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .section h2 {
            font-size: 18px;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 15px;
            width: 100%;
            margin-top: 12px;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        .btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #2a2f4a;
            box-shadow: none;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #3a3f5a;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }
        
        .timer {
            font-size: 32px;
            font-weight: 900;
            color: #ffd700;
            text-align: center;
            padding: 16px;
            background: rgba(255, 215, 0, 0.1);
            border: 3px solid #ffd700;
            border-radius: 12px;
            margin: 12px 0;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .timer.warning {
            color: #ff6b6b;
            border-color: #ff6b6b;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .score-display {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            padding: 12px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            margin: 12px 0;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 12px 0;
        }
        
        .stat-box {
            background: rgba(102, 126, 234, 0.1);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .stat-label {
            font-size: 11px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #ffd700;
        }
        
        .progress-bar {
            width: 100%;
            height: 28px;
            background: #1a1f3a;
            border-radius: 14px;
            overflow: hidden;
            margin: 12px 0;
            border: 2px solid #2a2f4a;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 13px;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .challenge-item {
            background: rgba(102, 126, 234, 0.1);
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
            transition: all 0.2s;
        }
        
        .challenge-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }
        
        .challenge-item.completed {
            background: rgba(0, 255, 127, 0.1);
            border-left-color: #00ff7f;
        }
        
        .challenge-item.completed .challenge-text {
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .answer-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 12px 0;
        }
        
        .answer-btn {
            background: #1a1f3a;
            color: white;
            border: 2px solid #2a2f4a;
            padding: 14px 18px;
            border-radius: 10px;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            position: relative;
        }
        
        .answer-btn:hover:not(:disabled) {
            background: #2a2f4a;
            border-color: #667eea;
            transform: translateX(4px);
        }
        
        .answer-btn.correct {
            background: linear-gradient(135deg, #00ff7f 0%, #00d96f 100%);
            color: #000;
            border-color: #00ff7f;
            animation: correctPulse 0.5s;
        }
        
        .answer-btn.incorrect {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            border-color: #ff6b6b;
            animation: shake 0.5s;
        }
        
        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .hint-box {
            background: rgba(255, 215, 0, 0.15);
            border: 2px solid #ffd700;
            padding: 14px;
            border-radius: 10px;
            margin: 12px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .hint-box strong {
            color: #ffd700;
        }
        
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }
        
        .tutorial-overlay.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .tutorial-content {
            background: linear-gradient(135deg, #1a1f3a 0%, #0f1329 100%);
            padding: 32px;
            border-radius: 16px;
            max-width: 600px;
            border: 3px solid #667eea;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .tutorial-content h2 {
            font-size: 28px;
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .tutorial-content h3 {
            font-size: 20px;
            color: #667eea;
            margin: 20px 0 12px 0;
        }
        
        .tutorial-content p, .tutorial-content ul {
            font-size: 15px;
            line-height: 1.8;
            margin-bottom: 16px;
            color: #ddd;
        }
        
        .tutorial-content ul {
            margin-left: 20px;
        }
        
        .tutorial-content li {
            margin-bottom: 8px;
        }
        
        .tutorial-content strong {
            color: #ffd700;
        }
        
        .why-play {
            background: rgba(102, 126, 234, 0.2);
            padding: 16px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin: 16px 0;
        }
        
        .notification {
            position: fixed;
            top: 120px;
            right: 20px;
            background: linear-gradient(135deg, #00ff7f 0%, #00d96f 100%);
            color: #000;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 6px 20px rgba(0, 255, 127, 0.5);
            z-index: 10001;
            display: none;
            animation: slideInRight 0.3s ease-out;
        }
        
        .notification.active {
            display: block;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .coords-display {
            background: #1a1f3a;
            padding: 16px;
            border-radius: 10px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            color: #ffd700;
            border: 2px solid #667eea;
            margin: 12px 0;
            font-family: 'Courier New', monospace;
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background: #1a1f3a;
            border: 2px solid #2a2f4a;
            color: white;
            font-size: 14px;
            margin-top: 8px;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }
        
        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 700;
            margin: 6px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
        }
        
        .badge.locked {
            background: #2a2f4a;
            color: #666;
            box-shadow: none;
        }
        
        #sidebar::-webkit-scrollbar {
            width: 8px;
        }
        
        #sidebar::-webkit-scrollbar-track {
            background: #0f1329;
        }
        
        #sidebar::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        
        #sidebar::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
        
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            
            #sidebar {
                width: 100%;
                height: 350px;
            }
            
            #map {
                height: calc(100vh - 460px);
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>🕵️ GEOGRAPHIC DETECTIVE ACADEMY</h1>
        <div class="xp-display">
            <span>⭐</span>
            <span id="total-xp">0</span>
            <span>XP</span>
        </div>
    </div>
    
    <div id="game-modes">
        <button class="mode-btn active" onclick="switchMode('explore')">🗺️ EXPLORE</button>
        <button class="mode-btn" onclick="switchMode('mystery')">🎯 MYSTERY</button>
        <button class="mode-btn" onclick="switchMode('scavenger')">🌍 SCAVENGER</button>
        <button class="mode-btn" onclick="switchMode('guess')">📸 GUESS</button>
        <button class="mode-btn" onclick="switchMode('missions')">🏆 MISSIONS</button>
        <button class="mode-btn" onclick="switchMode('create')">🗺️ CREATE</button>
    </div>
    
    <div id="container">
        <div id="map"></div>
        
        <div id="sidebar">
            <!-- EXPLORE MODE -->
            <div id="explore-panel" class="game-panel active">
                <div class="section">
                    <h2>🗺️ FREE EXPLORE</h2>
                    <p style="color: #aaa; line-height: 1.6; margin-bottom: 12px;">
                        Click anywhere on the map to see coordinates and location info. Use the layer control (top right) to switch between satellite, terrain, and street views.
                    </p>
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-label">Latitude</div>
                            <div class="stat-value" id="hover-lat">--</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Longitude</div>
                            <div class="stat-value" id="hover-lon">--</div>
                        </div>
                    </div>
                    <div id="location-info" style="color: #aaa; font-size: 14px; margin-top: 12px;">
                        Click on the map to investigate a location
                    </div>
                </div>
                
                <div class="section">
                    <h2>🎮 GAME MODES</h2>
                    <p style="color: #aaa; line-height: 1.6; margin-bottom: 12px;">
                        Choose a game mode above to start earning XP and completing challenges!
                    </p>
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.6; color: #ddd;">
                        <strong style="color: #ffd700;">🎯 MYSTERY:</strong> Find locations from coordinates<br>
                        <strong style="color: #ffd700;">🌍 SCAVENGER:</strong> Complete geographic challenges<br>
                        <strong style="color: #ffd700;">📸 GUESS:</strong> Identify famous landmarks<br>
                        <strong style="color: #ffd700;">🏆 MISSIONS:</strong> Track your progress<br>
                        <strong style="color: #ffd700;">🗺️ CREATE:</strong> Make your own mysteries
                    </div>
                </div>
            </div>
            
            <!-- MYSTERY CHALLENGE MODE -->
            <div id="mystery-panel" class="game-panel">
                <div class="section">
                    <h2>🎯 MYSTERY LOCATION CHALLENGE</h2>
                    
                    <div id="mystery-game" style="display: none;">
                        <div class="timer" id="mystery-timer">60</div>
                        
                        <div class="score-display">
                            Score: <span id="mystery-score">0</span> | Streak: <span id="mystery-streak">0</span> 🔥
                        </div>
                        
                        <div class="coords-display" id="mystery-coords">
                            --
                        </div>
                        
                        <div id="mystery-hints" style="display: none;">
                            <div class="hint-box">
                                <strong>🔍 HINT:</strong> <span id="hint-text"></span>
                            </div>
                        </div>
                        
                        <p style="color: #aaa; text-align: center; margin: 12px 0;">
                            Click on the map where you think these coordinates are!
                        </p>
                        
                        <button class="btn btn-danger" onclick="skipMystery()">⏭️ SKIP (-5 XP)</button>
                    </div>
                    
                    <div id="mystery-intro">
                        <div class="why-play">
                            <strong style="font-size: 16px; color: #ffd700;">WHY PLAY THIS?</strong>
                            <p style="margin-top: 8px; color: #ddd;">
                                Race against time to find mystery locations. Build your streak for massive XP bonuses. Compete with classmates for the highest score!
                            </p>
                        </div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 14px; border-radius: 8px; margin: 12px 0; font-size: 14px; line-height: 1.8; color: #ddd;">
                            <strong style="color: #ffd700;">HOW TO PLAY:</strong><br>
                            1️⃣ You'll see coordinates (like 40.7128°N, 74.0060°W)<br>
                            2️⃣ Find that spot on the map and click it<br>
                            3️⃣ Get it right within 60 seconds to earn XP<br>
                            4️⃣ Hints unlock at 30s and 15s if you need help<br>
                            5️⃣ Build streaks for bonus XP!
                        </div>
                        
                        <button class="btn" onclick="startMysteryGame()">🎮 START MYSTERY CHALLENGE</button>
                        <button class="btn btn-secondary" onclick="showTutorial('mystery')">📖 FULL TUTORIAL</button>
                    </div>
                </div>
                
                <div class="section">
                    <h2>📊 YOUR STATS</h2>
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-label">Total Solved</div>
                            <div class="stat-value" id="mysteries-solved">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Best Streak</div>
                            <div class="stat-value" id="best-streak">0</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SCAVENGER HUNT MODE -->
            <div id="scavenger-panel" class="game-panel">
                <div class="section">
                    <h2>🌍 SCAVENGER HUNT</h2>
                    
                    <div id="scavenger-game" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="scavenger-progress" style="width: 0%">0/10</div>
                        </div>
                        
                        <div id="scavenger-list" style="margin: 16px 0;"></div>
                        
                        <button class="btn btn-secondary" onclick="resetScavenger()">🔄 NEW HUNT</button>
                    </div>
                    
                    <div id="scavenger-intro">
                        <div class="why-play">
                            <strong style="font-size: 16px; color: #ffd700;">WHY PLAY THIS?</strong>
                            <p style="margin-top: 8px; color: #ddd;">
                                Explore the entire world! Find deserts, mountains, oceans, and cities. Unlock achievement badges and become a geography master.
                            </p>
                        </div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 14px; border-radius: 8px; margin: 12px 0; font-size: 14px; line-height: 1.8; color: #ddd;">
                            <strong style="color: #ffd700;">HOW TO PLAY:</strong><br>
                            1️⃣ You'll get 10 challenges (find a desert, find a mountain, etc.)<br>
                            2️⃣ Use map layers to help you find each one<br>
                            3️⃣ Click on the map when you find it<br>
                            4️⃣ Each correct answer = 20 XP<br>
                            5️⃣ Complete all 10 to unlock achievement badges!
                        </div>
                        
                        <button class="btn" onclick="startScavengerGame()">🎮 START SCAVENGER HUNT</button>
                        <button class="btn btn-secondary" onclick="showTutorial('scavenger')">📖 FULL TUTORIAL</button>
                    </div>
                </div>
                
                <div class="section">
                    <h2>🏆 ACHIEVEMENTS</h2>
                    <div id="achievement-badges">
                        <span class="badge locked">🏜️ Desert Explorer</span>
                        <span class="badge locked">⛰️ Mountain Master</span>
                        <span class="badge locked">🌊 Ocean Navigator</span>
                        <span class="badge locked">🏙️ City Finder</span>
                    </div>
                </div>
            </div>
            
            <!-- GUESS LOCATION MODE -->
            <div id="guess-panel" class="game-panel">
                <div class="section">
                    <h2>📸 GUESS THE LOCATION</h2>
                    
                    <div id="guess-game" style="display: none;">
                        <div class="score-display">
                            Round: <span id="guess-round">1</span>/5 | Score: <span id="guess-score">0</span>
                        </div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px; text-align: center; margin: 12px 0;">
                            <strong style="color: #ffd700; font-size: 16px;" id="guess-prompt">Look at the satellite view. Where is this?</strong>
                        </div>
                        
                        <div id="guess-options" class="answer-options"></div>
                        
                        <button class="btn btn-secondary" onclick="nextGuessRound()" id="next-guess-btn" style="display: none;">➡️ NEXT LOCATION</button>
                    </div>
                    
                    <div id="guess-intro">
                        <div class="why-play">
                            <strong style="font-size: 16px; color: #ffd700;">WHY PLAY THIS?</strong>
                            <p style="margin-top: 8px; color: #ddd;">
                                Test your world knowledge! Identify famous landmarks from satellite view. Perfect your visual geography skills and impress your friends.
                            </p>
                        </div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 14px; border-radius: 8px; margin: 12px 0; font-size: 14px; line-height: 1.8; color: #ddd;">
                            <strong style="color: #ffd700;">HOW TO PLAY:</strong><br>
                            1️⃣ The map will zoom to a famous location<br>
                            2️⃣ Look at the satellite/terrain view carefully<br>
                            3️⃣ Choose the correct country from 4 options<br>
                            4️⃣ Earn 30 XP for each correct answer<br>
                            5️⃣ Play 5 rounds per game!
                        </div>
                        
                        <button class="btn" onclick="startGuessGame()">🎮 START GUESS GAME</button>
                        <button class="btn btn-secondary" onclick="showTutorial('guess')">📖 FULL TUTORIAL</button>
                    </div>
                </div>
                
                <div class="section">
                    <h2>📊 YOUR STATS</h2>
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-label">Correct</div>
                            <div class="stat-value" id="guess-correct">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Total Played</div>
                            <div class="stat-value" id="guess-total">0</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- DETECTIVE MISSIONS MODE -->
            <div id="missions-panel" class="game-panel">
                <div class="section">
                    <h2>🏆 DETECTIVE MISSIONS</h2>
                    <p style="color: #aaa; margin-bottom: 16px;">
                        Complete missions to level up your detective skills and earn massive XP rewards!
                    </p>
                    <div id="missions-list"></div>
                </div>
            </div>
            
            <!-- CREATE HEIST MODE -->
            <div id="create-panel" class="game-panel">
                <div class="section">
                    <h2>🗺️ CREATE YOUR OWN HEIST</h2>
                    
                    <div class="why-play" style="margin-bottom: 16px;">
                        <strong style="font-size: 16px; color: #ffd700;">WHY CREATE?</strong>
                        <p style="margin-top: 8px; color: #ddd;">
                            Challenge your classmates! Create tricky mysteries and share them. Earn 50 XP for each heist you create!
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="color: #aaa; font-size: 12px; text-transform: uppercase; font-weight: 600;">Heist Name</label>
                        <input type="text" id="heist-name" class="input-field" placeholder="The Mystery of...">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="color: #aaa; font-size: 12px; text-transform: uppercase; font-weight: 600;">Target Location</label>
                        <div class="coords-display" id="heist-coords" style="font-size: 14px;">
                            Click on map to set location
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="color: #aaa; font-size: 12px; text-transform: uppercase; font-weight: 600;">Clue 1</label>
                        <input type="text" id="clue1" class="input-field" placeholder="Hint about the location...">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="color: #aaa; font-size: 12px; text-transform: uppercase; font-weight: 600;">Clue 2 (Optional)</label>
                        <input type="text" id="clue2" class="input-field" placeholder="Another hint...">
                    </div>
                    
                    <button class="btn" onclick="saveHeist()">💾 SAVE HEIST (+50 XP)</button>
                    <button class="btn btn-secondary" onclick="loadHeists()">📂 VIEW SAVED HEISTS</button>
                </div>
                
                <div class="section" id="saved-heists-section" style="display: none;">
                    <h2>📂 YOUR HEISTS</h2>
                    <div id="saved-heists-list"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay" class="tutorial-overlay">
        <div class="tutorial-content" id="tutorial-content">
            <!-- Tutorial content will be inserted here -->
        </div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    
    <script>
        // Initialize map
        const map = L.map('map', {
            preferCanvas: true,
            zoomControl: true
        }).setView([20, 0], 2);
        
        // BASE LAYERS (Choose ONE)
        const streetMapEnglish = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd'
        });
        
        const streetMapLocal = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap'
        });
        
        const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Tiles &copy; Esri'
        });
        
        const topoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 17,
            attribution: '&copy; OpenStreetMap, SRTM'
        });
        
        const terrainMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 13,
            attribution: 'Tiles &copy; Esri'
        });
        
        const physicalMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 8,
            attribution: 'Tiles &copy; Esri'
        });
        
        const darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd'
        });
        
        const watercolorMap = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_watercolor/{z}/{x}/{y}.jpg', {
            maxZoom: 16,
            attribution: '&copy; Stamen Design &copy; OpenStreetMap'
        });
        
        const oceanBaseMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 16,
            attribution: 'Ocean Base &copy; Esri'
        });
        
        const natGeoMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 16,
            attribution: 'National Geographic &copy; Esri'
        });
        
        const terrainBaseMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 13,
            attribution: 'Terrain &copy; Esri'
        });
        
        // OVERLAY LAYERS (Toggle ON/OFF)
        const englishLabelsOverlay = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            subdomains: 'abcd',
            opacity: 1.0
        });
        
        const boundariesOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Boundaries &copy; Esri',
            opacity: 0.7
        });
        
        const transportOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Transport &copy; Esri',
            opacity: 0.7
        });
        
        const hillshadeOverlay = L.tileLayer('https://tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Hillshading: OpenTopoMap',
            opacity: 0.5
        });
        
        const railwayOverlay = L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Railway: OpenRailwayMap',
            opacity: 0.7
        });
        
        const oceanReferenceOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Reference/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 16,
            attribution: 'Ocean Reference &copy; Esri',
            opacity: 0.8
        });
        
        const worldReferenceOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Reference &copy; Esri',
            opacity: 0.7
        });
        
        const lightGrayReferenceOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 16,
            attribution: 'Reference &copy; Esri',
            opacity: 0.8
        });
        
        const watercolorLabelsOverlay = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_terrain_labels/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; Stamen Design',
            opacity: 1.0
        });
        
        streetMapEnglish.addTo(map);
        
        const baseMaps = {
            "🗺️ Street (English) ⭐": streetMapEnglish,
            "🗺️ Street (Local Language)": streetMapLocal,
            "🛰️ Satellite": satelliteMap,
            "⛰️ Topographic": topoMap,
            "🏔️ Terrain Relief": terrainMap,
            "🌍 Physical Map": physicalMap,
            "🌊 Ocean Base": oceanBaseMap,
            "🌎 National Geographic": natGeoMap,
            "🎨 Watercolor": watercolorMap,
            "🏞️ Terrain Base": terrainBaseMap,
            "🌙 Dark Mode": darkMap
        };
        
        const overlayMaps = {
            "🔤 English Labels": englishLabelsOverlay,
            "🏛️ Boundaries & Places": boundariesOverlay,
            "📝 World Reference (All Labels)": worldReferenceOverlay,
            "📊 Light Gray Labels": lightGrayReferenceOverlay,
            "🚗 Transportation": transportOverlay,
            "🚂 Railways": railwayOverlay,
            "⛰️ Hillshade": hillshadeOverlay,
            "🌊 Ocean Features & Names": oceanReferenceOverlay,
            "🎨 Terrain Labels": watercolorLabelsOverlay
        };
        
        L.control.layers(baseMaps, overlayMaps, {
            collapsed: true,
            position: 'topright'
        }).addTo(map);
        
        L.control.scale({
            imperial: true,
            metric: true
        }).addTo(map);
        
        // Game state
        let gameState = {
            totalXP: 0,
            currentMode: 'explore',
            mystery: {
                score: 0,
                streak: 0,
                bestStreak: 0,
                solved: 0,
                current: null,
                timer: null,
                active: false
            },
            scavenger: {
                challenges: [],
                completed: 0,
                active: false
            },
            guess: {
                score: 0,
                correct: 0,
                total: 0,
                round: 0,
                current: null,
                active: false
            },
            missions: [
                { id: 1, name: "Master Coordinates", desc: "Complete 10 Mystery Challenges", progress: 0, target: 10, xp: 100 },
                { id: 2, name: "Terrain Expert", desc: "Complete a Scavenger Hunt", progress: 0, target: 1, xp: 150 },
                { id: 3, name: "Visual Detective", desc: "Get 5 correct in Guess Game", progress: 0, target: 5, xp: 200 },
                { id: 4, name: "Master Creator", desc: "Create 3 heists", progress: 0, target: 3, xp: 250 }
            ],
            heists: []
        };
        
        // Load saved state
        if (localStorage.getItem('geoDetectiveState')) {
            const saved = JSON.parse(localStorage.getItem('geoDetectiveState'));
            gameState = { ...gameState, ...saved };
            updateAllDisplays();
        }
        
        // Save state
        function saveState() {
            localStorage.setItem('geoDetectiveState', JSON.stringify(gameState));
        }
        
        // Add XP with notification
        function addXP(amount, reason) {
            gameState.totalXP += amount;
            document.getElementById('total-xp').textContent = gameState.totalXP;
            showNotification(`+${amount} XP! ${reason}`);
            saveState();
        }
        
        // Show notification
        function showNotification(message) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.classList.add('active');
            setTimeout(() => {
                notif.classList.remove('active');
            }, 2000);
        }
        
        // Update all displays
        function updateAllDisplays() {
            document.getElementById('total-xp').textContent = gameState.totalXP;
            document.getElementById('mystery-score').textContent = gameState.mystery.score;
            document.getElementById('mystery-streak').textContent = gameState.mystery.streak;
            document.getElementById('best-streak').textContent = gameState.mystery.bestStreak;
            document.getElementById('mysteries-solved').textContent = gameState.mystery.solved;
            document.getElementById('guess-score').textContent = gameState.guess.score;
            document.getElementById('guess-correct').textContent = gameState.guess.correct;
            document.getElementById('guess-total').textContent = gameState.guess.total;
        }
        
        // Switch mode
        function switchMode(mode) {
            gameState.currentMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.game-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(mode + '-panel').classList.add('active');
            
            if (mode === 'missions') {
                renderMissions();
            }
        }
        
        // Format coordinates
        function formatCoord(value, isLat) {
            const dir = isLat ? (value >= 0 ? 'N' : 'S') : (value >= 0 ? 'E' : 'W');
            return `${Math.abs(value).toFixed(4)}° ${dir}`;
        }
        
        // Mouse move
        map.on('mousemove', function(e) {
            document.getElementById('hover-lat').textContent = formatCoord(e.latlng.lat, true);
            document.getElementById('hover-lon').textContent = formatCoord(e.latlng.lng, false);
        });
        
        // Click handler
        let currentMarker = null;
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            
            if (gameState.mystery.active) {
                checkMysteryAnswer(lat, lon);
            } else if (gameState.scavenger.active) {
                checkScavengerAnswer(lat, lon);
            } else if (gameState.currentMode === 'create') {
                setHeistLocation(lat, lon);
            } else {
                showLocationInfo(lat, lon);
            }
        });
        
        async function showLocationInfo(lat, lon) {
            if (currentMarker) map.removeLayer(currentMarker);
            currentMarker = L.marker([lat, lon]).addTo(map);
            
            document.getElementById('location-info').innerHTML = 'Loading...';
            
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1&accept-language=en`,
                    { headers: { 'User-Agent': 'Geographic Detective Academy' } }
                );
                const data = await response.json();
                const addr = data.address || {};
                
                let info = `<strong>${formatCoord(lat, true)}, ${formatCoord(lon, false)}</strong><br>`;
                if (addr.city || addr.town) info += `${addr.city || addr.town}, `;
                if (addr.country) info += addr.country;
                
                document.getElementById('location-info').innerHTML = info;
            } catch (error) {
                document.getElementById('location-info').innerHTML = 'Error loading location';
            }
        }
        
        // MYSTERY CHALLENGE
        const mysteryLocations = [
            { lat: 40.7128, lon: -74.0060, name: "New York City", hint: "Major US city, financial capital", continent: "North America", zoom: 10 },
            { lat: 51.5074, lon: -0.1278, name: "London", hint: "UK capital, River Thames", continent: "Europe", zoom: 10 },
            { lat: 35.6762, lon: 139.6503, name: "Tokyo", hint: "Japan's capital, largest metro area", continent: "Asia", zoom: 10 },
            { lat: -33.8688, lon: 151.2093, name: "Sydney", hint: "Famous harbor, Opera House", continent: "Australia", zoom: 10 },
            { lat: 48.8566, lon: 2.3522, name: "Paris", hint: "City of Light, Eiffel Tower", continent: "Europe", zoom: 10 },
            { lat: 55.7558, lon: 37.6173, name: "Moscow", hint: "Russia's capital, Red Square", continent: "Europe", zoom: 10 },
            { lat: -23.5505, lon: -46.6333, name: "São Paulo", hint: "Largest city in South America", continent: "South America", zoom: 10 },
            { lat: 30.0444, lon: 31.2357, name: "Cairo", hint: "Ancient capital, pyramids nearby", continent: "Africa", zoom: 10 },
            { lat: 19.4326, lon: -99.1332, name: "Mexico City", hint: "Aztec heritage, high altitude", continent: "North America", zoom: 10 },
            { lat: 1.3521, lon: 103.8198, name: "Singapore", hint: "Island city-state, Southeast Asia", continent: "Asia", zoom: 11 }
        ];
        
        function startMysteryGame() {
            document.getElementById('mystery-intro').style.display = 'none';
            document.getElementById('mystery-game').style.display = 'block';
            gameState.mystery.active = true;
            startMystery();
        }
        
        function startMystery() {
            if (gameState.mystery.timer) clearInterval(gameState.mystery.timer);
            
            gameState.mystery.current = mysteryLocations[Math.floor(Math.random() * mysteryLocations.length)];
            
            document.getElementById('mystery-coords').textContent = 
                `${formatCoord(gameState.mystery.current.lat, true)}, ${formatCoord(gameState.mystery.current.lon, false)}`;
            
            document.getElementById('mystery-hints').style.display = 'none';
            
            let timeLeft = 60;
            const timerEl = document.getElementById('mystery-timer');
            timerEl.textContent = timeLeft;
            timerEl.classList.remove('warning');
            
            gameState.mystery.timer = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                
                if (timeLeft <= 10) {
                    timerEl.classList.add('warning');
                }
                
                if (timeLeft === 30) {
                    document.getElementById('mystery-hints').style.display = 'block';
                    document.getElementById('hint-text').textContent = `Continent: ${gameState.mystery.current.continent}`;
                }
                
                if (timeLeft === 15) {
                    document.getElementById('hint-text').textContent = gameState.mystery.current.hint;
                }
                
                if (timeLeft <= 0) {
                    clearInterval(gameState.mystery.timer);
                    showNotification('⏰ Time\'s up! Streak reset.');
                    gameState.mystery.streak = 0;
                    updateAllDisplays();
                    startMystery();
                }
            }, 1000);
        }
        
        function checkMysteryAnswer(lat, lon) {
            if (!gameState.mystery.current) return;
            
            const distance = Math.sqrt(
                Math.pow((lat - gameState.mystery.current.lat) * 111, 2) + 
                Math.pow((lon - gameState.mystery.current.lon) * 111 * Math.cos(lat * Math.PI / 180), 2)
            );
            
            if (distance < 500) { // Within 500km
                clearInterval(gameState.mystery.timer);
                const baseXP = 50;
                const streakBonus = gameState.mystery.streak * 10;
                const totalXP = baseXP + streakBonus;
                
                addXP(totalXP, `Correct! ${gameState.mystery.current.name}`);
                gameState.mystery.score += totalXP;
                gameState.mystery.streak++;
                gameState.mystery.solved++;
                
                if (gameState.mystery.streak > gameState.mystery.bestStreak) {
                    gameState.mystery.bestStreak = gameState.mystery.streak;
                }
                
                // Update mission progress
                gameState.missions[0].progress++;
                
                updateAllDisplays();
                saveState();
                
                setTimeout(() => startMystery(), 1500);
            } else {
                showNotification('❌ Not quite! Keep trying!');
            }
        }
        
        function skipMystery() {
            if (!gameState.mystery.current) return;
            clearInterval(gameState.mystery.timer);
            addXP(-5, 'Mystery skipped');
            gameState.mystery.streak = 0;
            updateAllDisplays();
            startMystery();
        }
        
        // SCAVENGER HUNT
        const scavengerChallenges = [
            { desc: "Find the Sahara Desert", lat: 23.4162, lon: 25.6628, tolerance: 1000, type: "desert" },
            { desc: "Find Mount Everest", lat: 27.9881, lon: 86.9250, tolerance: 200, type: "mountain" },
            { desc: "Find the Amazon River", lat: -3.4653, lon: -62.2159, tolerance: 500, type: "river" },
            { desc: "Find Paris, France", lat: 48.8566, lon: 2.3522, tolerance: 100, type: "city" },
            { desc: "Find the Great Barrier Reef", lat: -18.2871, lon: 147.6992, tolerance: 300, type: "reef" },
            { desc: "Find Tokyo, Japan", lat: 35.6762, lon: 139.6503, tolerance: 100, type: "city" },
            { desc: "Find the Grand Canyon", lat: 36.1069, lon: -112.1129, tolerance: 200, type: "canyon" },
            { desc: "Find the Nile River", lat: 26.8206, lon: 30.8025, tolerance: 500, type: "river" },
            { desc: "Find Antarctica", lat: -82.8628, lon: 135.0000, tolerance: 2000, type: "continent" },
            { desc: "Find the Great Wall of China", lat: 40.4319, lon: 116.5704, tolerance: 200, type: "landmark" }
        ];
        
        function startScavengerGame() {
            document.getElementById('scavenger-intro').style.display = 'none';
            document.getElementById('scavenger-game').style.display = 'block';
            gameState.scavenger.active = true;
            gameState.scavenger.challenges = scavengerChallenges.map(c => ({ ...c, completed: false }));
            gameState.scavenger.completed = 0;
            renderScavengerList();
        }
        
        function renderScavengerList() {
            const html = gameState.scavenger.challenges.map((c, idx) => `
                <div class="challenge-item ${c.completed ? 'completed' : ''}">
                    <span class="challenge-text">${c.completed ? '✅' : '⭕'} ${c.desc}</span>
                    ${c.completed ? '<span style="color: #00ff7f; font-weight: 700;">+20 XP</span>' : ''}
                </div>
            `).join('');
            document.getElementById('scavenger-list').innerHTML = html;
            
            const progress = (gameState.scavenger.completed / gameState.scavenger.challenges.length) * 100;
            document.getElementById('scavenger-progress').style.width = progress + '%';
            document.getElementById('scavenger-progress').textContent = 
                `${gameState.scavenger.completed}/${gameState.scavenger.challenges.length}`;
        }
        
        function checkScavengerAnswer(lat, lon) {
            for (let i = 0; i < gameState.scavenger.challenges.length; i++) {
                const c = gameState.scavenger.challenges[i];
                if (c.completed) continue;
                
                const distance = Math.sqrt(
                    Math.pow((lat - c.lat) * 111, 2) + 
                    Math.pow((lon - c.lon) * 111 * Math.cos(lat * Math.PI / 180), 2)
                );
                
                if (distance < c.tolerance) {
                    c.completed = true;
                    gameState.scavenger.completed++;
                    addXP(20, c.desc + ' found!');
                    renderScavengerList();
                    
                    if (gameState.scavenger.completed === gameState.scavenger.challenges.length) {
                        addXP(100, 'Scavenger Hunt Complete!');
                        gameState.missions[1].progress = 1;
                        saveState();
                    }
                    return;
                }
            }
            
            showNotification('❌ Not quite! Try another location.');
        }
        
        function resetScavenger() {
            gameState.scavenger.challenges = scavengerChallenges.map(c => ({ ...c, completed: false }));
            gameState.scavenger.completed = 0;
            renderScavengerList();
        }
        
        // GUESS GAME
        const guessLocations = [
            { lat: 27.1751, lon: 78.0421, name: "Taj Mahal", country: "India", zoom: 15, options: ["India", "Pakistan", "Bangladesh", "Nepal"] },
            { lat: 41.8902, lon: 12.4922, name: "Colosseum", country: "Italy", zoom: 16, options: ["Italy", "Greece", "Spain", "France"] },
            { lat: -13.1631, lon: -72.5450, name: "Machu Picchu", country: "Peru", zoom: 14, options: ["Peru", "Chile", "Bolivia", "Ecuador"] },
            { lat: 29.9792, lon: 31.1342, name: "Pyramids of Giza", country: "Egypt", zoom: 15, options: ["Egypt", "Sudan", "Libya", "Tunisia"] },
            { lat: -22.9519, lon: -43.2105, name: "Christ the Redeemer", country: "Brazil", zoom: 15, options: ["Brazil", "Argentina", "Colombia", "Venezuela"] },
            { lat: 40.6892, lon: -74.0445, name: "Statue of Liberty", country: "USA", zoom: 16, options: ["USA", "Canada", "France", "UK"] },
            { lat: 25.1972, lon: 55.2744, name: "Burj Khalifa", country: "UAE", zoom: 16, options: ["UAE", "Saudi Arabia", "Qatar", "Kuwait"] },
            { lat: -25.3444, lon: 131.0369, name: "Uluru", country: "Australia", zoom: 13, options: ["Australia", "New Zealand", "South Africa", "Namibia"] },
            { lat: 43.7230, lon: 10.3966, name: "Leaning Tower of Pisa", country: "Italy", zoom: 17, options: ["Italy", "France", "Spain", "Greece"] },
            { lat: 51.1789, lon: -1.8262, name: "Stonehenge", country: "UK", zoom: 16, options: ["UK", "Ireland", "France", "Germany"] }
        ];
        
        function startGuessGame() {
            document.getElementById('guess-intro').style.display = 'none';
            document.getElementById('guess-game').style.display = 'block';
            gameState.guess.active = true;
            gameState.guess.round = 0;
            gameState.guess.score = 0;
            document.getElementById('guess-score').textContent = '0';
            nextGuessRound();
        }
        
        function nextGuessRound() {
            if (gameState.guess.round >= 5) {
                gameState.guess.active = false;
                addXP(50, 'Guess Game Complete!');
                document.getElementById('guess-intro').style.display = 'block';
                document.getElementById('guess-game').style.display = 'none';
                return;
            }
            
            gameState.guess.round++;
            gameState.guess.current = guessLocations[Math.floor(Math.random() * guessLocations.length)];
            
            document.getElementById('guess-round').textContent = gameState.guess.round;
            document.getElementById('next-guess-btn').style.display = 'none';
            
            map.setView([gameState.guess.current.lat, gameState.guess.current.lon], gameState.guess.current.zoom);
            
            const optionsHtml = gameState.guess.current.options.map(option => 
                `<button class="answer-btn" onclick="checkGuess('${option}')">${option}</button>`
            ).join('');
            document.getElementById('guess-options').innerHTML = optionsHtml;
        }
        
        function checkGuess(answer) {
            if (!gameState.guess.current) return;
            
            const buttons = document.querySelectorAll('#guess-options .answer-btn');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === gameState.guess.current.country) {
                    btn.classList.add('correct');
                } else if (btn.textContent === answer) {
                    btn.classList.add('incorrect');
                }
            });
            
            if (answer === gameState.guess.current.country) {
                addXP(30, 'Correct!');
                gameState.guess.score += 30;
                gameState.guess.correct++;
                gameState.missions[2].progress++;
                document.getElementById('guess-score').textContent = gameState.guess.score;
            }
            
            gameState.guess.total++;
            updateAllDisplays();
            saveState();
            
            document.getElementById('next-guess-btn').style.display = 'block';
        }
        
        // MISSIONS
        function renderMissions() {
            const html = gameState.missions.map(m => {
                const progress = Math.min((m.progress / m.target) * 100, 100);
                const isComplete = m.progress >= m.target;
                return `
                    <div class="section" style="margin-bottom: 12px;">
                        <h3 style="color: ${isComplete ? '#00ff7f' : '#ffd700'}; font-size: 16px; margin-bottom: 8px;">
                            ${isComplete ? '✅' : '🎯'} ${m.name}
                        </h3>
                        <p style="color: #aaa; font-size: 13px; margin-bottom: 10px;">${m.desc}</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%">${m.progress}/${m.target}</div>
                        </div>
                        <div style="text-align: right; margin-top: 8px; color: ${isComplete ? '#00ff7f' : '#ffd700'}; font-weight: 700;">
                            ${isComplete ? 'COMPLETE!' : `Reward: ${m.xp} XP`}
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('missions-list').innerHTML = html;
        }
        
        // CREATE HEIST
        let heistLocation = null;
        
        function setHeistLocation(lat, lon) {
            heistLocation = { lat, lon };
            document.getElementById('heist-coords').textContent = `${formatCoord(lat, true)}, ${formatCoord(lon, false)}`;
            if (currentMarker) map.removeLayer(currentMarker);
            currentMarker = L.marker([lat, lon]).addTo(map);
        }
        
        function saveHeist() {
            const name = document.getElementById('heist-name').value;
            const clue1 = document.getElementById('clue1').value;
            const clue2 = document.getElementById('clue2').value;
            
            if (!name || !heistLocation || !clue1) {
                showNotification('⚠️ Fill in name, location, and clue 1!');
                return;
            }
            
            const heist = {
                id: Date.now(),
                name,
                location: heistLocation,
                clues: [clue1, clue2].filter(c => c),
                created: new Date().toLocaleDateString()
            };
            
            gameState.heists.push(heist);
            gameState.missions[3].progress++;
            addXP(50, 'Heist created!');
            saveState();
            
            document.getElementById('heist-name').value = '';
            document.getElementById('clue1').value = '';
            document.getElementById('clue2').value = '';
            document.getElementById('heist-coords').textContent = 'Click on map to set location';
            heistLocation = null;
            if (currentMarker) map.removeLayer(currentMarker);
        }
        
        function loadHeists() {
            if (gameState.heists.length === 0) {
                showNotification('No saved heists yet!');
                return;
            }
            
            const html = gameState.heists.map(h => `
                <div class="challenge-item">
                    <div>
                        <strong style="color: #ffd700;">${h.name}</strong><br>
                        <span style="font-size: 12px; color: #aaa;">Created: ${h.created}</span>
                    </div>
                    <button class="btn" style="width: auto; padding: 8px 16px; margin: 0;" onclick="viewHeist(${h.id})">VIEW</button>
                </div>
            `).join('');
            
            document.getElementById('saved-heists-list').innerHTML = html;
            document.getElementById('saved-heists-section').style.display = 'block';
        }
        
        function viewHeist(id) {
            const heist = gameState.heists.find(h => h.id === id);
            if (!heist) return;
            
            map.setView([heist.location.lat, heist.location.lon], 10);
            if (currentMarker) map.removeLayer(currentMarker);
            currentMarker = L.marker([heist.location.lat, heist.location.lon]).addTo(map);
            
            showNotification(`📍 ${heist.name}`);
        }
        
        // TUTORIALS
        function showTutorial(mode) {
            const tutorials = {
                mystery: `
                    <h2>🎯 MYSTERY CHALLENGE TUTORIAL</h2>
                    <div class="why-play">
                        <strong>WHY PLAY THIS?</strong>
                        <p>Master coordinate reading while racing against time. Build massive streaks for huge XP bonuses. Compete with friends for the highest score!</p>
                    </div>
                    <h3>HOW TO PLAY:</h3>
                    <ul>
                        <li><strong>Step 1:</strong> Click "START MYSTERY CHALLENGE"</li>
                        <li><strong>Step 2:</strong> You'll see coordinates like <code>40.7128°N, 74.0060°W</code></li>
                        <li><strong>Step 3:</strong> Find that location on the map and click it</li>
                        <li><strong>Step 4:</strong> You have 60 seconds - hints unlock at 30s and 15s</li>
                        <li><strong>Step 5:</strong> Get it right to earn XP and build your streak!</li>
                    </ul>
                    <h3>TIPS:</h3>
                    <ul>
                        <li>🧭 Use the coordinates to narrow down the region first</li>
                        <li>🗺️ Switch map layers to see terrain/satellite views</li>
                        <li>🔥 Build streaks for bonus XP (each streak adds +10 XP)</li>
                        <li>⏱️ Don't wait for hints - faster = more practice!</li>
                    </ul>
                    <button class="btn" onclick="closeTutorial()">GOT IT! LET'S PLAY</button>
                `,
                scavenger: `
                    <h2>🌍 SCAVENGER HUNT TUTORIAL</h2>
                    <div class="why-play">
                        <strong>WHY PLAY THIS?</strong>
                        <p>Explore the entire world! Learn where major geographic features are located. Unlock achievement badges and become a geography expert!</p>
                    </div>
                    <h3>HOW TO PLAY:</h3>
                    <ul>
                        <li><strong>Step 1:</strong> Click "START SCAVENGER HUNT"</li>
                        <li><strong>Step 2:</strong> You'll get 10 challenges (find deserts, mountains, cities, etc.)</li>
                        <li><strong>Step 3:</strong> Use different map layers to help you find each one</li>
                        <li><strong>Step 4:</strong> Click on the map when you think you found it</li>
                        <li><strong>Step 5:</strong> Each correct answer = 20 XP!</li>
                    </ul>
                    <h3>TIPS:</h3>
                    <ul>
                        <li>🛰️ Use Satellite view to see terrain features</li>
                        <li>⛰️ Use Topographic view to find mountains</li>
                        <li>🏙️ Use Street view to find cities</li>
                        <li>🌍 Zoom out to see continents, zoom in for precision</li>
                    </ul>
                    <button class="btn" onclick="closeTutorial()">GOT IT! LET'S HUNT</button>
                `,
                guess: `
                    <h2>📸 GUESS THE LOCATION TUTORIAL</h2>
                    <div class="why-play">
                        <strong>WHY PLAY THIS?</strong>
                        <p>Test your world knowledge! Identify famous landmarks from satellite view. Perfect your visual geography skills and impress everyone!</p>
                    </div>
                    <h3>HOW TO PLAY:</h3>
                    <ul>
                        <li><strong>Step 1:</strong> Click "START GUESS GAME"</li>
                        <li><strong>Step 2:</strong> The map zooms to a famous location</li>
                        <li><strong>Step 3:</strong> Look at the satellite/terrain view carefully</li>
                        <li><strong>Step 4:</strong> Choose the correct country from 4 options</li>
                        <li><strong>Step 5:</strong> Earn 30 XP for each correct answer!</li>
                    </ul>
                    <h3>TIPS:</h3>
                    <ul>
                        <li>👀 Look for distinctive features (rivers, coastlines, deserts)</li>
                        <li>🗺️ Try switching to Terrain view for elevation clues</li>
                        <li>🏛️ Famous landmarks have unique shapes from above</li>
                        <li>🌍 Use continent knowledge to eliminate wrong answers</li>
                    </ul>
                    <button class="btn" onclick="closeTutorial()">GOT IT! LET'S GUESS</button>
                `
            };
            
            document.getElementById('tutorial-content').innerHTML = tutorials[mode];
            document.getElementById('tutorial-overlay').classList.add('active');
        }
        
        function closeTutorial() {
            document.getElementById('tutorial-overlay').classList.remove('active');
        }
        
        // Initialize
        updateAllDisplays();
        renderMissions();
        
        console.log('🕵️ Geographic Detective Academy initialized!');
        console.log('🎮 All game modes ready!');
        console.log('🏆 Mission system active!');
    </script>
</body>
</html>

