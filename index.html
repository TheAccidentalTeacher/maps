<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Geography Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f0f0f0;
        }
        
        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            position: relative;
        }
        
        #header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        #header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        #container {
            display: flex;
            height: calc(100vh - 85px);
        }
        
        #map {
            flex: 1;
            height: 100%;
        }
        
        #sidebar {
            width: 320px;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-y: auto;
            z-index: 999;
        }
        
        .info-section {
            margin-bottom: 25px;
        }
        
        .info-section h2 {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }
        
        .info-item {
            margin-bottom: 12px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .info-item:hover {
            background: #e9ecef;
        }
        
        .info-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .coordinates-display {
            display: flex;
            gap: 10px;
        }
        
        .coord-box {
            flex: 1;
        }
        
        #instructions {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.6;
            color: #856404;
        }
        
        #instructions strong {
            display: block;
            margin-bottom: 8px;
            color: #533f03;
        }
        
        #instructions ul {
            margin-left: 20px;
            margin-top: 8px;
        }
        
        #instructions li {
            margin-bottom: 4px;
        }
        
        .loading {
            color: #667eea;
            font-style: italic;
        }
        
        .error {
            color: #dc3545;
            font-size: 12px;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.2);
        }
        
        .leaflet-popup-content {
            margin: 15px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        .popup-title {
            font-weight: 600;
            font-size: 14px;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .popup-coords {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .popup-location {
            font-size: 13px;
            color: #333;
            line-height: 1.4;
        }
        
        /* Enhanced layer control styling */
        .leaflet-control-layers {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            padding: 10px;
        }
        
        .leaflet-control-layers-expanded {
            padding: 15px;
            background: white;
        }
        
        .leaflet-control-layers-separator {
            margin: 8px 0;
            border-top: 1px solid #ddd;
        }
        
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            
            #sidebar {
                width: 100%;
                height: 250px;
            }
            
            #map {
                height: calc(100vh - 335px);
            }
        }
        
        /* Custom scrollbar for sidebar */
        #sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        #sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        #sidebar::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }
        
        #sidebar::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>üåç Interactive Geography Map</h1>
        <p>Move your mouse to see coordinates ‚Ä¢ Click to explore locations ‚Ä¢ All labels available in English!</p>
    </div>
    
    <div id="container">
        <div id="map"></div>
        
        <div id="sidebar">
            <div class="info-section">
                <h2>üñ±Ô∏è Live Coordinates</h2>
                <div class="coordinates-display">
                    <div class="coord-box">
                        <div class="info-item">
                            <div class="info-label">Latitude</div>
                            <div class="info-value" id="hover-latitude">Move mouse over map</div>
                        </div>
                    </div>
                    <div class="coord-box">
                        <div class="info-item">
                            <div class="info-label">Longitude</div>
                            <div class="info-value" id="hover-longitude">--</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="info-section">
                <h2>üìç Clicked Location</h2>
                <div id="location-info">
                    <div class="info-item">
                        <div class="info-label">Click on the map to see location details</div>
                    </div>
                </div>
            </div>
            
            <div class="info-section">
                <h2>üó∫Ô∏è Clicked Coordinates</h2>
                <div class="coordinates-display">
                    <div class="coord-box">
                        <div class="info-item">
                            <div class="info-label">Latitude</div>
                            <div class="info-value" id="latitude">--</div>
                        </div>
                    </div>
                    <div class="coord-box">
                        <div class="info-item">
                            <div class="info-label">Longitude</div>
                            <div class="info-value" id="longitude">--</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="info-section">
                <h2>‚ÑπÔ∏è Instructions</h2>
                <div id="instructions">
                    <strong>How to use:</strong>
                    <ul>
                        <li>Move your mouse to see live coordinates</li>
                        <li>Click anywhere to get location details</li>
                        <li>Use layer control (top right) to switch maps</li>
                        <li><strong>For English labels: Choose "Street (English)" or toggle "English Labels" overlay</strong></li>
                        <li>Use touchpad to pan around the map</li>
                        <li>Scroll to zoom in and out</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    
    <script>
        // Initialize the map centered on a default location (world view)
        const map = L.map('map', {
            preferCanvas: true,  // Use canvas for better performance
            zoomControl: true
        }).setView([20, 0], 2);
        
        // Define different BASE tile layers with optimized settings
        
        // ENGLISH LABELS VERSION - Uses CartoDB which shows English names worldwide
        const streetMapEnglish = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            updateWhenIdle: false,
            keepBuffer: 2
        });
        
        // Standard OpenStreetMap (shows local language names)
        const streetMap = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            updateWhenIdle: false,
            keepBuffer: 2
        });
        
        const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Tiles &copy; Esri',
            updateWhenIdle: false,
            keepBuffer: 2
        });
        
        const topoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 17,
            attribution: 'Map data: &copy; <a href="https://openstreetmap.org">OpenStreetMap</a>, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>',
            updateWhenIdle: false,
            keepBuffer: 2
        });
        
        const terrainMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 13,
            attribution: 'Tiles &copy; Esri',
            updateWhenIdle: false,
            keepBuffer: 2
        });
        
        const physicalMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 8,
            attribution: 'Tiles &copy; Esri',
            updateWhenIdle: false,
            keepBuffer: 2
        });
        
        // Define OVERLAY layers (can be toggled on/off)
        
        // ENGLISH LABELS OVERLAY - Can be added to any base map
        const englishLabelsOverlay = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            opacity: 1.0
        });
        
        const boundariesOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Boundaries &copy; Esri',
            opacity: 0.7
        });
        
        const transportOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Transport &copy; Esri',
            opacity: 0.7
        });
        
        const hillshadeOverlay = L.tileLayer('https://tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Hillshading: <a href="https://github.com/der-stefan/OpenTopoMap">OpenTopoMap</a>',
            opacity: 0.5
        });
        
        const railwayOverlay = L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Railway: <a href="https://www.openrailwaymap.org/">OpenRailwayMap</a>',
            opacity: 0.7
        });
        
        // Add default layer (English street map)
        streetMapEnglish.addTo(map);
        
        // Create base layers object for layer control
        const baseMaps = {
            "üó∫Ô∏è Street (English) ‚≠ê": streetMapEnglish,
            "üó∫Ô∏è Street (Local Language)": streetMap,
            "üõ∞Ô∏è Satellite": satelliteMap,
            "‚õ∞Ô∏è Topographic": topoMap,
            "üèîÔ∏è Terrain Relief": terrainMap,
            "üåç Physical": physicalMap
        };
        
        // Create overlay layers object
        const overlayMaps = {
            "üî§ English Labels (for Satellite/Terrain)": englishLabelsOverlay,
            "üèõÔ∏è Boundaries & Places": boundariesOverlay,
            "üöó Transportation": transportOverlay,
            "‚õ∞Ô∏è Hillshade": hillshadeOverlay,
            "üöÇ Railways": railwayOverlay
        };
        
        // Add layer control to map with both base maps and overlays
        L.control.layers(baseMaps, overlayMaps, {
            collapsed: false,
            position: 'topright'
        }).addTo(map);
        
        // Variable to store the current marker
        let currentMarker = null;
        
        // Cache for geocoding results to reduce API calls
        const geocodeCache = new Map();
        
        // Throttle mechanism for API calls
        let lastApiCall = 0;
        const API_THROTTLE_MS = 1000; // 1 second between calls
        
        // Function to format coordinates
        function formatCoordinate(value, isLat) {
            const direction = isLat ? (value >= 0 ? 'N' : 'S') : (value >= 0 ? 'E' : 'W');
            return `${Math.abs(value).toFixed(6)}¬∞ ${direction}`;
        }
        
        // Update hover coordinates as mouse moves
        map.on('mousemove', function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            
            document.getElementById('hover-latitude').textContent = formatCoordinate(lat, true);
            document.getElementById('hover-longitude').textContent = formatCoordinate(lon, false);
        });
        
        // Clear hover coordinates when mouse leaves map
        map.on('mouseout', function() {
            document.getElementById('hover-latitude').textContent = 'Move mouse over map';
            document.getElementById('hover-longitude').textContent = '--';
        });
        
        // Function to get location name from coordinates using Nominatim
        async function getLocationName(lat, lon) {
            // Create cache key
            const cacheKey = `${lat.toFixed(4)},${lon.toFixed(4)}`;
            
            // Check cache first
            if (geocodeCache.has(cacheKey)) {
                return geocodeCache.get(cacheKey);
            }
            
            // Throttle API calls
            const now = Date.now();
            const timeSinceLastCall = now - lastApiCall;
            if (timeSinceLastCall < API_THROTTLE_MS) {
                await new Promise(resolve => setTimeout(resolve, API_THROTTLE_MS - timeSinceLastCall));
            }
            
            try {
                // Request with accept-language=en to get English names
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1&accept-language=en`,
                    {
                        headers: {
                            'User-Agent': 'Geography Education Map Application for Students',
                            'Accept-Language': 'en'
                        }
                    }
                );
                
                lastApiCall = Date.now();
                
                if (!response.ok) {
                    throw new Error('Geocoding request failed');
                }
                
                const data = await response.json();
                
                // Extract relevant location information
                const address = data.address || {};
                const locationParts = [];
                
                // Build location string from available address components
                if (address.city) locationParts.push(address.city);
                else if (address.town) locationParts.push(address.town);
                else if (address.village) locationParts.push(address.village);
                else if (address.hamlet) locationParts.push(address.hamlet);
                
                if (address.state) locationParts.push(address.state);
                if (address.country) locationParts.push(address.country);
                
                const locationName = locationParts.length > 0 
                    ? locationParts.join(', ') 
                    : data.display_name || 'Location information not available';
                
                const result = {
                    name: locationName,
                    fullAddress: data.display_name,
                    details: address
                };
                
                // Cache the result
                geocodeCache.set(cacheKey, result);
                
                return result;
            } catch (error) {
                console.error('Error fetching location:', error);
                return {
                    name: 'Unable to fetch location information',
                    fullAddress: 'Please try again',
                    details: {},
                    error: true
                };
            }
        }
        
        // Function to update the sidebar with location information
        function updateSidebar(lat, lon, locationData) {
            // Update coordinates
            document.getElementById('latitude').textContent = formatCoordinate(lat, true);
            document.getElementById('longitude').textContent = formatCoordinate(lon, false);
            
            // Update location info
            const locationInfoDiv = document.getElementById('location-info');
            
            if (locationData.error) {
                locationInfoDiv.innerHTML = `
                    <div class="info-item">
                        <div class="error">${locationData.name}</div>
                    </div>
                `;
            } else {
                const details = locationData.details;
                let detailsHTML = '';
                
                // Add specific location details if available
                if (details.city || details.town || details.village) {
                    detailsHTML += `
                        <div class="info-item">
                            <div class="info-label">City/Town</div>
                            <div class="info-value">${details.city || details.town || details.village}</div>
                        </div>
                    `;
                }
                
                if (details.state || details.region) {
                    detailsHTML += `
                        <div class="info-item">
                            <div class="info-label">State/Region</div>
                            <div class="info-value">${details.state || details.region}</div>
                        </div>
                    `;
                }
                
                if (details.country) {
                    detailsHTML += `
                        <div class="info-item">
                            <div class="info-label">Country</div>
                            <div class="info-value">${details.country}</div>
                        </div>
                    `;
                }
                
                if (details.postcode) {
                    detailsHTML += `
                        <div class="info-item">
                            <div class="info-label">Postal Code</div>
                            <div class="info-value">${details.postcode}</div>
                        </div>
                    `;
                }
                
                // If no specific details, show the full address
                if (!detailsHTML) {
                    detailsHTML = `
                        <div class="info-item">
                            <div class="info-label">Location</div>
                            <div class="info-value">${locationData.name}</div>
                        </div>
                    `;
                }
                
                locationInfoDiv.innerHTML = detailsHTML;
            }
        }
        
        // Handle map clicks
        map.on('click', async function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            
            // Remove previous marker if it exists
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            
            // Add new marker
            currentMarker = L.marker([lat, lon]).addTo(map);
            
            // Show loading state in popup
            const loadingPopup = L.popup()
                .setLatLng([lat, lon])
                .setContent(`
                    <div class="popup-title">üìç Location Details</div>
                    <div class="popup-coords">
                        <strong>Coordinates:</strong><br>
                        ${formatCoordinate(lat, true)}, ${formatCoordinate(lon, false)}
                    </div>
                    <div class="popup-location loading">Loading location information...</div>
                `)
                .openOn(map);
            
            // Update sidebar with coordinates immediately
            document.getElementById('latitude').textContent = formatCoordinate(lat, true);
            document.getElementById('longitude').textContent = formatCoordinate(lon, false);
            document.getElementById('location-info').innerHTML = `
                <div class="info-item">
                    <div class="loading">Loading location information...</div>
                </div>
            `;
            
            // Fetch location name (in English)
            const locationData = await getLocationName(lat, lon);
            
            // Update popup with location information
            const popupContent = `
                <div class="popup-title">üìç Location Details</div>
                <div class="popup-coords">
                    <strong>Coordinates:</strong><br>
                    ${formatCoordinate(lat, true)}, ${formatCoordinate(lon, false)}
                </div>
                <div class="popup-location">
                    <strong>Location:</strong><br>
                    ${locationData.name}
                </div>
            `;
            
            currentMarker.bindPopup(popupContent).openPopup();
            
            // Update sidebar
            updateSidebar(lat, lon, locationData);
        });
        
        // Add scale control
        L.control.scale({
            imperial: true,
            metric: true
        }).addTo(map);
        
        // Log map initialization
        console.log('Interactive Geography Map initialized successfully');
        console.log('Base layers: Street (English), Street (Local), Satellite, Topographic, Terrain, Physical');
        console.log('Overlays: English Labels, Boundaries, Transportation, Hillshade, Railways');
        console.log('Features: English labels available, live hover coordinates, click for details');
    </script>
</body>
</html>

