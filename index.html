<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geographic Detective Academy</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #0a0e27;
            color: white;
        }
        
        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 1000;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #header h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .xp-display {
            background: rgba(0,0,0,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #logout-btn {
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            margin-left: 15px;
        }
        
        #logout-btn:hover {
            background: rgba(255,107,107,0.3);
            border-color: #ff6b6b;
            transform: translateY(-2px);
        }
        
        #game-modes {
            background: #0f1329;
            padding: 12px 20px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            border-bottom: 3px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .mode-btn {
            background: #1a1f3a;
            color: #aaa;
            border: 2px solid #2a2f4a;
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            transition: all 0.2s;
            position: relative;
        }
        
        .mode-btn:hover {
            background: #2a2f4a;
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .mode-btn.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .mode-btn.locked::after {
            content: "üîí";
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 16px;
        }
        
        #container {
            display: flex;
            height: calc(100vh - 110px);
        }
        
        #map {
            flex: 1;
            height: 100%;
            position: relative;
        }
        
        #sidebar {
            width: 380px;
            background: #0f1329;
            box-shadow: -4px 0 20px rgba(0,0,0,0.5);
            padding: 20px;
            overflow-y: auto;
            z-index: 999;
        }
        
        .game-panel {
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        
        .game-panel.active {
            display: block;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .section {
            background: linear-gradient(135deg, #1a1f3a 0%, #0f1329 100%);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 2px solid #2a2f4a;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .section h2 {
            font-size: 18px;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }
        
        .section h2:hover {
            color: #fff;
            transform: translateX(4px);
        }
        
        .section h2::after {
            content: '‚ñº';
            margin-left: auto;
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .section.collapsed h2::after {
            transform: rotate(-90deg);
        }
        
        .section-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.2s;
            opacity: 1;
        }
        
        .section.collapsed .section-content {
            max-height: 0;
            opacity: 0;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 15px;
            width: 100%;
            margin-top: 12px;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        .btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #2a2f4a;
            box-shadow: none;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #3a3f5a;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }
        
        .timer {
            font-size: 32px;
            font-weight: 900;
            color: #ffd700;
            text-align: center;
            padding: 16px;
            background: rgba(255, 215, 0, 0.1);
            border: 3px solid #ffd700;
            border-radius: 12px;
            margin: 12px 0;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .timer.warning {
            color: #ff6b6b;
            border-color: #ff6b6b;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .score-display {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            padding: 12px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            margin: 12px 0;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 12px 0;
        }
        
        .stat-box {
            background: rgba(102, 126, 234, 0.1);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .stat-label {
            font-size: 11px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #ffd700;
        }
        
        .progress-bar {
            width: 100%;
            height: 28px;
            background: #1a1f3a;
            border-radius: 14px;
            overflow: hidden;
            margin: 12px 0;
            border: 2px solid #2a2f4a;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 13px;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .challenge-item {
            background: rgba(102, 126, 234, 0.1);
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
            transition: all 0.2s;
        }
        
        .challenge-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }
        
        .challenge-item.completed {
            background: rgba(0, 255, 127, 0.1);
            border-left-color: #00ff7f;
        }
        
        .challenge-item.completed .challenge-text {
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        .answer-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 12px 0;
        }
        
        .answer-btn {
            background: #1a1f3a;
            color: white;
            border: 2px solid #2a2f4a;
            padding: 14px 18px;
            border-radius: 10px;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            position: relative;
        }
        
        .answer-btn:hover:not(:disabled) {
            background: #2a2f4a;
            border-color: #667eea;
            transform: translateX(4px);
        }
        
        .answer-btn.correct {
            background: linear-gradient(135deg, #00ff7f 0%, #00d96f 100%);
            color: #000;
            border-color: #00ff7f;
            animation: correctPulse 0.5s;
        }
        
        .answer-btn.incorrect {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            border-color: #ff6b6b;
            animation: shake 0.5s;
        }
        
        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .hint-box {
            background: rgba(255, 215, 0, 0.15);
            border: 2px solid #ffd700;
            padding: 14px;
            border-radius: 10px;
            margin: 12px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .hint-box strong {
            color: #ffd700;
        }
        
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }
        
        .tutorial-overlay.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .tutorial-content {
            background: linear-gradient(135deg, #1a1f3a 0%, #0f1329 100%);
            padding: 32px;
            border-radius: 16px;
            max-width: 600px;
            border: 3px solid #667eea;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .tutorial-content h2 {
            font-size: 28px;
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .tutorial-content h3 {
            font-size: 20px;
            color: #667eea;
            margin: 20px 0 12px 0;
        }
        
        .tutorial-content p, .tutorial-content ul {
            font-size: 15px;
            line-height: 1.8;
            margin-bottom: 16px;
            color: #ddd;
        }
        
        .tutorial-content ul {
            margin-left: 20px;
        }
        
        .tutorial-content li {
            margin-bottom: 8px;
        }
        
        .tutorial-content strong {
            color: #ffd700;
        }
        
        .why-play {
            background: rgba(102, 126, 234, 0.2);
            padding: 16px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin: 16px 0;
        }
        
        .notification {
            position: fixed;
            top: 120px;
            right: 20px;
            background: linear-gradient(135deg, #00ff7f 0%, #00d96f 100%);
            color: #000;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 6px 20px rgba(0, 255, 127, 0.5);
            z-index: 10001;
            display: none;
            animation: slideInRight 0.3s ease-out;
        }
        
        .notification.active {
            display: block;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .coords-display {
            background: #1a1f3a;
            padding: 16px;
            border-radius: 10px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            color: #ffd700;
            border: 2px solid #667eea;
            margin: 12px 0;
            font-family: 'Courier New', monospace;
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background: #1a1f3a;
            border: 2px solid #2a2f4a;
            color: white;
            font-size: 14px;
            margin-top: 8px;
            transition: all 0.2s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }
        
        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 700;
            margin: 6px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
        }
        
        .badge.locked {
            background: #2a2f4a;
            color: #666;
            box-shadow: none;
        }
        
        .badge.unlocked {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
            animation: badgeUnlock 0.5s ease-out;
        }
        
        @keyframes badgeUnlock {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Toast Notification System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            pointer-events: none;
        }
        
        .toast {
            background: rgba(10, 14, 39, 0.98);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            min-width: 300px;
            max-width: 400px;
            border-left: 4px solid;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: toastSlideIn 0.3s ease-out, toastFadeOut 0.3s ease-in 2.7s;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toast.success {
            border-left-color: #10b981;
        }
        
        .toast.error {
            border-left-color: #ef4444;
        }
        
        .toast.warning {
            border-left-color: #f59e0b;
        }
        
        .toast.info {
            border-left-color: #3b82f6;
        }
        
        .toast-icon {
            font-size: 24px;
            line-height: 1;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 4px;
            color: #fff;
        }
        
        .toast-message {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.4;
        }
        
        @keyframes toastSlideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes toastFadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        
        /* Loading Spinner System */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 20px;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #fff;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }
        
        .loading-subtext {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }
        
        /* Button Loading State */
        .btn.loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }
        
        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        #sidebar::-webkit-scrollbar {
            width: 8px;
        }
        
        #sidebar::-webkit-scrollbar-track {
            background: #0f1329;
        }
        
        #sidebar::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        
        #sidebar::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
        
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }
            
            #sidebar {
                width: 100%;
                height: 350px;
            }
            
            #map {
                height: calc(100vh - 460px);
            }
        }
        
        /* Population Density Legend */
        .population-legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: rgba(10, 14, 39, 0.95);
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #667eea;
            z-index: 1000;
            font-size: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: none;
        }
        
        .population-legend.active {
            display: block;
        }
        
        .population-legend h4 {
            margin: 0 0 8px 0;
            font-size: 13px;
            color: #667eea;
            font-weight: 700;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
            gap: 8px;
        }
        
        .legend-color {
            width: 30px;
            height: 15px;
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .legend-label {
            font-size: 11px;
            color: #ccc;
        }
        
        /* Coordinate Finder Floating Panel */
        #coordinate-finder-panel {
            position: fixed;
            top: 100px;
            right: 30px;
            width: 450px;
            max-width: calc(100vw - 60px);
            background: rgba(10, 14, 39, 0.98);
            border: 3px solid #667eea;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            box-sizing: border-box;
        }
        
        #coordinate-finder-panel.active {
            display: block;
        }
        
        .cf-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 16px 20px;
            border-radius: 13px 13px 0 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .cf-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .cf-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            line-height: 1;
            padding: 0;
            flex-shrink: 0;
        }
        
        .cf-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .cf-content {
            padding: 20px;
            color: white;
            overflow-x: hidden;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
            box-sizing: border-box;
        }
        
        .cf-content * {
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            #coordinate-finder-panel {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
                top: 80px;
            }
        }
        
        /* ========================================
           FUN MODE STYLES - Phase 4
           ======================================== */
        
        /* Fun Mode Toggle Switch */
        .fun-mode-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }
        
        .toggle-label {
            font-size: 14px;
            font-weight: 600;
            color: #aaa;
            flex-grow: 1;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #2a2f4a;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #667eea;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-switch.active {
            background: linear-gradient(135deg, #00ff88, #00ccff);
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }
        
        .toggle-switch.active::after {
            left: 33px;
            background: #0a0e27;
        }
        
        /* Fun Mode - Body Changes */
        body.fun-mode {
            background: #0a0e27;
        }
        
        body.fun-mode #coordinate-finder-panel {
            background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(20, 14, 39, 0.98));
            border: 3px solid #00ff88;
            box-shadow: 0 8px 32px rgba(0, 255, 136, 0.4), 0 0 60px rgba(0, 204, 255, 0.2);
        }
        
        body.fun-mode .cf-header {
            background: linear-gradient(135deg, #00ff88 0%, #00ccff 100%);
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
        }
        
        body.fun-mode .cf-header h3 {
            color: #0a0e27;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        body.fun-mode .cf-close-btn {
            background: rgba(10, 14, 39, 0.6);
            color: #00ff88;
        }
        
        body.fun-mode .cf-close-btn:hover {
            background: rgba(10, 14, 39, 0.8);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.6);
        }
        
        body.fun-mode .btn {
            background: linear-gradient(135deg, #00ff88 0%, #00ccff 100%);
            color: #0a0e27;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
            font-weight: 800;
        }
        
        body.fun-mode .btn:hover:not(:disabled) {
            box-shadow: 0 6px 25px rgba(0, 255, 136, 0.5);
            transform: translateY(-3px) scale(1.02);
        }
        
        body.fun-mode .btn:disabled {
            background: linear-gradient(135deg, #2a2f4a, #3a3f5a);
            color: #666;
        }
        
        body.fun-mode #cf-timer-overlay {
            background: linear-gradient(135deg, rgba(10, 14, 39, 0.98), rgba(20, 14, 39, 0.98)) !important;
            border: 3px solid #00ff88 !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8), 0 0 40px rgba(0, 255, 136, 0.6) !important;
        }
        
        body.fun-mode #cf-timer-label {
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        
        body.fun-mode #cf-timer-countdown {
            color: #00ccff;
            text-shadow: 0 0 20px rgba(0, 204, 255, 0.8);
        }
        
        body.fun-mode #cf-timer-countdown.warning {
            color: #ff00ff;
            text-shadow: 0 0 20px rgba(255, 0, 255, 0.8);
        }
        
        body.fun-mode #cf-timer-countdown.danger {
            color: #ff0088;
            text-shadow: 0 0 20px rgba(255, 0, 136, 0.8);
        }
        
        body.fun-mode #cf-skip-hint {
            color: #00ff88;
        }
        
        /* Fun Mode Input Styling */
        body.fun-mode input[type="number"],
        body.fun-mode select {
            background: rgba(10, 14, 39, 0.8);
            border-color: #00ccff;
            color: #00ff88;
        }
        
        body.fun-mode input[type="number"]:focus,
        body.fun-mode select:focus {
            border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.4);
        }
        
        body.fun-mode input.valid {
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }
        
        body.fun-mode input.invalid {
            border-color: #ff0088;
            box-shadow: 0 0 10px rgba(255, 0, 136, 0.3);
        }
        
        /* ========================================
           CELEBRATION MESSAGE STYLES - Phase 5
           ======================================== */
        
        /* Success Message Popup */
        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(0, 255, 127, 0.95), rgba(0, 204, 255, 0.95));
            color: #0a0e27;
            padding: 40px 60px;
            border-radius: 20px;
            font-size: 36px;
            font-weight: 900;
            z-index: 10000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8), 0 0 40px rgba(0, 255, 127, 0.6);
            text-align: center;
            animation: popIn 0.3s ease-out;
        }
        
        .success-message.academic {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
            color: white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
        }
        
        @keyframes popIn {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        
        /* Six Seven Glitch Effect */
        .glitch-text {
            position: relative;
            font-size: 48px;
            font-weight: 900;
            color: #ff00ff;
            text-shadow: 
                2px 2px #00ffff,
                -2px -2px #ff00ff;
            animation: glitch 0.3s infinite;
        }
        
        @keyframes glitch {
            0% {
                text-shadow: 
                    2px 2px #00ffff,
                    -2px -2px #ff00ff;
            }
            25% {
                text-shadow: 
                    -2px 2px #ff00ff,
                    2px -2px #00ffff;
            }
            50% {
                text-shadow: 
                    2px -2px #00ffff,
                    -2px 2px #ff00ff;
            }
            75% {
                text-shadow: 
                    -2px -2px #00ffff,
                    2px 2px #ff00ff;
            }
            100% {
                text-shadow: 
                    2px 2px #00ffff,
                    -2px -2px #ff00ff;
            }
        }
        
        /* Fade out animation */
        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }
        
        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }

        /* ========================================
           LOCATION EXPLORER SIDEBAR STYLES
           Phase 1.1: Collapsible sidebar + animations
           ======================================== */
        
        .location-sidebar {
            position: fixed;
            top: 0;
            right: -450px; /* Hidden by default */
            width: 450px;
            height: 100vh;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            border-left: 2px solid #ffd700;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease-in-out;
        }

        .location-sidebar.active {
            right: 0;
        }

        /* Sidebar Header */
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        }

        .sidebar-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-icon {
            font-size: 24px;
        }

        .sidebar-title h3 {
            margin: 0;
            font-size: 20px;
            color: #ffd700;
            font-weight: bold;
        }

        .sidebar-controls {
            display: flex;
            gap: 10px;
        }

        .sidebar-control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            width: 36px;
            height: 36px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-control-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.1);
        }

        /* Sidebar Content (Scrollable) */
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            padding-bottom: 80px; /* Space for footer */
        }

        .sidebar-content::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: rgba(255, 215, 0, 0.3);
            border-radius: 4px;
        }

        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 215, 0, 0.5);
        }

        /* Collection Badge */
        .collection-badge {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%);
            border: 2px solid rgba(255, 215, 0, 0.4);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: pulse 2s ease-in-out infinite;
        }

        .collection-icon {
            font-size: 32px;
        }

        .collection-text {
            font-size: 16px;
            font-weight: bold;
            color: #ffd700;
        }

        #locations-explored-count {
            font-size: 24px;
            color: #fff;
        }

        /* Location Cards */
        .location-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .location-card:hover {
            border-color: rgba(255, 215, 0, 0.4);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        .card-header:hover {
            background: rgba(255, 215, 0, 0.15);
        }

        .card-header h4 {
            margin: 0;
            font-size: 16px;
            color: #ffd700;
            font-weight: bold;
        }

        .card-toggle {
            font-size: 14px;
            color: #ffd700;
            transition: transform 0.3s ease;
        }

        .location-card.collapsed .card-toggle {
            transform: rotate(-90deg);
        }

        .card-content {
            padding: 15px;
            color: #ffffff;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .location-card.collapsed .card-content {
            max-height: 0;
            padding: 0 15px;
        }

        /* Location Header Content */
        .location-header-content {
            text-align: center;
        }

        .country-flag {
            font-size: 80px;
            margin-bottom: 15px;
            animation: wave 2s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .location-name {
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
            margin: 10px 0;
        }

        .location-badges {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .location-badge {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 20px;
            padding: 6px 15px;
            font-size: 14px;
            font-weight: bold;
            color: #ffd700;
        }

        .location-coordinates {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 20px;
            padding: 6px 15px;
            font-size: 14px;
            font-weight: bold;
            color: #ffd700;
        }

        .coord-toggle-btn {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
        }

        .coord-toggle-btn:hover {
            background: rgba(255, 215, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.6);
            transform: rotate(180deg);
        }

        .coord-toggle-icon {
            font-size: 14px;
        }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        /* PHOTO ENLARGEMENT MODAL with AI Captions */
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        
        .photo-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
        }

        .photo-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .photo-modal-content {
            background: #1e293b;
            border-radius: 16px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            animation: bounceIn 0.4s ease;
            position: relative;
        }

        .photo-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 10001;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .photo-modal-close:hover {
            background: rgba(239, 68, 68, 0.8);
            transform: rotate(90deg) scale(1.1);
            border-color: rgba(239, 68, 68, 0.8);
        }

        .photo-modal-image-container {
            position: relative;
            width: 100%;
            max-height: 60vh;
            background: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .photo-modal-image-container img {
            width: 100%;
            height: auto;
            max-height: 60vh;
            object-fit: contain;
            display: block;
        }
        
        /* Photo modal image (used when not in container) */
        .photo-modal-image {
            width: 100%;
            height: auto;
            max-height: 70vh;
            object-fit: contain;
            display: block;
            border-radius: 8px 8px 0 0;
        }

        .photo-loading {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.95);
            padding: 15px 25px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 2px solid rgba(251, 191, 36, 0.3);
        }

        .photo-loading.hidden {
            display: none;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(251, 191, 36, 0.3);
            border-top-color: #fbbf24;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .photo-loading p {
            margin: 0;
            color: #fbbf24;
            font-size: 14px;
            font-weight: 500;
        }

        .photo-modal-info {
            padding: 25px 30px;
            overflow-y: auto;
            max-height: 40vh;
        }

        .photo-modal-credit {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
            border-radius: 6px;
        }

        .credit-icon {
            font-size: 18px;
        }

        .photo-modal-credit a {
            color: #60a5fa;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .photo-modal-credit a:hover {
            color: #93c5fd;
            text-decoration: underline;
        }

        .photo-modal-caption {
            margin-bottom: 20px;
        }

        .photo-modal-caption h3 {
            margin: 0 0 15px 0;
            color: #fbbf24;
            font-size: 20px;
            font-weight: 600;
        }

        .photo-description {
            color: #e2e8f0;
            font-size: 15px;
            line-height: 1.7;
            margin-bottom: 15px;
        }

        .photo-description p {
            margin: 0 0 12px 0;
        }

        .photo-description p:last-child {
            margin-bottom: 0;
        }

        .photo-relevance {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(16, 185, 129, 0.15) 100%);
            border-left: 3px solid #10b981;
            padding: 12px 15px;
            border-radius: 6px;
            font-size: 14px;
            color: #a7f3d0;
            font-style: italic;
        }

        .photo-relevance::before {
            content: 'üéØ Why this matters: ';
            font-weight: 600;
            color: #6ee7b7;
            font-style: normal;
        }

        .photo-modal-meta {
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .photo-search-query {
            display: inline-block;
            background: rgba(251, 191, 36, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .photo-search-query::before {
            content: 'üîç Search: ';
            font-weight: 600;
        }

        /* AI Badge on thumbnail */
        .ai-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(251, 191, 36, 0.95);
            color: #1e293b;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            z-index: 10;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(251, 191, 36, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        /* AI/Vision Labels for fact photos */
        .ai-label, .vision-label {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(251, 191, 36, 0.95);
            color: #1e293b;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            z-index: 10;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(251, 191, 36, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s ease;
        }
        
        .vision-label {
            background: rgba(59, 130, 246, 0.95);
            border-color: rgba(59, 130, 246, 1);
            color: white;
            left: auto;
            right: 8px;
        }
        
        /* Fact photo modal styles */
        .photo-modal-fact {
            font-size: 16px;
            line-height: 1.6;
            color: #2c3e50;
            margin-bottom: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .photo-modal-reason {
            font-size: 13px;
            color: #64748b;
            font-style: italic;
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(100, 116, 139, 0.1);
            border-radius: 6px;
        }

        /* AI Disclosure in modal */
        .ai-disclosure {
            background: rgba(251, 191, 36, 0.1);
            border-left: 4px solid #fbbf24;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: slideInTop 0.3s ease;
        }

        .ai-disclosure h4 {
            color: #fbbf24;
            font-size: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .ai-disclosure p {
            color: #e2e8f0;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
        }

        @keyframes slideInTop {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .photo-modal-content {
                max-height: 95vh;
            }

            .photo-modal-image-container {
                max-height: 50vh;
            }

            .photo-modal-info {
                padding: 20px;
                max-height: 45vh;
            }

            .photo-modal-caption h3 {
                font-size: 18px;
            }

            .photo-description {
                font-size: 14px;
            }
        }

        /* Floating Reopen Sidebar Button */
        .reopen-sidebar-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border: 3px solid rgba(255, 215, 0, 0.4);
            border-radius: 50%;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 1999; /* Just below sidebar */
            gap: 2px;
        }

        .reopen-sidebar-btn:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
            background: linear-gradient(135deg, #ffed4e 0%, #ffd700 100%);
        }

        .reopen-sidebar-btn:active {
            transform: scale(0.95);
        }

        .reopen-sidebar-btn.visible {
            display: flex;
        }

        .reopen-icon {
            font-size: 24px;
            animation: bounce 2s infinite;
        }

        .reopen-text {
            font-size: 11px;
            font-weight: bold;
            color: #1e293b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        
        /* ========================================
           GEN ALPHA LOADING ANIMATION (67 DANCE!)
           ======================================== */
        
        .gen-alpha-loading {
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .gen-alpha-loading::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.05) 10px,
                rgba(255,255,255,0.05) 20px
            );
            animation: vibeShift 20s linear infinite;
        }
        
        @keyframes vibeShift {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(50px, 50px) rotate(360deg); }
        }
        
        .six-seven-dance {
            position: relative;
            z-index: 1;
        }
        
        .six-seven-big {
            font-size: 120px;
            display: inline-block;
            animation: sixSevenDance 0.8s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.8));
            text-shadow: 0 0 30px rgba(255,255,255,0.5);
        }
        
        @keyframes sixSevenDance {
            0%, 100% { 
                transform: translateY(0) rotate(0deg) scale(1);
            }
            25% { 
                transform: translateY(-20px) rotate(-10deg) scale(1.1);
            }
            50% { 
                transform: translateY(0) rotate(0deg) scale(1);
            }
            75% { 
                transform: translateY(-15px) rotate(10deg) scale(1.05);
            }
        }
        
        .loading-text {
            margin-top: 20px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .loading-word {
            display: inline-block;
            animation: wordBounce 1.2s ease-in-out infinite;
        }
        
        .loading-word-1 {
            animation-delay: 0s;
        }
        
        .loading-word-2 {
            animation-delay: 0.2s;
        }
        
        @keyframes wordBounce {
            0%, 100% { 
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            50% { 
                transform: translateY(-10px) scale(1.1);
                opacity: 0.8;
            }
        }
        
        .loading-dots {
            display: inline-block;
            margin-left: 5px;
        }
        
        .loading-dots .dot {
            animation: dotPulse 1.4s ease-in-out infinite;
            opacity: 0;
        }
        
        .loading-dots .dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .loading-dots .dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .loading-dots .dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes dotPulse {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        .vibe-check {
            margin-top: 15px;
            font-size: 16px;
            color: rgba(255,255,255,0.9);
            font-style: italic;
            animation: vibeGlow 2s ease-in-out infinite;
        }
        
        @keyframes vibeGlow {
            0%, 100% { 
                opacity: 0.7;
                text-shadow: 0 0 10px rgba(255,255,255,0.5);
            }
            50% { 
                opacity: 1;
                text-shadow: 0 0 20px rgba(255,255,255,0.8);
            }
        }

        /* Hide reopen button when sidebar is active */
        .location-sidebar.active ~ .reopen-sidebar-btn {
            display: none !important;
        }
        }

        .location-coordinates {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
            border-radius: 20px;
            padding: 6px 15px;
            font-size: 14px;
            font-weight: bold;
            color: #60a5fa;
        }

        /* Quick Facts Grid */
        .fact-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .fact-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid #ffd700;
        }

        .fact-label {
            font-weight: bold;
            color: #ffd700;
        }

        .fact-value {
            color: #ffffff;
            text-align: right;
        }

        /* Comparison Content */
        .comparison-content {
            text-align: center;
        }

        .distance-display {
            margin-bottom: 20px;
        }

        .distance-value {
            font-size: 48px;
            font-weight: bold;
            color: #ffd700;
            display: block;
        }

        .distance-unit {
            font-size: 16px;
            color: #aaa;
        }

        .comparison-facts {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .comparison-fact {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .comparison-icon {
            font-size: 24px;
        }

        /* Loading Placeholder */
        .loading-placeholder {
            text-align: center;
            padding: 30px;
            color: #888;
        }

        .placeholder-icon {
            font-size: 48px;
            display: block;
            margin-bottom: 15px;
        }

        .loading-placeholder p {
            margin: 0;
            font-style: italic;
        }

        /* Sidebar Footer */
        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 215, 0, 0.3);
        }

        .view-collection-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            color: #1e293b;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-collection-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .location-sidebar {
                width: 100%;
                right: -100%;
            }

            .location-sidebar.active {
                right: 0;
            }
        }

        /* Nearby Places Styling */
        .nearby-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nearby-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid #ffd700;
            transition: all 0.2s ease;
        }

        .nearby-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .nearby-item-icon {
            font-size: 20px;
            margin-right: 10px;
        }

        .nearby-item-info {
            flex: 1;
        }

        .nearby-item-name {
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 4px;
        }

        .nearby-item-type {
            font-size: 12px;
            color: #888;
        }

        .nearby-item-distance {
            font-size: 14px;
            color: #ffd700;
            font-weight: bold;
            white-space: nowrap;
        }

        .no-nearby {
            text-align: center;
            padding: 20px;
            color: #888;
        }

        /* AI Facts Styling (Card 4) */
        .fact-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        /* NEW: Fact-Photo List with Scrolling */
        .fact-photo-list {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 8px;
        }
        
        /* Custom Scrollbar for Fact List */
        .fact-photo-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .fact-photo-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .fact-photo-list::-webkit-scrollbar-thumb {
            background: rgba(255, 107, 157, 0.5);
            border-radius: 4px;
        }
        
        .fact-photo-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 107, 157, 0.8);
        }

        .fact-item {
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid #ff6b9d;
            line-height: 1.6;
            color: #ffffff;
        }

        .fact-item::before {
            margin-right: 8px;
        }

        /* Geography in Real Life Styling (Card 4.5) */
        .real-life-content {
            padding: 10px;
            max-height: 600px;
            overflow-y: auto;
            padding-right: 8px;
        }
        
        /* Custom scrollbar for real-life content */
        .real-life-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .real-life-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .real-life-content::-webkit-scrollbar-thumb {
            background: rgba(76, 175, 80, 0.5);
            border-radius: 4px;
        }
        
        .real-life-content::-webkit-scrollbar-thumb:hover {
            background: rgba(76, 175, 80, 0.8);
        }

        .real-life-theme {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
        }

        .real-life-theme:last-child {
            margin-bottom: 0;
        }

        .theme-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: #4CAF50;
            font-weight: bold;
            font-size: 16px;
        }

        .theme-icon {
            font-size: 24px;
        }

        .theme-explanation {
            color: #ffffff;
            line-height: 1.6;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .student-application {
            margin-top: 12px;
            padding: 12px;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(76, 175, 80, 0.1) 100%);
            border-radius: 8px;
            border: 2px solid rgba(76, 175, 80, 0.4);
            position: relative;
        }

        .student-application::before {
            content: 'üéì';
            position: absolute;
            top: -12px;
            left: 10px;
            background: #2d3e50;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 16px;
        }

        .student-label {
            font-weight: bold;
            color: #4CAF50;
            font-size: 13px;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .student-example {
            color: #e0e0e0;
            font-size: 14px;
            line-height: 1.5;
            font-style: italic;
        }

        .safety-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(76, 175, 80, 0.2);
            border-radius: 4px;
            font-size: 11px;
            color: #4CAF50;
            margin-top: 10px;
        }

        /* Photo Grid Styling (Card 5) */
        .photo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
        }

        .photo-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        .photo-credit {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 5px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            font-size: 10px;
            color: white;
        }

        /* Weather Display Styling (Card 6) */
        .weather-display {
            text-align: center;
        }

        .weather-main {
            margin-bottom: 15px;
        }

        .weather-icon {
            width: 80px;
            height: 80px;
        }

        .weather-temp {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
            color: #ffffff;
        }

        .temp-secondary {
            font-size: 18px;
            color: #888;
            margin-left: 10px;
        }

        .weather-desc {
            text-transform: capitalize;
            font-size: 16px;
            margin-bottom: 15px;
            color: #ffd700;
        }

        .weather-details {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        .weather-detail {
            padding: 5px 0;
            font-size: 14px;
            color: #ffffff;
        }

        /* No Data State (Used by all cards) */
        .no-data {
            text-align: center;
            padding: 30px 20px;
            color: #888;
        }

        .no-data p {
            margin: 10px 0;
        }

        /* Gen Alpha Style (To be toggled in Phase 7) */
        .location-sidebar.gen-alpha-mode .card-header h4::before {
            content: 'üî• ';
        }

        .location-sidebar.gen-alpha-mode .location-name::after {
            content: ' ‚ú®';
        }
    </style>
    
    <!-- ============================================ -->
    <!-- SUPABASE CONNECTION - Added October 20, 2025 -->
    <!-- ============================================ -->
    
    <!-- Supabase Client Library (v2.x) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ========================================
        // SUPABASE INITIALIZATION - PROPER SETUP
        // ========================================
        
        // Your Supabase project configuration
        const SUPABASE_URL = 'https://fuppbkhfqutzcromomkc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1cHBia2hmcXV0emNyb21vbWtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODE4NDQsImV4cCI6MjA3NjU1Nzg0NH0.A1kARz6ujz1wMQy-T_4W2EN1wrroma6f230_-rKnNBo';
        
        // Create Supabase client with localStorage persistence
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                storage: window.localStorage,
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: false
            }
        });
        
        // Log successful connection (you'll see this in browser console!)
        console.log('‚úÖ Supabase initialized successfully!');
        console.log('üì¶ Supabase client:', supabase);
        console.log('üåê Project URL:', SUPABASE_URL);
        console.log('üîó Ready to connect to database!');
        
        // Test function to verify connection (run in console: testSupabaseConnection())
        async function testSupabaseConnection() {
            console.log('üß™ Testing Supabase connection...');
            try {
                const { data, error } = await supabase
                    .from('test_connection')
                    .select('*');
                
                if (error) {
                    console.warn('‚ö†Ô∏è Query error (table might not exist yet):', error.message);
                } else {
                    console.log('‚úÖ SUCCESS! Database connection working!');
                    console.log('üìä Data received:', data);
                }
            } catch (err) {
                console.error('‚ùå Connection test failed:', err);
            }
        }
        
        // Make test function available globally
        window.testSupabaseConnection = testSupabaseConnection;
        
        // ========================================
        // LOGOUT FUNCTION
        // ========================================
        async function logoutUser() {
            console.log('üö™ Logging out...');
            try {
                // Clear localStorage
                localStorage.removeItem('user_full_name');
                localStorage.removeItem('user_account_type');
                localStorage.removeItem('user_username');
                localStorage.removeItem('user_email');
                
                // Sign out from Supabase
                const { error } = await supabase.auth.signOut();
                if (error) {
                    console.error('‚ùå Logout error:', error);
                    alert('Error logging out. Redirecting anyway...');
                } else {
                    console.log('‚úÖ Logged out successfully!');
                }
                // Redirect to login page
                window.location.href = 'login.html';
            } catch (err) {
                console.error('‚ùå Logout failed:', err);
                // Redirect anyway
                window.location.href = 'login.html';
            }
        }
        
        // Make logout function available globally
        window.logoutUser = logoutUser;

        // ========================================
        // SESSION MANAGEMENT & AUTH CHECK
        // ========================================
        // PROPER IMPLEMENTATION: Always check Supabase session first, never trust localStorage alone
        
        async function checkAuthentication() {
            console.log('üîê === AUTHENTICATION CHECK START ===');
            console.log('üìÖ Timestamp:', new Date().toISOString());
            
            try {
                // ALWAYS check Supabase session first - this is the source of truth
                console.log('üì° Calling supabase.auth.getSession()...');
                const { data: { session }, error } = await supabase.auth.getSession();
                
                console.log('üì¶ getSession() result:');
                console.log('  - Error:', error);
                console.log('  - Session exists:', !!session);
                
                if (error) {
                    console.error('‚ùå Session error:', error);
                    await forceSignOut();
                    return null;
                }
                
                if (!session) {
                    console.log('‚ùå No session found - clearing stale localStorage data');
                    await forceSignOut();
                    return null;
                }
                
                console.log('‚úÖ Session object received:');
                console.log('  - User email:', session.user?.email);
                console.log('  - User ID:', session.user?.id);
                console.log('  - Expires at:', session.expires_at);
                console.log('  - Expires date:', new Date(session.expires_at * 1000));
                console.log('  - Access token (first 20 chars):', session.access_token?.substring(0, 20) + '...');
                
                // Verify session is actually valid by trying to use it
                console.log('üß™ Verifying session by fetching user...');
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                
                console.log('üë§ getUser() result:');
                console.log('  - Error:', userError);
                console.log('  - User exists:', !!user);
                
                if (userError || !user) {
                    console.error('‚ùå Session exists but user fetch failed!');
                    console.error('   Error details:', userError);
                    console.log('üîß Session is stale/invalid - forcing full signout');
                    await forceSignOut();
                    return null;
                }
                
                console.log('‚úÖ User verified:', user.email);
                console.log('üìÖ Session expires:', new Date(session.expires_at * 1000));
                
                // Check if we have cached user data
                let userName = localStorage.getItem('user_full_name');
                let accountType = localStorage.getItem('user_account_type');
                
                console.log('üíæ localStorage cache:');
                console.log('  - user_full_name:', userName);
                console.log('  - user_account_type:', accountType);
                
                // If no cached data OR it might be stale, fetch from database
                if (!userName || !accountType) {
                    console.log('üìä Fetching user data from database...');
                    const { data: accountData, error: accountError } = await supabase
                        .from('accounts')
                        .select('full_name, account_type')
                        .eq('auth_user_id', session.user.id)
                        .single();
                    
                    console.log('üóÉÔ∏è Database query result:');
                    console.log('  - Error:', accountError);
                    console.log('  - Data:', accountData);
                    
                    if (accountError) {
                        console.error('‚ùå Account fetch error:', accountError);
                        await forceSignOut();
                        return null;
                    }
                    
                    userName = accountData.full_name;
                    accountType = accountData.account_type;
                    
                    // Cache in localStorage for UI performance
                    localStorage.setItem('user_full_name', userName);
                    localStorage.setItem('user_account_type', accountType);
                    
                    console.log('‚úÖ Account data loaded and cached:', userName);
                } else {
                    console.log('‚úÖ Using cached user data:', userName);
                }
                
                // Display welcome message
                displayWelcomeMessage(userName, accountType);
                
                console.log('üéâ === AUTHENTICATION CHECK COMPLETE - SUCCESS ===');
                
                return {
                    session: session,
                    userName: userName,
                    accountType: accountType
                };
                
            } catch (err) {
                console.error('‚ùå === AUTHENTICATION CHECK FAILED ===');
                console.error('Exception:', err);
                console.error('Stack:', err.stack);
                await forceSignOut();
                return null;
            }
        }

        async function forceSignOut() {
            console.log('ÔøΩ === FORCE SIGN OUT TRIGGERED ===');
            console.log('üìÖ Timestamp:', new Date().toISOString());
            
            try {
                console.log('üîì Calling supabase.auth.signOut()...');
                // Sign out from Supabase (clears session from localStorage)
                await supabase.auth.signOut();
                console.log('‚úÖ Supabase signOut() completed');
            } catch (err) {
                console.error('‚ö†Ô∏è Signout error (continuing anyway):', err);
            }
            
            // Clear ALL storage
            console.log('üßπ Clearing localStorage...');
            localStorage.clear();
            console.log('üßπ Clearing sessionStorage...');
            sessionStorage.clear();
            
            console.log('‚úÖ All sessions cleared');
            console.log('üîÑ Calling redirectToLogin()...');
            
            // Now redirect
            redirectToLogin();
        }

        function redirectToLogin() {
            console.log('üîÑ No valid session - redirecting to login...');
            
            // Anti-strobing protection: Don't redirect if we just came from login
            const lastRedirect = sessionStorage.getItem('last_redirect_time');
            const now = Date.now();
            
            if (lastRedirect && (now - parseInt(lastRedirect)) < 3000) {
                console.log('‚ö†Ô∏è STROBING DETECTED - preventing rapid redirect loop');
                console.log('‚ùå Session persistence is broken - please close browser and restart');
                
                // Show error message instead of redirecting
                document.body.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #1a1a2e; color: white; font-family: Arial, sans-serif; text-align: center; padding: 20px;">
                        <div>
                            <div style="font-size: 80px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                            <h1 style="color: #FFE951; margin-bottom: 20px;">Session Error Detected</h1>
                            <p style="font-size: 18px; margin-bottom: 30px; max-width: 600px;">
                                A redirect loop was detected. This usually means Supabase session storage isn't working properly.
                            </p>
                            <p style="font-size: 16px; color: #888; margin-bottom: 30px;">
                                Please try:<br>
                                1. Close ALL browser windows<br>
                                2. Clear browser cache and cookies<br>
                                3. Restart the browser<br>
                                4. Try again
                            </p>
                            <button onclick="sessionStorage.clear(); localStorage.clear(); location.reload()" 
                                    style="background: #6366F1; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 8px; cursor: pointer; box-shadow: 8px 8px 0 #000;">
                                üîÑ Clear Everything & Reload
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Record redirect time
            sessionStorage.setItem('last_redirect_time', now.toString());
            
            // Redirect immediately
            window.location.replace('login.html');
        }

        function displayWelcomeMessage(userName, accountType) {
            console.log(`üëã Welcome, ${userName}! (${accountType})`);
            
            // Update header to show user's name
            const headerTitle = document.getElementById('header-title');
            if (headerTitle) {
                const accountEmoji = accountType === 'teacher' ? 'üë©‚Äçüè´' : 'üéì';
                const firstName = userName.split(' ')[0]; // Get first name only
                headerTitle.innerHTML = `${accountEmoji} Welcome, ${firstName}!`;
            }
            
            // Show a toast notification
            const accountEmoji = accountType === 'teacher' ? 'üë©‚Äçüè´' : 'üéì';
            const welcomeText = `${accountEmoji} Welcome back, ${userName}!`;
            
            // Show toast after a brief delay
            setTimeout(() => {
                showToast(welcomeText, 'success');
            }, 1000);
        }

        // ========================================
        // TEACHER DASHBOARD FUNCTIONS
        // ========================================
        
        // Store original teacher session
        let originalTeacherSession = null;
        let viewingAsStudent = false;
        
        async function loadTeacherDashboard() {
            const accountType = localStorage.getItem('user_account_type');
            
            // Only show dashboard if user is a teacher
            if (accountType !== 'teacher') {
                return;
            }
            
            console.log('üë©‚Äçüè´ Loading teacher dashboard...');
            const dashboard = document.getElementById('teacher-dashboard');
            dashboard.style.display = 'block';
            
            // Load all students
            await loadAllStudents();
        }
        
        async function loadAllStudents() {
            console.log('üìö Loading all students...');
            
            try {
                // Fetch all student accounts
                const { data: students, error } = await supabase
                    .from('accounts')
                    .select('id, full_name, account_type, created_at, auth_user_id')
                    .eq('account_type', 'student')
                    .order('full_name');
                
                if (error) {
                    console.error('‚ùå Error loading students:', error);
                    return;
                }
                
                console.log(`‚úÖ Loaded ${students.length} students`);
                
                // Render student list
                const studentList = document.getElementById('student-list');
                studentList.innerHTML = students.map(student => `
                    <div class="student-card" style="background: #FFE951; border: 3px solid #000; padding: 15px; box-shadow: 5px 5px 0 rgba(0,0,0,0.3); transition: all 0.2s;">
                        <h3 style="margin: 0 0 10px 0; font-size: 18px; color: #000;">
                            üéì ${student.full_name}
                        </h3>
                        <div style="margin: 10px 0; font-size: 14px; color: #333;">
                            <div>üìÖ Joined: ${new Date(student.created_at).toLocaleDateString()}</div>
                        </div>
                        <button onclick="viewAsStudent('${student.auth_user_id}', '${student.full_name}')" 
                            style="background: #6366F1; color: #FFE951; border: 3px solid #000; padding: 8px 16px; font-size: 14px; font-weight: bold; cursor: pointer; box-shadow: 3px 3px 0 rgba(0,0,0,0.3); margin-top: 10px; width: 100%;">
                            üëÅÔ∏è View As Student
                        </button>
                    </div>
                `).join('');
                
            } catch (err) {
                console.error('‚ùå Failed to load students:', err);
            }
        }
        
        function filterStudents() {
            const searchInput = document.getElementById('student-search').value.toLowerCase();
            const studentCards = document.querySelectorAll('.student-card');
            
            studentCards.forEach(card => {
                const studentName = card.querySelector('h3').textContent.toLowerCase();
                if (studentName.includes(searchInput)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        async function viewAsStudent(studentUserId, studentName) {
            console.log(`üëÅÔ∏è Viewing as student: ${studentName} (${studentUserId})`);
            
            // Store original teacher session if not already stored
            if (!viewingAsStudent) {
                const { data: { session } } = await supabase.auth.getSession();
                originalTeacherSession = session;
                viewingAsStudent = true;
            }
            
            // Store student info in sessionStorage (temporary, not persistent)
            sessionStorage.setItem('viewing_student_id', studentUserId);
            sessionStorage.setItem('viewing_student_name', studentName);
            
            // Update UI to show "Return to Teacher View" button
            document.getElementById('return-to-teacher-container').style.display = 'block';
            document.getElementById('current-student-name').textContent = `Viewing: ${studentName}`;
            
            // Update header title
            const headerTitle = document.getElementById('header-title');
            headerTitle.innerHTML = `üéì ${studentName}'s Progress`;
            
            // Hide student list, show return button prominently
            document.getElementById('student-list-container').style.display = 'none';
            
            // TODO: Load student's progress data
            // This will be implemented when we build the progress tracking
            showToast(`Now viewing ${studentName}'s account`, 'success');
        }
        
        function returnToTeacherView() {
            console.log('‚¨ÖÔ∏è Returning to teacher view');
            
            // Clear student viewing state
            sessionStorage.removeItem('viewing_student_id');
            sessionStorage.removeItem('viewing_student_name');
            viewingAsStudent = false;
            
            // Update UI
            document.getElementById('return-to-teacher-container').style.display = 'none';
            document.getElementById('student-list-container').style.display = 'block';
            
            // Restore header
            const userName = localStorage.getItem('user_full_name');
            const firstName = userName.split(' ')[0];
            const headerTitle = document.getElementById('header-title');
            headerTitle.innerHTML = `üë©‚Äçüè´ Welcome, ${firstName}!`;
            
            showToast('Returned to teacher view', 'success');
        }
        
        // Make functions globally available
        window.loadTeacherDashboard = loadTeacherDashboard;
        window.viewAsStudent = viewAsStudent;
        window.returnToTeacherView = returnToTeacherView;
        window.filterStudents = filterStudents;

        // Run auth check when page loads
        let currentUser = null;
        window.addEventListener('DOMContentLoaded', async () => {
            currentUser = await checkAuthentication();
            if (!currentUser) {
                // Will redirect to login
                return;
            }
            
            // Load teacher dashboard if user is a teacher
            await loadTeacherDashboard();
        });
    </script>
    
    <!-- End of Supabase setup -->
</head>
<body>
    <!-- Toast Notification Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">Loading...</div>
        <div class="loading-subtext" id="loading-subtext">Please wait</div>
    </div>
    
    <!-- Game Completion Modal -->
    <div id="game-complete-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10001; align-items: center; justify-content: center;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div style="font-size: 80px; margin-bottom: 20px;" id="completion-emoji">üéâ</div>
            <h1 id="completion-title" style="color: #ffd700; margin: 0 0 20px 0; font-size: 36px;">Game Complete!</h1>
            <div id="completion-stats" style="background: rgba(0,0,0,0.3); padding: 30px; border-radius: 12px; margin: 20px 0; line-height: 2; color: #fff;">
                <!-- Stats populated by JS -->
            </div>
            <div id="completion-message" style="font-size: 18px; color: #fff; margin: 20px 0;">
                <!-- Message populated by JS -->
            </div>
            <button id="play-again-btn" style="background: #ffd700; color: #1a1a2e; border: none; padding: 15px 40px; border-radius: 30px; font-size: 20px; font-weight: bold; cursor: pointer; margin: 10px; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4); transition: all 0.3s;">
                üéÆ PLAY AGAIN
            </button>
            <button onclick="closeCompletionModal()" style="background: transparent; color: #fff; border: 2px solid #fff; padding: 15px 40px; border-radius: 30px; font-size: 20px; font-weight: bold; cursor: pointer; margin: 10px; transition: all 0.3s;">
                üìä VIEW ACHIEVEMENTS
            </button>
        </div>
    </div>
    
    <div id="header">
        <h1 id="header-title">üïµÔ∏è GEOGRAPHIC DETECTIVE ACADEMY</h1>
        <div class="xp-display">
            <span>‚≠ê</span>
            <span id="total-xp">0</span>
            <span>XP</span>
        </div>
        <button id="logout-btn" onclick="logoutUser()">
            üö™ Logout
        </button>
    </div>
    
    <!-- Teacher Dashboard (Only visible for teachers) -->
    <div id="teacher-dashboard" style="display: none; background: #6366F1; border: 5px solid #000; padding: 20px; margin: 20px; box-shadow: 10px 10px 0 rgba(0,0,0,0.3);">
        <h2 style="color: #FFE951; margin: 0 0 20px 0; font-size: 28px; text-shadow: 3px 3px 0 rgba(0,0,0,0.3);">
            üë©‚Äçüè´ Teacher Dashboard
        </h2>
        
        <!-- Return to Teacher View Button (hidden by default, shown when viewing as student) -->
        <div id="return-to-teacher-container" style="display: none; margin-bottom: 20px;">
            <button onclick="returnToTeacherView()" style="background: #FFE951; color: #000; border: 3px solid #000; padding: 12px 24px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 5px 5px 0 rgba(0,0,0,0.3); transition: all 0.2s;">
                ‚¨ÖÔ∏è Return to Teacher View
            </button>
            <span id="current-student-name" style="color: #FFE951; margin-left: 20px; font-size: 18px; font-weight: bold;">
                <!-- Current student name will be shown here -->
            </span>
        </div>
        
        <!-- Student List -->
        <div id="student-list-container">
            <div style="background: rgba(255,255,255,0.1); padding: 15px; border: 3px solid #000; margin-bottom: 20px;">
                <input type="text" id="student-search" placeholder="üîç Search students..." 
                    onkeyup="filterStudents()"
                    style="width: 100%; padding: 10px; font-size: 16px; border: 3px solid #000; box-shadow: inset 3px 3px 0 rgba(0,0,0,0.2);">
            </div>
            
            <div id="student-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; max-height: 500px; overflow-y: auto;">
                <!-- Students will be loaded here dynamically -->
            </div>
        </div>
    </div>
    
    <div id="game-modes">
        <button class="mode-btn active" onclick="switchMode('explore')">üó∫Ô∏è EXPLORE</button>
        <button class="mode-btn" onclick="switchMode('mystery')">üéØ MYSTERY</button>
        <button class="mode-btn" onclick="switchMode('scavenger')">üåç SCAVENGER</button>
        <button class="mode-btn" onclick="switchMode('guess')">üì∏ GUESS</button>
        <button class="mode-btn" onclick="switchMode('missions')">üèÜ MISSIONS</button>
        <button class="mode-btn" onclick="switchMode('create')">üó∫Ô∏è CREATE</button>
        <button class="mode-btn" onclick="switchMode('alaska')">üèîÔ∏è ALASKA</button>
    </div>
    
    <div id="container">
        <div id="map"></div>
        
        <!-- Population Density Legend -->
        <div class="population-legend" id="pop-legend">
            <h4>üë• Population Density</h4>
            <div class="legend-item">
                <div class="legend-color" style="background: #8B0000;"></div>
                <span class="legend-label">Very High (>1000/km¬≤)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FF4500;"></div>
                <span class="legend-label">High (250-1000/km¬≤)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFA500;"></div>
                <span class="legend-label">Medium (100-250/km¬≤)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFD700;"></div>
                <span class="legend-label">Low (25-100/km¬≤)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFFACD;"></div>
                <span class="legend-label">Very Low (<25/km¬≤)</span>
            </div>
        </div>
        
        <div id="sidebar">
            <!-- EXPLORE MODE -->
            <div id="explore-panel" class="game-panel active">
                <div class="section">
                    <h2>ÔøΩ COORDINATE FINDER</h2>
                    <div class="section-content">
                        <p style="color: #aaa; line-height: 1.6; margin-bottom: 12px;">
                            Have coordinates? Use our Coordinate Finder tool to navigate to any location on Earth!
                        </p>
                        <button class="btn" onclick="toggleCoordinateFinderPanel()" style="width: 100%; font-size: 16px;">
                            üìç OPEN COORDINATE FINDER
                        </button>
                    </div>
                </div>
                
                <div class="section">
                    <h2>ÔøΩüó∫Ô∏è FREE EXPLORE</h2>
                    <div class="section-content">
                        <p style="color: #aaa; line-height: 1.6; margin-bottom: 12px;">
                            Click anywhere on the map to see coordinates and location info. Use the layer control (top right) to switch between satellite, terrain, and street views.
                        </p>
                        <div class="stat-grid">
                            <div class="stat-box">
                                <div class="stat-label">Latitude</div>
                                <div class="stat-value" id="hover-lat">--</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Longitude</div>
                                <div class="stat-value" id="hover-lon">--</div>
                            </div>
                        </div>
                        <div id="location-info" style="color: #aaa; font-size: 14px; margin-top: 12px;">
                            Click on the map to investigate a location
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üìç DISTANCE FROM GLENNALLEN</h2>
                    <div class="section-content">
                        <div id="distance-display" style="color: #aaa; font-size: 14px; line-height: 1.6;">
                            Click anywhere on the map to see how far it is from your hometown!
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üéÆ GAME MODES</h2>
                    <div class="section-content">
                        <p style="color: #aaa; line-height: 1.6; margin-bottom: 12px;">
                            Choose a game mode above to start earning XP and completing challenges!
                        </p>
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.6; color: #ddd;">
                            <strong style="color: #ffd700;">üéØ MYSTERY:</strong> Find locations from coordinates<br>
                            <strong style="color: #ffd700;">üåç SCAVENGER:</strong> Complete geographic challenges<br>
                            <strong style="color: #ffd700;">üì∏ GUESS:</strong> Identify famous landmarks<br>
                            <strong style="color: #ffd700;">üèÜ MISSIONS:</strong> Track your progress<br>
                            <strong style="color: #ffd700;">üó∫Ô∏è CREATE:</strong> Make your own mysteries
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- MYSTERY CHALLENGE MODE -->
            <div id="mystery-panel" class="game-panel">
                <div class="section">
                    <h2>üéØ MYSTERY LOCATION CHALLENGE</h2>
                    
                    <div id="mystery-game" style="display: none;">
                        
                        <!-- Big, Beautiful Coordinate Display -->
                        <div style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.2)); border: 3px solid #ffd700; border-radius: 16px; padding: 30px; margin-bottom: 20px; text-align: center;">
                            <div style="font-size: 14px; color: #ffd700; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 2px; font-weight: bold;">üó∫Ô∏è Find This Location:</div>
                            <div class="coords-display" id="mystery-coords" style="font-size: 42px; font-weight: bold; color: #fff; text-shadow: 2px 2px 8px rgba(0,0,0,0.5); margin: 15px 0;">
                                --
                            </div>
                            <div style="font-size: 13px; color: #aaa; margin-top: 12px;">
                                üí° Tip: First number is North/South, Second is East/West
                            </div>
                        </div>
                        
                        <!-- Timer and Score Row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                            <div style="background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #66b3ff;" id="mystery-timer">60</div>
                                <div style="font-size: 11px; color: #888; margin-top: 4px;">SECONDS LEFT</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #00ff7f;" id="mystery-score">0</div>
                                <div style="font-size: 11px; color: #888; margin-top: 4px;">SCORE</div>
                            </div>
                            <div style="background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold; color: #ff6b6b;" id="mystery-streak">0</div>
                                <div style="font-size: 11px; color: #888; margin-top: 4px;">STREAK üî•</div>
                            </div>
                        </div>
                        
                        <!-- Hints Box -->
                        <div id="mystery-hints" style="display: none; margin-bottom: 16px;">
                            <div class="hint-box" style="background: rgba(102, 179, 255, 0.15); border: 2px solid rgba(102, 179, 255, 0.4); padding: 16px;">
                                <strong style="color: #66b3ff;">üîç HINT:</strong> <span id="hint-text" style="color: #ddd;"></span>
                            </div>
                        </div>
                        
                        <!-- Helper Guide -->
                        <div style="background: rgba(100, 149, 237, 0.1); border-left: 4px solid #6495ed; padding: 12px; margin-bottom: 16px; border-radius: 6px;">
                            <strong style="color: #6495ed;">üìç How to Read Coordinates:</strong><br>
                            <span style="font-size: 13px; color: #aaa; line-height: 1.6;">
                                ‚Ä¢ <strong>0¬∞-30¬∞</strong> = Near equator<br>
                                ‚Ä¢ <strong>30¬∞-60¬∞</strong> = Mid-latitudes (most cities)<br>
                                ‚Ä¢ <strong>60¬∞-90¬∞</strong> = Near poles<br>
                                ‚Ä¢ <strong>N/S</strong> = North or South of equator<br>
                                ‚Ä¢ <strong>E/W</strong> = East or West of Prime Meridian
                            </span>
                        </div>
                        
                        <!-- Your Current Mouse Position -->
                        <div style="background: rgba(0, 255, 127, 0.15); border: 2px solid rgba(0, 255, 127, 0.4); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                            <div style="font-size: 13px; color: #00ff7f; margin-bottom: 8px; font-weight: bold;">üëÜ YOUR MOUSE POSITION:</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: #888; margin-bottom: 4px;">LATITUDE</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #00ff7f;" id="mystery-hover-lat">--</div>
                                </div>
                                <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 11px; color: #888; margin-bottom: 4px;">LONGITUDE</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #00ff7f;" id="mystery-hover-lon">--</div>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: #aaa; margin-top: 10px; text-align: center;">
                                üí° Move your mouse over the map to see coordinates
                            </div>
                        </div>
                        
                        <button class="btn btn-danger" onclick="skipMystery()" style="width: 100%; font-size: 16px; padding: 14px;">‚è≠Ô∏è SKIP THIS ONE (-5 XP)</button>
                    </div>
                    
                    <div id="mystery-intro">
                        <div class="why-play">
                            <strong style="font-size: 16px; color: #ffd700;">WHY PLAY THIS?</strong>
                            <p style="margin-top: 8px; color: #ddd;">
                                Learn to read coordinates while racing against time! Build your geography skills and compete for the highest streak!
                            </p>
                        </div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 16px; border-radius: 8px; margin: 12px 0; font-size: 14px; line-height: 2; color: #ddd;">
                            <strong style="color: #ffd700;">üìö QUICK COORDINATE GUIDE:</strong><br>
                            <div style="margin-top: 8px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                <strong style="color: #66b3ff;">Example: 40.71¬∞ N, 74.01¬∞ W</strong><br>
                                <span style="font-size: 13px; color: #aaa;">
                                    ‚Ä¢ <strong>40.71¬∞ N</strong> = 40 degrees North of equator (New York area)<br>
                                    ‚Ä¢ <strong>74.01¬∞ W</strong> = 74 degrees West of Prime Meridian<br>
                                    ‚Ä¢ This is New York City! üóΩ
                                </span>
                            </div>
                        </div>
                        
                        <div style="background: rgba(255, 215, 0, 0.1); padding: 14px; border-radius: 8px; margin: 12px 0; font-size: 14px; line-height: 1.8; color: #ddd;">
                            <strong style="color: #ffd700;">üéÆ HOW TO PLAY:</strong><br>
                            1Ô∏è‚É£ You'll see coordinates like <strong>40.71¬∞ N, 74.01¬∞ W</strong><br>
                            2Ô∏è‚É£ Think about which region they point to<br>
                            3Ô∏è‚É£ Click on the map where you think it is<br>
                            4Ô∏è‚É£ You have 60 seconds - hints appear at 30s and 15s<br>
                            5Ô∏è‚É£ Get it right to build your streak for bonus XP!
                        </div>
                        
                        <div style="background: rgba(0, 255, 127, 0.1); border: 2px solid rgba(0, 255, 127, 0.3); padding: 12px; border-radius: 8px; margin: 12px 0;">
                            <strong style="color: #00ff7f;">üí° BEGINNER TIPS:</strong><br>
                            <span style="font-size: 13px; color: #aaa; line-height: 1.8;">
                                ‚Ä¢ Look at the first number (latitude) - is it close to 0¬∞ (equator) or 90¬∞ (poles)?<br>
                                ‚Ä¢ Check N/S/E/W to know which hemisphere<br>
                                ‚Ä¢ Don't stress about being exact - within 500km counts!<br>
                                ‚Ä¢ Use hints if you're stuck - learning is the goal!
                            </span>
                        </div>
                        
                        <button class="btn" onclick="startMysteryGame()">üéÆ START MYSTERY CHALLENGE</button>
                        <button class="btn btn-secondary" onclick="showTutorial('mystery')">üìñ FULL TUTORIAL</button>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üìä YOUR STATS</h2>
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-label">Total Solved</div>
                            <div class="stat-value" id="mysteries-solved">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Best Streak</div>
                            <div class="stat-value" id="best-streak">0</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SCAVENGER HUNT MODE -->
            <div id="scavenger-panel" class="game-panel">
                <div class="section">
                    <h2>üåç SCAVENGER HUNT</h2>
                    
                    <div id="scavenger-game" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="scavenger-progress" style="width: 0%">0/10</div>
                        </div>
                        
                        <div id="scavenger-list" style="margin: 16px 0;"></div>
                        
                        <button class="btn btn-secondary" onclick="resetScavenger()">üîÑ NEW HUNT</button>
                    </div>
                    
                    <div id="scavenger-intro">
                        <div class="why-play">
                            <strong style="font-size: 16px; color: #ffd700;">WHY PLAY THIS?</strong>
                            <p style="margin-top: 8px; color: #ddd;">
                                Explore the entire world! Find deserts, mountains, oceans, and cities. Unlock achievement badges and become a geography master.
                            </p>
                        </div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 14px; border-radius: 8px; margin: 12px 0; font-size: 14px; line-height: 1.8; color: #ddd;">
                            <strong style="color: #ffd700;">HOW TO PLAY:</strong><br>
                            1Ô∏è‚É£ You'll get 10 challenges (find a desert, find a mountain, etc.)<br>
                            2Ô∏è‚É£ Use map layers to help you find each one<br>
                            3Ô∏è‚É£ Click on the map when you find it<br>
                            4Ô∏è‚É£ Each correct answer = 20 XP<br>
                            5Ô∏è‚É£ Complete all 10 to unlock achievement badges!
                        </div>
                        
                        <button class="btn" onclick="startScavengerGame()">üéÆ START SCAVENGER HUNT</button>
                        <button class="btn btn-secondary" onclick="showTutorial('scavenger')">üìñ FULL TUTORIAL</button>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üèÜ ACHIEVEMENTS</h2>
                    <div id="achievement-badges">
                        <span class="badge locked">üèúÔ∏è Desert Explorer</span>
                        <span class="badge locked">‚õ∞Ô∏è Mountain Master</span>
                        <span class="badge locked">üåä Ocean Navigator</span>
                        <span class="badge locked">üèôÔ∏è City Finder</span>
                    </div>
                </div>
            </div>
            
            <!-- GUESS LOCATION MODE -->
            <div id="guess-panel" class="game-panel">
                <div class="section">
                    <h2>üì∏ GUESS THE LOCATION</h2>
                    
                    <div id="guess-game" style="display: none;">
                        <div class="score-display">
                            Round: <span id="guess-round">1</span>/5 | Score: <span id="guess-score">0</span>
                        </div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px; text-align: center; margin: 12px 0;">
                            <strong style="color: #ffd700; font-size: 16px;" id="guess-prompt">Look at the satellite view. Where is this?</strong>
                        </div>
                        
                        <div id="guess-options" class="answer-options"></div>
                        
                        <button class="btn btn-secondary" onclick="nextGuessRound()" id="next-guess-btn" style="display: none;">‚û°Ô∏è NEXT LOCATION</button>
                    </div>
                    
                    <div id="guess-intro">
                        <div class="why-play">
                            <strong style="font-size: 16px; color: #ffd700;">WHY PLAY THIS?</strong>
                            <p style="margin-top: 8px; color: #ddd;">
                                Test your world knowledge! Identify famous landmarks from satellite view. Perfect your visual geography skills and impress your friends.
                            </p>
                        </div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 14px; border-radius: 8px; margin: 12px 0; font-size: 14px; line-height: 1.8; color: #ddd;">
                            <strong style="color: #ffd700;">HOW TO PLAY:</strong><br>
                            1Ô∏è‚É£ The map will zoom to a famous location<br>
                            2Ô∏è‚É£ Look at the satellite/terrain view carefully<br>
                            3Ô∏è‚É£ Choose the correct country from 4 options<br>
                            4Ô∏è‚É£ Earn 30 XP for each correct answer<br>
                            5Ô∏è‚É£ Play 5 rounds per game!
                        </div>
                        
                        <button class="btn" onclick="startGuessGame()">üéÆ START GUESS GAME</button>
                        <button class="btn btn-secondary" onclick="showTutorial('guess')">üìñ FULL TUTORIAL</button>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üìä YOUR STATS</h2>
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-label">Correct</div>
                            <div class="stat-value" id="guess-correct">0</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Total Played</div>
                            <div class="stat-value" id="guess-total">0</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- DETECTIVE MISSIONS MODE -->
            <div id="missions-panel" class="game-panel">
                <div class="section">
                    <h2>üèÜ DETECTIVE MISSIONS</h2>
                    <p style="color: #aaa; margin-bottom: 16px;">
                        Complete missions to level up your detective skills and earn massive XP rewards!
                    </p>
                    <div id="missions-list"></div>
                </div>
            </div>
            
            <!-- CREATE HEIST MODE -->
            <div id="create-panel" class="game-panel">
                <div class="section">
                    <h2>üó∫Ô∏è CREATE YOUR OWN HEIST</h2>
                    
                    <div class="why-play" style="margin-bottom: 16px;">
                        <strong style="font-size: 16px; color: #ffd700;">WHY CREATE?</strong>
                        <p style="margin-top: 8px; color: #ddd;">
                            Challenge your classmates! Create tricky mysteries and share them. Earn 50 XP for each heist you create!
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="color: #aaa; font-size: 12px; text-transform: uppercase; font-weight: 600;">Heist Name</label>
                        <input type="text" id="heist-name" class="input-field" placeholder="The Mystery of...">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="color: #aaa; font-size: 12px; text-transform: uppercase; font-weight: 600;">Target Location</label>
                        <div class="coords-display" id="heist-coords" style="font-size: 14px;">
                            Click on map to set location
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="color: #aaa; font-size: 12px; text-transform: uppercase; font-weight: 600;">Clue 1</label>
                        <input type="text" id="clue1" class="input-field" placeholder="Hint about the location...">
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <label style="color: #aaa; font-size: 12px; text-transform: uppercase; font-weight: 600;">Clue 2 (Optional)</label>
                        <input type="text" id="clue2" class="input-field" placeholder="Another hint...">
                    </div>
                    
                    <button class="btn" onclick="saveHeist()">üíæ SAVE HEIST (+50 XP)</button>
                    <button class="btn btn-secondary" onclick="loadHeists()">üìÇ VIEW SAVED HEISTS</button>
                </div>
                
                <div class="section" id="saved-heists-section" style="display: none;">
                    <h2>üìÇ YOUR HEISTS</h2>
                    <div id="saved-heists-list"></div>
                </div>
            </div>
            
            <!-- ALASKA ADVENTURE MODE -->
            <div id="alaska-panel" class="game-panel">
                <div class="section">
                    <h2>üèîÔ∏è ALASKA ADVENTURE</h2>
                    
                    <div id="alaska-game" style="display: none;">
                        
                        <!-- Round Info Header -->
                        <div style="background: linear-gradient(135deg, rgba(100, 149, 237, 0.15), rgba(65, 105, 225, 0.15)); border: 2px solid rgba(100, 149, 237, 0.4); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div>
                                    <div id="round-name" style="font-size: 18px; font-weight: bold; color: #66b3ff; margin-bottom: 4px;">Round 1: Home Territory</div>
                                    <div id="round-description" style="font-size: 13px; color: #aaa;">Explore the Copper River Basin around your hometown</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 28px; font-weight: bold; color: #00ff7f;" id="round-score">0/10</div>
                                    <div style="font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1px;">This Round</div>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="progress-bar" style="margin-bottom: 12px;">
                                <div class="progress-fill" id="alaska-progress" style="width: 0%">0/10</div>
                            </div>
                            
                            <!-- Stats Row -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 12px;">
                                <div style="text-align: center; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                                    <div style="font-size: 20px; font-weight: bold; color: #ffd700;" id="total-found">0</div>
                                    <div style="font-size: 11px; color: #888;">Total Found</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                                    <div style="font-size: 20px; font-weight: bold; color: #66b3ff;" id="current-round">1</div>
                                    <div style="font-size: 11px; color: #888;">Current Round</div>
                                </div>
                                <div style="text-align: center; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                                    <div style="font-size: 20px; font-weight: bold; color: #ff69b4;" id="distance-home">--</div>
                                    <div style="font-size: 11px; color: #888;">Miles from Home</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Locations List -->
                        <div id="alaska-list" style="margin: 16px 0;"></div>
                        
                        <div class="hint-box" style="margin-top: 16px;">
                            <strong>üéØ PRO TIP:</strong> Use Satellite and Terrain layers to help find mountains and rivers!
                        </div>
                        
                        <button class="btn btn-secondary" onclick="resetAlaska()">üîÑ NEW ADVENTURE</button>
                    </div>
                    
                    <div id="alaska-intro">
                        <div class="why-play">
                            <strong style="font-size: 16px; color: #ffd700;">WHY PLAY THIS?</strong>
                            <p style="margin-top: 8px; color: #ddd;">
                                Explore YOUR home state! Start from Glennallen and discover Alaska's incredible geography. See how your hometown connects to the Last Frontier's most amazing places!
                            </p>
                        </div>
                        
                        <div style="background: rgba(102, 126, 234, 0.1); padding: 14px; border-radius: 8px; margin: 12px 0; font-size: 14px; line-height: 1.8; color: #ddd;">
                            <strong style="color: #ffd700;">HOW TO PLAY:</strong><br>
                            1Ô∏è‚É£ Find 10 famous Alaska locations starting from Glennallen<br>
                            2Ô∏è‚É£ Click on each location when you find it<br>
                            3Ô∏è‚É£ Learn cool facts about each place<br>
                            4Ô∏è‚É£ See how far everything is from home!<br>
                            5Ô∏è‚É£ Earn 30 XP for each location + bonus for completing all!
                        </div>
                        
                        <div style="background: rgba(255, 215, 0, 0.15); border: 2px solid #ffd700; padding: 14px; border-radius: 10px; margin: 12px 0; font-size: 13px; line-height: 1.6; color: #ddd;">
                            <strong style="color: #ffd700;">üè† STARTING FROM HOME:</strong><br>
                            Glennallen, Alaska<br>
                            Population: ~500<br>
                            Gateway to Wrangell-St. Elias National Park<br>
                            Crossroads of Glenn & Richardson Highways
                        </div>
                        
                        <button class="btn" onclick="startAlaskaGame()">üéÆ START ALASKA ADVENTURE</button>
                        <button class="btn btn-secondary" onclick="showTutorial('alaska')">üìö FULL TUTORIAL</button>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üèÜ ALASKA ACHIEVEMENTS</h2>
                    <div id="alaska-badges">
                        <span class="badge locked">üèîÔ∏è Mountain Master</span>
                        <span class="badge locked">üåä River Runner</span>
                        <span class="badge locked">üèûÔ∏è Park Explorer</span>
                        <span class="badge locked">üèõÔ∏è City Finder</span>
                        <span class="badge locked">‚ùÑÔ∏è Alaska Expert</span>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- Coordinate Finder Floating Panel -->
    <div id="coordinate-finder-panel">
        <div class="cf-header">
            <h3>üìç Coordinate Finder</h3>
            <button class="cf-close-btn" onclick="closeCoordinateFinderPanel()">√ó</button>
        </div>
        <div class="cf-content">
            <p style="color: #aaa; margin-bottom: 12px; line-height: 1.6;">
                Enter coordinates to find any location on Earth!
            </p>
            
            <!-- Fun Mode Toggle - Phase 4 -->
            <div class="fun-mode-toggle">
                <span class="toggle-label">
                    <span id="fun-mode-label">üìö Academic Mode</span>
                </span>
                <div class="toggle-switch" id="fun-mode-switch" onclick="toggleFunMode()"></div>
            </div>
            
            <!-- Format Toggle -->
            <div style="display: flex; gap: 8px; margin-bottom: 16px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px;">
                <button 
                    id="format-decimal" 
                    class="format-toggle-btn active" 
                    onclick="switchCoordinateFormat('decimal')"
                    style="flex: 1; padding: 10px 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    üìä Decimal
                </button>
                <button 
                    id="format-cardinal" 
                    class="format-toggle-btn" 
                    onclick="switchCoordinateFormat('cardinal')"
                    style="flex: 1; padding: 10px 8px; background: rgba(102, 126, 234, 0.2); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 6px; color: #aaa; font-weight: 600; cursor: pointer; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    üß≠ N/S/E/W
                </button>
            </div>
            
            <!-- Decimal Format Inputs (default) -->
            <div id="decimal-inputs" style="display: block;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; color: #888; font-size: 12px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Latitude</label>
                        <input 
                            type="number" 
                            id="cf-latitude-decimal" 
                            placeholder="40.71" 
                            step="0.01" 
                            min="-90" 
                            max="90"
                            style="width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: white; font-size: 16px; font-weight: bold;"
                            oninput="validateCoordinateInputs()"
                        >
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">(-90 to 90)</div>
                    </div>
                    <div>
                        <label style="display: block; color: #888; font-size: 12px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Longitude</label>
                        <input 
                            type="number" 
                            id="cf-longitude-decimal" 
                            placeholder="-74.01" 
                            step="0.01" 
                            min="-180" 
                            max="180"
                            style="width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: white; font-size: 16px; font-weight: bold;"
                            oninput="validateCoordinateInputs()"
                        >
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">(-180 to 180)</div>
                    </div>
                </div>
            </div>
            
            <!-- Cardinal Format Inputs (N/S/E/W) -->
            <div id="cardinal-inputs" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; color: #888; font-size: 12px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Latitude</label>
                        <div style="display: flex; gap: 8px;">
                            <input 
                                type="number" 
                                id="cf-latitude-cardinal" 
                                placeholder="40.71" 
                                step="0.01" 
                                min="0" 
                                max="90"
                                style="flex: 1; padding: 12px; background: rgba(0,0,0,0.3); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: white; font-size: 16px; font-weight: bold;"
                                oninput="validateCoordinateInputs()"
                            >
                            <select 
                                id="cf-lat-direction" 
                                style="padding: 12px; background: rgba(0,0,0,0.3); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: white; font-size: 16px; font-weight: bold; cursor: pointer;"
                                onchange="validateCoordinateInputs()">
                                <option value="N">N</option>
                                <option value="S">S</option>
                            </select>
                        </div>
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">(0 to 90)</div>
                    </div>
                    <div>
                        <label style="display: block; color: #888; font-size: 12px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">Longitude</label>
                        <div style="display: flex; gap: 8px;">
                            <input 
                                type="number" 
                                id="cf-longitude-cardinal" 
                                placeholder="74.01" 
                                step="0.01" 
                                min="0" 
                                max="180"
                                style="flex: 1; padding: 12px; background: rgba(0,0,0,0.3); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: white; font-size: 16px; font-weight: bold;"
                                oninput="validateCoordinateInputs()"
                            >
                            <select 
                                id="cf-lon-direction" 
                                style="padding: 12px; background: rgba(0,0,0,0.3); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 8px; color: white; font-size: 16px; font-weight: bold; cursor: pointer;"
                                onchange="validateCoordinateInputs()">
                                <option value="E">E</option>
                                <option value="W" selected>W</option>
                            </select>
                        </div>
                        <div style="font-size: 11px; color: #666; margin-top: 4px;">(0 to 180)</div>
                    </div>
                </div>
            </div>
            
            <!-- Error Message -->
            <div id="cf-error" style="display: none; background: rgba(255, 107, 107, 0.2); border: 2px solid rgba(255, 107, 107, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 16px; color: #ff6b6b; font-size: 14px;"></div>
            
            <!-- Helper Guide -->
            <div style="background: rgba(102, 179, 255, 0.1); border-left: 4px solid #66b3ff; padding: 12px; margin-bottom: 16px; border-radius: 6px; word-wrap: break-word; overflow-wrap: break-word;">
                <strong style="color: #66b3ff; font-size: 13px;">üí° Quick Guide:</strong><br>
                <span style="font-size: 12px; color: #aaa; line-height: 1.8;">
                    ‚Ä¢ <strong>Latitude:</strong> North (+) or South (-)<br>
                    ‚Ä¢ <strong>Longitude:</strong> East (+) or West (-)<br>
                    ‚Ä¢ <strong>Examples:</strong> NYC (40.71, -74.01),<br>&nbsp;&nbsp;Sydney (-33.87, 151.21)
                </span>
            </div>
            
            <!-- Find Location Button -->
            <button 
                id="cf-find-btn" 
                class="btn" 
                onclick="findCoordinateLocation()" 
                disabled
                style="width: 100%; font-size: 16px; padding: 14px; opacity: 0.5; cursor: not-allowed;">
                üó∫Ô∏è FIND LOCATION!
            </button>
        </div>
    </div>
    
    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay" class="tutorial-overlay">
        <div class="tutorial-content" id="tutorial-content">
            <!-- Tutorial content will be inserted here -->
        </div>
    </div>
    
    <!-- Coordinate Finder Timer Overlay (Fun & Draggable!) -->
    <div id="cf-timer-overlay" style="display: none; position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95)); border: 3px solid #ffd700; border-radius: 16px; padding: 20px 24px; z-index: 3000; text-align: center; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8), 0 0 20px rgba(255, 215, 0, 0.3); cursor: move; user-select: none; min-width: 200px;">
        <div style="font-size: 13px; color: #ffd700; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; font-weight: bold;" id="cf-stage-label">üåç Stage 1: Hemisphere</div>
        <div style="font-size: 48px; font-weight: 900; color: #fff; text-shadow: 0 0 15px rgba(255, 255, 255, 0.5), 0 2px 4px rgba(0, 0, 0, 0.5); margin-bottom: 8px; font-family: 'Arial Black', sans-serif;" id="cf-timer-display">20</div>
        <div style="font-size: 11px; color: #ffeb3b; font-weight: 600; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">üëÜ Click map to skip fr fr</div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification"></div>
    
    <!-- Achievement Testing Debug Panel (Press Ctrl+Shift+A to toggle) -->
    <div id="debug-panel" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 800px; max-height: 80vh; background: rgba(0, 0, 0, 0.95); border: 3px solid #ffd700; border-radius: 12px; padding: 20px; z-index: 10000; overflow-y: auto; box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="color: #ffd700; margin: 0; font-size: 24px;">üéÆ Achievement Testing Console</h2>
            <button onclick="toggleDebugPanel()" style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;">‚úñ Close</button>
        </div>
        
        <div style="background: rgba(255, 215, 0, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 3px solid #ffd700;">
            <p style="color: #ffd700; margin: 0; font-size: 14px;">
                <strong>üí° Quick Test:</strong> Click any button below to instantly set achievement stats and trigger unlocks!
            </p>
        </div>
        
        <div id="debug-content" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <!-- Content will be populated by JavaScript -->
        </div>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(255, 215, 0, 0.3);">
            <h3 style="color: #66b3ff; font-size: 18px; margin-bottom: 10px;">üîß Manual Controls:</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="clearAllAchievements()" class="btn btn-secondary" style="font-size: 14px;">üóëÔ∏è Clear All</button>
                <button onclick="unlockAllAchievements()" class="btn" style="font-size: 14px;">üèÜ Unlock All</button>
                <button onclick="showAchievementStats()" class="btn btn-secondary" style="font-size: 14px;">üìä View Stats</button>
                <button onclick="testRandomAchievement()" class="btn" style="font-size: 14px;">üé≤ Test Random</button>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    
    <script>
        // ========================================
        // TOAST NOTIFICATION SYSTEM
        // ========================================
        
        /**
         * Show a toast notification
         * @param {string} type - 'success', 'error', 'warning', or 'info'
         * @param {string} title - Toast title
         * @param {string} message - Toast message
         * @param {number} duration - Duration in ms (default 3000)
         */
        function showToast(type = 'info', title, message, duration = 3000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
            `;
            
            container.appendChild(toast);
            
            // Remove after duration
            setTimeout(() => {
                toast.style.animation = 'toastFadeOut 0.3s ease-in';
                setTimeout(() => {
                    if (toast.parentNode) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }
        
        // ========================================
        // LOADING STATE SYSTEM
        // ========================================
        
        /**
         * Show loading overlay
         * @param {string} text - Main loading text
         * @param {string} subtext - Subtext (optional)
         */
        function showLoading(text = 'Loading...', subtext = 'Please wait') {
            const overlay = document.getElementById('loading-overlay');
            const textEl = document.getElementById('loading-text');
            const subtextEl = document.getElementById('loading-subtext');
            
            if (overlay) {
                if (textEl) textEl.textContent = text;
                if (subtextEl) subtextEl.textContent = subtext;
                overlay.classList.add('active');
            }
        }
        
        /**
         * Hide loading overlay
         */
        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
        }
        
        /**
         * Add loading state to a button
         * @param {HTMLElement} button - Button element
         */
        function setButtonLoading(button) {
            if (button) {
                button.classList.add('loading');
                button.disabled = true;
            }
        }
        
        /**
         * Remove loading state from a button
         * @param {HTMLElement} button - Button element
         */
        function removeButtonLoading(button) {
            if (button) {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }
        
        // ========================================
        // LOCATION EXPLORER SIDEBAR FUNCTIONS
        // Phase 1.2: Interactive sidebar controls
        // GLOBAL SCOPE - Accessible from HTML onclick handlers
        // ========================================
        
        // Global variable for currently displayed location
        let currentLocation = null;
        
        // Collection system - stores explored locations
        let exploredLocations = [];
        
        // Style mode: 'gen-alpha' or 'classic'
        let locationStyleMode = 'classic';
        
        // Coordinate display format: 'decimal' or 'dms' (Degrees Minutes Seconds)
        let coordinateFormat = 'decimal';
        let currentLat = 0;
        let currentLng = 0;
        
        // Convert decimal degrees to DMS (Degrees Minutes Seconds)
        function decimalToDMS(decimal, isLat) {
            const absolute = Math.abs(decimal);
            const degrees = Math.floor(absolute);
            const minutesDecimal = (absolute - degrees) * 60;
            const minutes = Math.floor(minutesDecimal);
            const seconds = Math.floor((minutesDecimal - minutes) * 60);
            
            let direction;
            if (isLat) {
                direction = decimal >= 0 ? 'N' : 'S';
            } else {
                direction = decimal >= 0 ? 'E' : 'W';
            }
            
            return `${degrees}¬∞ ${minutes}' ${seconds}" ${direction}`;
        }
        
        // Toggle between decimal and DMS format
        function toggleCoordinateFormat() {
            coordinateFormat = coordinateFormat === 'decimal' ? 'dms' : 'decimal';
            
            // Save preference
            try {
                localStorage.setItem('coordinateFormat', coordinateFormat);
            } catch (e) {
                console.warn('Could not save coordinate format preference:', e);
            }
            
            // Update display
            updateCoordinateDisplay();
            
            console.log('üìç Coordinate format changed to:', coordinateFormat.toUpperCase());
        }
        
        // Update the coordinate display based on current format
        function updateCoordinateDisplay() {
            const coordsElement = document.getElementById('location-coords');
            if (!coordsElement) return;
            
            if (coordinateFormat === 'decimal') {
                // Decimal format: 7.7110¬∞N, 6.6797¬∞E
                const latDir = currentLat >= 0 ? 'N' : 'S';
                const lonDir = currentLng >= 0 ? 'E' : 'W';
                coordsElement.textContent = `${Math.abs(currentLat).toFixed(4)}¬∞${latDir}, ${Math.abs(currentLng).toFixed(4)}¬∞${lonDir}`;
            } else {
                // DMS format: 7¬∞ 42' 40" N, 6¬∞ 40' 47" E
                coordsElement.textContent = `${decimalToDMS(currentLat, true)}, ${decimalToDMS(currentLng, false)}`;
            }
        }
        
        // Load coordinate format preference
        function loadCoordinateFormatPreference() {
            try {
                const saved = localStorage.getItem('coordinateFormat');
                if (saved && (saved === 'decimal' || saved === 'dms')) {
                    coordinateFormat = saved;
                    console.log('üìç Loaded coordinate format preference:', coordinateFormat.toUpperCase());
                }
            } catch (e) {
                console.warn('Could not load coordinate format preference:', e);
            }
        }
        
        // Load explored locations from localStorage
        function loadExploredLocations() {
            try {
                const saved = localStorage.getItem('exploredLocations');
                if (saved) {
                    exploredLocations = JSON.parse(saved);
                    updateCollectionCount();
                    console.log('üìç Loaded', exploredLocations.length, 'explored locations');
                }
            } catch (e) {
                console.warn('Could not load explored locations:', e);
            }
        }
        
        // Save explored locations to localStorage
        function saveExploredLocations() {
            try {
                localStorage.setItem('exploredLocations', JSON.stringify(exploredLocations));
                updateCollectionCount();
            } catch (e) {
                console.warn('Could not save explored locations:', e);
            }
        }
        
        // Update collection counter badge
        function updateCollectionCount() {
            const countElement = document.getElementById('locations-explored-count');
            if (countElement) {
                countElement.textContent = exploredLocations.length;
            }
        }
        
        // Toggle sidebar visibility
        function toggleLocationSidebar() {
            const sidebar = document.getElementById('location-explorer-sidebar');
            const reopenBtn = document.getElementById('reopen-sidebar-btn');
            if (sidebar) {
                const isClosing = sidebar.classList.contains('active');
                sidebar.classList.toggle('active');
                
                // Show reopen button when closing sidebar (but only if we have location data)
                if (reopenBtn && currentLocation) {
                    if (isClosing) {
                        reopenBtn.classList.add('visible');
                    } else {
                        reopenBtn.classList.remove('visible');
                    }
                }
                
                console.log('üìç Sidebar toggled:', sidebar.classList.contains('active') ? 'open' : 'closed');
            }
        }
        
        // Show sidebar (called when user drops a pin)
        function showLocationSidebar() {
            const sidebar = document.getElementById('location-explorer-sidebar');
            const reopenBtn = document.getElementById('reopen-sidebar-btn');
            if (sidebar) {
                sidebar.classList.add('active');
                // Hide reopen button when opening sidebar
                if (reopenBtn) {
                    reopenBtn.classList.remove('visible');
                }
                console.log('üìç Sidebar opened');
            }
        }
        
        // Hide sidebar
        function hideLocationSidebar() {
            const sidebar = document.getElementById('location-explorer-sidebar');
            const reopenBtn = document.getElementById('reopen-sidebar-btn');
            if (sidebar) {
                sidebar.classList.remove('active');
                // Show reopen button when hiding sidebar (if we have location data)
                if (reopenBtn && currentLocation) {
                    reopenBtn.classList.add('visible');
                }
                console.log('üìç Sidebar closed');
            }
        }
        
        // Reopen sidebar with current location data (no new API calls!)
        function reopenLocationSidebar() {
            const sidebar = document.getElementById('location-explorer-sidebar');
            const reopenBtn = document.getElementById('reopen-sidebar-btn');
            
            if (!sidebar) return;
            
            // Simply show the sidebar again - data is already loaded!
            sidebar.classList.add('active');
            
            // Hide reopen button
            if (reopenBtn) {
                reopenBtn.classList.remove('visible');
            }
            
            console.log('üìç Sidebar reopened with existing location data');
        }
        
        // Toggle individual card expand/collapse
        function toggleCard(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.classList.toggle('collapsed');
                console.log('üÉè Card', cardId, card.classList.contains('collapsed') ? 'collapsed' : 'expanded');
            }
        }
        
        // Toggle between Gen Alpha and Classic styles
        function toggleLocationStyle() {
            const sidebar = document.getElementById('location-explorer-sidebar');
            const toggleBtn = document.getElementById('style-toggle-btn');
            
            if (!sidebar || !toggleBtn) return;
            
            // Toggle mode
            locationStyleMode = locationStyleMode === 'classic' ? 'gen-alpha' : 'classic';
            
            // Update sidebar class
            if (locationStyleMode === 'gen-alpha') {
                sidebar.classList.add('gen-alpha-mode');
                toggleBtn.textContent = 'üî•';
                console.log('üî• Gen Alpha mode activated');
            } else {
                sidebar.classList.remove('gen-alpha-mode');
                toggleBtn.textContent = 'üìö';
                console.log('üìö Classic mode activated');
            }
            
            // Save preference
            try {
                localStorage.setItem('locationStyleMode', locationStyleMode);
            } catch (e) {
                console.warn('Could not save style preference:', e);
            }
        }
        
        // Load style preference from localStorage
        function loadLocationStylePreference() {
            try {
                const saved = localStorage.getItem('locationStyleMode');
                if (saved) {
                    locationStyleMode = saved;
                    const sidebar = document.getElementById('location-explorer-sidebar');
                    const toggleBtn = document.getElementById('style-toggle-btn');
                    
                    if (locationStyleMode === 'gen-alpha' && sidebar) {
                        sidebar.classList.add('gen-alpha-mode');
                        if (toggleBtn) toggleBtn.textContent = 'üî•';
                    }
                    
                    console.log('üé® Style preference loaded:', locationStyleMode);
                }
            } catch (e) {
                console.warn('Could not load style preference:', e);
            }
        }
        
        // Populate location data in sidebar (Phase 1.3 - REAL DATA!)
        async function populateLocationData(lat, lng) {
            console.log('üìç Populating location data for:', lat, lng);
            
            // Store current location
            currentLocation = { lat, lng, timestamp: Date.now() };
            
            // Show sidebar
            showLocationSidebar();
            
            // Show loading state
            showLoadingState();
            
            try {
                // Step 1: Reverse Geocoding (get location name, country, etc.)
                console.log('üîç Step 1: Calling reverseGeocode...');
                const geocodeData = await reverseGeocode(lat, lng);
                console.log('üîç geocodeData:', geocodeData);
                
                // Step 2: Get country details if we found a country
                let countryData = null;
                if (geocodeData.country) {
                    console.log('üîç Step 2: Getting country data for:', geocodeData.countryCode);
                    countryData = await getCountryData(geocodeData.countryCode);
                    console.log('üîç countryData:', countryData);
                } else {
                    console.log('‚ö†Ô∏è No country found in geocodeData');
                }
                
                // Step 3: Calculate distance and bearing from Glennallen
                const GLENNALLEN = { lat: 62.1089, lon: -145.5467 };
                const distance = calculateDistance(GLENNALLEN.lat, GLENNALLEN.lon, lat, lng);
                const bearing = calculateBearing(GLENNALLEN.lat, GLENNALLEN.lon, lat, lng);
                console.log('üîç Step 3: Distance:', distance, 'km, Bearing:', bearing);
                
                // Step 4: Populate all cards with data
                console.log('üîç Step 4: Populating cards...');
                populateLocationHeader(geocodeData, countryData, lat, lng);
                populateQuickFacts(geocodeData, countryData);
                populateComparison(distance, bearing, geocodeData);
                
                // Step 5: Populate nearby places (Phase 2)
                populateNearbyPlaces(lat, lng);
                
                // Step 6: Populate AI Facts, Photos, and Weather (Phase 3)
                // These will only work after deployment to Netlify
                const locationName = geocodeData.city || geocodeData.town || geocodeData.village || geocodeData.state || geocodeData.country || 'location';
                const countryName = countryData?.name || geocodeData.country || 'Unknown';
                
                // NEW FLOW: Fetch AI facts ‚Üí Match photos to facts ‚Üí Display together!
                console.log('üß† Fetching AI facts + matching photos...');
                
                // Show Gen Alpha loading animation!
                showGenAlphaLoading();
                
                fetchLocationFacts(locationName, countryName)
                    .then(async facts => {
                        if (facts && facts.length > 0) {
                            console.log(`‚úÖ Got ${facts.length} facts, now matching photos...`);
                            
                            // Match photos to facts using vision AI
                            try {
                                const matchedData = await matchPhotosToFacts(facts, locationName, countryName);
                                populateAIFactsWithPhotos(matchedData);
                                
                                // Generate Geography in Real Life content
                                generateRealLifeGeography(locationName, countryName, facts);
                            } catch (err) {
                                console.log('‚ö†Ô∏è Photo matching failed, showing facts only:', err.message);
                                populateAIFacts(facts);
                                generateRealLifeGeography(locationName, countryName, facts);
                            }
                        } else {
                            populateAIFacts([]);
                        }
                    })
                    .catch(err => {
                        console.log('‚ÑπÔ∏è AI facts not available yet (needs deployment)');
                        populateAIFacts([]);
                    });
                
                // Fetch general photos for the Photos card (separate from fact photos)
                console.log('üì∏ Fetching general location photos...');
                fetchLocationPhotos(locationName, countryName)
                    .then(photos => populatePhotos(photos))
                    .catch(err => {
                        console.log('‚ÑπÔ∏è Photos not available yet (needs deployment)');
                        populatePhotos([]);
                    });
                
                // Fetch weather (async, don't wait)
                fetchLocationWeather(lat, lng)
                    .then(weather => populateWeather(weather))
                    .catch(err => {
                        console.log('‚ÑπÔ∏è Weather not available yet (needs deployment)');
                        populateWeather(null);
                    });
                
                // Step 7: Add to collection (if new location)
                const locationData = {
                    lat,
                    lng,
                    name: geocodeData.display_name || `${lat.toFixed(4)}¬∞, ${lng.toFixed(4)}¬∞`,
                    country: geocodeData.country,
                    countryCode: geocodeData.countryCode,
                    city: geocodeData.city || geocodeData.town || geocodeData.village,
                    distance: distance
                };
                addToCollection(locationData);
                
                console.log('‚úÖ Location data loaded successfully!');
                
            } catch (error) {
                console.error('‚ùå Error loading location data:', error);
                showErrorState(error.message);
            }
        }
        
        // Reverse geocoding using Nominatim API (free, no key required)
        async function reverseGeocode(lat, lng) {
            const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1`;
            
            const response = await fetch(url, {
                headers: {
                    'User-Agent': 'MrsSomersMaps Educational App'
                }
            });
            
            if (!response.ok) {
                throw new Error('Geocoding failed');
            }
            
            const data = await response.json();
            
            // Extract relevant information
            return {
                display_name: data.display_name,
                country: data.address?.country,
                countryCode: data.address?.country_code?.toUpperCase(),
                city: data.address?.city || data.address?.town || data.address?.village || data.address?.municipality,
                state: data.address?.state,
                ocean: data.address?.ocean || data.address?.sea,
                isWater: data.type === 'body_of_water' || data.class === 'natural' && data.type === 'water',
                raw: data
            };
        }
        
        // Get country data from REST Countries API (free, no key required)
        async function getCountryData(countryCode) {
            if (!countryCode) return null;
            
            const url = `https://restcountries.com/v3.1/alpha/${countryCode}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) return null;
                
                const data = await response.json();
                const country = data[0];
                
                return {
                    name: country.name.common,
                    capital: country.capital ? country.capital[0] : 'N/A',
                    population: country.population,
                    area: country.area,
                    continent: country.continents ? country.continents[0] : 'Unknown',
                    flag: country.flag, // Emoji flag
                    flagImage: country.flags?.png || country.flags?.svg, // Actual flag image URL
                    flagAlt: country.flags?.alt || country.name.common + ' flag',
                    timezone: country.timezones ? country.timezones[0] : 'Unknown',
                    currencies: country.currencies,
                    languages: country.languages
                };
            } catch (error) {
                console.warn('Could not fetch country data:', error);
                return null;
            }
        }
        
        // Populate Card 1: Location Header
        function populateLocationHeader(geocodeData, countryData, lat, lng) {
            // Flag - Use actual flag image if available (BIGGER SIZE: 64x48)
            const flagElement = document.getElementById('location-flag');
            if (flagElement) {
                if (countryData?.flagImage) {
                    // Replace text content with an image - BIGGER!
                    flagElement.innerHTML = `<img src="${countryData.flagImage}" alt="${countryData.flagAlt || 'Flag'}" style="width: 64px; height: 48px; object-fit: cover; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" />`;
                } else {
                    // Fallback to emoji or globe
                    flagElement.textContent = countryData?.flag || 'üåç';
                }
            }
            
            // Location name - Prefer English names
            const nameElement = document.getElementById('location-name');
            if (nameElement) {
                // Priority: Use countryData for English name, then fall back to geocode data
                let name = geocodeData.city || geocodeData.town || geocodeData.village || 
                           geocodeData.state || geocodeData.region ||
                           (countryData?.name) || geocodeData.country || 'Unknown Location';
                
                if (geocodeData.isWater && geocodeData.ocean) {
                    name = geocodeData.ocean;
                }
                nameElement.textContent = name;
            }
            
            // Coordinates - Store and display in current format
            currentLat = lat;
            currentLng = lng;
            updateCoordinateDisplay();
            
            // Land/Ocean badge
            const badgeElement = document.getElementById('location-type-badge');
            if (badgeElement) {
                if (geocodeData.isWater || geocodeData.ocean) {
                    badgeElement.textContent = 'üåä Ocean';
                    badgeElement.style.background = 'rgba(59, 130, 246, 0.2)';
                    badgeElement.style.borderColor = 'rgba(59, 130, 246, 0.4)';
                    badgeElement.style.color = '#60a5fa';
                } else {
                    badgeElement.textContent = 'üèîÔ∏è Land';
                    badgeElement.style.background = 'rgba(34, 197, 94, 0.2)';
                    badgeElement.style.borderColor = 'rgba(34, 197, 94, 0.4)';
                    badgeElement.style.color = '#4ade80';
                }
            }
        }
        
        // Populate Card 2: Quick Facts
        function populateQuickFacts(geocodeData, countryData) {
            console.log('üîç populateQuickFacts called with:', { geocodeData, countryData });
            
            // Country
            const countryElement = document.getElementById('fact-country');
            if (countryElement) {
                const countryValue = geocodeData.country || 'Unknown';
                console.log('üîç Setting country to:', countryValue);
                countryElement.textContent = countryValue;
            } else {
                console.error('‚ùå fact-country element not found!');
            }
            
            // Capital
            const capitalElement = document.getElementById('fact-capital');
            if (capitalElement) {
                const capitalValue = countryData?.capital || 'N/A';
                console.log('üîç Setting capital to:', capitalValue);
                capitalElement.textContent = capitalValue;
            } else {
                console.error('‚ùå fact-capital element not found!');
            }
            
            // Population
            const populationElement = document.getElementById('fact-population');
            if (populationElement) {
                if (countryData?.population) {
                    const popValue = countryData.population.toLocaleString();
                    console.log('üîç Setting population to:', popValue);
                    populationElement.textContent = popValue;
                } else {
                    populationElement.textContent = 'N/A';
                }
            } else {
                console.error('‚ùå fact-population element not found!');
            }
            
            // Area
            const areaElement = document.getElementById('fact-area');
            if (areaElement) {
                if (countryData?.area) {
                    const areaValue = `${countryData.area.toLocaleString()} km¬≤`;
                    console.log('üîç Setting area to:', areaValue);
                    areaElement.textContent = areaValue;
                } else {
                    areaElement.textContent = 'N/A';
                }
            } else {
                console.error('‚ùå fact-area element not found!');
            }
            
            // Continent
            const continentElement = document.getElementById('fact-continent');
            if (continentElement) {
                const continentValue = countryData?.continent || 'Unknown';
                console.log('üîç Setting continent to:', continentValue);
                continentElement.textContent = continentValue;
            } else {
                console.error('‚ùå fact-continent element not found!');
            }
            
            // Timezone
            const timezoneElement = document.getElementById('fact-timezone');
            if (timezoneElement) {
                const timezoneValue = countryData?.timezone || 'Unknown';
                console.log('üîç Setting timezone to:', timezoneValue);
                timezoneElement.textContent = timezoneValue;
            } else {
                console.error('‚ùå fact-timezone element not found!');
            }
            
            console.log('‚úÖ populateQuickFacts complete');
        }
        
        // Populate Card 3: Comparison to Home
        function populateComparison(distance, bearing, geocodeData) {
            // Distance
            const distanceElement = document.getElementById('distance-value');
            if (distanceElement) {
                // Convert km to miles
                const miles = distance * 0.621371;
                distanceElement.textContent = miles.toLocaleString(undefined, { maximumFractionDigits: 0 });
            }
            
            // Bearing
            const bearingElement = document.getElementById('bearing-text');
            if (bearingElement) {
                bearingElement.textContent = `${bearing} from Glennallen`;
            }
            
            // Timezone difference
            const timezoneElement = document.getElementById('timezone-diff-text');
            if (timezoneElement) {
                // Alaska is UTC-9 (AKST) or UTC-8 (AKDT)
                // For simplicity, we'll show "Same timezone" for Alaska, otherwise "Different timezone"
                if (geocodeData.state === 'Alaska') {
                    timezoneElement.textContent = 'Same timezone ‚è∞';
                } else {
                    timezoneElement.textContent = 'Different timezone üåê';
                }
            }
        }
        
        // Show loading state in all cards
        function showLoadingState() {
            // Location name
            const nameElement = document.getElementById('location-name');
            if (nameElement) {
                nameElement.textContent = 'Loading...';
            }
            
            // Show loading in facts
            ['fact-country', 'fact-capital', 'fact-population', 'fact-area', 'fact-continent', 'fact-timezone'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = '...';
            });
            
            // Show loading in comparison
            const distanceElement = document.getElementById('distance-value');
            if (distanceElement) distanceElement.textContent = '...';
        }
        
        // Show error state
        function showErrorState(message) {
            const nameElement = document.getElementById('location-name');
            if (nameElement) {
                nameElement.textContent = 'Error loading data';
            }
            console.error('Location data error:', message);
        }
        
        // ========================================
        // PHASE 2: NEARBY PLACES CARD
        // ========================================
        
        // Fetch nearby places using Overpass API (OpenStreetMap)
        async function fetchNearbyPlaces(lat, lng) {
            const radius = 10000; // 10km radius
            
            // Overpass query for interesting places
            // Looking for: cities, towns, villages, peaks, lakes, parks, landmarks
            const query = `
                [out:json][timeout:10];
                (
                    node["place"~"city|town|village"](around:${radius},${lat},${lng});
                    node["natural"~"peak|volcano|lake"](around:${radius},${lat},${lng});
                    node["tourism"~"attraction|viewpoint"](around:${radius},${lat},${lng});
                    way["leisure"="park"](around:${radius},${lat},${lng});
                );
                out body 20;
            `;
            
            const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Overpass API request failed');
                
                const data = await response.json();
                return data.elements || [];
            } catch (error) {
                console.warn('Could not fetch nearby places:', error);
                return [];
            }
        }
        
        // Populate nearby places card
        async function populateNearbyPlaces(lat, lng) {
            const contentElement = document.getElementById('nearby-content');
            if (!contentElement) return;
            
            // Show loading
            contentElement.innerHTML = `
                <div class="loading-placeholder">
                    <span class="placeholder-icon">‚è≥</span>
                    <p>Searching for nearby places...</p>
                </div>
            `;
            
            try {
                const places = await fetchNearbyPlaces(lat, lng);
                
                if (places.length === 0) {
                    contentElement.innerHTML = `
                        <div class="no-nearby">
                            <span style="font-size: 32px;">üèúÔ∏è</span>
                            <p>No nearby places found within 10km</p>
                        </div>
                    `;
                    return;
                }
                
                // Calculate distances and sort by proximity
                const placesWithDistance = places
                    .map(place => {
                        const placeLat = place.lat || (place.center ? place.center.lat : null);
                        const placeLon = place.lon || (place.center ? place.center.lon : null);
                        
                        if (!placeLat || !placeLon) return null;
                        
                        const distance = calculateDistance(lat, lng, placeLat, placeLon);
                        
                        return {
                            name: place.tags?.name || 'Unnamed',
                            type: place.tags?.place || place.tags?.natural || place.tags?.tourism || place.tags?.leisure || 'location',
                            distance: distance,
                            lat: placeLat,
                            lon: placeLon,
                            tags: place.tags
                        };
                    })
                    .filter(p => p !== null && p.name !== 'Unnamed')
                    .sort((a, b) => a.distance - b.distance)
                    .slice(0, 10); // Top 10 closest
                
                if (placesWithDistance.length === 0) {
                    contentElement.innerHTML = `
                        <div class="no-nearby">
                            <span style="font-size: 32px;">üèúÔ∏è</span>
                            <p>No named places found nearby</p>
                        </div>
                    `;
                    return;
                }
                
                // Render list
                let html = '<div class="nearby-list">';
                
                placesWithDistance.forEach(place => {
                    const icon = getPlaceIcon(place.type);
                    const distanceMiles = (place.distance * 0.621371).toFixed(1);
                    const distanceKm = place.distance.toFixed(1);
                    
                    html += `
                        <div class="nearby-item">
                            <span class="nearby-item-icon">${icon}</span>
                            <div class="nearby-item-info">
                                <div class="nearby-item-name">${escapeHtml(place.name)}</div>
                                <div class="nearby-item-type">${capitalizeFirst(place.type)}</div>
                            </div>
                            <div class="nearby-item-distance">
                                ${distanceMiles} mi
                                <div style="font-size: 10px; color: #666;">${distanceKm} km</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                contentElement.innerHTML = html;
                
                console.log('‚úÖ Loaded', placesWithDistance.length, 'nearby places');
                
            } catch (error) {
                console.error('Error populating nearby places:', error);
                contentElement.innerHTML = `
                    <div class="no-nearby">
                        <span style="font-size: 32px;">‚ö†Ô∏è</span>
                        <p>Could not load nearby places</p>
                    </div>
                `;
            }
        }
        
        // Get appropriate icon for place type
        function getPlaceIcon(type) {
            const icons = {
                'city': 'üèôÔ∏è',
                'town': 'üèòÔ∏è',
                'village': 'üè°',
                'peak': '‚õ∞Ô∏è',
                'volcano': 'üåã',
                'lake': 'üèûÔ∏è',
                'park': 'üå≥',
                'attraction': 'üé≠',
                'viewpoint': 'üëÅÔ∏è',
                'default': 'üìç'
            };
            return icons[type] || icons['default'];
        }
        
        // Capitalize first letter
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Add location to collection
        function addToCollection(locationData) {
            // Check if already collected (within 1km)
            const isDuplicate = exploredLocations.some(loc => {
                const distance = calculateDistance(
                    loc.lat, loc.lng,
                    locationData.lat, locationData.lng
                );
                return distance < 1; // Less than 1km apart
            });
            
            if (!isDuplicate) {
                exploredLocations.push({
                    ...locationData,
                    exploredAt: Date.now()
                });
                saveExploredLocations();
                console.log('‚úÖ Location added to collection!');
                return true;
            } else {
                console.log('‚ÑπÔ∏è Location already in collection');
                return false;
            }
        }
        
        // Calculate distance between two points (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distance in km
        }
        
        // Calculate RHUMB LINE bearing between two points (constant compass direction)
        // This is more intuitive than great circle bearing for educational purposes
        function calculateBearing(lat1, lon1, lat2, lon2) {
            // Convert to radians
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            let ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            
            // Normalize longitude difference to [-180, 180]
            if (ŒîŒª > Math.PI) ŒîŒª -= 2 * Math.PI;
            if (ŒîŒª < -Math.PI) ŒîŒª += 2 * Math.PI;
            
            // Calculate Œîœà (difference in the isometric latitude)
            const Œîœà = Math.log(Math.tan(œÜ2/2 + Math.PI/4) / Math.tan(œÜ1/2 + Math.PI/4));
            
            // Calculate bearing
            const Œ∏ = Math.atan2(ŒîŒª, Œîœà);
            const bearing = (Œ∏ * 180 / Math.PI + 360) % 360;
            
            // DEBUG
            console.log('üß≠ Rhumb Line Bearing (Constant Compass Direction):');
            console.log('  From:', lat1.toFixed(4) + '¬∞', lon1.toFixed(4) + '¬∞');
            console.log('  To:', lat2.toFixed(4) + '¬∞', lon2.toFixed(4) + '¬∞');
            console.log('  Bearing:', bearing.toFixed(2) + '¬∞');
            
            // Convert to compass direction
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(bearing / 22.5) % 16;
            console.log('  Direction:', directions[index]);
            
            return directions[index];
        }
        
        // View explored locations collection (opens modal - Phase 6)
        function viewExploredLocations() {
            console.log('üóÇÔ∏è Viewing collection of', exploredLocations.length, 'locations');
            
            if (exploredLocations.length === 0) {
                alert('üìç No locations explored yet!\n\nDrop a pin on the map to start your collection!');
                return;
            }
            
            // Phase 6 will add:
            // - Modal popup with grid of collected locations
            // - Click to revisit location
            // - Delete from collection
            // - Export/share collection
            
            // For now, show simple list in console
            console.table(exploredLocations.map(loc => ({
                name: loc.name || 'Unknown',
                lat: loc.lat.toFixed(4),
                lng: loc.lng.toFixed(4),
                exploredAt: new Date(loc.exploredAt).toLocaleDateString()
            })));
            
            alert(`üìç Your Collection (${exploredLocations.length} places)\n\nCheck the console for details!\n\nCollection modal coming in Phase 6!`);
        }
        
        // Initialize Location Explorer on page load
        function initLocationExplorer() {
            loadExploredLocations();
            loadLocationStylePreference();
            loadCoordinateFormatPreference();
            console.log('üìç Location Explorer initialized');
        }
        
        // ========================================
        // NETLIFY FUNCTIONS API CALLERS (Phase 3)
        // ========================================
        
        /**
         * Fetch photos from Unsplash/Pexels via Netlify Function
         * @param {string} location - Location name
         * @param {string} query - Search query
         * @returns {Promise<Array>} Array of photo objects
         */
        /**
         * Fetch location photos from Unsplash/Pexels via Netlify Function
         * NOW with AI-powered smart search queries! üß†
         * @param {string} location - City/location name
         * @param {string} country - Country name for context
         * @returns {Promise<Array>} Array of photo objects
         */
        async function fetchLocationPhotos(location, country) {
            try {
                const params = new URLSearchParams({ location, country });
                const response = await fetch(`/.netlify/functions/get-photos?${params}`);
                
                if (!response.ok) {
                    console.warn('Photos API returned error:', response.status);
                    return [];
                }
                
                const data = await response.json();
                console.log('‚úÖ Received', data.photos?.length || 0, 'photos from AI-powered search');
                return data.photos || [];
            } catch (error) {
                console.error('Error fetching photos:', error);
                return [];
            }
        }
        
        /**
         * Fetch weather data from OpenWeatherMap via Netlify Function
         * @param {number} lat - Latitude
         * @param {number} lon - Longitude
         * @returns {Promise<Object|null>} Weather object or null
         */
        async function fetchLocationWeather(lat, lon) {
            try {
                const params = new URLSearchParams({ lat: lat.toString(), lon: lon.toString() });
                const response = await fetch(`/.netlify/functions/get-weather?${params}`);
                
                if (!response.ok) {
                    console.warn('Weather API returned error:', response.status);
                    return null;
                }
                
                const data = await response.json();
                return data.weather || null;
            } catch (error) {
                console.error('Error fetching weather:', error);
                return null;
            }
        }
        
        /**
         * Fetch AI-generated fun facts from OpenAI via Netlify Function
         * @param {string} location - Location name
         * @param {string} country - Country name
         * @returns {Promise<Array>} Array of fact strings
         */
        async function fetchLocationFacts(location, country) {
            try {
                const params = new URLSearchParams({ location, country });
                const response = await fetch(`/.netlify/functions/get-ai-facts?${params}`);
                
                if (!response.ok) {
                    console.warn('AI Facts API returned error:', response.status);
                    return [];
                }
                
                const data = await response.json();
                return data.facts || [];
            } catch (error) {
                console.error('Error fetching AI facts:', error);
                return [];
            }
        }
        
        /**
         * Match photos to AI facts using vision validation
         * @param {Array<string>} facts - Array of fact strings
         * @param {string} location - Location name
         * @param {string} country - Country name
         * @returns {Promise<Array>} - Array of {fact, photo} objects
         */
        async function matchPhotosToFacts(facts, location, country) {
            try {
                console.log('üéØ Matching photos to', facts.length, 'facts...');
                
                const response = await fetch('/.netlify/functions/match-photos-to-facts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ facts, location, country })
                });
                
                if (!response.ok) {
                    console.warn('Photo matching API returned error:', response.status);
                    return facts.map(fact => ({ fact, photo: null }));
                }
                
                const data = await response.json();
                console.log('‚úÖ Matched', data.matched?.length || 0, 'photos to facts');
                console.log('üîç MATCHED DATA STRUCTURE:', JSON.stringify(data.matched, null, 2));
                return data.matched || facts.map(fact => ({ fact, photo: null }));
            } catch (error) {
                console.error('Error matching photos to facts:', error);
                return facts.map(fact => ({ fact, photo: null }));
            }
        }
        
        /**
         * Open fact photo modal (for enlarging fact-specific photos)
         * @param {number} index - Index of the fact photo
         */
        function openFactPhoto(index) {
            console.log('üñºÔ∏è Opening fact photo at index:', index);
            console.log('üì¶ Available fact photos:', window.currentFactPhotos?.length || 0);
            
            if (!window.currentFactPhotos || !window.currentFactPhotos[index]) {
                console.warn('‚ùå No fact photo at index', index);
                console.log('Available indices:', window.currentFactPhotos ? Object.keys(window.currentFactPhotos) : 'none');
                return;
            }
            
            const item = window.currentFactPhotos[index];
            const photo = item.photo;
            
            if (!photo || !photo.url) {
                console.warn('‚ùå No photo URL for fact', index);
                return;
            }
            
            console.log('‚úÖ Opening photo:', photo.photographer || 'Unknown');
            
            // Create modal overlay with ACTIVE class!
            const modalHTML = `
                <div id="photo-modal" class="photo-modal active" onclick="closePhotoModal()">
                    <div class="photo-modal-content" onclick="event.stopPropagation()">
                        <button class="photo-modal-close" onclick="closePhotoModal()">&times;</button>
                        <img src="${photo.url}" alt="${escapeHtml(photo.alt || item.fact)}" class="photo-modal-image" />
                        <div class="photo-modal-info">
                            <div class="photo-modal-fact">${escapeHtml(item.fact)}</div>
                            ${photo.photographer ? `
                                <div class="photo-modal-credit">
                                    üì∑ Photo by ${escapeHtml(photo.photographer)}
                                    ${photo.aiGenerated ? ' (AI Generated)' : ''}
                                    ${photo.visionValidated ? ' ‚Ä¢ Vision Verified ‚úì' : ''}
                                </div>
                            ` : ''}
                            ${photo.visionReason ? `
                                <div class="photo-modal-reason">
                                    üí° ${escapeHtml(photo.visionReason)}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('photo-modal');
            if (existingModal) existingModal.remove();
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }
        
        /**
         * Open regular photo modal (for Fast Facts section photos)
         * @param {number} index - Index of the photo
         */
        function openPhotoModal(index) {
            console.log('üì∏ Opening regular photo at index:', index);
            console.log('üì¶ Available photos:', window.currentPhotos?.length || 0);
            
            if (!window.currentPhotos || !window.currentPhotos[index]) {
                console.warn('‚ùå No photo at index', index);
                return;
            }
            
            const photo = window.currentPhotos[index];
            
            console.log('‚úÖ Opening photo by:', photo.photographer || 'Unknown');
            
            // Create modal overlay with ACTIVE class!
            const modalHTML = `
                <div id="photo-modal" class="photo-modal active" onclick="closePhotoModal()">
                    <div class="photo-modal-content" onclick="event.stopPropagation()">
                        <button class="photo-modal-close" onclick="closePhotoModal()">&times;</button>
                        <img src="${photo.url}" alt="${escapeHtml(photo.description || 'Location photo')}" class="photo-modal-image" />
                        <div class="photo-modal-info">
                            ${photo.description ? `
                                <div class="photo-modal-caption">
                                    <h3>${escapeHtml(photo.description)}</h3>
                                </div>
                            ` : ''}
                            ${photo.photographer ? `
                                <div class="photo-modal-credit">
                                    üì∑ Photo by ${escapeHtml(photo.photographer)}
                                    ${photo.photographerUrl ? `<br><a href="${photo.photographerUrl}" target="_blank" rel="noopener noreferrer">View profile</a>` : ''}
                                    ${photo.isAIGenerated ? '<br><span class="ai-badge">ü§ñ AI Generated</span>' : ''}
                                </div>
                            ` : ''}
                            ${photo.source ? `
                                <div class="photo-modal-meta">
                                    Source: ${escapeHtml(photo.source)}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('photo-modal');
            if (existingModal) existingModal.remove();
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }
        
        /**
         * Close photo modal
         */
        function closePhotoModal() {
            const modal = document.getElementById('photo-modal');
            if (modal) {
                modal.remove();
            }
            // Restore body scroll
            document.body.style.overflow = '';
        }
        
        // Add keyboard support for closing modals (ESC key)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' || e.keyCode === 27) {
                closePhotoModal();
            }
        });
        
        // ========================================
        // GEN ALPHA LOADING ANIMATION (67 DANCE!)
        // ========================================
        
        /**
         * Show a BUSSIN Gen Alpha loading screen with dancing 67!
         */
        function showGenAlphaLoading() {
            const card = document.getElementById('card-ai-facts');
            if (!card) return;
            
            const contentElement = card.querySelector('.card-content');
            if (!contentElement) return;
            
            contentElement.innerHTML = `
                <div class="gen-alpha-loading">
                    <div class="six-seven-dance">
                        <span class="six-seven-big">6Ô∏è‚É£7Ô∏è‚É£</span>
                        <div class="loading-text">
                            <span class="loading-word loading-word-1">Generating</span>
                            <span class="loading-word loading-word-2">facts...</span>
                            <span class="loading-dots">
                                <span class="dot">.</span>
                                <span class="dot">.</span>
                                <span class="dot">.</span>
                            </span>
                        </div>
                        <div class="vibe-check">‚ú® vibe check initiated ‚ú®</div>
                    </div>
                </div>
            `;
        }
        
        // ========================================
        // LOCATION EXPLORER CARD POPULATION (Phase 3)
        // ========================================
        
        /**
         * Populate AI Facts Card (Card 4) - NOW WITH MATCHED PHOTOS!
         * @param {Array<Object>} matchedData - Array of {fact, photo} objects
         */
        function populateAIFactsWithPhotos(matchedData) {
            const card = document.getElementById('card-ai-facts');
            if (!card) return;
            
            const contentElement = card.querySelector('.card-content');
            if (!contentElement) return;
            
            if (!matchedData || matchedData.length === 0) {
                contentElement.innerHTML = `
                    <div class="no-data">
                        <span style="font-size: 32px;">ü§î</span>
                        <p>No facts available</p>
                        <p style="font-size: 12px; color: #666;">AI facts will be available after deployment</p>
                    </div>
                `;
                return;
            }
            
            // CRITICAL: Store matched data globally FIRST
            window.currentFactPhotos = matchedData;
            console.log('üì¶ Stored', matchedData.length, 'fact photos for modal access');
            console.log('üîç FIRST MATCHED ITEM:', JSON.stringify(matchedData[0], null, 2));
            
            let html = '<div class="fact-photo-list" style="max-height: 600px; overflow-y: auto; padding-right: 8px;">';
            matchedData.forEach((item, index) => {
                const { fact, photo } = item;
                const aiLabel = photo && photo.aiGenerated ? '<span class="ai-label">ü§ñ AI Generated</span>' : '';
                const visionLabel = photo && photo.visionValidated ? '<span class="vision-label">üëÅÔ∏è Vision Verified</span>' : '';
                
                console.log(`üîç Item ${index}: fact="${fact?.substring(0,30)}...", photo.url="${photo?.url?.substring(0,50) || 'NULL'}"`);
                
                html += `
                    <div class="fact-photo-item" style="margin-bottom: 24px; border-radius: 12px; overflow: hidden; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        ${photo && photo.url ? `
                            <div class="fact-photo" style="position: relative; width: 100%; height: 200px; overflow: hidden; cursor: pointer;" 
                                 onclick="openFactPhoto(${index})" 
                                 title="Click to enlarge"
                                 data-index="${index}">
                                <img src="${photo.url}" 
                                     alt="${escapeHtml(photo.alt || fact)}" 
                                     loading="lazy"
                                     style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; pointer-events: none;" 
                                     onmouseover="this.style.transform='scale(1.05)'"
                                     onmouseout="this.style.transform='scale(1)'" />
                                ${aiLabel}
                                ${visionLabel}
                                ${photo.photographer ? `
                                    <div style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; pointer-events: none;">
                                        üì∑ ${escapeHtml(photo.photographer)}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        <div class="fact-text" style="padding: 16px; background: white;">
                            <p style="margin: 0; font-size: 15px; line-height: 1.6; color: #2c3e50;">
                                ${escapeHtml(fact)}
                            </p>
                            ${photo && photo.visionReason ? `
                                <p style="margin: 8px 0 0 0; font-size: 12px; color: #7f8c8d; font-style: italic;">
                                    üí° ${escapeHtml(photo.visionReason)}
                                </p>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            contentElement.innerHTML = html;
            
            // Data already stored above - no need to store twice!
            
            console.log('‚úÖ Loaded', matchedData.length, 'facts with matched photos');
        }
        
        /**
         * Populate AI Facts Card (Card 4) - FALLBACK (facts only, no photos)
         * @param {Array<string>} facts - Array of fact strings
         */
        function populateAIFacts(facts) {
            const card = document.getElementById('card-ai-facts');
            if (!card) return;
            
            const contentElement = card.querySelector('.card-content');
            if (!contentElement) return;
            
            if (!facts || facts.length === 0) {
                contentElement.innerHTML = `
                    <div class="no-data">
                        <span style="font-size: 32px;">ü§î</span>
                        <p>No facts available</p>
                        <p style="font-size: 12px; color: #666;">AI facts will be available after deployment</p>
                    </div>
                `;
                return;
            }
            
            let html = '<ul class="fact-list">';
            facts.forEach(fact => {
                html += `<li class="fact-item">‚ú® ${escapeHtml(fact)}</li>`;
            });
            html += '</ul>';
            
            contentElement.innerHTML = html;
            console.log('‚úÖ Loaded', facts.length, 'AI facts');
        }
        
        /**
         * Populate Photos Card (Card 5) - NOW with clickable enlargement!
         * @param {Array<Object>} photos - Array of photo objects
         */
        function populatePhotos(photos) {
            const card = document.getElementById('card-photo');
            if (!card) return;
            
            const contentElement = card.querySelector('.card-content');
            if (!contentElement) return;
            
            if (!photos || photos.length === 0) {
                contentElement.innerHTML = `
                    <div class="no-data">
                        <span style="font-size: 32px;">üì∑</span>
                        <p>No photos available</p>
                        <p style="font-size: 12px; color: #666;">Photos will be available after deployment</p>
                    </div>
                `;
                return;
            }
            
            // Show up to 4 photos in a grid with photographer credits
            const photosToShow = photos.slice(0, 4);
            let html = '<div class="photo-grid">';
            
            photosToShow.forEach((photo, index) => {
                const aiAttribute = photo.isAIGenerated ? ' data-ai-generated="true"' : '';
                const aiBadge = photo.isAIGenerated ? '<div class="ai-badge">ü§ñ AI</div>' : '';
                
                html += `
                    <div class="photo-item"${aiAttribute} onclick="openPhotoModal(${index})" style="cursor: pointer; position: relative;" title="Click to enlarge">
                        ${aiBadge}
                        <img src="${photo.thumbnail}" 
                             alt="${escapeHtml(photo.description || 'Location photo')}" 
                             loading="lazy" />
                        <div class="photo-credit" title="Photo by ${escapeHtml(photo.photographer)}">
                            üì∑ ${escapeHtml(photo.photographer)}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            contentElement.innerHTML = html;
            
            // Store photos globally for modal access
            window.currentPhotos = photos;
            
            const realCount = photos.filter(p => !p.isAIGenerated).length;
            const aiCount = photos.filter(p => p.isAIGenerated).length;
            console.log(`‚úÖ Loaded ${photosToShow.length} photos (${realCount} real, ${aiCount} AI) - click to enlarge!`);
        }
        
        /**
         * Generate Geography in Real Life content (Card 4.5)
         * Uses AI to create practical applications of 5 Themes of Geography
         * with special focus on middle school student life
         * @param {string} location - Location name
         * @param {string} country - Country name  
         * @param {Array<string>} facts - Array of facts about the location
         */
        async function generateRealLifeGeography(location, country, facts) {
            const card = document.getElementById('card-real-life-geography');
            if (!card) return;
            
            const contentElement = card.querySelector('#real-life-content');
            if (!contentElement) return;
            
            // Show loading state
            contentElement.innerHTML = `
                <div class="loading-placeholder">
                    <span class="placeholder-icon">üåç</span>
                    <p>Connecting geography to real life...</p>
                </div>
            `;
            
            try {
                console.log('üåç Generating real-life geography applications...');
                
                // Call AI to generate practical applications
                const response = await fetch('/.netlify/functions/generate-real-life-geography', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        location, 
                        country,
                        facts: facts || []
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to generate content');
                }
                
                const data = await response.json();
                console.log('‚úÖ Generated real-life geography content');
                
                // Render the content (contentElement is #real-life-content with scrolling)
                let html = '';
                
                if (data.themes && data.themes.length > 0) {
                    data.themes.forEach(theme => {
                        html += `
                            <div class="real-life-theme">
                                <div class="theme-header">
                                    <span class="theme-icon">${theme.icon}</span>
                                    <span>${theme.name}</span>
                                </div>
                                <div class="theme-explanation">${theme.explanation}</div>
                                ${theme.studentApplication ? `
                                    <div class="student-application">
                                        <div class="student-label">How this connects to YOUR life:</div>
                                        <div class="student-example">${theme.studentApplication}</div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    html += `
                        <div class="safety-badge">
                            <span>‚úÖ</span>
                            <span>Content reviewed for student safety</span>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="no-data">
                            <span style="font-size: 32px;">ü§î</span>
                            <p>Geography connections unavailable</p>
                        </div>
                    `;
                }
                
                contentElement.innerHTML = html;
                
            } catch (error) {
                console.error('‚ùå Error generating real-life geography:', error);
                contentElement.innerHTML = `
                    <div class="no-data">
                        <span style="font-size: 32px;">üåç</span>
                        <p>Geography connections coming soon!</p>
                        <p style="font-size: 12px; color: #666;">This feature needs deployment</p>
                    </div>
                `;
            }
        }
        
        /**
         * Populate Weather Card (Card 6)
         * @param {Object} weather - Weather data object
         */
        function populateWeather(weather) {
            const card = document.getElementById('card-weather');
            if (!card) return;
            
            const contentElement = card.querySelector('.card-content');
            if (!contentElement) return;
            
            if (!weather) {
                contentElement.innerHTML = `
                    <div class="no-data">
                        <span style="font-size: 32px;">‚òÅÔ∏è</span>
                        <p>Weather unavailable</p>
                        <p style="font-size: 12px; color: #666;">Weather will be available after deployment</p>
                    </div>
                `;
                return;
            }
            
            const html = `
                <div class="weather-display">
                    <div class="weather-main">
                        <img src="http://openweathermap.org/img/wn/${weather.icon}@2x.png" 
                             alt="${escapeHtml(weather.description)}" 
                             class="weather-icon" />
                        <div class="weather-temp">
                            ${Math.round(weather.temp.fahrenheit)}¬∞F
                            <span class="temp-secondary">(${Math.round(weather.temp.celsius)}¬∞C)</span>
                        </div>
                        <div class="weather-desc">${escapeHtml(weather.description)}</div>
                    </div>
                    <div class="weather-details">
                        <div class="weather-detail">üí® Wind: ${weather.wind.speed} mph ${weather.wind.direction}</div>
                        <div class="weather-detail">üíß Humidity: ${weather.humidity}%</div>
                        <div class="weather-detail">üëÅÔ∏è Visibility: ${weather.visibility} mi</div>
                    </div>
                </div>
            `;
            
            contentElement.innerHTML = html;
            console.log('‚úÖ Loaded weather data');
        }
        
        // ========================================
        // MAIN INITIALIZATION
        // ========================================
        
        document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded event fired');
        
        // Achievement system will be initialized later after playerAchievements is defined
        console.log('üèÜ Achievement system will initialize after DOM loads');
        
        // v2.0 - Alaska Adventure Edition
        // Initialize map
        const geoMap = L.map('map', {
            preferCanvas: true,
            zoomControl: true,
            maxBounds: [[-90, -180], [90, 180]], // Prevent map from repeating
            maxBoundsViscosity: 1.0, // Makes it "stick" to the bounds
            minZoom: 2, // Prevent zooming out too far
            worldCopyJump: false // Disable world wrapping
        }).setView([20, 0], 2);
        
        // Force map to load
        setTimeout(() => {
            if (geoMap && geoMap.invalidateSize) {
                geoMap.invalidateSize();
            }
        }, 100);
        
        // BASE LAYERS (Choose ONE)
        const streetMapEnglish = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd'
        });
        
        const streetMapLocal = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap'
        });
        
        const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Tiles &copy; Esri'
        });
        
        const topoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 17,
            attribution: '&copy; OpenStreetMap, SRTM'
        });
        
        const terrainMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 13,
            attribution: 'Tiles &copy; Esri'
        });
        
        const physicalMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 8,
            attribution: 'Tiles &copy; Esri'
        });
        
        const darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd'
        });
        
        const watercolorMap = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_watercolor/{z}/{x}/{y}.jpg', {
            maxZoom: 16,
            attribution: '&copy; Stamen Design &copy; OpenStreetMap'
        });
        
        const oceanBaseMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 16,
            attribution: 'Ocean Base &copy; Esri'
        });
        
        const natGeoMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 16,
            attribution: 'National Geographic &copy; Esri'
        });
        
        const terrainBaseMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 13,
            attribution: 'Terrain &copy; Esri'
        });
        
        // OVERLAY LAYERS (Toggle ON/OFF)
        const englishLabelsOverlay = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            subdomains: 'abcd',
            opacity: 1.0
        });
        
        const boundariesOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Boundaries &copy; Esri',
            opacity: 0.7
        });
        
        const transportOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Transport &copy; Esri',
            opacity: 0.7
        });
        
        const hillshadeOverlay = L.tileLayer('https://tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Hillshading: OpenTopoMap',
            opacity: 0.5
        });
        
        const railwayOverlay = L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Railway: OpenRailwayMap',
            opacity: 0.7
        });
        
        const oceanReferenceOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Reference/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 16,
            attribution: 'Ocean Reference &copy; Esri',
            opacity: 0.8
        });
        
        const worldReferenceOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Reference &copy; Esri',
            opacity: 0.7
        });
        
        const lightGrayReferenceOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 16,
            attribution: 'Reference &copy; Esri',
            opacity: 0.8
        });
        
        const watercolorLabelsOverlay = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_terrain_labels/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; Stamen Design',
            opacity: 1.0
        });
        
        const populationDensityOverlay = L.tileLayer('https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/GPW_Population_Density_2020/default/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png', {
            maxZoom: 18,
            maxNativeZoom: 7,
            attribution: 'Population Density: NASA SEDAC GPW v4',
            opacity: 0.65
        });
        
        // Show/hide legend when population density layer is toggled
        populationDensityOverlay.on('add', function() {
            document.getElementById('pop-legend').classList.add('active');
        });
        populationDensityOverlay.on('remove', function() {
            document.getElementById('pop-legend').classList.remove('active');
        });
        
        streetMapEnglish.addTo(geoMap);
        
        const baseMaps = {
            "üó∫Ô∏è Street (English) ‚≠ê": streetMapEnglish,
            "üó∫Ô∏è Street (Local Language)": streetMapLocal,
            "üõ∞Ô∏è Satellite": satelliteMap,
            "‚õ∞Ô∏è Topographic": topoMap,
            "üèîÔ∏è Terrain Relief": terrainMap,
            "üåç Physical Map": physicalMap,
            "üåä Ocean Base": oceanBaseMap,
            "üåé National Geographic": natGeoMap,
            "üé® Watercolor": watercolorMap,
            "üèûÔ∏è Terrain Base": terrainBaseMap,
            "üåô Dark Mode": darkMap
        };
        
        const overlayMaps = {
            "üî§ English Labels": englishLabelsOverlay,
            "üèõÔ∏è Boundaries & Places": boundariesOverlay,
            "üìù World Reference (All Labels)": worldReferenceOverlay,
            "üìä Light Gray Labels": lightGrayReferenceOverlay,
            "üöó Transportation": transportOverlay,
            "üöÇ Railways": railwayOverlay,
            "‚õ∞Ô∏è Hillshade": hillshadeOverlay,
            "üåä Ocean Features & Names": oceanReferenceOverlay,
            "üé® Terrain Labels": watercolorLabelsOverlay,
            "üë• Population Density": populationDensityOverlay
        };
        
        L.control.layers(baseMaps, overlayMaps, {
            collapsed: true,
            position: 'topright'
        }).addTo(geoMap);
        
        // Track layer changes for Explore achievements
        geoMap.on('baselayerchange', function(e) {
            playerAchievements.stats.explore.layersUsed.add(e.name);
            saveAchievements();
            checkExploreAchievements();
        });
        
        L.control.scale({
            imperial: true,
            metric: true
        }).addTo(geoMap);
        
        // Game state
        let gameState = {
            totalXP: 0,
            currentMode: 'explore',
            mystery: {
                score: 0,
                streak: 0,
                bestStreak: 0,
                solved: 0,
                current: null,
                timer: null,
                active: false,
                roundsPlayed: 0,
                fastestTime: 999
            },
            scavenger: {
                challenges: [],
                completed: 0,
                active: false
            },
            guess: {
                score: 0,
                correct: 0,
                total: 0,
                round: 0,
                current: null,
                active: false
            },
            missions: [
                { id: 1, name: "Master Coordinates", desc: "Complete 10 Mystery Challenges", progress: 0, target: 10, xp: 100 },
                { id: 2, name: "Terrain Expert", desc: "Complete a Scavenger Hunt", progress: 0, target: 1, xp: 150 },
                { id: 3, name: "Visual Detective", desc: "Get 5 correct in Guess Game", progress: 0, target: 5, xp: 200 },
                { id: 4, name: "Master Creator", desc: "Create 3 heists", progress: 0, target: 3, xp: 250 }
            ],
            heists: [],
            alaska: {
                currentRound: 0,
                roundProgress: [0, 0, 0, 0, 0], // Track found locations per round
                totalFound: 0,
                active: false,
                foundLocations: [] // Track which locations have been found
            }
        };
        
        // ========================================
        // LOCATION EXPLORER SIDEBAR FUNCTIONS
        // Phase 1.2: Interactive sidebar controls
        // ========================================
        
        // Global variable for currently displayed location
        let currentLocation = null;
        
        // Collection system - stores explored locations
        let exploredLocations = [];
        
        // Style mode: 'gen-alpha' or 'classic'
        let locationStyleMode = 'classic';
        
        // Load explored locations from localStorage
        function loadExploredLocations() {
            try {
                const saved = localStorage.getItem('exploredLocations');
                if (saved) {
                    exploredLocations = JSON.parse(saved);
                    updateCollectionCount();
                    console.log('üìç Loaded', exploredLocations.length, 'explored locations');
                }
            } catch (e) {
                console.warn('Could not load explored locations:', e);
            }
        }
        
        // Save explored locations to localStorage
        function saveExploredLocations() {
            try {
                localStorage.setItem('exploredLocations', JSON.stringify(exploredLocations));
                updateCollectionCount();
            } catch (e) {
                console.warn('Could not save explored locations:', e);
            }
        }
        
        // Update collection counter badge
        function updateCollectionCount() {
            const countElement = document.getElementById('locations-explored-count');
            if (countElement) {
                countElement.textContent = exploredLocations.length;
            }
        }
        
        // Toggle sidebar visibility
        function toggleLocationSidebar() {
            const sidebar = document.getElementById('location-explorer-sidebar');
            const reopenBtn = document.getElementById('reopen-sidebar-btn');
            if (sidebar) {
                const isClosing = sidebar.classList.contains('active');
                sidebar.classList.toggle('active');
                
                // Show reopen button when closing sidebar (but only if we have location data)
                if (reopenBtn && currentLocation) {
                    if (isClosing) {
                        reopenBtn.classList.add('visible');
                    } else {
                        reopenBtn.classList.remove('visible');
                    }
                }
                
                console.log('üìç Sidebar toggled:', sidebar.classList.contains('active') ? 'open' : 'closed');
            }
        }
        
        // Show sidebar (called when user drops a pin)
        function showLocationSidebar() {
            const sidebar = document.getElementById('location-explorer-sidebar');
            const reopenBtn = document.getElementById('reopen-sidebar-btn');
            if (sidebar) {
                sidebar.classList.add('active');
                // Hide reopen button when opening sidebar
                if (reopenBtn) {
                    reopenBtn.classList.remove('visible');
                }
                console.log('üìç Sidebar opened');
            }
        }
        
        // Hide sidebar
        function hideLocationSidebar() {
            const sidebar = document.getElementById('location-explorer-sidebar');
            const reopenBtn = document.getElementById('reopen-sidebar-btn');
            if (sidebar) {
                sidebar.classList.remove('active');
                // Show reopen button when hiding sidebar (if we have location data)
                if (reopenBtn && currentLocation) {
                    reopenBtn.classList.add('visible');
                }
                console.log('üìç Sidebar closed');
            }
        }
        
        // Reopen sidebar with current location data (no new API calls!)
        function reopenLocationSidebar() {
            const sidebar = document.getElementById('location-explorer-sidebar');
            const reopenBtn = document.getElementById('reopen-sidebar-btn');
            
            if (!sidebar) return;
            
            // Simply show the sidebar again - data is already loaded!
            sidebar.classList.add('active');
            
            // Hide reopen button
            if (reopenBtn) {
                reopenBtn.classList.remove('visible');
            }
            
            console.log('üìç Sidebar reopened with existing location data');
        }
        
        // Toggle individual card expand/collapse
        function toggleCard(cardId) {
            const card = document.getElementById(cardId);
            if (card) {
                card.classList.toggle('collapsed');
                console.log('üÉè Card', cardId, card.classList.contains('collapsed') ? 'collapsed' : 'expanded');
            }
        }
        
        // Toggle between Gen Alpha and Classic styles
        function toggleLocationStyle() {
            const sidebar = document.getElementById('location-explorer-sidebar');
            const toggleBtn = document.getElementById('style-toggle-btn');
            
            if (!sidebar || !toggleBtn) return;
            
            // Toggle mode
            locationStyleMode = locationStyleMode === 'classic' ? 'gen-alpha' : 'classic';
            
            // Update sidebar class
            if (locationStyleMode === 'gen-alpha') {
                sidebar.classList.add('gen-alpha-mode');
                toggleBtn.textContent = 'üî•';
                console.log('üî• Gen Alpha mode activated');
            } else {
                sidebar.classList.remove('gen-alpha-mode');
                toggleBtn.textContent = 'üìö';
                console.log('üìö Classic mode activated');
            }
            
            // Save preference
            try {
                localStorage.setItem('locationStyleMode', locationStyleMode);
            } catch (e) {
                console.warn('Could not save style preference:', e);
            }
        }
        
        // Load style preference from localStorage
        function loadLocationStylePreference() {
            try {
                const saved = localStorage.getItem('locationStyleMode');
                if (saved) {
                    locationStyleMode = saved;
                    const sidebar = document.getElementById('location-explorer-sidebar');
                    const toggleBtn = document.getElementById('style-toggle-btn');
                    
                    if (locationStyleMode === 'gen-alpha' && sidebar) {
                        sidebar.classList.add('gen-alpha-mode');
                        if (toggleBtn) toggleBtn.textContent = 'üî•';
                    }
                    
                    console.log('üé® Style preference loaded:', locationStyleMode);
                }
            } catch (e) {
                console.warn('Could not load style preference:', e);
            }
        }
        
        // Add location to collection
        function addToCollection(locationData) {
            // Check if already collected (within 1km)
            const isDuplicate = exploredLocations.some(loc => {
                const distance = calculateDistance(
                    loc.lat, loc.lng,
                    locationData.lat, locationData.lng
                );
                return distance < 1; // Less than 1km apart
            });
            
            if (!isDuplicate) {
                exploredLocations.push({
                    ...locationData,
                    exploredAt: Date.now()
                });
                saveExploredLocations();
                console.log('‚úÖ Location added to collection!');
                return true;
            } else {
                console.log('‚ÑπÔ∏è Location already in collection');
                return false;
            }
        }
        
        // Calculate distance between two points (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distance in km
        }
        
        // Calculate RHUMB LINE bearing between two points (constant compass direction)
        // This is more intuitive than great circle bearing for educational purposes
        function calculateBearing(lat1, lon1, lat2, lon2) {
            // Convert to radians
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            let ŒîŒª = (lon2 - lon1) * Math.PI / 180;
            
            // Normalize longitude difference to [-180, 180]
            if (ŒîŒª > Math.PI) ŒîŒª -= 2 * Math.PI;
            if (ŒîŒª < -Math.PI) ŒîŒª += 2 * Math.PI;
            
            // Calculate Œîœà (difference in the isometric latitude)
            const Œîœà = Math.log(Math.tan(œÜ2/2 + Math.PI/4) / Math.tan(œÜ1/2 + Math.PI/4));
            
            // Calculate bearing
            const Œ∏ = Math.atan2(ŒîŒª, Œîœà);
            const bearing = (Œ∏ * 180 / Math.PI + 360) % 360;
            
            // DEBUG
            console.log('üß≠ Rhumb Line Bearing (Constant Compass Direction):');
            console.log('  From:', lat1.toFixed(4) + '¬∞', lon1.toFixed(4) + '¬∞');
            console.log('  To:', lat2.toFixed(4) + '¬∞', lon2.toFixed(4) + '¬∞');
            console.log('  Bearing:', bearing.toFixed(2) + '¬∞');
            
            // Convert to compass direction
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(bearing / 22.5) % 16;
            console.log('  Direction:', directions[index]);
            
            return directions[index];
        }
        
        // View explored locations collection (opens modal - Phase 6)
        function viewExploredLocations() {
            console.log('üóÇÔ∏è Viewing collection of', exploredLocations.length, 'locations');
            
            if (exploredLocations.length === 0) {
                alert('üìç No locations explored yet!\n\nDrop a pin on the map to start your collection!');
                return;
            }
            
            // Phase 6 will add:
            // - Modal popup with grid of collected locations
            // - Click to revisit location
            // - Delete from collection
            // - Export/share collection
            
            // For now, show simple list in console
            console.table(exploredLocations.map(loc => ({
                name: loc.name || 'Unknown',
                lat: loc.lat.toFixed(4),
                lng: loc.lng.toFixed(4),
                exploredAt: new Date(loc.exploredAt).toLocaleDateString()
            })));
            
            alert(`üìç Your Collection (${exploredLocations.length} places)\n\nCheck the console for details!\n\nCollection modal coming in Phase 6!`);
        }
        
        // Initialize Location Explorer on page load
        function initLocationExplorer() {
            loadExploredLocations();
            loadLocationStylePreference();
            console.log('üìç Location Explorer initialized');
        }
        
        // ========================================
        // UNIVERSAL ACHIEVEMENT SYSTEM
        // ========================================
        
        // Complete achievement database (45 total achievements)
        const ACHIEVEMENTS = {
            // EXPLORE MODE (5 achievements)
            explore: {
                globeTrotter: {
                    id: 'globeTrotter',
                    name: 'üåç Globe Trotter',
                    description: 'Visit all 7 continents',
                    xp: 100,
                    tier: 'uncommon',
                    requirement: { type: 'continents', count: 7 }
                },
                zoomMaster: {
                    id: 'zoomMaster',
                    name: 'üî≠ Zoom Master',
                    description: 'Use all zoom levels',
                    xp: 75,
                    tier: 'common',
                    requirement: { type: 'zoomLevels', count: 10 }
                },
                layerExpert: {
                    id: 'layerExpert',
                    name: 'üó∫Ô∏è Layer Expert',
                    description: 'Try all 10 map layers',
                    xp: 125,
                    tier: 'uncommon',
                    requirement: { type: 'layers', count: 10 }
                },
                markerManiac: {
                    id: 'markerManiac',
                    name: 'üìç Marker Maniac',
                    description: 'Place 50+ markers',
                    xp: 150,
                    tier: 'rare',
                    requirement: { type: 'markers', count: 50 }
                },
                styleSwitcher: {
                    id: 'styleSwitcher',
                    name: 'üé® Style Switcher',
                    description: 'Toggle Fun Mode 10 times',
                    xp: 50,
                    tier: 'common',
                    requirement: { type: 'modeToggles', count: 10 }
                }
            },
            
            // COORDINATE FINDER (5 achievements)
            coordinate: {
                pinpointPro: {
                    id: 'pinpointPro',
                    name: 'üéØ Pinpoint Pro',
                    description: '10 perfect finds (within 1km)',
                    xp: 150,
                    tier: 'rare',
                    requirement: { type: 'perfectFinds', count: 10 }
                },
                formatFluent: {
                    id: 'formatFluent',
                    name: 'üåé Format Fluent',
                    description: 'Use both Decimal and Cardinal 5 times each',
                    xp: 100,
                    tier: 'uncommon',
                    requirement: { type: 'formats', decimalCount: 5, cardinalCount: 5 }
                },
                speedDemon: {
                    id: 'speedDemon',
                    name: '‚ö° Speed Demon',
                    description: 'Find 5 locations in under 30 seconds each',
                    xp: 200,
                    tier: 'rare',
                    requirement: { type: 'speedFinds', count: 5, maxTime: 30 }
                },
                navigator: {
                    id: 'navigator',
                    name: 'üß≠ Navigator',
                    description: 'Complete 25 coordinate challenges',
                    xp: 125,
                    tier: 'uncommon',
                    requirement: { type: 'completions', count: 25 }
                },
                perfectionist: {
                    id: 'perfectionist',
                    name: 'üíØ Perfectionist',
                    description: '100% accuracy on 10 finds',
                    xp: 250,
                    tier: 'epic',
                    requirement: { type: 'perfectAccuracy', count: 10 }
                }
            },
            
            // MYSTERY CHALLENGE (7 achievements)
            mystery: {
                mysterySolver: {
                    id: 'mysterySolver',
                    name: 'üîç Mystery Solver',
                    description: 'Solve 10 mysteries',
                    xp: 100,
                    tier: 'uncommon',
                    requirement: { type: 'solved', count: 10 }
                },
                speedDetective: {
                    id: 'speedDetective',
                    name: '‚è±Ô∏è Speed Detective',
                    description: 'Solve in under 20 seconds',
                    xp: 200,
                    tier: 'rare',
                    requirement: { type: 'speedSolve', maxTime: 20 }
                },
                noHints: {
                    id: 'noHints',
                    name: 'üß† No Hints',
                    description: 'Solve without using hints 5 times',
                    xp: 250,
                    tier: 'epic',
                    requirement: { type: 'noHintSolves', count: 5 }
                },
                continentalExpert: {
                    id: 'continentalExpert',
                    name: 'üåç Continental Expert',
                    description: 'Solve 1 from each continent',
                    xp: 150,
                    tier: 'uncommon',
                    requirement: { type: 'continents', count: 6 }
                },
                streakMaster: {
                    id: 'streakMaster',
                    name: 'üî• Streak Master',
                    description: '5-mystery win streak',
                    xp: 300,
                    tier: 'epic',
                    requirement: { type: 'streak', count: 5 }
                },
                mysteryMaster: {
                    id: 'mysteryMaster',
                    name: 'üèÜ Mystery Master',
                    description: 'Solve all 70 locations',
                    xp: 500,
                    tier: 'legendary',
                    requirement: { type: 'uniqueSolves', count: 70 }
                },
                lightningRound: {
                    id: 'lightningRound',
                    name: '‚ö° Lightning Round',
                    description: 'Solve 3 in under 2 minutes total',
                    xp: 400,
                    tier: 'epic',
                    requirement: { type: 'lightningRound', count: 3, maxTime: 120 }
                }
            },
            
            // SCAVENGER HUNT (6 achievements)
            scavenger: {
                photoFinish: {
                    id: 'photoFinish',
                    name: 'üì∏ Photo Finish',
                    description: 'Complete 10 scavenger hunts',
                    xp: 125,
                    tier: 'uncommon',
                    requirement: { type: 'completed', count: 10 }
                },
                speedScavenger: {
                    id: 'speedScavenger',
                    name: 'üèÉ Speed Scavenger',
                    description: 'Complete hunt in under 5 minutes',
                    xp: 200,
                    tier: 'rare',
                    requirement: { type: 'speedHunt', maxTime: 300 }
                },
                eagleEye: {
                    id: 'eagleEye',
                    name: 'üéØ Eagle Eye',
                    description: 'Find all items with 95%+ accuracy',
                    xp: 250,
                    tier: 'epic',
                    requirement: { type: 'accuracy', threshold: 95 }
                },
                worldExplorer: {
                    id: 'worldExplorer',
                    name: 'üåè World Explorer',
                    description: 'Complete hunts on all continents',
                    xp: 150,
                    tier: 'uncommon',
                    requirement: { type: 'continents', count: 6 }
                },
                detailDetective: {
                    id: 'detailDetective',
                    name: 'üîé Detail Detective',
                    description: 'Find 5 hidden bonus items',
                    xp: 300,
                    tier: 'epic',
                    requirement: { type: 'bonusItems', count: 5 }
                },
                scavengerLegend: {
                    id: 'scavengerLegend',
                    name: 'üèÜ Scavenger Legend',
                    description: 'Complete 25 hunts',
                    xp: 400,
                    tier: 'epic',
                    requirement: { type: 'completed', count: 25 }
                }
            },
            
            // GUESS MODE (6 achievements)
            guess: {
                sharpShooter: {
                    id: 'sharpShooter',
                    name: 'üéØ Sharp Shooter',
                    description: '10 guesses within 100km',
                    xp: 150,
                    tier: 'rare',
                    requirement: { type: 'closeGuesses', count: 10, maxDistance: 100 }
                },
                geographyGenius: {
                    id: 'geographyGenius',
                    name: 'üåç Geography Genius',
                    description: '90%+ accuracy over 20 photos',
                    xp: 250,
                    tier: 'epic',
                    requirement: { type: 'accuracy', threshold: 90, count: 20 }
                },
                instantIdentifier: {
                    id: 'instantIdentifier',
                    name: '‚ö° Instant Identifier',
                    description: 'Guess correctly in under 5 seconds, 5 times',
                    xp: 200,
                    tier: 'rare',
                    requirement: { type: 'speedGuesses', count: 5, maxTime: 5 }
                },
                photoMaster: {
                    id: 'photoMaster',
                    name: 'üèÜ Photo Master',
                    description: 'View all 100 photos',
                    xp: 300,
                    tier: 'epic',
                    requirement: { type: 'photosSeen', count: 100 }
                },
                perfectRound: {
                    id: 'perfectRound',
                    name: 'üî• Perfect Round',
                    description: '5/5 perfect guesses in one session',
                    xp: 400,
                    tier: 'epic',
                    requirement: { type: 'perfectRound', count: 5 }
                },
                detailExpert: {
                    id: 'detailExpert',
                    name: 'üëÅÔ∏è Detail Expert',
                    description: 'Identify from cropped/zoomed photos 10 times',
                    xp: 350,
                    tier: 'epic',
                    requirement: { type: 'croppedPhotos', count: 10 }
                }
            },
            
            // CREATE HEIST (6 achievements)
            heist: {
                architect: {
                    id: 'architect',
                    name: 'üé® Architect',
                    description: 'Create 5 heists',
                    xp: 100,
                    tier: 'uncommon',
                    requirement: { type: 'created', count: 5 }
                },
                globalPlanner: {
                    id: 'globalPlanner',
                    name: 'üåç Global Planner',
                    description: 'Heists on all continents',
                    xp: 150,
                    tier: 'uncommon',
                    requirement: { type: 'continents', count: 6 }
                },
                masterThief: {
                    id: 'masterThief',
                    name: 'üèÜ Master Thief',
                    description: 'Create 25 heists',
                    xp: 300,
                    tier: 'epic',
                    requirement: { type: 'created', count: 25 }
                },
                speedDesigner: {
                    id: 'speedDesigner',
                    name: '‚ö° Speed Designer',
                    description: 'Create heist in under 2 minutes',
                    xp: 200,
                    tier: 'rare',
                    requirement: { type: 'speedCreate', maxTime: 120 }
                },
                heistPerfectionist: {
                    id: 'heistPerfectionist',
                    name: 'üéØ Perfectionist',
                    description: 'All custom waypoints, no templates',
                    xp: 250,
                    tier: 'epic',
                    requirement: { type: 'customWaypoints', count: 5 }
                },
                influencer: {
                    id: 'influencer',
                    name: 'üì± Influencer',
                    description: 'Share 10 heists',
                    xp: 150,
                    tier: 'uncommon',
                    requirement: { type: 'shared', count: 10 }
                }
            },
            
            // ALASKA ADVENTURE (10 achievements - 5 already implemented!)
            alaska: {
                mountainMaster: {
                    id: 'mountainMaster',
                    name: '‚õ∞Ô∏è Mountain Master',
                    description: 'Find 5+ mountains',
                    xp: 100,
                    tier: 'uncommon',
                    requirement: { type: 'locationsByType', locationType: 'mountain', count: 5 }
                },
                riverRunner: {
                    id: 'riverRunner',
                    name: 'üåä River Runner',
                    description: 'Find 3+ rivers',
                    xp: 75,
                    tier: 'common',
                    requirement: { type: 'locationsByType', locationType: 'river', count: 3 }
                },
                parkExplorer: {
                    id: 'parkExplorer',
                    name: 'üèûÔ∏è Park Explorer',
                    description: 'Find 5+ parks',
                    xp: 125,
                    tier: 'uncommon',
                    requirement: { type: 'locationsByType', locationType: 'park', count: 5 }
                },
                cityFinder: {
                    id: 'cityFinder',
                    name: 'üèôÔ∏è City Finder',
                    description: 'Find 8+ cities',
                    xp: 150,
                    tier: 'rare',
                    requirement: { type: 'locationsByType', locationType: 'city', count: 8 }
                },
                alaskaExpert: {
                    id: 'alaskaExpert',
                    name: 'üèÜ Alaska Expert',
                    description: 'Discover all 50 Alaska locations',
                    xp: 500,
                    tier: 'legendary',
                    requirement: { type: 'total', count: 50 }
                },
                fishTales: {
                    id: 'fishTales',
                    name: 'üé£ Fish Tales',
                    description: 'Find all fishing locations',
                    xp: 100,
                    tier: 'uncommon',
                    requirement: { type: 'fishingSpots', count: 5 }
                },
                bearCountry: {
                    id: 'bearCountry',
                    name: 'üêª Bear Country',
                    description: 'Find all wildlife spots',
                    xp: 125,
                    tier: 'uncommon',
                    requirement: { type: 'wildlifeSpots', count: 5 }
                },
                summitSeeker: {
                    id: 'summitSeeker',
                    name: '‚õ∞Ô∏è Summit Seeker',
                    description: 'Find all peaks in one session',
                    xp: 200,
                    tier: 'rare',
                    requirement: { type: 'peaksInSession', count: 8 }
                },
                alaskaSpeedRunner: {
                    id: 'alaskaSpeedRunner',
                    name: '‚ö° Speed Runner',
                    description: 'Complete all 5 rounds in under 30 min',
                    xp: 500,
                    tier: 'legendary',
                    requirement: { type: 'speedComplete', maxTime: 1800 }
                },
                alaskaLegend: {
                    id: 'alaskaLegend',
                    name: 'üèÜ Alaska Legend',
                    description: '100% completion + all achievements',
                    xp: 1000,
                    tier: 'legendary',
                    requirement: { type: 'masterComplete', allAchievements: true }
                }
            },
            
            // UNIVERSAL CROSS-GAME ACHIEVEMENTS (10 achievements)
            universal: {
                gameHopper: {
                    id: 'gameHopper',
                    name: 'üéÆ Game Hopper',
                    description: 'Try all 7 game modes',
                    xp: 100,
                    tier: 'uncommon',
                    requirement: { type: 'modesPlayed', count: 7 }
                },
                jackOfAllTrades: {
                    id: 'jackOfAllTrades',
                    name: 'üèÜ Jack of All Trades',
                    description: 'Complete 1 of each mode',
                    xp: 200,
                    tier: 'rare',
                    requirement: { type: 'modesCompleted', count: 7 }
                },
                masterOfAll: {
                    id: 'masterOfAll',
                    name: 'üëë Master of All',
                    description: 'Expert in all 7 modes',
                    xp: 1000,
                    tier: 'legendary',
                    requirement: { type: 'modesMastered', count: 7 }
                },
                universalSpeedDemon: {
                    id: 'universalSpeedDemon',
                    name: '‚ö° Speed Demon',
                    description: 'Complete 10 games in under 1 hour',
                    xp: 300,
                    tier: 'epic',
                    requirement: { type: 'speedGames', count: 10, maxTime: 3600 }
                },
                streakLegend: {
                    id: 'streakLegend',
                    name: 'üî• Streak Legend',
                    description: '7-day play streak',
                    xp: 500,
                    tier: 'legendary',
                    requirement: { type: 'dailyStreak', count: 7 }
                },
                statistician: {
                    id: 'statistician',
                    name: 'üìä Statistician',
                    description: 'View stats dashboard 10 times',
                    xp: 50,
                    tier: 'common',
                    requirement: { type: 'statsViews', count: 10 }
                },
                styleIcon: {
                    id: 'styleIcon',
                    name: 'üé® Style Icon',
                    description: 'Use Fun Mode in all 7 games',
                    xp: 150,
                    tier: 'uncommon',
                    requirement: { type: 'funModeAllGames', count: 7 }
                },
                cartographer: {
                    id: 'cartographer',
                    name: 'üó∫Ô∏è Cartographer',
                    description: 'Use all 10 map layers',
                    xp: 100,
                    tier: 'uncommon',
                    requirement: { type: 'layersUsed', count: 10 }
                },
                universalPerfectionist: {
                    id: 'universalPerfectionist',
                    name: 'üíØ Perfectionist',
                    description: '100% accuracy in 3 different modes',
                    xp: 400,
                    tier: 'epic',
                    requirement: { type: 'perfectModes', count: 3 }
                },
                achievementHunter: {
                    id: 'achievementHunter',
                    name: 'üèÖ Achievement Hunter',
                    description: 'Unlock 30 achievements',
                    xp: 750,
                    tier: 'legendary',
                    requirement: { type: 'achievementsUnlocked', count: 30 }
                }
            }
        };
        
        // Player achievement tracking (saved to localStorage)
        let playerAchievements = {
            unlocked: [], // Array of achievement IDs
            stats: {
                // Explore mode stats
                explore: {
                    continentsVisited: new Set(),
                    zoomLevelsUsed: new Set(),
                    layersUsed: new Set(),
                    markersPlaced: 0,
                    modeToggles: 0
                },
                // Coordinate Finder stats
                coordinate: {
                    perfectFinds: 0,
                    decimalUses: 0,
                    cardinalUses: 0,
                    speedFinds: 0,
                    completions: 0,
                    perfectAccuracyRuns: 0
                },
                // Mystery Challenge stats
                mystery: {
                    solved: 0,
                    speedSolves: 0,
                    noHintSolves: 0,
                    continentsSolved: new Set(),
                    streak: 0,
                    uniqueLocationsSolved: new Set(),
                    lightningRounds: 0
                },
                // Scavenger Hunt stats
                scavenger: {
                    completed: 0,
                    speedHunts: 0,
                    highAccuracyHunts: 0,
                    continentsCompleted: new Set(),
                    bonusItemsFound: 0
                },
                // Guess Mode stats
                guess: {
                    roundsPlayed: 0,
                    correctGuesses: 0,
                    closeGuesses: 0,
                    accuracyRuns: [],
                    speedGuesses: 0,
                    photosSeen: new Set(),
                    landmarksIdentified: new Set(),
                    instantIdentifications: 0,
                    gamesCompleted: 0,
                    fastCompletions: 0,
                    perfectRounds: 0,
                    croppedPhotoGuesses: 0
                },
                // Create Heist stats
                heist: {
                    created: 0,
                    continents: new Set(),
                    speedCreates: 0,
                    customHeists: 0,
                    shared: 0
                },
                // Alaska Adventure stats (already tracking some)
                alaska: {
                    achievements: {
                        mountainMaster: false,
                        riverRunner: false,
                        parkExplorer: false,
                        cityFinder: false,
                        alaskaExpert: false,
                        fishTales: false,
                        bearCountry: false,
                        summitSeeker: false,
                        alaskaSpeedRunner: false,
                        alaskaLegend: false
                    }
                },
                // Universal stats
                universal: {
                    modesPlayed: new Set(),
                    modesCompleted: new Set(),
                    modesMastered: new Set(),
                    gamesThisHour: [],
                    playDates: new Set(),
                    statsViews: 0,
                    funModeGames: new Set(),
                    perfectModes: new Set()
                }
            },
            lastUpdated: new Date().toISOString()
        };
        
        // Initialize achievement system immediately after object creation
        // This ensures loadAchievements() has access to playerAchievements
        console.log('üèÜ Achievement system initialized with playerAchievements object');
        
        // ========================================
        // UNIVERSAL ACHIEVEMENT FUNCTIONS
        // ========================================
        
        // Load achievement data from localStorage
        window.loadAchievements = function() {
            try {
                const saved = localStorage.getItem('playerAchievements');
                if (saved) {
                    const data = JSON.parse(saved);
                    // Restore sets from arrays
                    playerAchievements.unlocked = data.unlocked || [];
                    playerAchievements.lastUpdated = data.lastUpdated;
                    
                    // Restore stats with Sets
                    if (data.stats) {
                        if (data.stats.explore) {
                            playerAchievements.stats.explore.continentsVisited = new Set(data.stats.explore.continentsVisited || []);
                            playerAchievements.stats.explore.zoomLevelsUsed = new Set(data.stats.explore.zoomLevelsUsed || []);
                            playerAchievements.stats.explore.layersUsed = new Set(data.stats.explore.layersUsed || []);
                            playerAchievements.stats.explore.markersPlaced = data.stats.explore.markersPlaced || 0;
                            playerAchievements.stats.explore.modeToggles = data.stats.explore.modeToggles || 0;
                        }
                        if (data.stats.mystery) {
                            // Restore Sets first
                            playerAchievements.stats.mystery.continentsSolved = new Set(data.stats.mystery.continentsSolved || []);
                            playerAchievements.stats.mystery.uniqueLocationsSolved = new Set(data.stats.mystery.uniqueLocationsSolved || []);
                            // Copy primitive values (don't overwrite Sets)
                            if (data.stats.mystery.solved) playerAchievements.stats.mystery.solved = data.stats.mystery.solved;
                            if (data.stats.mystery.currentStreak) playerAchievements.stats.mystery.currentStreak = data.stats.mystery.currentStreak;
                            if (data.stats.mystery.bestStreak) playerAchievements.stats.mystery.bestStreak = data.stats.mystery.bestStreak;
                            if (data.stats.mystery.fastestTime) playerAchievements.stats.mystery.fastestTime = data.stats.mystery.fastestTime;
                            if (data.stats.mystery.hintsUsed !== undefined) playerAchievements.stats.mystery.hintsUsed = data.stats.mystery.hintsUsed;
                        }
                        if (data.stats.guess) {
                            // Restore Sets and arrays first
                            playerAchievements.stats.guess.photosSeen = new Set(data.stats.guess.photosSeen || []);
                            playerAchievements.stats.guess.landmarksIdentified = new Set(data.stats.guess.landmarksIdentified || []);
                            playerAchievements.stats.guess.accuracyRuns = data.stats.guess.accuracyRuns || [];
                            // Copy primitive values
                            if (data.stats.guess.roundsPlayed) playerAchievements.stats.guess.roundsPlayed = data.stats.guess.roundsPlayed;
                            if (data.stats.guess.correctGuesses) playerAchievements.stats.guess.correctGuesses = data.stats.guess.correctGuesses;
                            if (data.stats.guess.closeGuesses) playerAchievements.stats.guess.closeGuesses = data.stats.guess.closeGuesses;
                            if (data.stats.guess.instantIdentifications) playerAchievements.stats.guess.instantIdentifications = data.stats.guess.instantIdentifications;
                            if (data.stats.guess.gamesCompleted) playerAchievements.stats.guess.gamesCompleted = data.stats.guess.gamesCompleted;
                            if (data.stats.guess.fastCompletions) playerAchievements.stats.guess.fastCompletions = data.stats.guess.fastCompletions;
                            if (data.stats.guess.perfectRounds) playerAchievements.stats.guess.perfectRounds = data.stats.guess.perfectRounds;
                        }
                        if (data.stats.universal) {
                            // Restore Sets first
                            playerAchievements.stats.universal.modesPlayed = new Set(data.stats.universal.modesPlayed || []);
                            playerAchievements.stats.universal.modesCompleted = new Set(data.stats.universal.modesCompleted || []);
                            playerAchievements.stats.universal.modesMastered = new Set(data.stats.universal.modesMastered || []);
                            playerAchievements.stats.universal.playDates = new Set(data.stats.universal.playDates || []);
                            playerAchievements.stats.universal.funModeGames = new Set(data.stats.universal.funModeGames || []);
                            playerAchievements.stats.universal.perfectModes = new Set(data.stats.universal.perfectModes || []);
                            // Copy primitive values (numbers, strings) but NOT the Set arrays
                            if (data.stats.universal.totalPlayTime) playerAchievements.stats.universal.totalPlayTime = data.stats.universal.totalPlayTime;
                            if (data.stats.universal.statsViews) playerAchievements.stats.universal.statsViews = data.stats.universal.statsViews;
                        }
                        // Restore other stats
                        if (data.stats.coordinate) Object.assign(playerAchievements.stats.coordinate, data.stats.coordinate);
                        if (data.stats.scavenger) {
                            // Restore Sets first
                            playerAchievements.stats.scavenger.continentsVisited = new Set(data.stats.scavenger.continentsVisited || []);
                            // Copy primitive values
                            if (data.stats.scavenger.challengesCompleted) playerAchievements.stats.scavenger.challengesCompleted = data.stats.scavenger.challengesCompleted;
                            if (data.stats.scavenger.huntsCompleted) playerAchievements.stats.scavenger.huntsCompleted = data.stats.scavenger.huntsCompleted;
                            if (data.stats.scavenger.perfectFinds) playerAchievements.stats.scavenger.perfectFinds = data.stats.scavenger.perfectFinds;
                            if (data.stats.scavenger.fastCompletions) playerAchievements.stats.scavenger.fastCompletions = data.stats.scavenger.fastCompletions;
                        }
                        if (data.stats.heist) {
                            // Restore Sets first
                            playerAchievements.stats.heist.continents = new Set(data.stats.heist.continents || []);
                            // Copy primitive values
                            if (data.stats.heist.created) playerAchievements.stats.heist.created = data.stats.heist.created;
                        }
                        if (data.stats.alaska) Object.assign(playerAchievements.stats.alaska, data.stats.alaska);
                    }
                    console.log('‚úÖ Achievements loaded:', playerAchievements.unlocked.length, 'unlocked');
                }
            } catch (e) {
                console.warn('Could not load achievements:', e);
            }
        }
        
        // Save achievement data to localStorage
        function saveAchievements() {
            try {
                // Convert Sets to arrays for JSON serialization (with safety checks)
                const toSave = {
                    unlocked: playerAchievements.unlocked,
                    lastUpdated: new Date().toISOString(),
                    stats: {
                        explore: {
                            ...playerAchievements.stats.explore,
                            continentsVisited: Array.from(playerAchievements.stats.explore.continentsVisited || []),
                            zoomLevelsUsed: Array.from(playerAchievements.stats.explore.zoomLevelsUsed || []),
                            layersUsed: Array.from(playerAchievements.stats.explore.layersUsed || [])
                        },
                        coordinate: playerAchievements.stats.coordinate,
                        mystery: {
                            ...playerAchievements.stats.mystery,
                            continentsSolved: Array.from(playerAchievements.stats.mystery.continentsSolved || []),
                            uniqueLocationsSolved: Array.from(playerAchievements.stats.mystery.uniqueLocationsSolved || [])
                        },
                        scavenger: {
                            ...playerAchievements.stats.scavenger,
                            continentsVisited: Array.from(playerAchievements.stats.scavenger.continentsVisited || [])
                        },
                        guess: {
                            ...playerAchievements.stats.guess,
                            photosSeen: Array.from(playerAchievements.stats.guess.photosSeen || []),
                            landmarksIdentified: Array.from(playerAchievements.stats.guess.landmarksIdentified || [])
                        },
                        heist: {
                            ...playerAchievements.stats.heist,
                            continents: Array.from(playerAchievements.stats.heist.continents || [])
                        },
                        alaska: playerAchievements.stats.alaska,
                        universal: {
                            ...playerAchievements.stats.universal,
                            modesPlayed: Array.from(playerAchievements.stats.universal.modesPlayed || []),
                            modesCompleted: Array.from(playerAchievements.stats.universal.modesCompleted || []),
                            modesMastered: Array.from(playerAchievements.stats.universal.modesMastered || []),
                            playDates: Array.from(playerAchievements.stats.universal.playDates || []),
                            funModeGames: Array.from(playerAchievements.stats.universal.funModeGames || []),
                            perfectModes: Array.from(playerAchievements.stats.universal.perfectModes || [])
                        }
                    }
                };
                localStorage.setItem('playerAchievements', JSON.stringify(toSave));
                console.log('üíæ Achievements saved');
            } catch (e) {
                console.warn('Could not save achievements:', e);
            }
        }
        
        // Load achievements from localStorage immediately after functions are defined
        loadAchievements();
        console.log('‚úÖ Achievements loaded from localStorage');
        
        // Initialize Location Explorer sidebar system
        initLocationExplorer();
        console.log('‚úÖ Location Explorer initialized');
        
        // Check if achievement is already unlocked
        function isAchievementUnlocked(achievementId) {
            return playerAchievements.unlocked.includes(achievementId);
        }
        
        // Unlock a new achievement
        function unlockAchievement(category, achievementId, silent = false) {
            // Check if already unlocked
            if (isAchievementUnlocked(achievementId)) {
                return false;
            }
            
            // Get achievement data
            const achievement = ACHIEVEMENTS[category]?.[achievementId];
            if (!achievement) {
                console.warn('Unknown achievement:', category, achievementId);
                return false;
            }
            
            // Mark as unlocked
            playerAchievements.unlocked.push(achievementId);
            
            // Award XP
            gameState.totalXP += achievement.xp;
            
            // Save to localStorage
            saveAchievements();
            
            // Show celebration (unless silent)
            if (!silent) {
                showAchievementUnlock(achievement);
            }
            
            console.log(`üèÜ Achievement unlocked: ${achievement.name} (+${achievement.xp} XP)`);
            return true;
        }
        
        // Show full-screen achievement celebration
        function showAchievementUnlock(achievement) {
            // Create celebration overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;
            
            // Tier colors
            const tierColors = {
                common: '#94a3b8',
                uncommon: '#3b82f6',
                rare: '#a855f7',
                epic: '#f59e0b',
                legendary: '#ef4444'
            };
            
            const tierColor = tierColors[achievement.tier] || tierColors.common;
            
            // Achievement card
            const card = document.createElement('div');
            card.style.cssText = `
                background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
                border: 3px solid ${tierColor};
                border-radius: 20px;
                padding: 3rem;
                text-align: center;
                max-width: 500px;
                box-shadow: 0 0 50px ${tierColor}80;
                animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            `;
            
            card.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 1rem; animation: pulse 2s infinite;">üèÜ</div>
                <div style="color: ${tierColor}; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; font-size: 0.9rem; margin-bottom: 0.5rem;">
                    ${achievement.tier} Achievement
                </div>
                <div style="color: white; font-size: 2rem; font-weight: bold; margin-bottom: 1rem;">
                    ${achievement.name}
                </div>
                <div style="color: #94a3b8; font-size: 1.1rem; margin-bottom: 1.5rem;">
                    ${achievement.description}
                </div>
                <div style="background: ${tierColor}20; border: 1px solid ${tierColor}; border-radius: 10px; padding: 1rem; display: inline-block;">
                    <div style="color: ${tierColor}; font-size: 1.5rem; font-weight: bold;">+${achievement.xp} XP</div>
                </div>
                <div style="margin-top: 2rem; color: #64748b; font-size: 0.9rem;">Click anywhere to continue</div>
            `;
            
            overlay.appendChild(card);
            document.body.appendChild(overlay);
            
            // Add particle effects
            createConfetti(tierColor);
            
            // Click to close
            overlay.addEventListener('click', () => {
                overlay.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => overlay.remove(), 300);
            });
            
            // Auto-close after 5 seconds
            setTimeout(() => {
                if (overlay.parentElement) {
                    overlay.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => overlay.remove(), 300);
                }
            }, 5000);
        }
        
        // Create confetti particles
        function createConfetti(color) {
            const colors = [color, '#fbbf24', '#10b981', '#3b82f6', '#f59e0b'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.style.cssText = `
                        position: fixed;
                        width: 10px;
                        height: 10px;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        top: 50%;
                        left: 50%;
                        border-radius: 50%;
                        z-index: 10001;
                        animation: confettiFall ${1 + Math.random() * 2}s linear forwards;
                        transform: translate(-50%, -50%) rotate(${Math.random() * 360}deg);
                    `;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }
        
        // Add animations to document
        if (!document.getElementById('achievement-animations')) {
            const style = document.createElement('style');
            style.id = 'achievement-animations';
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
                @keyframes bounceIn {
                    0% { transform: scale(0); }
                    50% { transform: scale(1.1); }
                    100% { transform: scale(1); }
                }
                @keyframes pulse {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.2); }
                }
                @keyframes confettiFall {
                    0% {
                        transform: translate(-50%, -50%) translateY(0) rotate(0deg);
                        opacity: 1;
                    }
                    100% {
                        transform: translate(-50%, -50%) translateY(100vh) rotate(720deg);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // ========================================
        // GAME-SPECIFIC ACHIEVEMENT CHECKERS
        // ========================================
        
        // Check Explore Mode achievements
        function checkExploreAchievements() {
            const stats = playerAchievements.stats.explore;
            
            // Globe Trotter: Visit all 7 continents
            if (stats.continentsVisited.size >= 7) {
                unlockAchievement('explore', 'globeTrotter');
            }
            
            // Zoom Master: Use all zoom levels (2-19)
            if (stats.zoomLevelsUsed.size >= 10) {
                unlockAchievement('explore', 'zoomMaster');
            }
            
            // Layer Expert: Try all 10 map layers
            if (stats.layersUsed.size >= 10) {
                unlockAchievement('explore', 'layerExpert');
            }
            
            // Marker Maniac: Place 50+ markers
            if (stats.markersPlaced >= 50) {
                unlockAchievement('explore', 'markerManiac');
            }
            
            // Style Switcher: Toggle Fun Mode 10 times
            if (stats.modeToggles >= 10) {
                unlockAchievement('explore', 'styleSwitcher');
            }
        }
        
        // Check Coordinate Finder achievements
        function checkCoordinateAchievements() {
            const stats = playerAchievements.stats.coordinate;
            
            // Pinpoint Pro: 10 perfect finds (within 1km)
            if (stats.perfectFinds >= 10) {
                unlockAchievement('coordinate', 'pinpointPro');
            }
            
            // Format Fluent: Use both formats 5 times each
            if (stats.decimalUses >= 5 && stats.cardinalUses >= 5) {
                unlockAchievement('coordinate', 'formatFluent');
            }
            
            // Speed Demon: 5 finds in under 30 seconds each
            if (stats.speedFinds >= 5) {
                unlockAchievement('coordinate', 'speedDemon');
            }
            
            // Navigator: Complete 25 challenges
            if (stats.completions >= 25) {
                unlockAchievement('coordinate', 'navigator');
            }
            
            // Perfectionist: 100% accuracy on 10 finds
            if (stats.perfectAccuracyRuns >= 10) {
                unlockAchievement('coordinate', 'perfectionist');
            }
        }
        
        // Check Mystery Challenge achievements
        function checkMysteryAchievements() {
            const stats = playerAchievements.stats.mystery;
            
            // Mystery Solver: Solve 10 mysteries
            if (stats.solved >= 10) {
                unlockAchievement('mystery', 'mysterySolver');
            }
            
            // Speed Detective: Solve in under 20 seconds (tracked per solve)
            // This is checked in the mystery solve function
            
            // No Hints: Solve without hints 5 times
            if (stats.noHintSolves >= 5) {
                unlockAchievement('mystery', 'noHints');
            }
            
            // Continental Expert: Solve 1 from each continent (6 continents)
            if (stats.continentsSolved.size >= 6) {
                unlockAchievement('mystery', 'continentalExpert');
            }
            
            // Streak Master: 5-mystery win streak
            if (stats.streak >= 5) {
                unlockAchievement('mystery', 'streakMaster');
            }
            
            // Mystery Master: Solve all 70 locations
            if (stats.uniqueLocationsSolved.size >= 70) {
                unlockAchievement('mystery', 'mysteryMaster');
            }
            
            // Lightning Round: 3 solves in under 2 minutes total
            if (stats.lightningRounds >= 1) {
                unlockAchievement('mystery', 'lightningRound');
            }
        }
        
        // Check Scavenger Hunt achievements
        function checkScavengerAchievements() {
            const stats = playerAchievements.stats.scavenger;
            
            // Photo Finish: Complete 10 hunts
            if (stats.completed >= 10) {
                unlockAchievement('scavenger', 'photoFinish');
            }
            
            // Speed Scavenger: Complete in under 5 minutes (tracked per hunt)
            // Checked during hunt completion
            
            // Eagle Eye: 95%+ accuracy (tracked per hunt)
            // Checked during hunt completion
            
            // World Explorer: Complete hunts on all continents
            if (stats.continentsCompleted.size >= 6) {
                unlockAchievement('scavenger', 'worldExplorer');
            }
            
            // Detail Detective: Find 5 hidden bonus items
            if (stats.bonusItemsFound >= 5) {
                unlockAchievement('scavenger', 'detailDetective');
            }
            
            // Scavenger Legend: Complete 25 hunts
            if (stats.completed >= 25) {
                unlockAchievement('scavenger', 'scavengerLegend');
            }
        }
        
        // Check Guess Mode achievements
        function checkGuessAchievements() {
            const stats = playerAchievements.stats.guess;
            
            // Sharp Shooter: 10 guesses within 100km
            if (stats.closeGuesses >= 10) {
                unlockAchievement('guess', 'sharpShooter');
            }
            
            // Geography Genius: 90%+ accuracy over 20 photos
            const recentAccuracy = stats.accuracyRuns.slice(-20);
            if (recentAccuracy.length >= 20) {
                const avgAccuracy = recentAccuracy.reduce((a,b) => a+b, 0) / recentAccuracy.length;
                if (avgAccuracy >= 90) {
                    unlockAchievement('guess', 'geographyGenius');
                }
            }
            
            // Instant Identifier: Guess correctly in under 5 seconds, 5 times
            if (stats.speedGuesses >= 5) {
                unlockAchievement('guess', 'instantIdentifier');
            }
            
            // Photo Master: View all 100 photos
            if (stats.photosSeen.size >= 100) {
                unlockAchievement('guess', 'photoMaster');
            }
            
            // Perfect Round: 5/5 perfect guesses (tracked per round)
            // Checked during round completion
            
            // Detail Expert: Identify from cropped photos 10 times
            if (stats.croppedPhotoGuesses >= 10) {
                unlockAchievement('guess', 'detailExpert');
            }
        }
        
        // Check Create Heist achievements
        function checkHeistAchievements() {
            const stats = playerAchievements.stats.heist;
            
            // Architect: Create 5 heists
            if (stats.created >= 5) {
                unlockAchievement('heist', 'architect');
            }
            
            // Global Planner: Heists on all continents
            if (stats.continents.size >= 6) {
                unlockAchievement('heist', 'globalPlanner');
            }
            
            // Master Thief: Create 25 heists
            if (stats.created >= 25) {
                unlockAchievement('heist', 'masterThief');
            }
            
            // Speed Designer: Create in under 2 minutes (tracked per heist)
            // Checked during heist creation
            
            // Perfectionist: All custom waypoints
            if (stats.customHeists >= 5) {
                unlockAchievement('heist', 'heistPerfectionist');
            }
            
            // Influencer: Share 10 heists
            if (stats.shared >= 10) {
                unlockAchievement('heist', 'influencer');
            }
        }
        
        // Check Alaska Adventure achievements (already exists in gameState)
        function checkAlaskaAchievements() {
            const alaska = gameState.alaska;
            const achievements = playerAchievements.stats.alaska.achievements;
            
            // Count locations by type
            const locationTypes = { mountain: 0, river: 0, park: 0, city: 0 };
            
            alaskaRounds.forEach(round => {
                round.locations.forEach(loc => {
                    if (alaska.foundLocations.includes(loc.name)) {
                        if (locationTypes[loc.type] !== undefined) {
                            locationTypes[loc.type]++;
                        }
                    }
                });
            });
            
            // Mountain Master: Find 5+ mountains
            if (locationTypes.mountain >= 5 && !achievements.mountainMaster) {
                achievements.mountainMaster = true;
                unlockAchievement('alaska', 'mountainMaster');
            }
            
            // River Runner: Find 3+ rivers
            if (locationTypes.river >= 3 && !achievements.riverRunner) {
                achievements.riverRunner = true;
                unlockAchievement('alaska', 'riverRunner');
            }
            
            // Park Explorer: Find 5+ parks
            if (locationTypes.park >= 5 && !achievements.parkExplorer) {
                achievements.parkExplorer = true;
                unlockAchievement('alaska', 'parkExplorer');
            }
            
            // City Finder: Find 8+ cities
            if (locationTypes.city >= 8 && !achievements.cityFinder) {
                achievements.cityFinder = true;
                unlockAchievement('alaska', 'cityFinder');
            }
            
            // Alaska Expert: Find all 50 locations
            if (alaska.totalFound >= 50 && !achievements.alaskaExpert) {
                achievements.alaskaExpert = true;
                unlockAchievement('alaska', 'alaskaExpert');
            }
            
            // Save updated achievements
            saveAchievements();
        }
        
        // Check Universal achievements (cross-game)
        function checkUniversalAchievements() {
            const stats = playerAchievements.stats.universal;
            
            // Game Hopper: Try all 7 game modes
            if (stats.modesPlayed.size >= 7) {
                unlockAchievement('universal', 'gameHopper');
            }
            
            // Jack of All Trades: Complete 1 of each mode
            if (stats.modesCompleted.size >= 7) {
                unlockAchievement('universal', 'jackOfAllTrades');
            }
            
            // Master of All: Expert in all 7 modes
            if (stats.modesMastered.size >= 7) {
                unlockAchievement('universal', 'masterOfAll');
            }
            
            // Speed Demon: 10 games in under 1 hour
            const now = Date.now();
            const recentGames = stats.gamesThisHour.filter(t => now - t < 3600000);
            if (recentGames.length >= 10) {
                unlockAchievement('universal', 'universalSpeedDemon');
            }
            
            // Streak Legend: 7-day play streak
            if (stats.playDates.size >= 7) {
                // Check if consecutive days
                const dates = Array.from(stats.playDates).sort();
                let consecutive = 1;
                for (let i = 1; i < dates.length; i++) {
                    const prev = new Date(dates[i-1]);
                    const curr = new Date(dates[i]);
                    const diffDays = Math.floor((curr - prev) / (1000 * 60 * 60 * 24));
                    if (diffDays === 1) consecutive++;
                    else consecutive = 1;
                    if (consecutive >= 7) {
                        unlockAchievement('universal', 'streakLegend');
                        break;
                    }
                }
            }
            
            // Statistician: View stats 10 times
            if (stats.statsViews >= 10) {
                unlockAchievement('universal', 'statistician');
            }
            
            // Style Icon: Use Fun Mode in all 7 games
            if (stats.funModeGames.size >= 7) {
                unlockAchievement('universal', 'styleIcon');
            }
            
            // Cartographer: Use all 10 map layers
            // This overlaps with Explore mode, so check explore stats
            if (playerAchievements.stats.explore.layersUsed.size >= 10) {
                unlockAchievement('universal', 'cartographer');
            }
            
            // Perfectionist: 100% accuracy in 3 different modes
            if (stats.perfectModes.size >= 3) {
                unlockAchievement('universal', 'universalPerfectionist');
            }
            
            // Achievement Hunter: Unlock 30 achievements
            if (playerAchievements.unlocked.length >= 30) {
                unlockAchievement('universal', 'achievementHunter');
            }
        }
        
        // Track today's play date
        function trackPlayDate() {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            playerAchievements.stats.universal.playDates.add(today);
            saveAchievements();
            checkUniversalAchievements();
        }
        
        // ========================================
        // GAME COMPLETION MODAL SYSTEM (Quick Win #2)
        // ========================================
        
        // Show game completion modal with stats
        window.showGameComplete = function(gameMode, stats) {
            const modal = document.getElementById('game-complete-modal');
            const title = document.getElementById('completion-title');
            const statsDiv = document.getElementById('completion-stats');
            const message = document.getElementById('completion-message');
            const emoji = document.getElementById('completion-emoji');
            const playAgainBtn = document.getElementById('play-again-btn');
            
            // Store current game mode for restart
            modal.dataset.gameMode = gameMode;
            
            // Customize based on game mode
            switch(gameMode) {
                case 'mystery':
                    emoji.textContent = 'üéØ';
                    title.textContent = 'üéØ Mystery Challenge Complete!';
                    statsDiv.innerHTML = `
                        <div style="font-size: 48px; color: #ffd700; margin-bottom: 10px;">${stats.score || 0}</div>
                        <div style="font-size: 20px; color: #fff;">FINAL SCORE</div>
                        <div style="margin-top: 20px; font-size: 16px; color: #ccc;">
                            ‚úÖ Correct: ${stats.correct || 0}/5<br>
                            ‚ö° Best Time: ${stats.bestTime || 0}s<br>
                            üî• Streak: ${stats.streak || 0}
                        </div>
                    `;
                    message.textContent = (stats.score || 0) > 400 ? "Outstanding detective work! üî•" : 
                                          (stats.score || 0) > 300 ? "Great job finding those locations! üëè" :
                                          "Keep practicing, you'll get faster! üí™";
                    playAgainBtn.onclick = () => { closeCompletionModal(); startMysteryMode(); };
                    break;
                    
                case 'scavenger':
                    emoji.textContent = 'üåç';
                    title.textContent = 'üåç Scavenger Hunt Complete!';
                    statsDiv.innerHTML = `
                        <div style="font-size: 48px; color: #ffd700; margin-bottom: 10px;">${stats.found || 0}/10</div>
                        <div style="font-size: 20px; color: #fff;">LOCATIONS FOUND</div>
                        <div style="margin-top: 20px; font-size: 16px; color: #ccc;">
                            ‚è±Ô∏è Time: ${stats.time || 0}s<br>
                            üéØ Accuracy: ${stats.accuracy || 0}%<br>
                            ‚≠ê XP Earned: +${stats.xp || 0}
                        </div>
                    `;
                    message.textContent = (stats.found || 0) === 10 ? "Perfect score! You're a geography master! üèÜ" :
                                          (stats.found || 0) >= 7 ? "Great hunting skills! üéØ" :
                                          "Keep exploring to improve! üó∫Ô∏è";
                    playAgainBtn.onclick = () => { closeCompletionModal(); startScavengerIntro(); };
                    break;
                    
                case 'guess':
                    emoji.textContent = 'üì∏';
                    title.textContent = 'üì∏ Guess Mode Complete!';
                    statsDiv.innerHTML = `
                        <div style="font-size: 48px; color: #ffd700; margin-bottom: 10px;">${stats.correct || 0}/5</div>
                        <div style="font-size: 20px; color: #fff;">CORRECT GUESSES</div>
                        <div style="margin-top: 20px; font-size: 16px; color: #ccc;">
                            üéØ Accuracy: ${((stats.correct || 0)/5*100).toFixed(0)}%<br>
                            ‚ö° Avg Time: ${stats.avgTime || 0}s<br>
                            ‚≠ê XP Earned: +${stats.xp || 0}
                        </div>
                    `;
                    message.textContent = (stats.correct || 0) === 5 ? "Perfect! You know your landmarks! üåü" :
                                          (stats.correct || 0) >= 3 ? "Nice work identifying those places! üëç" :
                                          "Study those landmarks and try again! üìö";
                    playAgainBtn.onclick = () => { closeCompletionModal(); startGuessIntro(); };
                    break;
                    
                case 'alaska':
                    emoji.textContent = 'üèîÔ∏è';
                    title.textContent = 'üèîÔ∏è Alaska Adventure Complete!';
                    statsDiv.innerHTML = `
                        <div style="font-size: 48px; color: #ffd700; margin-bottom: 10px;">Round ${stats.round || 1}/5</div>
                        <div style="font-size: 20px; color: #fff;">COMPLETED</div>
                        <div style="margin-top: 20px; font-size: 16px; color: #ccc;">
                            üìç Found: ${stats.found || 0}/10<br>
                            üèîÔ∏è Total Found: ${stats.totalFound || 0}/50<br>
                            ‚≠ê XP Earned: +${stats.xp || 0}
                        </div>
                    `;
                    message.textContent = (stats.round || 1) === 5 ? "You've explored all of Alaska! üéâ" :
                                          `Round ${stats.round || 1} complete! On to round ${(stats.round || 1) + 1}! üöÄ`;
                    playAgainBtn.onclick = () => { closeCompletionModal(); startAlaskaIntro(); };
                    break;
                    
                default:
                    emoji.textContent = 'üéâ';
                    title.textContent = 'Game Complete!';
                    statsDiv.innerHTML = '<p>Great job!</p>';
                    message.textContent = 'Keep exploring!';
                    playAgainBtn.onclick = closeCompletionModal;
            }
            
            modal.style.display = 'flex';
            
            // Add confetti animation
            createConfetti('#ffd700');
            setTimeout(() => createConfetti('#764ba2'), 200);
            setTimeout(() => createConfetti('#667eea'), 400);
        }
        
        // Close completion modal
        window.closeCompletionModal = function() {
            document.getElementById('game-complete-modal').style.display = 'none';
        }
        
        // Restart current game (called by Play Again button)
        window.restartCurrentGame = function() {
            const modal = document.getElementById('game-complete-modal');
            const gameMode = modal.dataset.gameMode;
            closeCompletionModal();
            
            // Restart based on stored game mode
            if (gameMode === 'mystery') {
                startMysteryMode();
            } else if (gameMode === 'scavenger') {
                startScavengerIntro();
            } else if (gameMode === 'guess') {
                startGuessIntro();
            } else if (gameMode === 'alaska') {
                startAlaskaIntro();
            }
        }
        
        // ========================================
        // MAKE ACHIEVEMENT FUNCTIONS GLOBALLY ACCESSIBLE FOR DEBUG PANEL
        // ========================================
        // Core functions
        window.saveAchievements = saveAchievements;
        window.unlockAchievement = unlockAchievement;
        window.isAchievementUnlocked = isAchievementUnlocked;
        window.showAchievementUnlock = showAchievementUnlock;
        
        // Checker functions
        window.checkExploreAchievements = checkExploreAchievements;
        window.checkCoordinateAchievements = checkCoordinateAchievements;
        window.checkMysteryAchievements = checkMysteryAchievements;
        window.checkScavengerAchievements = checkScavengerAchievements;
        window.checkGuessAchievements = checkGuessAchievements;
        window.checkHeistAchievements = checkHeistAchievements;
        window.checkAlaskaAchievements = checkAlaskaAchievements;
        window.checkUniversalAchievements = checkUniversalAchievements;
        
        // ========================================
        // ACHIEVEMENT TESTING DEBUG PANEL
        // ========================================
        
        window.toggleDebugPanel = function() {
            const panel = document.getElementById('debug-panel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                populateDebugPanel();
            } else {
                panel.style.display = 'none';
            }
        }
        
        // Debug test functions (globally accessible)
        // These functions will be called after DOMContentLoaded, so all game functions will be available
        window.testExploreGlobeTrotter = function() { 
            playerAchievements.stats.explore.continentsVisited = new Set(['Africa', 'Asia', 'Europe', 'North America', 'South America', 'Oceania', 'Antarctica']); 
            window.saveAchievements(); 
            window.checkExploreAchievements(); 
        };
        window.testExploreZoomMaster = function() { 
            playerAchievements.stats.explore.zoomLevelsUsed = new Set([1,2,3,4,5,6,7,8,9,10,11]); 
            window.saveAchievements(); 
            window.checkExploreAchievements(); 
        };
        window.testExploreMarkerManiac = function() { 
            playerAchievements.stats.explore.markersPlaced = 50; 
            window.saveAchievements(); 
            window.checkExploreAchievements(); 
        };
        window.testExploreLayerExpert = function() { 
            playerAchievements.stats.explore.layersUsed = new Set(['Street','Satellite','Topo','Dark','Light','Terrain','OpenStreet','CartoDB','Stamen','Esri']); 
            window.saveAchievements(); 
            window.checkExploreAchievements(); 
        };
        window.testCoordinateNavigator = function() { 
            playerAchievements.stats.coordinate.completions = 25; 
            window.saveAchievements(); 
            window.checkCoordinateAchievements(); 
        };
        window.testCoordinateFormatFluent = function() { 
            playerAchievements.stats.coordinate.decimalUses = 5; 
            playerAchievements.stats.coordinate.cardinalUses = 5; 
            window.saveAchievements(); 
            window.checkCoordinateAchievements(); 
        };
        window.testCoordinatePerfectionist = function() { 
            playerAchievements.stats.coordinate.perfectAccuracyRuns = 10; 
            window.saveAchievements(); 
            window.checkCoordinateAchievements(); 
        };
        window.testMysterySolver = function() { 
            playerAchievements.stats.mystery.solved = 10; 
            window.saveAchievements(); 
            window.checkMysteryAchievements(); 
        };
        window.testMysteryStreakMaster = function() { 
            playerAchievements.stats.mystery.streak = 5; 
            window.saveAchievements(); 
            window.checkMysteryAchievements(); 
        };
        window.testMysteryContinental = function() { 
            playerAchievements.stats.mystery.continentsSolved = new Set(['Africa','Asia','Europe','North America','South America','Oceania']); 
            window.saveAchievements(); 
            window.checkMysteryAchievements(); 
        };
        window.testMysteryMaster = function() { 
            playerAchievements.stats.mystery.uniqueLocationsSolved = new Set(Array(70).fill(0).map((_,i) => i)); 
            window.saveAchievements(); 
            window.checkMysteryAchievements(); 
        };
        window.testScavengerPhotoFinish = function() { 
            playerAchievements.stats.scavenger.completed = 10; 
            window.saveAchievements(); 
            window.checkScavengerAchievements(); 
        };
        window.testScavengerSpeedHunter = function() { 
            playerAchievements.stats.scavenger.speedHunts = 5; 
            window.saveAchievements(); 
            window.checkScavengerAchievements(); 
        };
        window.testScavengerEagleEye = function() { 
            playerAchievements.stats.scavenger.highAccuracyHunts = 20; 
            window.saveAchievements(); 
            window.checkScavengerAchievements(); 
        };
        window.testScavengerWorldExplorer = function() { 
            playerAchievements.stats.scavenger.continentsCompleted = new Set(['Africa','Asia','Europe','North America','South America','Oceania']); 
            window.saveAchievements(); 
            window.checkScavengerAchievements(); 
        };
        window.testGuessSharpShooter = function() { 
            playerAchievements.stats.guess.closeGuesses = 10; 
            window.saveAchievements(); 
            window.checkGuessAchievements(); 
        };
        window.testGuessGeographyGenius = function() { 
            playerAchievements.stats.guess.accuracyRuns = [92, 95, 91, 88, 94]; 
            window.saveAchievements(); 
            window.checkGuessAchievements(); 
        };
        window.testGuessPhotoMaster = function() { 
            playerAchievements.stats.guess.photosSeen = new Set(Array(100).fill(0).map((_,i) => 'photo' + i)); 
            window.saveAchievements(); 
            window.checkGuessAchievements(); 
        };
        window.testHeistArchitect = function() { 
            playerAchievements.stats.heist.created = 5; 
            window.saveAchievements(); 
            window.checkHeistAchievements(); 
        };
        window.testHeistMasterThief = function() { 
            playerAchievements.stats.heist.created = 25; 
            window.saveAchievements(); 
            window.checkHeistAchievements(); 
        };
        window.testAlaskaMountainMaster = function() { 
            // Add 5 mountains to foundLocations
            gameState.alaska.foundLocations = ['Mount Denali', 'Mount Wrangell', 'Mount Foraker', 'Mount Hunter', 'Mount Drum'];
            gameState.alaska.totalFound = 5;
            window.saveAchievements(); 
            window.checkAlaskaAchievements(); 
        };
        window.testAlaskaRiverRunner = function() { 
            // Add 3 rivers to foundLocations
            gameState.alaska.foundLocations = ['Yukon River', 'Copper River', 'Kuskokwim River'];
            gameState.alaska.totalFound = 3;
            window.saveAchievements(); 
            window.checkAlaskaAchievements(); 
        };
        window.testAlaskaParkExplorer = function() { 
            // Add 5 parks to foundLocations
            gameState.alaska.foundLocations = ['Denali National Park', 'Wrangell-St. Elias National Park', 'Kenai Fjords National Park', 'Glacier Bay National Park', 'Katmai National Park'];
            gameState.alaska.totalFound = 5;
            window.saveAchievements(); 
            window.checkAlaskaAchievements(); 
        };
        window.testAlaskaCityFinder = function() { 
            // Add 8 cities to foundLocations
            gameState.alaska.foundLocations = ['Anchorage', 'Fairbanks', 'Juneau', 'Sitka', 'Ketchikan', 'Glennallen', 'Nome', 'Barrow'];
            gameState.alaska.totalFound = 8;
            window.saveAchievements(); 
            window.checkAlaskaAchievements(); 
        };
        window.testAlaskaExpert = function() { 
            // Set total found to 50
            gameState.alaska.totalFound = 50;
            window.saveAchievements(); 
            window.checkAlaskaAchievements(); 
        };
        window.testUniversalGameHopper = function() { 
            playerAchievements.stats.universal.modesPlayed = new Set(['explore','coordinate','mystery','scavenger','guess','heist','alaska']); 
            window.saveAchievements(); 
            window.checkUniversalAchievements(); 
        };
        window.testUniversalJackOfAllTrades = function() { 
            playerAchievements.stats.universal.modesCompleted = new Set(['explore','coordinate','mystery','scavenger','guess','heist','alaska']); 
            window.saveAchievements(); 
            window.checkUniversalAchievements(); 
        };
        
        function populateDebugPanel() {
            const content = document.getElementById('debug-content');
            const testButtons = [
                { name: 'üåç Explore: Globe Trotter', func: 'testExploreGlobeTrotter' },
                { name: 'üî≠ Explore: Zoom Master', func: 'testExploreZoomMaster' },
                { name: 'üìç Explore: Marker Maniac', func: 'testExploreMarkerManiac' },
                { name: 'üó∫Ô∏è Explore: Layer Expert', func: 'testExploreLayerExpert' },
                { name: 'üéØ Coordinate: Navigator', func: 'testCoordinateNavigator' },
                { name: 'üåê Coordinate: Format Fluent', func: 'testCoordinateFormatFluent' },
                { name: 'üíØ Coordinate: Perfectionist', func: 'testCoordinatePerfectionist' },
                { name: 'üïµÔ∏è Mystery: Solver', func: 'testMysterySolver' },
                { name: 'üî• Mystery: Streak Master', func: 'testMysteryStreakMaster' },
                { name: 'üåé Mystery: Continental', func: 'testMysteryContinental' },
                { name: 'üéì Mystery: Master', func: 'testMysteryMaster' },
                { name: 'üì∏ Scavenger: Photo Finish', func: 'testScavengerPhotoFinish' },
                { name: '‚ö° Scavenger: Speed Hunter', func: 'testScavengerSpeedHunter' },
                { name: 'ü¶Ö Scavenger: Eagle Eye', func: 'testScavengerEagleEye' },
                { name: 'üåè Scavenger: World Explorer', func: 'testScavengerWorldExplorer' },
                { name: 'üéØ Guess: Sharp Shooter', func: 'testGuessSharpShooter' },
                { name: 'üß† Guess: Geography Genius', func: 'testGuessGeographyGenius' },
                { name: 'üì∏ Guess: Photo Master', func: 'testGuessPhotoMaster' },
                { name: 'üèóÔ∏è Heist: Architect', func: 'testHeistArchitect' },
                { name: 'ü¶π Heist: Master Thief', func: 'testHeistMasterThief' },
                { name: '‚õ∞Ô∏è Alaska: Mountain Master', func: 'testAlaskaMountainMaster' },
                { name: 'üèûÔ∏è Alaska: River Runner', func: 'testAlaskaRiverRunner' },
                { name: 'üèïÔ∏è Alaska: Park Explorer', func: 'testAlaskaParkExplorer' },
                { name: 'üèôÔ∏è Alaska: City Finder', func: 'testAlaskaCityFinder' },
                { name: 'üéñÔ∏è Alaska: Expert', func: 'testAlaskaExpert' },
                { name: 'üéÆ Universal: Game Hopper', func: 'testUniversalGameHopper' },
                { name: 'üèÜ Universal: Jack of All Trades', func: 'testUniversalJackOfAllTrades' },
            ];
            
            content.innerHTML = testButtons.map(btn => `
                <button onclick="${btn.func}()" class="btn" style="font-size: 13px; padding: 12px; text-align: left; white-space: normal; line-height: 1.4;">
                    ${btn.name}
                </button>
            `).join('');
        }
        
        window.clearAllAchievements = function() {
            if (confirm('Clear all achievements and stats? This cannot be undone!')) {
                localStorage.removeItem('playerAchievements');
                location.reload();
            }
        }
        
        window.unlockAllAchievements = function() {
            if (confirm('Unlock all 45 achievements at once?')) {
                Object.keys(ACHIEVEMENTS).forEach(category => {
                    Object.keys(ACHIEVEMENTS[category]).forEach(id => {
                        unlockAchievement(category, id, true);
                    });
                });
                showToast('success', 'üèÜ All Achievements Unlocked!', '45/45 achievements - You are a legend!', 5000);
            }
        }
        
        window.showAchievementStats = function() {
            console.log('üìä Current Achievement Stats:', playerAchievements.stats);
            console.log('üèÜ Unlocked Achievements:', playerAchievements.unlocked);
            console.log('üìà Total Unlocked:', playerAchievements.unlocked.length + '/45');
            alert(`Achievement Stats:\n\nUnlocked: ${playerAchievements.unlocked.length}/45\n\nCheck console (F12) for full details!`);
        }
        
        window.testRandomAchievement = function() {
            const categories = Object.keys(ACHIEVEMENTS);
            const randomCat = categories[Math.floor(Math.random() * categories.length)];
            const achievements = Object.keys(ACHIEVEMENTS[randomCat]);
            const randomAch = achievements[Math.floor(Math.random() * achievements.length)];
            unlockAchievement(randomCat, randomAch);
        }
        
        // Keyboard shortcut to open debug panel: Ctrl+Shift+A
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                toggleDebugPanel();
            }
        });
        
        // Glennallen home coordinates
        const GLENNALLEN = { lat: 62.1089, lon: -145.5467 };
        
        // Alaska Adventure locations - 5 ROUNDS of 10 locations each!
        const alaskaRounds = [
            // ROUND 1: HOME TERRITORY - Around Glennallen
            {
                name: "Round 1: Home Territory",
                description: "Explore the area around your hometown of Glennallen",
                locations: [
                    { name: "Glennallen", lat: 62.1089, lon: -145.5467, clue: "üè† Your hometown! At the junction of two major highways", fact: "Gateway to Wrangell-St. Elias National Park, population ~500", type: "city" },
                    { name: "Copper River", lat: 61.0444, lon: -145.4064, clue: "üåä A major river south of Glennallen, famous for salmon", fact: "290 miles long, world-famous for Copper River salmon", type: "river" },
                    { name: "Mount Wrangell", lat: 62.0059, lon: -144.0187, clue: "üåã Active volcano east of Glennallen, over 14,000 feet", fact: "One of the largest active volcanoes in North America - 14,163 ft", type: "mountain" },
                    { name: "Wrangell-St. Elias National Park", lat: 61.7104, lon: -142.9857, clue: "üèûÔ∏è Largest US National Park, southeast of Glennallen", fact: "6 times bigger than Yellowstone! 13.2 million acres", type: "park" },
                    { name: "Gulkana", lat: 62.2794, lon: -145.4553, clue: "üèòÔ∏è Small village north of Glennallen on the Richardson Highway", fact: "Native Ahtna village, population ~100", type: "city" },
                    { name: "Tazlina Glacier", lat: 61.4333, lon: -146.5167, clue: "üßä Glacier west of Glennallen, feeds into a river", fact: "One of many glaciers in the Copper River Basin", type: "glacier" },
                    { name: "Chitina", lat: 61.5156, lon: -144.4406, clue: "üöÇ Historic mining town southeast on the Copper River", fact: "Gateway to McCarthy, old railroad town", type: "city" },
                    { name: "Liberty Falls", lat: 61.0842, lon: -146.2867, clue: "üíß Scenic waterfall south of Glennallen on Richardson Highway", fact: "Popular roadside stop, 300-foot cascading waterfall", type: "landmark" },
                    { name: "Tonsina", lat: 61.6572, lon: -145.1728, clue: "üèòÔ∏è Tiny community south of Glennallen", fact: "Small settlement along the Richardson Highway", type: "city" },
                    { name: "Mentasta Lake", lat: 62.9167, lon: -143.7500, clue: "üèîÔ∏è Lake northeast of Glennallen near Tok cutoff", fact: "Native village in the Alaska Range foothills", type: "landmark" }
                ]
            },
            // ROUND 2: MAJOR CITIES - Alaska's Urban Centers
            {
                name: "Round 2: Major Cities",
                description: "Find Alaska's most important urban centers",
                locations: [
                    { name: "Anchorage", lat: 61.2181, lon: -149.9003, clue: "üèõÔ∏è Alaska's largest city, on the coast west of Glennallen", fact: "Population 290,000 - 40% of all Alaskans live here!", type: "city" },
                    { name: "Fairbanks", lat: 64.8378, lon: -147.7164, clue: "‚ùÑÔ∏è Second-largest city, far north in Interior Alaska", fact: "Golden Heart City - best place to see Northern Lights!", type: "city" },
                    { name: "Juneau", lat: 58.3019, lon: -134.4197, clue: "üèõÔ∏è State capital in Southeast Alaska, no road access", fact: "Only US capital inaccessible by car - boat or plane only!", type: "city" },
                    { name: "Sitka", lat: 57.0531, lon: -135.3300, clue: "üåä Historic coastal city on an island in Southeast", fact: "Former Russian capital of Alaska, rich Native heritage", type: "city" },
                    { name: "Ketchikan", lat: 55.3422, lon: -131.6461, clue: "üé£ Southernmost major city, 'Salmon Capital of the World'", fact: "Averages 152 inches of rain per year!", type: "city" },
                    { name: "Kenai", lat: 60.5544, lon: -151.2583, clue: "üé£ City on the Kenai Peninsula, southwest of Anchorage", fact: "Famous for world-record king salmon fishing", type: "city" },
                    { name: "Valdez", lat: 61.1308, lon: -146.3483, clue: "‚öì Ice-free port south of Glennallen, end of oil pipeline", fact: "Terminal of the Trans-Alaska Pipeline System", type: "city" },
                    { name: "Homer", lat: 59.6425, lon: -151.5483, clue: "ü¶Ö Coastal town on Kachemak Bay, 'Halibut Capital'", fact: "End of the road system on Kenai Peninsula", type: "city" },
                    { name: "Seward", lat: 60.1042, lon: -149.4422, clue: "üö¢ Port city south of Anchorage, gateway to Kenai Fjords", fact: "Start of the historic Iditarod Trail", type: "city" },
                    { name: "Bethel", lat: 60.7922, lon: -161.7558, clue: "‚úàÔ∏è Hub city in Southwest Alaska on the Kuskokwim River", fact: "Largest town in Western Alaska, only accessible by air", type: "city" }
                ]
            },
            // ROUND 3: NATURAL WONDERS - Mountains, Rivers, Glaciers
            {
                name: "Round 3: Natural Wonders",
                description: "Discover Alaska's incredible natural features",
                locations: [
                    { name: "Denali (Mt. McKinley)", lat: 63.0692, lon: -151.0070, clue: "üèîÔ∏è North America's highest peak, north of Anchorage", fact: "20,310 feet - the tallest mountain in North America!", type: "mountain" },
                    { name: "Mendenhall Glacier", lat: 58.4202, lon: -134.5503, clue: "üßä Famous glacier near Juneau, easily accessible", fact: "13 miles long, retreating due to climate change", type: "glacier" },
                    { name: "Yukon River", lat: 64.5011, lon: -164.9936, clue: "üåä One of longest rivers in North America, flows through Interior", fact: "1,980 miles long - third longest river in US", type: "river" },
                    { name: "Matanuska Glacier", lat: 61.7667, lon: -147.7500, clue: "üßä Accessible glacier northeast of Anchorage", fact: "27 miles long, one of few you can drive to!", type: "glacier" },
                    { name: "Prince William Sound", lat: 60.7831, lon: -147.0681, clue: "üåä Large sound south of Valdez, known for wildlife", fact: "Site of 1989 Exxon Valdez oil spill, now recovered", type: "landmark" },
                    { name: "Brooks Falls", lat: 58.5592, lon: -155.8742, clue: "üêª Famous waterfall where bears catch salmon, Katmai area", fact: "World-famous for brown bears fishing for salmon", type: "landmark" },
                    { name: "Malaspina Glacier", lat: 59.9500, lon: -140.5333, clue: "üßä Largest piedmont glacier in world, Southeast Alaska", fact: "Larger than Rhode Island at 1,500 square miles!", type: "glacier" },
                    { name: "Harding Icefield", lat: 59.9667, lon: -150.0167, clue: "üßä Massive icefield in Kenai Fjords, feeds many glaciers", fact: "300 square miles of ice, over 40 glaciers flow from it", type: "glacier" },
                    { name: "Turnagain Arm", lat: 60.9667, lon: -149.7000, clue: "üåä Scenic waterway south of Anchorage with huge tidal bore", fact: "Has one of the highest tidal ranges in world - 40 feet!", type: "landmark" },
                    { name: "Knik Glacier", lat: 61.4500, lon: -148.6167, clue: "üßä Glacier northeast of Palmer, accessible by hiking", fact: "25 miles long, part of the massive Knik Glacier system", type: "glacier" }
                ]
            },
            // ROUND 4: PARKS & WILDLIFE - Protected Areas
            {
                name: "Round 4: Parks & Wildlife",
                description: "Explore Alaska's incredible national parks and refuges",
                locations: [
                    { name: "Denali National Park", lat: 63.1148, lon: -151.1926, clue: "üèûÔ∏è Famous park surrounding North America's highest peak", fact: "6 million acres, home to grizzlies, wolves, caribou", type: "park" },
                    { name: "Kenai Fjords National Park", lat: 59.8117, lon: -149.9594, clue: "üßä Park on Kenai Peninsula, famous for glaciers and fjords", fact: "607,000 acres of ice, mountains, and wildlife", type: "park" },
                    { name: "Glacier Bay National Park", lat: 58.6658, lon: -136.9006, clue: "üßä Southeast Alaska park, UNESCO World Heritage Site", fact: "1,000+ glaciers, amazing whale watching!", type: "park" },
                    { name: "Katmai National Park", lat: 58.5969, lon: -155.0617, clue: "üêª Southwest park famous for brown bears fishing", fact: "Over 2,000 brown bears - densest population in world!", type: "park" },
                    { name: "Lake Clark National Park", lat: 60.4127, lon: -154.3267, clue: "üèûÔ∏è Remote park west of Anchorage, active volcanoes", fact: "4 million acres, two active volcanoes", type: "park" },
                    { name: "Gates of the Arctic National Park", lat: 67.7873, lon: -153.2967, clue: "üèîÔ∏è Northernmost park, entirely above Arctic Circle", fact: "Second-largest US park, no roads or trails!", type: "park" },
                    { name: "Arctic National Wildlife Refuge", lat: 69.3556, lon: -145.0000, clue: "ü¶å Massive refuge in far northeast, caribou calving grounds", fact: "19.6 million acres - largest wildlife refuge in US", type: "park" },
                    { name: "Tongass National Forest", lat: 57.0000, lon: -135.0000, clue: "üå≤ Largest US national forest, covers most of Southeast", fact: "17 million acres - largest temperate rainforest in world!", type: "park" },
                    { name: "Chugach National Forest", lat: 60.8972, lon: -148.0000, clue: "üå≤ Forest east of Anchorage, second-largest in US", fact: "6.9 million acres, most-visited forest in America", type: "park" },
                    { name: "Kodiak National Wildlife Refuge", lat: 57.4333, lon: -153.9667, clue: "üêª Island refuge famous for giant brown bears", fact: "Home to 3,000+ Kodiak bears - largest bears on Earth!", type: "park" }
                ]
            },
            // ROUND 5: HISTORIC & CULTURAL SITES
            {
                name: "Round 5: Historic Sites",
                description: "Discover Alaska's rich history and cultural landmarks",
                locations: [
                    { name: "Barrow (Utqiaƒ°vik)", lat: 71.2906, lon: -156.7886, clue: "‚ùÑÔ∏è Northernmost US city, on the Arctic Ocean", fact: "Furthest north you can go in USA! 65 days of darkness", type: "city" },
                    { name: "Nome", lat: 64.5011, lon: -165.4064, clue: "‚õèÔ∏è Historic gold rush town on Seward Peninsula", fact: "End of the famous Iditarod dog sled race!", type: "city" },
                    { name: "Skagway", lat: 59.4586, lon: -135.3136, clue: "üöÇ Historic gold rush town in Southeast, White Pass railroad", fact: "Gateway to Klondike Gold Rush in 1890s", type: "city" },
                    { name: "Sitka National Historical Park", lat: 57.0467, lon: -135.3194, clue: "üóø Park in Sitka with Native totem poles and history", fact: "Site of 1804 Battle of Sitka between Russians and Tlingit", type: "landmark" },
                    { name: "Russian Bishop's House", lat: 57.0522, lon: -135.3300, clue: "‚õ™ Historic Russian Orthodox building in Sitka", fact: "One of few surviving Russian colonial buildings in US", type: "landmark" },
                    { name: "Klondike Gold Rush National Park", lat: 59.4583, lon: -135.3150, clue: "‚õèÔ∏è Historic park in Skagway about gold rush", fact: "Commemorates 1897-98 gold rush that changed Alaska", type: "landmark" },
                    { name: "Totem Bight State Park", lat: 55.3733, lon: -131.7461, clue: "üóø Park near Ketchikan with traditional totem poles", fact: "14 restored totem poles from abandoned villages", type: "landmark" },
                    { name: "Alaska Native Heritage Center", lat: 61.2186, lon: -149.8089, clue: "üé≠ Cultural center in Anchorage showcasing Native culture", fact: "Celebrates 11 major Alaska Native cultural groups", type: "landmark" },
                    { name: "McCarthy", lat: 61.4344, lon: -142.9033, clue: "üèöÔ∏è Historic mining town in Wrangell Mountains", fact: "Gateway to Kennicott Mines, abandoned copper mining town", type: "city" },
                    { name: "Iditarod Trail Sled Dog Race HQ", lat: 61.5833, lon: -149.4428, clue: "üêï Headquarters in Wasilla for famous dog sled race", fact: "1,000-mile race from Anchorage to Nome every March!", type: "landmark" }
                ]
            }
        ];
        
        // Load saved state
        if (localStorage.getItem('geoDetectiveState')) {
            const saved = JSON.parse(localStorage.getItem('geoDetectiveState'));
            gameState = { ...gameState, ...saved };
            
            // Always deactivate all games on page load - user must start them manually
            gameState.mystery.active = false;
            gameState.scavenger.active = false;
            gameState.guess.active = false;
            gameState.alaska.active = false;
            
            // Clear any timers
            if (gameState.mystery.timer) {
                gameState.mystery.timer = null;
            }
        }
        
        // Save state
        window.saveState = function() {
            localStorage.setItem('geoDetectiveState', JSON.stringify(gameState));
        }
        
        // Add XP with notification
        window.addXP = function(amount, reason) {
            gameState.totalXP += amount;
            document.getElementById('total-xp').textContent = gameState.totalXP;
            showNotification(`+${amount} XP! ${reason}`);
            saveState();
        }
        
        // Show notification
        window.showNotification = function(message) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.classList.add('active');
            setTimeout(() => {
                notif.classList.remove('active');
            }, 2000);
        }
        
        // Update all displays
        window.updateAllDisplays = function() {
            document.getElementById('total-xp').textContent = gameState.totalXP;
            document.getElementById('mystery-score').textContent = gameState.mystery.score;
            document.getElementById('mystery-streak').textContent = gameState.mystery.streak;
            document.getElementById('best-streak').textContent = gameState.mystery.bestStreak;
            document.getElementById('mysteries-solved').textContent = gameState.mystery.solved;
            document.getElementById('guess-score').textContent = gameState.guess.score;
            document.getElementById('guess-correct').textContent = gameState.guess.correct;
            document.getElementById('guess-total').textContent = gameState.guess.total;
        }
        
        // Switch mode
        window.switchMode = function(mode) {
            // CRITICAL FIX: Stop all timers and cleanup before switching
            stopAllGameTimers();
            cleanupGameMarkers();
            
            gameState.currentMode = mode;
            
            // Deactivate all active games when switching modes
            gameState.mystery.active = false;
            gameState.scavenger.active = false;
            gameState.guess.active = false;
            gameState.alaska.active = false;
            
            // Update mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                // Find the button for the new mode and activate it
                if (btn.textContent.toLowerCase().includes(mode.toLowerCase()) || 
                    (mode === 'explore' && btn.textContent.includes('EXPLORE'))) {
                    btn.classList.add('active');
                }
            });
            
            // Switch panels
            document.querySelectorAll('.game-panel').forEach(panel => panel.classList.remove('active'));
            const targetPanel = document.getElementById(mode + '-panel');
            if (targetPanel) {
                targetPanel.classList.add('active');
            }
            
            if (mode === 'missions') {
                renderMissions();
            }
            
            saveState();
        }
        
        // CRITICAL FIX: Centralized timer cleanup function
        function stopAllGameTimers() {
            // Clear Mystery Challenge timer
            if (gameState.mystery.timer) {
                clearInterval(gameState.mystery.timer);
                gameState.mystery.timer = null;
            }
            
            // Clear any other game timers here as they're added
            // Example: if (gameState.guess.timer) clearInterval(gameState.guess.timer);
        }
        
        // CRITICAL FIX #3: Centralized marker cleanup function
        function cleanupGameMarkers() {
            // Remove current marker if it exists
            if (currentMarker) {
                try {
                    geoMap.removeLayer(currentMarker);
                    console.log('üßπ Removed current marker');
                } catch (e) {
                    console.warn('‚ö†Ô∏è Could not remove current marker:', e);
                }
                currentMarker = null;
            }
            
            // Remove Coordinate Finder reveal marker
            if (typeof revealMarker !== 'undefined' && revealMarker) {
                try {
                    geoMap.removeLayer(revealMarker);
                    console.log('üßπ Removed reveal marker');
                } catch (e) {
                    console.warn('‚ö†Ô∏è Could not remove reveal marker:', e);
                }
                revealMarker = null;
            }
            
            // Clear any orphaned markers (markers without proper tracking)
            // This catches any markers that weren't properly tracked
            geoMap.eachLayer(function(layer) {
                // Keep the base tile layer, but remove any markers
                if (layer instanceof L.Marker) {
                    try {
                        geoMap.removeLayer(layer);
                        console.log('üßπ Removed orphaned marker');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Could not remove marker:', e);
                    }
                }
            });
        }
        
        // ========================================
        // COORDINATE FINDER FUNCTIONS - Phase 1
        // ========================================
        
        // Toggle Coordinate Finder Panel
        window.toggleCoordinateFinderPanel = function() {
            const panel = document.getElementById('coordinate-finder-panel');
            panel.classList.toggle('active');
            
            // Make panel draggable if not already initialized
            if (!panel.dataset.draggableInitialized) {
                makePanelDraggable();
                panel.dataset.draggableInitialized = 'true';
            }
        }
        
        // Close Coordinate Finder Panel
        window.closeCoordinateFinderPanel = function() {
            const panel = document.getElementById('coordinate-finder-panel');
            panel.classList.remove('active');
        }
        
        // Make Panel Draggable
        function makePanelDraggable() {
            const panel = document.getElementById('coordinate-finder-panel');
            const header = panel.querySelector('.cf-header');
            
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;
            
            header.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            
            function dragStart(e) {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
                
                if (e.target === header || e.target.parentElement === header) {
                    isDragging = true;
                }
            }
            
            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    
                    xOffset = currentX;
                    yOffset = currentY;
                    
                    setTranslate(currentX, currentY, panel);
                }
            }
            
            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
            }
            
            function setTranslate(xPos, yPos, el) {
                el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
            }
        }
        
        // ========================================
        // COLLAPSIBLE SECTIONS FUNCTIONALITY
        // ========================================
        
        // Make all sidebar sections collapsible by clicking h2
        document.querySelectorAll('.section h2').forEach(header => {
            header.addEventListener('click', function() {
                const section = this.parentElement;
                section.classList.toggle('collapsed');
            });
        });
        
        // ========================================
        // FUN MODE TOGGLE - Phase 4
        // ========================================
        
        // Check localStorage for Fun Mode preference on page load
        function initFunMode() {
            const funModeEnabled = localStorage.getItem('funModeEnabled') === 'true';
            if (funModeEnabled) {
                document.body.classList.add('fun-mode');
                document.getElementById('fun-mode-switch').classList.add('active');
                document.getElementById('fun-mode-label').textContent = 'üéÆ Fun Mode';
            }
        }
        
        // Toggle Fun Mode
        window.toggleFunMode = function() {
            const body = document.body;
            const toggleSwitch = document.getElementById('fun-mode-switch');
            const label = document.getElementById('fun-mode-label');
            
            // Toggle the fun-mode class on body
            body.classList.toggle('fun-mode');
            toggleSwitch.classList.toggle('active');
            
            // Update label
            if (body.classList.contains('fun-mode')) {
                label.textContent = 'üéÆ Fun Mode';
                localStorage.setItem('funModeEnabled', 'true');
            } else {
                label.textContent = 'üìö Academic Mode';
                localStorage.setItem('funModeEnabled', 'false');
            }
        }
        
        // Initialize Fun Mode on page load
        initFunMode();
        
        // ========================================
        // CELEBRATION MESSAGES - Phase 5
        // ========================================
        
        // Academic Mode messages - simple and professional
        const ACADEMIC_MESSAGES = [
            'üìç Location Found!',
            '‚úÖ Target Reached!',
            'üéØ Success!',
            '‚úì Coordinates Verified!'
        ];
        
        // Fun Mode messages - Gen Alpha approved
        const FUN_MESSAGES = [
            'üî• W!',
            '‚ú® SLAY!',
            'üíØ NO CAP!',
            'üéÆ LOCKED IN!',
            '‚ö° BUSSIN!',
            'üöÄ SHEESH!',
            'üëë GET GOOD!',
            'üí™ COOKED!',
            'üéØ LET HIM COOK!',
            'üåü FIRE!'
        ];
        
        // Six Seven easter egg messages (4.5% chance)
        const SIX_SEVEN_MESSAGES = [
            'SIIIIX SEEEEVVEN! üéâ',
            '6-7 GANG! üí™',
            'DOOT DOOT 6-7! üéÆ',
            '67 NO CAP! ‚ú®'
        ];
        
        // Get celebration message based on Fun Mode state
        function getCelebrationMessage() {
            const funModeEnabled = document.body.classList.contains('fun-mode');
            
            if (!funModeEnabled) {
                // Academic mode - simple messages
                return ACADEMIC_MESSAGES[Math.floor(Math.random() * ACADEMIC_MESSAGES.length)];
            }
            
            // Fun mode - check for six seven easter egg (4.5% chance)
            const random = Math.random() * 100;
            if (random < 4.5) {
                // SIX SEVEN EASTER EGG!
                return SIX_SEVEN_MESSAGES[Math.floor(Math.random() * SIX_SEVEN_MESSAGES.length)];
            }
            
            // Regular fun message
            return FUN_MESSAGES[Math.floor(Math.random() * FUN_MESSAGES.length)];
        }
        
        // Show celebration message popup
        function showCelebrationMessage(message) {
            const isSixSeven = message.includes('6') || message.includes('SIX');
            const messageDiv = document.createElement('div');
            
            // Check if Fun Mode for styling
            const funModeEnabled = document.body.classList.contains('fun-mode');
            messageDiv.className = funModeEnabled ? 'success-message' : 'success-message academic';
            
            // Add glitch effect for six seven
            if (isSixSeven && funModeEnabled) {
                messageDiv.innerHTML = `<div class="glitch-text">${message}</div>`;
            } else {
                messageDiv.textContent = message;
            }
            
            document.body.appendChild(messageDiv);
            
            // Remove after 3 seconds with fade
            setTimeout(() => {
                messageDiv.classList.add('fade-out');
                setTimeout(() => messageDiv.remove(), 500);
            }, 3000);
        }
        
        // ========================================
        // COORDINATE FINDER FUNCTIONS - Phase 2
        // ========================================
        
        // Track current format
        let coordinateFormat = 'decimal';
        
        // Switch between decimal and cardinal format
        window.switchCoordinateFormat = function(format) {
            coordinateFormat = format;
            
            // Track format usage for achievements
            if (format === 'decimal') {
                playerAchievements.stats.coordinate.decimalUses++;
            } else if (format === 'cardinal') {
                playerAchievements.stats.coordinate.cardinalUses++;
            }
            saveAchievements();
            checkCoordinateAchievements();
            
            // Update button styles
            document.getElementById('format-decimal').style.background = 
                format === 'decimal' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'rgba(102, 126, 234, 0.2)';
            document.getElementById('format-decimal').style.border = 
                format === 'decimal' ? 'none' : '2px solid rgba(102, 126, 234, 0.3)';
            document.getElementById('format-decimal').style.color = 
                format === 'decimal' ? 'white' : '#aaa';
                
            document.getElementById('format-cardinal').style.background = 
                format === 'cardinal' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'rgba(102, 126, 234, 0.2)';
            document.getElementById('format-cardinal').style.border = 
                format === 'cardinal' ? 'none' : '2px solid rgba(102, 126, 234, 0.3)';
            document.getElementById('format-cardinal').style.color = 
                format === 'cardinal' ? 'white' : '#aaa';
            
            // Show/hide input sections
            document.getElementById('decimal-inputs').style.display = format === 'decimal' ? 'block' : 'none';
            document.getElementById('cardinal-inputs').style.display = format === 'cardinal' ? 'block' : 'none';
            
            // Reset validation
            validateCoordinateInputs();
        }
        
        // Validate coordinate inputs in real-time (FIXED VERSION)
        window.validateCoordinateInputs = function() {
            const errorDiv = document.getElementById('cf-error');
            const findBtn = document.getElementById('cf-find-btn');
            
            let lat, lon, latInput, lonInput;
            let latValid = false;
            let lonValid = false;
            let errorMessage = '';
            
            if (coordinateFormat === 'decimal') {
                latInput = document.getElementById('cf-latitude-decimal');
                lonInput = document.getElementById('cf-longitude-decimal');
                lat = parseFloat(latInput.value);
                lon = parseFloat(lonInput.value);
            } else {
                latInput = document.getElementById('cf-latitude-cardinal');
                lonInput = document.getElementById('cf-longitude-cardinal');
                const latDir = document.getElementById('cf-lat-direction').value;
                const lonDir = document.getElementById('cf-lon-direction').value;
                
                let latNum = parseFloat(latInput.value);
                let lonNum = parseFloat(lonInput.value);
                
                // Convert cardinal to decimal
                lat = latDir === 'S' ? -Math.abs(latNum) : Math.abs(latNum);
                lon = lonDir === 'W' ? -Math.abs(lonNum) : Math.abs(lonNum);
            }
            
            // Reset all styles first
            if (latInput) latInput.style.borderColor = 'rgba(102, 126, 234, 0.3)';
            if (lonInput) lonInput.style.borderColor = 'rgba(102, 126, 234, 0.3)';
            errorDiv.style.display = 'none';
            
            // Check if both fields have values
            if (!latInput.value || !lonInput.value) {
                findBtn.disabled = true;
                findBtn.style.opacity = '0.5';
                findBtn.style.cursor = 'not-allowed';
                return;
            }
            
            // Validate latitude independently
            if (coordinateFormat === 'decimal') {
                if (isNaN(lat) || lat < -90 || lat > 90) {
                    latInput.style.borderColor = '#ff6b6b';
                    errorMessage = '‚ùå Latitude must be between -90 and 90';
                } else {
                    latInput.style.borderColor = '#00ff7f';
                    latValid = true;
                }
            } else {
                if (isNaN(lat) || Math.abs(lat) < 0 || Math.abs(lat) > 90) {
                    latInput.style.borderColor = '#ff6b6b';
                    errorMessage = '‚ùå Latitude must be between 0 and 90';
                } else {
                    latInput.style.borderColor = '#00ff7f';
                    latValid = true;
                }
            }
            
            // Validate longitude independently
            if (coordinateFormat === 'decimal') {
                if (isNaN(lon) || lon < -180 || lon > 180) {
                    lonInput.style.borderColor = '#ff6b6b';
                    if (!errorMessage) errorMessage = '‚ùå Longitude must be between -180 and 180';
                } else {
                    lonInput.style.borderColor = '#00ff7f';
                    lonValid = true;
                }
            } else {
                if (isNaN(lon) || Math.abs(lon) < 0 || Math.abs(lon) > 180) {
                    lonInput.style.borderColor = '#ff6b6b';
                    if (!errorMessage) errorMessage = '‚ùå Longitude must be between 0 and 180';
                } else {
                    lonInput.style.borderColor = '#00ff7f';
                    lonValid = true;
                }
            }
            
            // Show error if any validation failed
            if (errorMessage) {
                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
            }
            
            // Enable button only if BOTH are valid
            if (latValid && lonValid) {
                findBtn.disabled = false;
                findBtn.style.opacity = '1';
                findBtn.style.cursor = 'pointer';
            } else {
                findBtn.disabled = true;
                findBtn.style.opacity = '0.5';
                findBtn.style.cursor = 'not-allowed';
            }
        }
        
        // ========================================
        // COORDINATE FINDER FUNCTIONS - Phase 3
        // ========================================
        
        // Track progressive reveal state
        let progressiveRevealActive = false;
        let progressiveRevealTimer = null;
        let currentStage = 0;
        let targetLat, targetLon;
        let revealMarker = null;
        
        // Find location from coordinates - START PROGRESSIVE REVEAL
        window.findCoordinateLocation = function() {
            if (coordinateFormat === 'decimal') {
                targetLat = parseFloat(document.getElementById('cf-latitude-decimal').value);
                targetLon = parseFloat(document.getElementById('cf-longitude-decimal').value);
            } else {
                const latNum = parseFloat(document.getElementById('cf-latitude-cardinal').value);
                const lonNum = parseFloat(document.getElementById('cf-longitude-cardinal').value);
                const latDir = document.getElementById('cf-lat-direction').value;
                const lonDir = document.getElementById('cf-lon-direction').value;
                
                targetLat = latDir === 'S' ? -Math.abs(latNum) : Math.abs(latNum);
                targetLon = lonDir === 'W' ? -Math.abs(lonNum) : Math.abs(lonNum);
            }
            
            // Close the panel
            closeCoordinateFinderPanel();
            
            // Start progressive reveal
            startProgressiveReveal(targetLat, targetLon);
        }
        
        // Start the progressive reveal sequence
        function startProgressiveReveal(lat, lon) {
            progressiveRevealActive = true;
            currentStage = 1;
            
            // Remove any existing marker
            if (revealMarker) {
                geoMap.removeLayer(revealMarker);
                revealMarker = null;
            }
            
            // Make timer overlay draggable (if not already done)
            makeTimerDraggable();
            
            // Start Stage 1: Hemisphere (20 seconds)
            startStage1Hemisphere(lat, lon);
        }
        
        // Make timer overlay draggable
        function makeTimerDraggable() {
            const timerOverlay = document.getElementById('cf-timer-overlay');
            if (timerOverlay.dataset.draggableInit) return; // Already initialized
            
            let isDragging = false;
            let currentX = 0;
            let currentY = 0;
            let initialX = 0;
            let initialY = 0;
            
            timerOverlay.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
            
            function dragStart(e) {
                initialX = e.clientX - currentX;
                initialY = e.clientY - currentY;
                isDragging = true;
            }
            
            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    timerOverlay.style.transform = `translate(${currentX}px, ${currentY}px)`;
                }
            }
            
            function dragEnd() {
                initialX = currentX;
                initialY = currentY;
                isDragging = false;
            }
            
            timerOverlay.dataset.draggableInit = 'true';
        }
        
        // Stage 1: Show Quadrant (zoom to show the correct quarter of Earth)
        function startStage1Hemisphere(lat, lon) {
            currentStage = 1;
            
            // Determine quadrant
            const latHemisphere = lat >= 0 ? 'N' : 'S';
            const lonHemisphere = lon >= 0 ? 'E' : 'W';
            const quadrant = `${latHemisphere}${lonHemisphere}`;
            
            // Quadrant names for display
            const quadrantNames = {
                'NE': 'üåè NE Quadrant (Asia/Pacific)',
                'NW': 'üåé NW Quadrant (Americas)',
                'SE': 'üåè SE Quadrant (Australia/Africa)',
                'SW': 'üåç SW Quadrant (S. America/Antarctica)'
            };
            
            document.getElementById('cf-stage-label').textContent = quadrantNames[quadrant] || 'üåç Stage 1: Quadrant';
            document.getElementById('cf-timer-overlay').style.display = 'block';
            
            // Zoom to center of the quadrant
            // Each quadrant is centered at ¬±45¬∞ lat, ¬±90¬∞ lon
            const quadrantCenters = {
                'NE': [30, 90],    // Asia/Pacific region
                'NW': [30, -90],   // North America
                'SE': [-30, 90],   // Australia/Southeast Asia
                'SW': [-30, -90]   // South America/South Atlantic
            };
            
            const [centerLat, centerLon] = quadrantCenters[quadrant] || [lat / 2, lon / 2];
            const quadrantZoom = 3; // Zoom level to show a quarter of Earth
            
            geoMap.setView([centerLat, centerLon], quadrantZoom, { animate: true, duration: 1 });
            
            // Start 20-second timer
            startStageTimer(20, () => startStage2Continent(lat, lon));
        }
        
        // Stage 2: Show Continent (zoom level 4-5)
        function startStage2Continent(lat, lon) {
            if (!progressiveRevealActive) return;
            
            currentStage = 2;
            document.getElementById('cf-stage-label').textContent = 'üó∫Ô∏è Stage 2: Continent';
            
            // Zoom to continent level
            const continentZoom = 4;
            geoMap.setView([lat, lon], continentZoom, { animate: true, duration: 1 });
            
            // Start 20-second timer
            startStageTimer(20, () => startStage3Region(lat, lon));
        }
        
        // Stage 3: Show Region (zoom level 7-8)
        function startStage3Region(lat, lon) {
            if (!progressiveRevealActive) return;
            
            currentStage = 3;
            document.getElementById('cf-stage-label').textContent = 'üìç Stage 3: Region';
            document.getElementById('cf-stage-label').textContent = 'Stage 3: Region';
            
            // Zoom to region level
            const regionZoom = 7;
            geoMap.setView([lat, lon], regionZoom, { animate: true, duration: 1 });
            
            // Start 20-second timer
            startStageTimer(20, () => dropPinAtTarget(lat, lon));
        }
        
        // Final: Drop pin at exact location
        function dropPinAtTarget(lat, lon) {
            if (!progressiveRevealActive) return;
            
            currentStage = 4;
            document.getElementById('cf-stage-label').textContent = 'üéØ FOUND IT! NO CAP';
            document.getElementById('cf-timer-display').textContent = '‚úì';
            document.getElementById('cf-timer-display').style.color = '#00ff7f';
            document.getElementById('cf-timer-display').style.textShadow = '0 0 20px rgba(0, 255, 127, 0.8)';
            
            // Zoom to exact location
            geoMap.setView([lat, lon], 13, { animate: true, duration: 1 });
            
            // Drop a pin marker
            setTimeout(() => {
                revealMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="font-size: 32px;">üìç</div>',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32]
                    })
                }).addTo(geoMap);
                
                revealMarker.bindPopup(`
                    <strong>üìç Target Location</strong><br>
                    ${formatCoord(lat, true)}, ${formatCoord(lon, false)}
                `).openPopup();
                
                // Show celebration message!
                const celebrationMessage = getCelebrationMessage();
                showCelebrationMessage(celebrationMessage);
                
                // Track Coordinate Finder achievements!
                playerAchievements.stats.coordinate.completions++;
                playerAchievements.stats.universal.modesPlayed.add('coordinate');
                playerAchievements.stats.universal.modesCompleted.add('coordinate');
                
                // Check accuracy (perfect find = within 1km = ~0.01 degrees)
                // Note: This is already perfect since we reached the exact coordinates
                playerAchievements.stats.coordinate.perfectAccuracyRuns++;
                
                saveAchievements();
                checkCoordinateAchievements();
                checkUniversalAchievements();
                trackPlayDate();
                
                // Show Play Again button
                showCoordinateFinderComplete();
                
                // Hide timer overlay after 2 seconds
                setTimeout(() => {
                    document.getElementById('cf-timer-overlay').style.display = 'none';
                    progressiveRevealActive = false;
                }, 2000);
            }, 500);
        }
        
        // Show Coordinate Finder completion with Play Again button
        function showCoordinateFinderComplete() {
            setTimeout(() => {
                const overlay = document.createElement('div');
                overlay.id = 'cf-complete-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(20, 30, 40, 0.95);
                    border-radius: 15px;
                    border: 2px solid #00ff7f;
                    padding: 40px;
                    z-index: 2000;
                    text-align: center;
                    max-width: 400px;
                    animation: fadeIn 0.5s ease-in;
                `;
                
                overlay.innerHTML = `
                    <h2 style="color: #00ff7f; font-size: 32px; margin: 0 0 15px 0;">üéØ LOCATION FOUND!</h2>
                    <p style="font-size: 16px; color: #aaa; margin: 0 0 20px 0;">You successfully navigated to the target coordinates!</p>
                    <button onclick="playAgainCoordinateFinder()" class="btn" style="font-size: 18px; padding: 12px 30px; background: #00ff7f; color: #000;">
                        üîÑ FIND ANOTHER
                    </button>
                `;
                
                document.body.appendChild(overlay);
                
                // Remove after 10 seconds if not clicked
                setTimeout(() => {
                    if (document.getElementById('cf-complete-overlay')) {
                        overlay.remove();
                    }
                }, 10000);
            }, 2500);
        }
        
        window.playAgainCoordinateFinder = function() {
            const overlay = document.getElementById('cf-complete-overlay');
            if (overlay) overlay.remove();
            
            // Reset and start new game
            if (revealMarker) {
                geoMap.removeLayer(revealMarker);
                revealMarker = null;
            }
            startProgressiveReveal();
        }
        
        // Timer function for each stage
        function startStageTimer(seconds, callback) {
            let timeLeft = seconds;
            const timerDisplay = document.getElementById('cf-timer-display');
            timerDisplay.textContent = timeLeft;
            timerDisplay.style.color = '#fff';
            timerDisplay.style.textShadow = '0 0 15px rgba(255, 255, 255, 0.5)';
            
            if (progressiveRevealTimer) {
                clearInterval(progressiveRevealTimer);
            }
            
            progressiveRevealTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                
                // Color changes as time runs out (more dramatic!)
                if (timeLeft <= 5) {
                    timerDisplay.style.color = '#ff6b6b';
                    timerDisplay.style.textShadow = '0 0 20px rgba(255, 107, 107, 0.8)';
                } else if (timeLeft <= 10) {
                    timerDisplay.style.color = '#ffd700';
                    timerDisplay.style.textShadow = '0 0 20px rgba(255, 215, 0, 0.8)';
                }
                
                if (timeLeft <= 0) {
                    clearInterval(progressiveRevealTimer);
                    progressiveRevealTimer = null;
                    callback();
                }
            }, 1000);
        }
        
        // Skip to final location when map is clicked during progressive reveal
        // Only works if click is within acceptable distance of target
        function skipToLocation(clickLat, clickLon) {
            if (!progressiveRevealActive) return;
            
            // Calculate distance from click to target (in degrees)
            const latDiff = Math.abs(clickLat - targetLat);
            const lonDiff = Math.abs(clickLon - targetLon);
            
            // Define "close enough" thresholds based on current stage
            // Stage 1 (Quadrant): Within 30 degrees
            // Stage 2 (Continent): Within 10 degrees
            // Stage 3 (Region): Within 3 degrees
            let threshold;
            if (currentStage === 1) {
                threshold = 30; // Pretty generous for quadrant stage
            } else if (currentStage === 2) {
                threshold = 10; // Continental accuracy
            } else if (currentStage === 3) {
                threshold = 3; // Regional accuracy
            } else {
                return; // Already at final stage
            }
            
            // Check if click is within threshold
            if (latDiff <= threshold && lonDiff <= threshold) {
                // Clear timer
                if (progressiveRevealTimer) {
                    clearInterval(progressiveRevealTimer);
                    progressiveRevealTimer = null;
                }
                
                // Jump straight to pin drop
                dropPinAtTarget(targetLat, targetLon);
            } else {
                // Not close enough - give feedback
                const feedback = document.createElement('div');
                feedback.textContent = '‚ùå Not quite! Keep searching...';
                feedback.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(255, 0, 0, 0.9);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 12px;
                    font-size: 20px;
                    font-weight: bold;
                    z-index: 10000;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
                `;
                document.body.appendChild(feedback);
                
                // Remove feedback after 1.5 seconds
                setTimeout(() => {
                    feedback.remove();
                }, 1500);
            }
        }
        
        // ========================================
        // END COORDINATE FINDER FUNCTIONS
        // ========================================
        
        // Format coordinates
        window.formatCoord = function(value, isLat) {
            const dir = isLat ? (value >= 0 ? 'N' : 'S') : (value >= 0 ? 'E' : 'W');
            return `${Math.abs(value).toFixed(2)}¬∞ ${dir}`;
        }
        
        // Mouse move
        geoMap.on('mousemove', function(e) {
            // Update Free Explore hover displays
            document.getElementById('hover-lat').textContent = formatCoord(e.latlng.lat, true);
            document.getElementById('hover-lon').textContent = formatCoord(e.latlng.lng, false);
            
            // Update Mystery Challenge hover displays (if elements exist)
            const mysteryLat = document.getElementById('mystery-hover-lat');
            const mysteryLon = document.getElementById('mystery-hover-lon');
            if (mysteryLat && mysteryLon) {
                mysteryLat.textContent = formatCoord(e.latlng.lat, true);
                mysteryLon.textContent = formatCoord(e.latlng.lng, false);
            }
        });
        
        // Track zoom levels for Explore achievements
        geoMap.on('zoomend', function() {
            const zoomLevel = geoMap.getZoom();
            playerAchievements.stats.explore.zoomLevelsUsed.add(zoomLevel);
            saveAchievements();
            checkExploreAchievements();
        });
        
        // Click handler
        let currentMarker = null;
        geoMap.on('click', function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            
            // COORDINATE FINDER: Skip to location if progressive reveal is active
            if (progressiveRevealActive && currentStage < 4) {
                skipToLocation(lat, lon); // Pass clicked coordinates
                return; // Don't process other click handlers
            }
            
            // Always show distance from Glennallen (useful in all modes)
            const distFromHomeKm = calculateDistance(GLENNALLEN.lat, GLENNALLEN.lon, lat, lon);
            const distFromHomeMiles = distFromHomeKm * 0.621371; // Convert km to miles
            const bearingFromHome = calculateBearing(GLENNALLEN.lat, GLENNALLEN.lon, lat, lon);
            
            // DEBUG: Log the calculation
            console.log('üß≠ Distance Calculation:');
            console.log('  From: Glennallen', GLENNALLEN.lat, GLENNALLEN.lon);
            console.log('  To: Clicked location', lat, lon);
            console.log('  Distance:', distFromHomeKm.toFixed(2), 'km =', distFromHomeMiles.toFixed(2), 'miles');
            console.log('  Bearing:', bearingFromHome);
            
            const distDisplay = document.getElementById('distance-display');
            if (distDisplay) {
                distDisplay.innerHTML = `
                    <strong style="color: #ffd700;">üè† Distance from Glennallen:</strong><br>
                    <span style="font-size: 24px; color: #00ff7f;">${Math.round(distFromHomeMiles).toLocaleString()}</span> miles<br>
                    <span style="font-size: 14px; color: #60a5fa;">üß≠ ${bearingFromHome} from Glennallen</span><br>
                    <span style="font-size: 12px; color: #888;">Coordinates: ${formatCoord(lat, true)}, ${formatCoord(lon, false)}</span>
                `;
            }
            
            // Handle based on active game mode
            if (gameState.mystery.active) {
                checkMysteryAnswer(lat, lon);
            } else if (gameState.scavenger.active) {
                checkScavengerAnswer(lat, lon);
            } else if (gameState.alaska.active) {
                checkAlaskaLocation(lat, lon);
            } else if (gameState.currentMode === 'create') {
                setHeistLocation(lat, lon);
            } else {
                // Free Explore mode or any other mode - show location info
                showLocationInfo(lat, lon);
                
                // LOCATION EXPLORER: Also populate sidebar in Explore mode
                populateLocationData(lat, lon);
            }
        });
        
        // CRITICAL FIX #2: Race condition prevention
        let currentFetchController = null;
        let lastFetchTime = 0;
        const FETCH_DELAY = 1000; // 1 second minimum between API calls (Nominatim rate limit)
        
        async function showLocationInfo(lat, lon) {
            // Cancel previous fetch if still running
            if (currentFetchController) {
                currentFetchController.abort();
                console.log('üö´ Cancelled previous location fetch');
            }
            
            // Rate limiting: Ensure minimum delay between requests
            const now = Date.now();
            const timeSinceLastFetch = now - lastFetchTime;
            if (timeSinceLastFetch < FETCH_DELAY) {
                const waitTime = FETCH_DELAY - timeSinceLastFetch;
                await new Promise(resolve => setTimeout(resolve, waitTime));
            }
            
            // Create new abort controller for this request
            currentFetchController = new AbortController();
            const signal = currentFetchController.signal;
            
            // Update marker
            if (currentMarker) geoMap.removeLayer(currentMarker);
            currentMarker = L.marker([lat, lon]).addTo(geoMap);
            
            // Track marker placement for Explore achievements
            playerAchievements.stats.explore.markersPlaced++;
            playerAchievements.stats.universal.modesPlayed.add('explore');
            saveAchievements();
            checkExploreAchievements();
            
            const locationInfoEl = document.getElementById('location-info');
            locationInfoEl.innerHTML = '<span style="color: #888;">üìç Loading location...</span>';
            
            try {
                lastFetchTime = Date.now();
                
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1&accept-language=en`,
                    { 
                        headers: { 'User-Agent': 'Geographic Detective Academy' },
                        signal: signal  // Allow aborting this request
                    }
                );
                
                // Check if request was aborted
                if (signal.aborted) {
                    console.log('‚ö†Ô∏è Request was aborted');
                    return;
                }
                
                // Check response status
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const addr = data.address || {};
                
                // Build location info
                let info = `<strong>${formatCoord(lat, true)}, ${formatCoord(lon, false)}</strong><br>`;
                if (addr.city || addr.town) {
                    info += `üìç ${addr.city || addr.town}`;
                }
                if (addr.state || addr.province) {
                    info += `, ${addr.state || addr.province}`;
                }
                if (addr.country) {
                    info += `<br>üåç ${addr.country}`;
                }
                
                // Only update if this request wasn't aborted
                if (!signal.aborted) {
                    locationInfoEl.innerHTML = info;
                }
                
            } catch (error) {
                // Don't show error if request was deliberately aborted
                if (error.name === 'AbortError') {
                    console.log('‚úÖ Location fetch cancelled (user clicked elsewhere)');
                    return;
                }
                
                // Show user-friendly error message
                console.error('‚ùå Location fetch error:', error);
                if (!signal.aborted) {
                    locationInfoEl.innerHTML = `
                        <span style="color: #ff6b6b;">‚ö†Ô∏è Location service temporarily unavailable</span><br>
                        <span style="color: #888; font-size: 11px;">Try again in a moment</span>
                    `;
                }
            } finally {
                // Clear the controller reference
                if (currentFetchController && currentFetchController.signal === signal) {
                    currentFetchController = null;
                }
            }
        }
        
        // MYSTERY CHALLENGE
        const mysteryLocations = [
            // NORTH AMERICA (15 locations)
            { lat: 40.7128, lon: -74.0060, name: "New York City, USA", hint: "Major US city, financial capital, Statue of Liberty", continent: "North America", zoom: 10 },
            { lat: 19.4326, lon: -99.1332, name: "Mexico City, Mexico", hint: "Aztec heritage, high altitude capital", continent: "North America", zoom: 10 },
            { lat: 34.0522, lon: -118.2437, name: "Los Angeles, USA", hint: "Hollywood, Pacific coast, entertainment capital", continent: "North America", zoom: 10 },
            { lat: 41.8781, lon: -87.6298, name: "Chicago, USA", hint: "Windy City, Great Lakes, deep-dish pizza", continent: "North America", zoom: 10 },
            { lat: 43.6532, lon: -79.3832, name: "Toronto, Canada", hint: "CN Tower, largest Canadian city, multicultural", continent: "North America", zoom: 10 },
            { lat: 49.2827, lon: -123.1207, name: "Vancouver, Canada", hint: "Pacific coast, mountains meet ocean", continent: "North America", zoom: 10 },
            { lat: 21.3099, lon: -157.8581, name: "Honolulu, Hawaii", hint: "Pacific island paradise, Pearl Harbor", continent: "North America", zoom: 10 },
            { lat: 29.7604, lon: -95.3698, name: "Houston, USA", hint: "Space City, NASA Mission Control", continent: "North America", zoom: 10 },
            { lat: 37.7749, lon: -122.4194, name: "San Francisco, USA", hint: "Golden Gate Bridge, Silicon Valley neighbor", continent: "North America", zoom: 10 },
            { lat: 25.7617, lon: -80.1918, name: "Miami, USA", hint: "Tropical beaches, cruise capital, Cuban culture", continent: "North America", zoom: 10 },
            { lat: 38.9072, lon: -77.0369, name: "Washington DC, USA", hint: "US capital, White House, monuments", continent: "North America", zoom: 10 },
            { lat: 45.4215, lon: -75.6972, name: "Ottawa, Canada", hint: "Canadian capital, Parliament Hill", continent: "North America", zoom: 10 },
            { lat: 51.0447, lon: -114.0719, name: "Calgary, Canada", hint: "Canadian Rockies gateway, Stampede city", continent: "North America", zoom: 10 },
            { lat: 20.9674, lon: -89.5926, name: "M√©rida, Mexico", hint: "Mayan heritage, Yucat√°n Peninsula", continent: "North America", zoom: 10 },
            { lat: 32.7157, lon: -117.1611, name: "San Diego, USA", hint: "Perfect weather, Mexico border, naval base", continent: "North America", zoom: 10 },
            
            // SOUTH AMERICA (10 locations)
            { lat: -23.5505, lon: -46.6333, name: "S√£o Paulo, Brazil", hint: "Largest city in South America, financial hub", continent: "South America", zoom: 10 },
            { lat: -22.9068, lon: -43.1729, name: "Rio de Janeiro, Brazil", hint: "Christ the Redeemer, Copacabana Beach, Carnival", continent: "South America", zoom: 10 },
            { lat: -34.6037, lon: -58.3816, name: "Buenos Aires, Argentina", hint: "Tango, Paris of South America, steakhouses", continent: "South America", zoom: 10 },
            { lat: -12.0464, lon: -77.0428, name: "Lima, Peru", hint: "Pacific coast, ancient Incan connections", continent: "South America", zoom: 10 },
            { lat: -33.4489, lon: -70.6693, name: "Santiago, Chile", hint: "Andes Mountains backdrop, wine country", continent: "South America", zoom: 10 },
            { lat: 4.7110, lon: -74.0721, name: "Bogot√°, Colombia", hint: "High altitude capital, Andean culture", continent: "South America", zoom: 10 },
            { lat: -0.1807, lon: -78.4678, name: "Quito, Ecuador", hint: "Equator line city, colonial architecture", continent: "South America", zoom: 10 },
            { lat: -3.7172, lon: -38.5433, name: "Fortaleza, Brazil", hint: "Northeastern beaches, tropical coast", continent: "South America", zoom: 10 },
            { lat: -16.5000, lon: -68.1500, name: "La Paz, Bolivia", hint: "Highest capital city, Andean culture", continent: "South America", zoom: 10 },
            { lat: -25.2637, lon: -57.5759, name: "Asunci√≥n, Paraguay", hint: "River port, Guaran√≠ culture", continent: "South America", zoom: 10 },
            
            // EUROPE (15 locations)
            { lat: 51.5074, lon: -0.1278, name: "London, United Kingdom", hint: "UK capital, River Thames, Big Ben", continent: "Europe", zoom: 10 },
            { lat: 48.8566, lon: 2.3522, name: "Paris, France", hint: "City of Light, Eiffel Tower, Louvre Museum", continent: "Europe", zoom: 10 },
            { lat: 55.7558, lon: 37.6173, name: "Moscow, Russia", hint: "Russia's capital, Red Square, Kremlin", continent: "Europe", zoom: 10 },
            { lat: 41.9028, lon: 12.4964, name: "Rome, Italy", hint: "Eternal City, Colosseum, Vatican nearby", continent: "Europe", zoom: 10 },
            { lat: 52.5200, lon: 13.4050, name: "Berlin, Germany", hint: "Brandenburg Gate, historic wall location", continent: "Europe", zoom: 10 },
            { lat: 40.4168, lon: -3.7038, name: "Madrid, Spain", hint: "Spanish capital, Royal Palace, museums", continent: "Europe", zoom: 10 },
            { lat: 59.3293, lon: 18.0686, name: "Stockholm, Sweden", hint: "Built on 14 islands, Nobel Prize home", continent: "Europe", zoom: 10 },
            { lat: 60.1699, lon: 24.9384, name: "Helsinki, Finland", hint: "Baltic Sea port, midnight sun in summer", continent: "Europe", zoom: 10 },
            { lat: 50.0755, lon: 14.4378, name: "Prague, Czech Republic", hint: "City of a Hundred Spires, medieval charm", continent: "Europe", zoom: 10 },
            { lat: 47.4979, lon: 19.0402, name: "Budapest, Hungary", hint: "Danube River divides Buda and Pest", continent: "Europe", zoom: 10 },
            { lat: 38.7223, lon: -9.1393, name: "Lisbon, Portugal", hint: "Westernmost European capital, Age of Discovery", continent: "Europe", zoom: 10 },
            { lat: 59.9139, lon: 10.7522, name: "Oslo, Norway", hint: "Fjord city, Viking heritage, Nobel Peace Prize", continent: "Europe", zoom: 10 },
            { lat: 55.6761, lon: 12.5683, name: "Copenhagen, Denmark", hint: "Little Mermaid statue, bicycle culture", continent: "Europe", zoom: 10 },
            { lat: 53.3498, lon: -6.2603, name: "Dublin, Ireland", hint: "Emerald Isle capital, literary heritage", continent: "Europe", zoom: 10 },
            { lat: 64.1466, lon: -21.9426, name: "Reykjavik, Iceland", hint: "Northernmost capital, geothermal energy, midnight sun", continent: "Europe", zoom: 10 },
            
            // AFRICA (10 locations)
            { lat: 30.0444, lon: 31.2357, name: "Cairo, Egypt", hint: "Ancient capital, pyramids nearby, Nile River", continent: "Africa", zoom: 10 },
            { lat: -26.2041, lon: 28.0473, name: "Johannesburg, South Africa", hint: "Gold mining history, largest SA city", continent: "Africa", zoom: 10 },
            { lat: -33.9249, lon: 18.4241, name: "Cape Town, South Africa", hint: "Table Mountain, southern tip of Africa", continent: "Africa", zoom: 10 },
            { lat: -1.2921, lon: 36.8219, name: "Nairobi, Kenya", hint: "Safari capital, East African hub", continent: "Africa", zoom: 10 },
            { lat: 6.5244, lon: 3.3792, name: "Lagos, Nigeria", hint: "West African megacity, Atlantic coast", continent: "Africa", zoom: 10 },
            { lat: 33.5731, lon: -7.5898, name: "Casablanca, Morocco", hint: "Atlantic port, famous movie namesake", continent: "Africa", zoom: 10 },
            { lat: -4.0435, lon: 39.6682, name: "Mombasa, Kenya", hint: "Indian Ocean port, historic Swahili coast", continent: "Africa", zoom: 10 },
            { lat: 9.0320, lon: 38.7469, name: "Addis Ababa, Ethiopia", hint: "High altitude capital, African Union headquarters", continent: "Africa", zoom: 10 },
            { lat: 15.5007, lon: 32.5599, name: "Khartoum, Sudan", hint: "Where Blue and White Nile meet", continent: "Africa", zoom: 10 },
            { lat: -18.8792, lon: 47.5079, name: "Antananarivo, Madagascar", hint: "Island nation capital, unique wildlife nearby", continent: "Africa", zoom: 10 },
            
            // ASIA (15 locations)
            { lat: 35.6762, lon: 139.6503, name: "Tokyo, Japan", hint: "Japan's capital, largest metro area, tech hub", continent: "Asia", zoom: 10 },
            { lat: 39.9042, lon: 116.4074, name: "Beijing, China", hint: "Chinese capital, Forbidden City, Great Wall nearby", continent: "Asia", zoom: 10 },
            { lat: 31.2304, lon: 121.4737, name: "Shanghai, China", hint: "Largest Chinese city, futuristic skyline", continent: "Asia", zoom: 10 },
            { lat: 28.6139, lon: 77.2090, name: "New Delhi, India", hint: "Indian capital, Red Fort, historic monuments", continent: "Asia", zoom: 10 },
            { lat: 19.0760, lon: 72.8777, name: "Mumbai, India", hint: "Bollywood, India's financial capital, Arabian Sea", continent: "Asia", zoom: 10 },
            { lat: 1.3521, lon: 103.8198, name: "Singapore", hint: "Island city-state, garden city, global finance hub", continent: "Asia", zoom: 11 },
            { lat: 13.7563, lon: 100.5018, name: "Bangkok, Thailand", hint: "Golden temples, floating markets, Chao Phraya River", continent: "Asia", zoom: 10 },
            { lat: 25.0330, lon: 121.5654, name: "Taipei, Taiwan", hint: "Island tech hub, Taipei 101 skyscraper", continent: "Asia", zoom: 10 },
            { lat: 37.5665, lon: 126.9780, name: "Seoul, South Korea", hint: "K-pop capital, palaces meet technology", continent: "Asia", zoom: 10 },
            { lat: 21.0285, lon: 105.8542, name: "Hanoi, Vietnam", hint: "Vietnamese capital, thousand-year history", continent: "Asia", zoom: 10 },
            { lat: -6.2088, lon: 106.8456, name: "Jakarta, Indonesia", hint: "Island nation capital, massive megacity", continent: "Asia", zoom: 10 },
            { lat: 14.5995, lon: 120.9842, name: "Manila, Philippines", hint: "Island capital, Spanish colonial history", continent: "Asia", zoom: 10 },
            { lat: 3.1390, lon: 101.6869, name: "Kuala Lumpur, Malaysia", hint: "Petronas Towers, multicultural Southeast Asian hub", continent: "Asia", zoom: 10 },
            { lat: 23.8103, lon: 90.4125, name: "Dhaka, Bangladesh", hint: "River delta megacity, historic textile trade", continent: "Asia", zoom: 10 },
            { lat: 33.3152, lon: 44.3661, name: "Baghdad, Iraq", hint: "Ancient Mesopotamian heritage, Tigris River", continent: "Asia", zoom: 10 },
            
            // OCEANIA (5 locations)
            { lat: -33.8688, lon: 151.2093, name: "Sydney, Australia", hint: "Famous harbor, Opera House, Harbour Bridge", continent: "Oceania", zoom: 10 },
            { lat: -37.8136, lon: 144.9631, name: "Melbourne, Australia", hint: "Cultural capital, Australian Rules Football, coffee culture", continent: "Oceania", zoom: 10 },
            { lat: -41.2865, lon: 174.7762, name: "Wellington, New Zealand", hint: "Windy city, southernmost capital, Lord of the Rings", continent: "Oceania", zoom: 10 },
            { lat: -36.8485, lon: 174.7633, name: "Auckland, New Zealand", hint: "City of Sails, volcanic field, largest NZ city", continent: "Oceania", zoom: 10 },
            { lat: -17.7134, lon: 178.0650, name: "Suva, Fiji", hint: "Pacific island capital, coral reefs, tropical paradise", continent: "Oceania", zoom: 10 }
        ];
        
        window.startMysteryGame = function() {
            document.getElementById('mystery-intro').style.display = 'none';
            document.getElementById('mystery-game').style.display = 'block';
            gameState.mystery.active = true;
            
            // Track that Mystery mode was played
            playerAchievements.stats.universal.modesPlayed.add('mystery');
            saveAchievements();
            trackPlayDate();
            
            startMystery();
            
            // Welcome toast
            showToast('info', 'üéØ Mystery Challenge Started!', 'Find the location using coordinates. Hints appear at 30s and 15s!', 4000);
        }
        
        window.startMystery = function() {
            if (gameState.mystery.timer) clearInterval(gameState.mystery.timer);
            
            gameState.mystery.current = mysteryLocations[Math.floor(Math.random() * mysteryLocations.length)];
            
            document.getElementById('mystery-coords').textContent = 
                `${formatCoord(gameState.mystery.current.lat, true)}, ${formatCoord(gameState.mystery.current.lon, false)}`;
            
            document.getElementById('mystery-hints').style.display = 'none';
            
            let timeLeft = 60;
            const timerEl = document.getElementById('mystery-timer');
            timerEl.textContent = timeLeft;
            timerEl.classList.remove('warning');
            
            gameState.mystery.timer = setInterval(() => {
                timeLeft--;
                timerEl.textContent = timeLeft;
                
                if (timeLeft <= 10) {
                    timerEl.classList.add('warning');
                }
                
                if (timeLeft === 30) {
                    document.getElementById('mystery-hints').style.display = 'block';
                    document.getElementById('hint-text').textContent = `Continent: ${gameState.mystery.current.continent}`;
                }
                
                if (timeLeft === 15) {
                    document.getElementById('hint-text').textContent = gameState.mystery.current.hint;
                }
                
                if (timeLeft <= 0) {
                    clearInterval(gameState.mystery.timer);
                    showNotification('‚è∞ Time\'s up! Streak reset.');
                    gameState.mystery.streak = 0;
                    updateAllDisplays();
                    startMystery();
                }
            }, 1000);
        }
        
        window.checkMysteryAnswer = function(lat, lon) {
            if (!gameState.mystery.current) return;
            
            const distance = Math.sqrt(
                Math.pow((lat - gameState.mystery.current.lat) * 111, 2) + 
                Math.pow((lon - gameState.mystery.current.lon) * 111 * Math.cos(lat * Math.PI / 180), 2)
            );
            
            if (distance < 500) { // Within 500km
                clearInterval(gameState.mystery.timer);
                
                // Calculate time taken (60 - remaining time)
                const timerEl = document.getElementById('mystery-timer');
                const timeLeft = parseInt(timerEl.textContent) || 0;
                const timeTaken = 60 - timeLeft;
                
                // Track fastest time
                if (timeTaken < gameState.mystery.fastestTime) {
                    gameState.mystery.fastestTime = timeTaken;
                }
                
                const baseXP = 50;
                const streakBonus = gameState.mystery.streak * 10;
                const totalXP = baseXP + streakBonus;
                
                addXP(totalXP, `Correct! ${gameState.mystery.current.name}`);
                gameState.mystery.score += totalXP;
                gameState.mystery.streak++;
                gameState.mystery.solved++;
                gameState.mystery.roundsPlayed++;
                
                if (gameState.mystery.streak > gameState.mystery.bestStreak) {
                    gameState.mystery.bestStreak = gameState.mystery.streak;
                }
                
                // Update mission progress
                gameState.missions[0].progress++;
                
                updateAllDisplays();
                saveState();
                
                // Track achievement stats
                playerAchievements.stats.mystery.solved++;
                playerAchievements.stats.mystery.uniqueLocationsSolved.add(gameState.mystery.current.name);
                playerAchievements.stats.mystery.streak = gameState.mystery.streak;
                saveAchievements();
                checkMysteryAchievements();
                checkUniversalAchievements();
                
                // Check if 5 rounds complete - show completion modal
                if (gameState.mystery.roundsPlayed % 5 === 0 && gameState.mystery.roundsPlayed > 0) {
                    showGameComplete('mystery', {
                        score: gameState.mystery.score,
                        correct: 5,
                        streak: gameState.mystery.streak,
                        bestTime: gameState.mystery.fastestTime
                    });
                } else {
                    // Show Play Again message with button
                    showMysterySuccess();
                }
            } else {
                // Provide helpful distance feedback
                const distanceKm = Math.round(distance);
                const distanceMiles = Math.round(distanceKm * 0.621371);
                let hint = '';
                if (distanceKm > 5000) {
                    hint = 'Try a different continent!';
                } else if (distanceKm > 2000) {
                    hint = 'Getting closer...';
                } else if (distanceKm > 1000) {
                    hint = 'You\'re in the right region!';
                } else {
                    hint = 'Very close! Keep trying!';
                }
                showNotification(`‚ùå Not quite! ${distanceMiles} miles away. ${hint}`);
                showToast('error', 'Try Again!', `You're ${distanceMiles.toLocaleString()} miles away. ${hint}`, 3000);
            }
        }
        
        window.showMysterySuccess = function() {
            // Show success message overlay with Play Again button
            const mysteryGame = document.getElementById('mystery-game');
            const overlay = document.createElement('div');
            overlay.id = 'mystery-success-overlay';
            overlay.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                animation: fadeIn 0.3s ease-in;
            `;
            
            overlay.innerHTML = `
                <div style="text-align: center; padding: 40px; background: rgba(20, 30, 40, 0.95); border-radius: 15px; border: 2px solid #00ff7f; max-width: 400px;">
                    <h2 style="color: #00ff7f; font-size: 36px; margin: 0 0 15px 0;">‚úÖ CORRECT!</h2>
                    <p style="font-size: 24px; color: #ffd700; margin: 0 0 10px 0;">${gameState.mystery.current.name}</p>
                    <p style="font-size: 16px; color: #aaa; margin: 0 0 20px 0;">${gameState.mystery.current.hint}</p>
                    <div style="background: rgba(0, 255, 127, 0.1); border-radius: 8px; padding: 15px; margin: 20px 0;">
                        <p style="color: #00ff7f; font-size: 18px; margin: 0;">üî• Streak: ${gameState.mystery.streak}</p>
                        <p style="color: #66b3ff; font-size: 14px; margin: 5px 0 0 0;">Best: ${gameState.mystery.bestStreak}</p>
                    </div>
                    <button onclick="playAgainMystery()" class="btn" style="font-size: 20px; padding: 15px 40px; margin-top: 10px; background: #00ff7f; color: #000;">
                        üéØ PLAY AGAIN
                    </button>
                    <p style="font-size: 12px; color: #666; margin: 15px 0 0 0;">Auto-start in 3 seconds...</p>
                </div>
            `;
            
            mysteryGame.style.position = 'relative';
            mysteryGame.appendChild(overlay);
            
            // Auto-start after 3 seconds
            setTimeout(() => {
                playAgainMystery();
            }, 3000);
        }
        
        window.playAgainMystery = function() {
            const overlay = document.getElementById('mystery-success-overlay');
            if (overlay) overlay.remove();
            startMystery();
        }
        
        window.skipMystery = function() {
            if (!gameState.mystery.current) return;
            clearInterval(gameState.mystery.timer);
            addXP(-5, 'Mystery skipped');
            gameState.mystery.streak = 0;
            updateAllDisplays();
            startMystery();
        }
        
        // SCAVENGER HUNT
        const scavengerChallenges = [
            // Africa
            { desc: "Find the Sahara Desert", clue: "üí° The world's largest hot desert in northern Africa", lat: 23.4162, lon: 25.6628, tolerance: 1000, type: "desert", continent: "Africa", difficulty: "easy" },
            { desc: "Find the Nile River", clue: "üí° The longest river in the world, flows through Egypt", lat: 26.8206, lon: 30.8025, tolerance: 500, type: "river", continent: "Africa", difficulty: "medium" },
            { desc: "Find Mount Kilimanjaro", clue: "üí° Africa's tallest mountain in Tanzania, near Kenya border", lat: -3.0674, lon: 37.3556, tolerance: 150, type: "mountain", continent: "Africa", difficulty: "hard" },
            
            // Asia
            { desc: "Find Mount Everest", clue: "üí° World's highest mountain on Nepal-China border", lat: 27.9881, lon: 86.9250, tolerance: 200, type: "mountain", continent: "Asia", difficulty: "medium" },
            { desc: "Find Tokyo, Japan", clue: "üí° Capital city on the eastern coast of Japan's main island", lat: 35.6762, lon: 139.6503, tolerance: 100, type: "city", continent: "Asia", difficulty: "easy" },
            { desc: "Find the Great Wall of China", clue: "üí° Ancient fortification north of Beijing, China", lat: 40.4319, lon: 116.5704, tolerance: 200, type: "landmark", continent: "Asia", difficulty: "medium" },
            { desc: "Find the Gobi Desert", clue: "üí° Large desert spanning northern China and southern Mongolia", lat: 42.5883, lon: 103.4608, tolerance: 800, type: "desert", continent: "Asia", difficulty: "hard" },
            
            // Europe
            { desc: "Find Paris, France", clue: "üí° France's capital city on the Seine River, home of the Eiffel Tower", lat: 48.8566, lon: 2.3522, tolerance: 100, type: "city", continent: "Europe", difficulty: "easy" },
            { desc: "Find the Alps", clue: "üí° Major mountain range through Switzerland, France, Italy, and Austria", lat: 46.5498, lon: 9.7882, tolerance: 300, type: "mountain", continent: "Europe", difficulty: "medium" },
            { desc: "Find the Volga River", clue: "üí° Europe's longest river, flows through western Russia to the Caspian Sea", lat: 57.6222, lon: 39.8844, tolerance: 400, type: "river", continent: "Europe", difficulty: "hard" },
            
            // North America
            { desc: "Find the Grand Canyon", clue: "üí° Massive canyon carved by the Colorado River in Arizona, USA", lat: 36.1069, lon: -112.1129, tolerance: 200, type: "canyon", continent: "North America", difficulty: "medium" },
            { desc: "Find the Mississippi River", clue: "üí° Major river flowing from Minnesota to the Gulf of Mexico, passes through St. Louis", lat: 38.6270, lon: -90.2006, tolerance: 400, type: "river", continent: "North America", difficulty: "medium" },
            { desc: "Find the Rocky Mountains", clue: "üí° Mountain range running from Canada through western USA, passes through Alberta", lat: 50.0262, lon: -114.2098, tolerance: 300, type: "mountain", continent: "North America", difficulty: "hard" },
            { desc: "Find Yellowstone National Park", clue: "üí° Famous national park in Wyoming with geysers and hot springs", lat: 44.4280, lon: -110.5885, tolerance: 150, type: "park", continent: "North America", difficulty: "hard" },
            
            // South America
            { desc: "Find the Amazon River", clue: "üí° World's largest river by volume, flows through Brazil's rainforest", lat: -3.4653, lon: -62.2159, tolerance: 500, type: "river", continent: "South America", difficulty: "medium" },
            { desc: "Find the Andes Mountains", clue: "üí° Longest mountain range in the world, runs along South America's west coast through Peru", lat: -13.1631, lon: -72.5450, tolerance: 400, type: "mountain", continent: "South America", difficulty: "medium" },
            { desc: "Find the Atacama Desert", clue: "üí° One of the driest places on Earth, in northern Chile near Bolivia", lat: -23.6980, lon: -70.4019, tolerance: 600, type: "desert", continent: "South America", difficulty: "hard" },
            
            // Oceania
            { desc: "Find the Great Barrier Reef", clue: "üí° World's largest coral reef system off northeastern Australia's coast", lat: -18.2871, lon: 147.6992, tolerance: 300, type: "reef", continent: "Oceania", difficulty: "medium" },
            { desc: "Find Uluru (Ayers Rock)", clue: "üí° Massive red sandstone formation in central Australia's desert", lat: -25.3444, lon: 131.0369, tolerance: 100, type: "landmark", continent: "Oceania", difficulty: "hard" },
            
            // Antarctica
            { desc: "Find Antarctica", clue: "üí° The frozen continent at the bottom of the world, south of all other continents", lat: -82.8628, lon: 135.0000, tolerance: 2000, type: "continent", continent: "Antarctica", difficulty: "easy" }
        ];
        
        window.startScavengerGame = function() {
            document.getElementById('scavenger-intro').style.display = 'none';
            document.getElementById('scavenger-game').style.display = 'block';
            gameState.scavenger.active = true;
            gameState.scavenger.challenges = scavengerChallenges.map(c => ({ ...c, completed: false }));
            gameState.scavenger.completed = 0;
            gameState.scavenger.startTime = Date.now();
            
            // Track mode played for achievements
            if (!playerAchievements.stats.universal.modesPlayed.has('scavenger')) {
                playerAchievements.stats.universal.modesPlayed.add('scavenger');
                saveAchievements();
            }
            trackPlayDate();
            
            renderScavengerList();
        }
        
        window.renderScavengerList = function() {
            // Show only the CURRENT challenge (not completed yet)
            const currentChallenge = gameState.scavenger.challenges.find(c => !c.completed);
            
            if (currentChallenge) {
                const html = `
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 20px; border-radius: 12px; border: 2px solid rgba(102, 126, 234, 0.3); text-align: center; margin: 20px 0;">
                        <h3 style="color: #ffd700; font-size: 24px; margin: 0 0 10px 0;">CURRENT CHALLENGE:</h3>
                        <p style="font-size: 20px; color: #66b3ff; font-weight: bold; margin: 15px 0;">
                            ${currentChallenge.desc}
                        </p>
                        ${currentChallenge.clue ? `
                            <div style="background: rgba(255, 215, 0, 0.1); border-left: 3px solid #ffd700; padding: 12px; margin: 15px 0; border-radius: 6px; text-align: left;">
                                <p style="font-size: 14px; color: #ffd700; margin: 0; line-height: 1.6;">
                                    ${currentChallenge.clue}
                                </p>
                            </div>
                        ` : ''}
                        <p style="font-size: 14px; color: #aaa; margin-top: 15px;">
                            ÔøΩÔ∏è Click on the map where you think it is!
                        </p>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="color: #888; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Completed Challenges:</h4>
                        ${gameState.scavenger.challenges
                            .filter(c => c.completed)
                            .map(c => `
                                <div style="padding: 10px; background: rgba(0, 255, 127, 0.1); border-left: 3px solid #00ff7f; margin: 5px 0; border-radius: 6px;">
                                    <span style="color: #00ff7f;">‚úÖ ${c.desc}</span>
                                    <span style="color: #00ff7f; font-weight: 700; float: right;">+20 XP</span>
                                </div>
                            `).join('')
                        }
                    </div>
                `;
                document.getElementById('scavenger-list').innerHTML = html;
            }
            
            const progress = (gameState.scavenger.completed / gameState.scavenger.challenges.length) * 100;
            document.getElementById('scavenger-progress').style.width = progress + '%';
            document.getElementById('scavenger-progress').textContent = 
                `${gameState.scavenger.completed}/${gameState.scavenger.challenges.length}`;
        }
        
        window.checkScavengerAnswer = function(lat, lon) {
            for (let i = 0; i < gameState.scavenger.challenges.length; i++) {
                const c = gameState.scavenger.challenges[i];
                if (c.completed) continue;
                
                const distance = Math.sqrt(
                    Math.pow((lat - c.lat) * 111, 2) + 
                    Math.pow((lon - c.lon) * 111 * Math.cos(lat * Math.PI / 180), 2)
                );
                
                if (distance < c.tolerance) {
                    c.completed = true;
                    gameState.scavenger.completed++;
                    
                    // Track achievement stats
                    playerAchievements.stats.scavenger.challengesCompleted++;
                    if (c.continent) {
                        playerAchievements.stats.scavenger.continentsVisited.add(c.continent);
                    }
                    if (distance < c.tolerance * 0.1) { // Within 10% of tolerance = high accuracy
                        playerAchievements.stats.scavenger.perfectFinds++;
                    }
                    
                    addXP(20, c.desc + ' found!');
                    saveAchievements();
                    checkScavengerAchievements();
                    renderScavengerList();
                    
                    if (gameState.scavenger.completed === gameState.scavenger.challenges.length) {
                        const completionTime = (Date.now() - gameState.scavenger.startTime) / 1000;
                        gameState.scavenger.completionTime = completionTime;
                        
                        playerAchievements.stats.scavenger.huntsCompleted++;
                        if (completionTime < 300) { // Under 5 minutes
                            playerAchievements.stats.scavenger.fastCompletions++;
                        }
                        
                        // Mark mode completed
                        if (!playerAchievements.stats.universal.modesCompleted.has('scavenger')) {
                            playerAchievements.stats.universal.modesCompleted.add('scavenger');
                        }
                        
                        addXP(100, 'Scavenger Hunt Complete!');
                        gameState.missions[1].progress = 1;
                        saveState();
                        saveAchievements();
                        checkScavengerAchievements();
                        checkUniversalAchievements();
                        showScavengerComplete();
                    }
                    return;
                }
            }
            
            showNotification('‚ùå Not quite! Try another location.');
        }
        
        window.showScavengerComplete = function() {
            setTimeout(() => {
                const scavengerList = document.getElementById('scavenger-list');
                const celebrationHTML = `
                    <div style="text-align: center; padding: 40px; background: rgba(0, 255, 127, 0.1); border-radius: 15px; border: 2px solid #00ff7f; margin: 20px 0;">
                        <h2 style="color: #00ff7f; font-size: 36px; margin: 0 0 15px 0;">üèÜ ALL CHALLENGES COMPLETE!</h2>
                        <p style="font-size: 18px; color: #aaa; margin: 0 0 25px 0;">
                            You discovered all ${gameState.scavenger.challenges.length} locations!
                        </p>
                        <div style="background: rgba(255, 215, 0, 0.1); border-radius: 8px; padding: 15px; margin: 20px 0;">
                            <p style="color: #ffd700; font-size: 20px; margin: 0;">+100 XP Completion Bonus!</p>
                        </div>
                        <button onclick="playAgainScavenger()" class="btn" style="font-size: 20px; padding: 15px 40px; margin-top: 15px; background: #00ff7f; color: #000;">
                            üîÑ PLAY AGAIN
                        </button>
                    </div>
                `;
                scavengerList.innerHTML = celebrationHTML;
            }, 1500);
        }
        
        window.playAgainScavenger = function() {
            resetScavenger();
            gameState.scavenger.startTime = Date.now();
            showNotification('üåç New Scavenger Hunt started! Find all locations!');
        }
        
        window.resetScavenger = function() {
            gameState.scavenger.challenges = scavengerChallenges.map(c => ({ ...c, completed: false }));
            gameState.scavenger.completed = 0;
            gameState.scavenger.startTime = Date.now();
            renderScavengerList();
        }
        
        // GUESS GAME - 30 Famous Landmarks Across All Continents
        const guessLocations = [
            // Asia (10 locations)
            { lat: 27.1751, lon: 78.0421, name: "Taj Mahal", country: "India", continent: "Asia", zoom: 15, difficulty: "easy", options: ["India", "Pakistan", "Bangladesh", "Nepal"] },
            { lat: 40.4319, lon: 116.5704, name: "Great Wall of China", country: "China", continent: "Asia", zoom: 14, difficulty: "medium", options: ["China", "Japan", "South Korea", "Vietnam"] },
            { lat: 25.1972, lon: 55.2744, name: "Burj Khalifa", country: "UAE", continent: "Asia", zoom: 16, difficulty: "easy", options: ["UAE", "Saudi Arabia", "Qatar", "Kuwait"] },
            { lat: 35.6762, lon: 139.6503, name: "Tokyo Tower", country: "Japan", continent: "Asia", zoom: 15, difficulty: "medium", options: ["Japan", "China", "South Korea", "Thailand"] },
            { lat: 13.4125, lon: 103.8670, name: "Angkor Wat", country: "Cambodia", continent: "Asia", zoom: 14, difficulty: "hard", options: ["Cambodia", "Thailand", "Vietnam", "Indonesia"] },
            { lat: 27.9881, lon: 86.9250, name: "Mount Everest", country: "Nepal", continent: "Asia", zoom: 13, difficulty: "medium", options: ["Nepal", "China", "India", "Pakistan"] },
            { lat: 1.2825, lon: 103.8582, name: "Marina Bay Sands", country: "Singapore", continent: "Asia", zoom: 16, difficulty: "medium", options: ["Singapore", "Malaysia", "Indonesia", "Thailand"] },
            { lat: 41.0082, lon: 28.9784, name: "Hagia Sophia", country: "Turkey", continent: "Asia", zoom: 16, difficulty: "hard", options: ["Turkey", "Greece", "Italy", "Egypt"] },
            { lat: 21.4225, lon: 39.8262, name: "Masjid al-Haram", country: "Saudi Arabia", continent: "Asia", zoom: 15, difficulty: "hard", options: ["Saudi Arabia", "UAE", "Kuwait", "Qatar"] },
            { lat: -6.1751, lon: 106.8650, name: "Monas (National Monument)", country: "Indonesia", continent: "Asia", zoom: 15, difficulty: "hard", options: ["Indonesia", "Philippines", "Malaysia", "Thailand"] },
            
            // Europe (8 locations)
            { lat: 41.8902, lon: 12.4922, name: "Colosseum", country: "Italy", continent: "Europe", zoom: 16, difficulty: "easy", options: ["Italy", "Greece", "Spain", "France"] },
            { lat: 43.7230, lon: 10.3966, name: "Leaning Tower of Pisa", country: "Italy", continent: "Europe", zoom: 17, difficulty: "easy", options: ["Italy", "France", "Spain", "Greece"] },
            { lat: 51.1789, lon: -1.8262, name: "Stonehenge", country: "UK", continent: "Europe", zoom: 16, difficulty: "medium", options: ["UK", "Ireland", "France", "Germany"] },
            { lat: 48.8584, lon: 2.2945, name: "Eiffel Tower", country: "France", continent: "Europe", zoom: 16, difficulty: "easy", options: ["France", "Italy", "Spain", "UK"] },
            { lat: 55.7558, lon: 37.6173, name: "Red Square", country: "Russia", continent: "Europe", zoom: 15, difficulty: "medium", options: ["Russia", "Germany", "UK", "France"] },
            { lat: 41.4036, lon: 2.1744, name: "Sagrada Familia", country: "Spain", continent: "Europe", zoom: 16, difficulty: "medium", options: ["Spain", "Italy", "France", "Greece"] },
            { lat: 51.5014, lon: -0.1419, name: "Big Ben", country: "UK", continent: "Europe", zoom: 17, difficulty: "easy", options: ["UK", "France", "Germany", "Ireland"] },
            { lat: 60.1282, lon: 18.6435, name: "Vasa Museum", country: "Sweden", continent: "Europe", zoom: 16, difficulty: "hard", options: ["Sweden", "Norway", "Germany", "Russia"] },
            
            // Africa (3 locations)
            { lat: 29.9792, lon: 31.1342, name: "Pyramids of Giza", country: "Egypt", continent: "Africa", zoom: 15, difficulty: "easy", options: ["Egypt", "Sudan", "Libya", "Tunisia"] },
            { lat: -1.2921, lon: 36.8219, name: "Nairobi National Park", country: "Kenya", continent: "Africa", zoom: 14, difficulty: "hard", options: ["Kenya", "Tanzania", "South Africa", "Nigeria"] },
            { lat: -33.9249, lon: 18.4241, name: "Table Mountain", country: "South Africa", continent: "Africa", zoom: 13, difficulty: "medium", options: ["South Africa", "Namibia", "Kenya", "Morocco"] },
            
            // North America (4 locations)
            { lat: 40.6892, lon: -74.0445, name: "Statue of Liberty", country: "USA", continent: "North America", zoom: 16, difficulty: "easy", options: ["USA", "Canada", "Mexico", "Cuba"] },
            { lat: 36.1069, lon: -112.1129, name: "Grand Canyon", country: "USA", continent: "North America", zoom: 13, difficulty: "medium", options: ["USA", "Mexico", "Canada", "Peru"] },
            { lat: 51.1784, lon: -115.5708, name: "Lake Louise", country: "Canada", continent: "North America", zoom: 14, difficulty: "hard", options: ["Canada", "USA", "Norway", "Sweden"] },
            { lat: 19.4326, lon: -99.1332, name: "Teotihuacan Pyramids", country: "Mexico", continent: "North America", zoom: 14, difficulty: "medium", options: ["Mexico", "Peru", "USA", "Cuba"] },
            
            // South America (3 locations)
            { lat: -13.1631, lon: -72.5450, name: "Machu Picchu", country: "Peru", continent: "South America", zoom: 14, difficulty: "easy", options: ["Peru", "Chile", "Bolivia", "Ecuador"] },
            { lat: -22.9519, lon: -43.2105, name: "Christ the Redeemer", country: "Brazil", continent: "South America", zoom: 15, difficulty: "easy", options: ["Brazil", "Argentina", "Colombia", "Venezuela"] },
            { lat: -54.8019, lon: -68.3030, name: "Ushuaia (End of World)", country: "Argentina", continent: "South America", zoom: 13, difficulty: "hard", options: ["Argentina", "Chile", "Brazil", "Peru"] },
            
            // Oceania (2 locations)
            { lat: -25.3444, lon: 131.0369, name: "Uluru", country: "Australia", continent: "Oceania", zoom: 13, difficulty: "medium", options: ["Australia", "New Zealand", "South Africa", "Namibia"] },
            { lat: -33.8568, lon: 151.2153, name: "Sydney Opera House", country: "Australia", continent: "Oceania", zoom: 16, difficulty: "easy", options: ["Australia", "New Zealand", "Fiji", "Indonesia"] }
        ];
        
        window.startGuessGame = function() {
            document.getElementById('guess-intro').style.display = 'none';
            document.getElementById('guess-game').style.display = 'block';
            gameState.guess.active = true;
            gameState.guess.round = 0;
            gameState.guess.score = 0;
            gameState.guess.correct = 0;
            gameState.guess.startTime = Date.now();
            document.getElementById('guess-score').textContent = '0';
            
            // Track mode played for achievements
            if (!playerAchievements.stats.universal.modesPlayed.has('guess')) {
                playerAchievements.stats.universal.modesPlayed.add('guess');
                saveAchievements();
            }
            trackPlayDate();
            
            nextGuessRound();
        }
        
        window.nextGuessRound = function() {
            if (gameState.guess.round >= 5) {
                gameState.guess.active = false;
                const completionTime = (Date.now() - gameState.guess.startTime) / 1000;
                gameState.guess.completionTime = completionTime;
                
                // Track achievement stats
                playerAchievements.stats.guess.roundsPlayed += 5;
                playerAchievements.stats.guess.gamesCompleted++;
                
                if (gameState.guess.correct === 5) {
                    playerAchievements.stats.guess.perfectRounds++;
                }
                if (completionTime < 60) { // Under 1 minute for 5 rounds
                    playerAchievements.stats.guess.fastCompletions++;
                }
                
                // Mark mode completed
                if (!playerAchievements.stats.universal.modesCompleted.has('guess')) {
                    playerAchievements.stats.universal.modesCompleted.add('guess');
                }
                
                addXP(50, 'Guess Game Complete!');
                saveAchievements();
                checkGuessAchievements();
                checkUniversalAchievements();
                showGuessComplete();
                return;
            }
            
            gameState.guess.round++;
            gameState.guess.roundStartTime = Date.now();
            gameState.guess.current = guessLocations[Math.floor(Math.random() * guessLocations.length)];
            
            document.getElementById('guess-round').textContent = gameState.guess.round;
            document.getElementById('next-guess-btn').style.display = 'none';
            
            geoMap.setView([gameState.guess.current.lat, gameState.guess.current.lon], gameState.guess.current.zoom);
            
            const optionsHtml = gameState.guess.current.options.map(option => 
                `<button class="answer-btn" onclick="checkGuess('${option}')">${option}</button>`
            ).join('');
            document.getElementById('guess-options').innerHTML = optionsHtml;
        }
        
        window.showGuessComplete = function() {
            const accuracy = gameState.guess.correct > 0 ? Math.round((gameState.guess.correct / 5) * 100) : 0;
            const guessGame = document.getElementById('guess-game');
            const guessOptions = document.getElementById('guess-options');
            
            const completionHTML = `
                <div style="text-align: center; padding: 40px; background: rgba(102, 179, 255, 0.1); border-radius: 15px; border: 2px solid #66b3ff; margin: 20px 0;">
                    <h2 style="color: #66b3ff; font-size: 36px; margin: 0 0 15px 0;">üéØ GAME COMPLETE!</h2>
                    <p style="font-size: 20px; color: #aaa; margin: 0 0 10px 0;">
                        You got <span style="color: #00ff7f; font-weight: bold;">${gameState.guess.correct}/5</span> correct!
                    </p>
                    <p style="font-size: 16px; color: #aaa; margin: 0 0 25px 0;">
                        Accuracy: ${accuracy}%
                    </p>
                    <div style="background: rgba(255, 215, 0, 0.1); border-radius: 8px; padding: 15px; margin: 20px 0;">
                        <p style="color: #ffd700; font-size: 20px; margin: 0;">+50 XP Completion Bonus!</p>
                        <p style="color: #aaa; font-size: 14px; margin: 5px 0 0 0;">Total Score: ${gameState.guess.score} XP</p>
                    </div>
                    <button onclick="playAgainGuess()" class="btn" style="font-size: 20px; padding: 15px 40px; margin-top: 15px; background: #66b3ff; color: #000;">
                        üîÑ PLAY AGAIN
                    </button>
                </div>
            `;
            
            guessOptions.innerHTML = completionHTML;
            document.getElementById('next-guess-btn').style.display = 'none';
        }
        
        window.playAgainGuess = function() {
            gameState.guess.round = 0;
            gameState.guess.score = 0;
            gameState.guess.correct = 0;
            gameState.guess.startTime = Date.now();
            document.getElementById('guess-score').textContent = '0';
            nextGuessRound();
            showNotification('üéØ New Guess Game started! Good luck!');
        }
        
        window.checkGuess = function(answer) {
            if (!gameState.guess.current) return;
            
            const roundTime = (Date.now() - gameState.guess.roundStartTime) / 1000;
            const buttons = document.querySelectorAll('#guess-options .answer-btn');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === gameState.guess.current.country) {
                    btn.classList.add('correct');
                } else if (btn.textContent === answer) {
                    btn.classList.add('incorrect');
                }
            });
            
            if (answer === gameState.guess.current.country) {
                addXP(30, 'Correct!');
                gameState.guess.score += 30;
                gameState.guess.correct++;
                gameState.missions[2].progress++;
                document.getElementById('guess-score').textContent = gameState.guess.score;
                
                // Track achievement stats
                playerAchievements.stats.guess.correctGuesses++;
                if (gameState.guess.current.name) {
                    playerAchievements.stats.guess.landmarksIdentified.add(gameState.guess.current.name);
                }
                if (roundTime < 5) { // Under 5 seconds
                    playerAchievements.stats.guess.instantIdentifications++;
                }
            } else {
                // Track close guesses (correct continent but wrong country)
                if (gameState.guess.current.continent) {
                    const correctContinent = gameState.guess.current.continent;
                    const guessContinent = getContinentForCountry(answer);
                    if (correctContinent === guessContinent) {
                        playerAchievements.stats.guess.closeGuesses++;
                    }
                }
            }
            
            gameState.guess.total++;
            saveAchievements();
            checkGuessAchievements();
            updateAllDisplays();
            saveState();
            
            // Show next button briefly, then auto-advance after 2 seconds
            const nextBtn = document.getElementById('next-guess-btn');
            nextBtn.style.display = 'block';
            
            // Auto-advance to next round after showing answer
            setTimeout(() => {
                if (gameState.guess.active) {
                    nextGuessRound();
                }
            }, 2000);
        }
        
        // Helper function to get continent for country (for close guess tracking)
        function getContinentForCountry(country) {
            const continentMap = {
                'India': 'Asia', 'Pakistan': 'Asia', 'Bangladesh': 'Asia', 'Nepal': 'Asia', 'China': 'Asia', 
                'Japan': 'Asia', 'Thailand': 'Asia', 'Vietnam': 'Asia', 'UAE': 'Asia', 'Saudi Arabia': 'Asia', 
                'Qatar': 'Asia', 'Kuwait': 'Asia', 'South Korea': 'Asia', 'Indonesia': 'Asia', 'Philippines': 'Asia',
                'Italy': 'Europe', 'Greece': 'Europe', 'Spain': 'Europe', 'France': 'Europe', 'UK': 'Europe', 
                'Ireland': 'Europe', 'Germany': 'Europe', 'Russia': 'Europe', 'Norway': 'Europe', 'Sweden': 'Europe',
                'USA': 'North America', 'Canada': 'North America', 'Mexico': 'North America', 'Cuba': 'North America',
                'Peru': 'South America', 'Chile': 'South America', 'Bolivia': 'South America', 'Ecuador': 'South America', 
                'Brazil': 'South America', 'Argentina': 'South America', 'Colombia': 'South America', 'Venezuela': 'South America',
                'Egypt': 'Africa', 'Sudan': 'Africa', 'Libya': 'Africa', 'Tunisia': 'Africa', 'Kenya': 'Africa', 
                'Tanzania': 'Africa', 'South Africa': 'Africa', 'Nigeria': 'Africa', 'Morocco': 'Africa',
                'Australia': 'Oceania', 'New Zealand': 'Oceania', 'Namibia': 'Oceania', 'Fiji': 'Oceania'
            };
            return continentMap[country] || 'Unknown';
        }
        
        // MISSIONS
        window.renderMissions = function() {
            const html = gameState.missions.map(m => {
                const progress = Math.min((m.progress / m.target) * 100, 100);
                const isComplete = m.progress >= m.target;
                return `
                    <div class="section" style="margin-bottom: 12px;">
                        <h3 style="color: ${isComplete ? '#00ff7f' : '#ffd700'}; font-size: 16px; margin-bottom: 8px;">
                            ${isComplete ? '‚úÖ' : 'üéØ'} ${m.name}
                        </h3>
                        <p style="color: #aaa; font-size: 13px; margin-bottom: 10px;">${m.desc}</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%">${m.progress}/${m.target}</div>
                        </div>
                        <div style="text-align: right; margin-top: 8px; color: ${isComplete ? '#00ff7f' : '#ffd700'}; font-weight: 700;">
                            ${isComplete ? 'COMPLETE!' : `Reward: ${m.xp} XP`}
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('missions-list').innerHTML = html;
        }
        
        // CREATE HEIST
        let heistLocation = null;
        
        window.setHeistLocation = function(lat, lon) {
            heistLocation = { lat, lon };
            document.getElementById('heist-coords').textContent = `${formatCoord(lat, true)}, ${formatCoord(lon, false)}`;
            if (currentMarker) geoMap.removeLayer(currentMarker);
            currentMarker = L.marker([lat, lon]).addTo(geoMap);
        }
        
        window.saveHeist = function() {
            const name = document.getElementById('heist-name').value;
            const clue1 = document.getElementById('clue1').value;
            const clue2 = document.getElementById('clue2').value;
            
            if (!name || !heistLocation || !clue1) {
                showNotification('‚ö†Ô∏è Fill in name, location, and clue 1!');
                return;
            }
            
            const heist = {
                id: Date.now(),
                name,
                location: heistLocation,
                clues: [clue1, clue2].filter(c => c),
                created: new Date().toLocaleDateString()
            };
            
            gameState.heists.push(heist);
            gameState.missions[3].progress++;
            addXP(50, 'Heist created!');
            saveState();
            
            // Track heist creation for achievements
            playerAchievements.stats.heist.created++;
            playerAchievements.stats.universal.modesPlayed.add('heist');
            playerAchievements.stats.universal.modesCompleted.add('heist');
            saveAchievements();
            checkHeistAchievements();
            checkUniversalAchievements();
            trackPlayDate();
            
            // Show success message with Play Again option
            showHeistSaved(heist.name);
        }
        
        window.showHeistSaved = function(heistName) {
            const overlay = document.createElement('div');
            overlay.id = 'heist-saved-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(20, 30, 40, 0.95);
                border-radius: 15px;
                border: 2px solid #ffd700;
                padding: 40px;
                z-index: 2000;
                text-align: center;
                max-width: 400px;
                animation: fadeIn 0.5s ease-in;
            `;
            
            overlay.innerHTML = `
                <h2 style="color: #ffd700; font-size: 32px; margin: 0 0 15px 0;">üíæ HEIST SAVED!</h2>
                <p style="font-size: 18px; color: #00ff7f; margin: 0 0 10px 0;">"${heistName}"</p>
                <p style="font-size: 14px; color: #aaa; margin: 0 0 20px 0;">Your classmates can now try to find this location!</p>
                <div style="background: rgba(255, 215, 0, 0.1); border-radius: 8px; padding: 15px; margin: 20px 0;">
                    <p style="color: #ffd700; font-size: 18px; margin: 0;">+50 XP Earned!</p>
                </div>
                <button onclick="createAnotherHeist()" class="btn" style="font-size: 18px; padding: 12px 30px; background: #ffd700; color: #000; margin-right: 10px;">
                    üó∫Ô∏è CREATE ANOTHER
                </button>
                <button onclick="closeHeistOverlay()" class="btn" style="font-size: 18px; padding: 12px 30px; background: #444; color: #fff;">
                    ‚úì DONE
                </button>
            `;
            
            document.body.appendChild(overlay);
        }
        
        window.createAnotherHeist = function() {
            closeHeistOverlay();
            // Reset form
            document.getElementById('heist-name').value = '';
            document.getElementById('clue1').value = '';
            document.getElementById('clue2').value = '';
            document.getElementById('heist-coords').textContent = 'Click on map to set location';
            heistLocation = null;
            if (currentMarker) geoMap.removeLayer(currentMarker);
            showNotification('üó∫Ô∏è Create another heist! Click the map to set a new location.');
        }
        
        window.closeHeistOverlay = function() {
            const overlay = document.getElementById('heist-saved-overlay');
            if (overlay) overlay.remove();
            // Also reset form
            document.getElementById('heist-name').value = '';
            document.getElementById('clue1').value = '';
            document.getElementById('clue2').value = '';
            document.getElementById('heist-coords').textContent = 'Click on map to set location';
            heistLocation = null;
            if (currentMarker) geoMap.removeLayer(currentMarker);
        }
        
        window.loadHeists = function() {
            if (gameState.heists.length === 0) {
                showNotification('No saved heists yet!');
                return;
            }
            
            const html = gameState.heists.map(h => `
                <div class="challenge-item">
                    <div>
                        <strong style="color: #ffd700;">${h.name}</strong><br>
                        <span style="font-size: 12px; color: #aaa;">Created: ${h.created}</span>
                    </div>
                    <button class="btn" style="width: auto; padding: 8px 16px; margin: 0;" onclick="viewHeist(${h.id})">VIEW</button>
                </div>
            `).join('');
            
            document.getElementById('saved-heists-list').innerHTML = html;
            document.getElementById('saved-heists-section').style.display = 'block';
        }
        
        window.viewHeist = function(id) {
            const heist = gameState.heists.find(h => h.id === id);
            if (!heist) return;
            
            geoMap.setView([heist.location.lat, heist.location.lon], 10);
            if (currentMarker) geoMap.removeLayer(currentMarker);
            currentMarker = L.marker([heist.location.lat, heist.location.lon]).addTo(geoMap);
            
            showNotification(`üìç ${heist.name}`);
        }
        
        // ============ ALASKA ADVENTURE FUNCTIONS ============
        
        window.calculateDistance = function(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return Math.round(R * c);
        }
        
        window.startAlaskaGame = function() {
            gameState.alaska.active = true;
            gameState.alaska.currentRound = 0;
            gameState.alaska.roundProgress = [0, 0, 0, 0, 0];
            gameState.alaska.totalFound = 0;
            gameState.alaska.foundLocations = [];
            
            // Track that Alaska mode was played (for universal achievements)
            playerAchievements.stats.universal.modesPlayed.add('alaska');
            saveAchievements();
            trackPlayDate();
            
            document.getElementById('alaska-intro').style.display = 'none';
            document.getElementById('alaska-game').style.display = 'block';
            
            // Zoom to Alaska
            geoMap.setView([64, -152], 5);
            
            updateAlaskaDisplay();
            const roundInfo = alaskaRounds[0];
            showNotification(`üèîÔ∏è ${roundInfo.name} Started! ${roundInfo.description}`);
            
            // Welcome toast
            showToast('info', 'üèîÔ∏è Alaska Adventure Started!', 'Find all 50 locations to become an Alaska Expert!', 4000);
        }
        
        window.updateAlaskaDisplay = function() {
            const currentRound = gameState.alaska.currentRound;
            const roundInfo = alaskaRounds[currentRound];
            const roundFound = gameState.alaska.roundProgress[currentRound];
            const roundTotal = roundInfo.locations.length;
            const totalFound = gameState.alaska.totalFound;
            const grandTotal = alaskaRounds.reduce((sum, r) => sum + r.locations.length, 0);
            
            // Update round header
            document.getElementById('round-name').textContent = roundInfo.name;
            document.getElementById('round-description').textContent = roundInfo.description;
            document.getElementById('round-score').textContent = `${roundFound}/${roundTotal}`;
            
            // Update stats boxes
            document.getElementById('total-found').textContent = `${totalFound}/50`;
            document.getElementById('current-round').textContent = currentRound + 1;
            
            // Update progress bar
            const percent = (roundFound / roundTotal) * 100;
            document.getElementById('alaska-progress').style.width = percent + '%';
            document.getElementById('alaska-progress').textContent = `${roundFound}/${roundTotal}`;
            
            // Display locations for current round
            const html = roundInfo.locations.map((loc, i) => {
                const locId = `r${currentRound}_${i}`;
                const found = gameState.alaska.foundLocations.includes(locId);
                
                if (found) {
                    return `
                        <div class="challenge-item" style="background: rgba(0, 255, 127, 0.1); border-left: 4px solid #00ff7f;">
                            <div>
                                <strong style="color: #00ff7f;">‚úÖ ${loc.name}</strong><br>
                                <span style="font-size: 12px; color: #aaa;">${loc.fact}</span>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="challenge-item">
                            <div>
                                <strong style="color: #888;">‚ùì Location ${i + 1}</strong><br>
                                <span style="font-size: 12px; color: #66b3ff;">üó∫Ô∏è Clue: ${loc.clue}</span>
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            document.getElementById('alaska-list').innerHTML = html;
            
            // Check for achievements
            checkAlaskaAchievements();
        }
        
        window.checkAlaskaAchievements = function() {
            const badges = document.querySelectorAll('#alaska-badges .badge');
            const totalFound = gameState.alaska.totalFound;
            const grandTotal = alaskaRounds.reduce((sum, r) => sum + r.locations.length, 0);
            
            console.log('Checking Alaska achievements:', totalFound, 'locations found out of', grandTotal);
            
            // Initialize achievement tracking if not exists
            if (!gameState.alaska.achievements) {
                gameState.alaska.achievements = {
                    mountainMaster: false,
                    riverRunner: false,
                    parkExplorer: false,
                    cityFinder: false,
                    alaskaExpert: false
                };
            }
            
            // Count types across ALL found locations
            let mountains = 0, rivers = 0, parks = 0, cities = 0, glaciers = 0;
            
            alaskaRounds.forEach((round, roundIdx) => {
                round.locations.forEach((loc, locIdx) => {
                    const locId = `r${roundIdx}_${locIdx}`;
                    if (gameState.alaska.foundLocations.includes(locId)) {
                        if (loc.type === 'mountain') mountains++;
                        if (loc.type === 'river') rivers++;
                        if (loc.type === 'park') parks++;
                        if (loc.type === 'city') cities++;
                        if (loc.type === 'glacier') glaciers++;
                    }
                });
            });
            
            console.log('Mountains:', mountains, 'Rivers:', rivers, 'Parks:', parks, 'Cities:', cities, 'Glaciers:', glaciers);
            
            // Mountain Master - find 5+ mountains
            if (mountains >= 5 && !gameState.alaska.achievements.mountainMaster) {
                gameState.alaska.achievements.mountainMaster = true;
                unlockAlaskaAchievement(badges[0], '‚õ∞Ô∏è MOUNTAIN MASTER', 'Found 5 mountains!', 100);
            } else if (mountains >= 5) {
                badges[0].classList.remove('locked');
                badges[0].classList.add('unlocked');
            }
            
            // River Runner - find 3+ rivers
            if (rivers >= 3 && !gameState.alaska.achievements.riverRunner) {
                gameState.alaska.achievements.riverRunner = true;
                unlockAlaskaAchievement(badges[1], 'üåä RIVER RUNNER', 'Found 3 rivers!', 75);
            } else if (rivers >= 3) {
                badges[1].classList.remove('locked');
                badges[1].classList.add('unlocked');
            }
            
            // Park Explorer - find 5+ parks
            if (parks >= 5 && !gameState.alaska.achievements.parkExplorer) {
                gameState.alaska.achievements.parkExplorer = true;
                unlockAlaskaAchievement(badges[2], 'üèûÔ∏è PARK EXPLORER', 'Found 5 parks!', 125);
            } else if (parks >= 5) {
                badges[2].classList.remove('locked');
                badges[2].classList.add('unlocked');
            }
            
            // City Finder - find 8+ cities
            if (cities >= 8 && !gameState.alaska.achievements.cityFinder) {
                gameState.alaska.achievements.cityFinder = true;
                unlockAlaskaAchievement(badges[3], 'üèôÔ∏è CITY FINDER', 'Found 8 cities!', 150);
            } else if (cities >= 8) {
                badges[3].classList.remove('locked');
                badges[3].classList.add('unlocked');
            }
            
            // Alaska Expert - find all locations
            if (totalFound === grandTotal && !gameState.alaska.achievements.alaskaExpert) {
                gameState.alaska.achievements.alaskaExpert = true;
                unlockAlaskaAchievement(badges[4], 'üèÜ ALASKA EXPERT', 'Discovered all Alaska locations!', 500);
            } else if (totalFound === grandTotal) {
                badges[4].classList.remove('locked');
                badges[4].classList.add('unlocked');
            }
            
            saveState();
        }
        
        // Animated achievement unlock with visual celebration (Alaska-specific)
        function unlockAlaskaAchievement(badgeElement, title, description, xpReward) {
            // Unlock the badge visually
            badgeElement.classList.remove('locked');
            badgeElement.classList.add('unlocked');
            
            // Award XP
            addXP(xpReward, title);
            
            // Show celebration overlay
            setTimeout(() => {
                showAlaskaAchievementUnlock(title, description, xpReward);
            }, 500);
        }
        
        // Show full-screen achievement unlock celebration (Alaska-specific)
        window.showAlaskaAchievementUnlock = function(title, description, xpReward) {
            const overlay = document.createElement('div');
            overlay.id = 'achievement-unlock-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 3000;
                animation: fadeIn 0.5s ease-in;
            `;
            
            overlay.innerHTML = `
                <div style="text-align: center; padding: 60px 40px; background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 237, 78, 0.15) 100%); border-radius: 20px; border: 3px solid #ffd700; max-width: 500px; animation: achievementPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);">
                    <div style="font-size: 80px; margin-bottom: 20px; animation: achievementSpin 0.8s ease-out;">
                        üèÜ
                    </div>
                    <h2 style="color: #ffd700; font-size: 32px; margin: 0 0 10px 0; text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);">
                        ACHIEVEMENT UNLOCKED!
                    </h2>
                    <h3 style="color: #fff; font-size: 24px; margin: 0 0 15px 0;">
                        ${title}
                    </h3>
                    <p style="color: #aaa; font-size: 16px; margin: 0 0 25px 0;">
                        ${description}
                    </p>
                    <div style="background: rgba(255, 215, 0, 0.2); border-radius: 12px; padding: 20px; margin: 20px 0;">
                        <p style="color: #ffd700; font-size: 28px; margin: 0; font-weight: bold;">
                            +${xpReward} XP
                        </p>
                    </div>
                    <button onclick="closeAchievementOverlay()" class="btn" style="font-size: 18px; padding: 12px 30px; margin-top: 15px; background: #ffd700; color: #000;">
                        üéâ AWESOME!
                    </button>
                    <p style="font-size: 12px; color: #666; margin: 15px 0 0 0;">Click or wait 5 seconds...</p>
                </div>
            `;
            
            // Add animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes achievementPop {
                    0% {
                        transform: scale(0.5) rotateY(-180deg);
                        opacity: 0;
                    }
                    70% {
                        transform: scale(1.1) rotateY(10deg);
                    }
                    100% {
                        transform: scale(1) rotateY(0deg);
                        opacity: 1;
                    }
                }
                @keyframes achievementSpin {
                    0% {
                        transform: rotate(0deg) scale(0.5);
                        opacity: 0;
                    }
                    50% {
                        transform: rotate(180deg) scale(1.2);
                    }
                    100% {
                        transform: rotate(360deg) scale(1);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(overlay);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                closeAchievementOverlay();
            }, 5000);
        }
        
        window.closeAchievementOverlay = function() {
            const overlay = document.getElementById('achievement-unlock-overlay');
            if (overlay) {
                overlay.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => overlay.remove(), 300);
            }
        }
        
        window.resetAlaska = function() {
            gameState.alaska.active = false;
            gameState.alaska.currentRound = 0;
            gameState.alaska.roundProgress = [0, 0, 0, 0, 0];
            gameState.alaska.totalFound = 0;
            gameState.alaska.foundLocations = [];
            
            document.getElementById('alaska-intro').style.display = 'block';
            document.getElementById('alaska-game').style.display = 'none';
            
            saveState();
        }
        
        window.checkAlaskaLocation = function(lat, lon) {
            const TOLERANCE = 50; // miles
            const currentRound = gameState.alaska.currentRound;
            const roundInfo = alaskaRounds[currentRound];
            
            // Check locations in current round
            for (let i = 0; i < roundInfo.locations.length; i++) {
                const loc = roundInfo.locations[i];
                const locId = `r${currentRound}_${i}`;
                
                if (gameState.alaska.foundLocations.includes(locId)) continue;
                
                const dist = calculateDistance(lat, lon, loc.lat, loc.lon);
                
                if (dist <= TOLERANCE) {
                    // Found it!
                    gameState.alaska.foundLocations.push(locId);
                    gameState.alaska.roundProgress[currentRound]++;
                    gameState.alaska.totalFound++;
                    
                    if (currentMarker) geoMap.removeLayer(currentMarker);
                    currentMarker = L.marker([loc.lat, loc.lon]).addTo(geoMap);
                    
                    showNotification(`‚úÖ FOUND: ${loc.name}! +30 XP`);
                    addXP(30, loc.name);
                    
                    // Update distance display
                    const distFromHome = calculateDistance(GLENNALLEN.lat, GLENNALLEN.lon, loc.lat, loc.lon);
                    document.getElementById('distance-home').textContent = distFromHome.toLocaleString() + ' mi';
                    
                    updateAlaskaDisplay();
                    saveState();
                    
                    // Check for achievements!
                    checkAlaskaAchievements();
                    checkUniversalAchievements();
                    trackPlayDate();
                    
                    // Check if round is complete
                    if (gameState.alaska.roundProgress[currentRound] === roundInfo.locations.length) {
                        setTimeout(() => {
                            if (currentRound < alaskaRounds.length - 1) {
                                // More rounds to go
                                showRoundComplete();
                            } else {
                                // All rounds complete!
                                showGameComplete();
                            }
                        }, 1500);
                    }
                    
                    return;
                }
            }
            
            // Not found - show hint
            let closest = null;
            let closestDist = Infinity;
            
            for (let i = 0; i < roundInfo.locations.length; i++) {
                const loc = roundInfo.locations[i];
                const locId = `r${currentRound}_${i}`;
                if (gameState.alaska.foundLocations.includes(locId)) continue;
                
                const dist = calculateDistance(lat, lon, loc.lat, loc.lon);
                if (dist < closestDist) {
                    closestDist = dist;
                    closest = loc;
                }
            }
            
            if (closest) {
                showNotification(`‚ùå Not quite! You're ${Math.round(closestDist)} miles from the nearest location. Hint: ${closest.clue}`);
            }
        }
        
        window.showRoundComplete = function() {
            const currentRound = gameState.alaska.currentRound;
            const roundInfo = alaskaRounds[currentRound];
            const nextRound = alaskaRounds[currentRound + 1];
            
            const html = `
                <div style="text-align: center; padding: 30px;">
                    <h2 style="color: #00ff7f; font-size: 36px; margin-bottom: 20px;">üéâ ROUND COMPLETE!</h2>
                    <p style="font-size: 20px; margin-bottom: 10px;">${roundInfo.name}</p>
                    <p style="font-size: 16px; color: #aaa; margin-bottom: 30px;">You found all ${roundInfo.locations.length} locations!</p>
                    <div style="background: rgba(0, 255, 127, 0.1); border: 2px solid #00ff7f; border-radius: 10px; padding: 20px; margin: 20px 0;">
                        <p style="font-size: 18px; color: #00ff7f; margin: 0;">+100 XP Round Bonus!</p>
                    </div>
                    <p style="font-size: 18px; margin-top: 30px; margin-bottom: 20px;"><strong>Next Round:</strong></p>
                    <p style="font-size: 16px; color: #66b3ff; margin-bottom: 30px;">${nextRound.name}</p>
                    <p style="font-size: 14px; color: #aaa; margin-bottom: 30px;">${nextRound.description}</p>
                    <button class="btn" onclick="startNextRound()" style="font-size: 18px; padding: 15px 30px;">
                        üöÄ START NEXT ROUND
                    </button>
                </div>
            `;
            
            document.getElementById('alaska-list').innerHTML = html;
            addXP(100);
        }
        
        window.showGameComplete = function() {
            const totalFound = gameState.alaska.totalFound;
            
            // Mark Alaska as completed for universal achievements!
            playerAchievements.stats.universal.modesCompleted.add('alaska');
            saveAchievements();
            checkAlaskaAchievements(); // Final check for completion achievements
            checkUniversalAchievements();
            
            const html = `
                <div style="text-align: center; padding: 30px;">
                    <h2 style="color: #ffd700; font-size: 42px; margin-bottom: 20px;">üèÜ ALASKA EXPERT!</h2>
                    <p style="font-size: 24px; margin-bottom: 10px;">ALL 5 ROUNDS COMPLETE!</p>
                    <p style="font-size: 18px; color: #aaa; margin-bottom: 30px;">You discovered all ${totalFound} locations across Alaska!</p>
                    <div style="background: rgba(255, 215, 0, 0.1); border: 2px solid #ffd700; border-radius: 10px; padding: 20px; margin: 20px 0;">
                        <p style="font-size: 20px; color: #ffd700; margin: 0;">üéâ +500 XP Grand Prize!</p>
                    </div>
                    <p style="font-size: 16px; margin-top: 30px; color: #aaa;">You've mastered Alaska geography and earned the prestigious Alaska Expert badge!</p>
                    <button class="btn" onclick="resetAlaska()" style="font-size: 18px; padding: 15px 30px; margin-top: 30px;">
                        üîÑ PLAY AGAIN
                    </button>
                </div>
            `;
            
            document.getElementById('alaska-list').innerHTML = html;
        }
        
        window.startNextRound = function() {
            gameState.alaska.currentRound++;
            const roundInfo = alaskaRounds[gameState.alaska.currentRound];
            
            showNotification(`üèîÔ∏è ${roundInfo.name} Started! ${roundInfo.description}`);
            updateAlaskaDisplay();
            saveState();
        }
        
        // TUTORIALS
        window.showTutorial = function(mode) {
            const tutorials = {
                mystery: `
                    <h2>üéØ MYSTERY CHALLENGE TUTORIAL</h2>
                    <div class="why-play">
                        <strong>WHY PLAY THIS?</strong>
                        <p>Master coordinate reading while racing against time. Build massive streaks for huge XP bonuses. Compete with friends for the highest score!</p>
                    </div>
                    <h3>HOW TO PLAY:</h3>
                    <ul>
                        <li><strong>Step 1:</strong> Click "START MYSTERY CHALLENGE"</li>
                        <li><strong>Step 2:</strong> You'll see coordinates like <code>40.7128¬∞N, 74.0060¬∞W</code></li>
                        <li><strong>Step 3:</strong> Find that location on the map and click it</li>
                        <li><strong>Step 4:</strong> You have 60 seconds - hints unlock at 30s and 15s</li>
                        <li><strong>Step 5:</strong> Get it right to earn XP and build your streak!</li>
                    </ul>
                    <h3>TIPS:</h3>
                    <ul>
                        <li>üß≠ Use the coordinates to narrow down the region first</li>
                        <li>üó∫Ô∏è Switch map layers to see terrain/satellite views</li>
                        <li>üî• Build streaks for bonus XP (each streak adds +10 XP)</li>
                        <li>‚è±Ô∏è Don't wait for hints - faster = more practice!</li>
                    </ul>
                    <button class="btn" onclick="closeTutorial()">GOT IT! LET'S PLAY</button>
                `,
                scavenger: `
                    <h2>üåç SCAVENGER HUNT TUTORIAL</h2>
                    <div class="why-play">
                        <strong>WHY PLAY THIS?</strong>
                        <p>Explore the entire world! Learn where major geographic features are located. Unlock achievement badges and become a geography expert!</p>
                    </div>
                    <h3>HOW TO PLAY:</h3>
                    <ul>
                        <li><strong>Step 1:</strong> Click "START SCAVENGER HUNT"</li>
                        <li><strong>Step 2:</strong> You'll get 10 challenges (find deserts, mountains, cities, etc.)</li>
                        <li><strong>Step 3:</strong> Use different map layers to help you find each one</li>
                        <li><strong>Step 4:</strong> Click on the map when you think you found it</li>
                        <li><strong>Step 5:</strong> Each correct answer = 20 XP!</li>
                    </ul>
                    <h3>TIPS:</h3>
                    <ul>
                        <li>üõ∞Ô∏è Use Satellite view to see terrain features</li>
                        <li>‚õ∞Ô∏è Use Topographic view to find mountains</li>
                        <li>üèôÔ∏è Use Street view to find cities</li>
                        <li>üåç Zoom out to see continents, zoom in for precision</li>
                    </ul>
                    <button class="btn" onclick="closeTutorial()">GOT IT! LET'S HUNT</button>
                `,
                guess: `
                    <h2>üì∏ GUESS THE LOCATION TUTORIAL</h2>
                    <div class="why-play">
                        <strong>WHY PLAY THIS?</strong>
                        <p>Test your world knowledge! Identify famous landmarks from satellite view. Perfect your visual geography skills and impress everyone!</p>
                    </div>
                    <h3>HOW TO PLAY:</h3>
                    <ul>
                        <li><strong>Step 1:</strong> Click "START GUESS GAME"</li>
                        <li><strong>Step 2:</strong> The map zooms to a famous location</li>
                        <li><strong>Step 3:</strong> Look at the satellite/terrain view carefully</li>
                        <li><strong>Step 4:</strong> Choose the correct country from 4 options</li>
                        <li><strong>Step 5:</strong> Earn 30 XP for each correct answer!</li>
                    </ul>
                    <h3>TIPS:</h3>
                    <ul>
                        <li>üëÄ Look for distinctive features (rivers, coastlines, deserts)</li>
                        <li>üó∫Ô∏è Try switching to Terrain view for elevation clues</li>
                        <li>üèõÔ∏è Famous landmarks have unique shapes from above</li>
                        <li>üåç Use continent knowledge to eliminate wrong answers</li>
                    </ul>
                    <button class="btn" onclick="closeTutorial()">GOT IT! LET'S GUESS</button>
                `,
                alaska: `
                    <h2>üèîÔ∏è ALASKA ADVENTURE TUTORIAL</h2>
                    <div class="why-play">
                        <strong>WHY PLAY THIS?</strong>
                        <p>Explore YOUR home state from a global perspective! Discover Alaska's incredible geography and see how Glennallen connects to the Last Frontier's most amazing places. Build local pride and geographic literacy!</p>
                    </div>
                    <h3>HOW TO PLAY:</h3>
                    <ul>
                        <li><strong>Step 1:</strong> Click "START ALASKA ADVENTURE" to begin</li>
                        <li><strong>Step 2:</strong> The map zooms to Alaska - your home state!</li>
                        <li><strong>Step 3:</strong> Find all 10 famous Alaska locations on the map</li>
                        <li><strong>Step 4:</strong> Click on each location when you find it (within 50 miles)</li>
                        <li><strong>Step 5:</strong> Learn cool facts about each place!</li>
                        <li><strong>Step 6:</strong> See how far everything is from Glennallen</li>
                        <li><strong>Step 7:</strong> Earn 30 XP per location + bonuses for completing rounds!</li>
                    </ul>
                    <h3>5 EXCITING ROUNDS:</h3>
                    <ul>
                        <li>üè† <strong>Round 1: Home Territory</strong> - 10 locations around Glennallen</li>
                        <li>ÔøΩÔ∏è <strong>Round 2: Major Cities</strong> - 10 important Alaskan cities</li>
                        <li>ÔøΩÔ∏è <strong>Round 3: Natural Wonders</strong> - 10 mountains, rivers, and glaciers</li>
                        <li>ÔøΩÔ∏è <strong>Round 4: Parks & Refuges</strong> - 10 protected wilderness areas</li>
                        <li>üìú <strong>Round 5: Historic Sites</strong> - 10 culturally significant locations</li>
                    </ul>
                    <h3>PRO TIPS:</h3>
                    <ul>
                        <li>üó∫Ô∏è <strong>Read the clues carefully</strong> - they point to geographical features</li>
                        <li>üõ∞Ô∏è Switch to Satellite view to see real imagery</li>
                        <li>‚õ∞Ô∏è Use Terrain or Topographic layers to find mountains</li>
                        <li>üåä Rivers show up well on satellite view</li>
                        <li>üèõÔ∏è Cities are easier to spot with Street or Boundaries layers</li>
                        <li>üîç Zoom in close to find exact locations</li>
                        <li>üéØ Click within 50 miles to count as "found"</li>
                    </ul>
                    <h3>ACHIEVEMENTS:</h3>
                    <ul>
                        <li>üèîÔ∏è <strong>Mountain Master</strong> - Find 5+ mountains</li>
                        <li>üåä <strong>River Runner</strong> - Find 3+ rivers</li>
                        <li>üèûÔ∏è <strong>Park Explorer</strong> - Find 5+ national parks</li>
                        <li>üèõÔ∏è <strong>City Finder</strong> - Find 8+ cities</li>
                        <li>‚ùÑÔ∏è <strong>Alaska Expert</strong> - Complete all 50 locations!</li>
                    </ul>
                    <h3>REWARDS:</h3>
                    <ul>
                        <li>‚≠ê 30 XP per location found</li>
                        <li>üéâ 100 XP bonus per round completed</li>
                        <li>üèÜ 500 XP grand prize for Alaska Expert!</li>
                    </ul>
                    <button class="btn" onclick="closeTutorial()">GOT IT! LET'S EXPLORE ALASKA</button>
                `
            };
            
            document.getElementById('tutorial-content').innerHTML = tutorials[mode];
            document.getElementById('tutorial-overlay').classList.add('active');
        }
        
        window.closeTutorial = function() {
            document.getElementById('tutorial-overlay').classList.remove('active');
        }
        
        // Initialize
        updateAllDisplays();
        renderMissions();
        
        console.log('üïµÔ∏è Geographic Detective Academy initialized!');
        console.log('üéÆ All game modes ready!');
        console.log('üèÜ Mission system active!');
        }); // end DOMContentLoaded
        
        // CRITICAL FIX: Cleanup on page unload to prevent memory leaks
        window.addEventListener('beforeunload', function() {
            stopAllGameTimers();
            cleanupGameMarkers();
            console.log('üßπ Cleaned up all timers and markers');
        });
    </script>

    <!-- ========================================
         LOCATION EXPLORER SIDEBAR
         Phase 1.1: Collapsible sidebar structure
         ======================================== -->
    <div id="location-explorer-sidebar" class="location-sidebar">
        <!-- Sidebar Header -->
        <div class="sidebar-header">
            <div class="sidebar-title">
                <span class="sidebar-icon">üìç</span>
                <h3>Location Explorer</h3>
            </div>
            <div class="sidebar-controls">
                <button class="sidebar-control-btn" id="style-toggle-btn" onclick="toggleLocationStyle()" title="Toggle Gen Alpha Style">
                    üî•
                </button>
                <button class="sidebar-control-btn" id="collapse-sidebar-btn" onclick="toggleLocationSidebar()" title="Close Sidebar">
                    ‚úï
                </button>
            </div>
        </div>

        <!-- Sidebar Content (Scrollable) -->
        <div class="sidebar-content" id="location-sidebar-content">
            
            <!-- Collection Counter (Top of sidebar) -->
            <div class="collection-badge" id="collection-counter">
                <span class="collection-icon">üåç</span>
                <span class="collection-text">
                    <span id="locations-explored-count">0</span> places explored!
                </span>
            </div>

            <!-- CARD 1: Location Header -->
            <div class="location-card" id="card-header">
                <div class="card-header" onclick="toggleCard('card-header')">
                    <h4>üìç Location</h4>
                    <span class="card-toggle">‚ñº</span>
                </div>
                <div class="card-content">
                    <div class="location-header-content">
                        <div class="country-flag" id="location-flag">üè≥Ô∏è</div>
                        <h3 class="location-name" id="location-name">Drop a pin to explore!</h3>
                        <div class="location-badges">
                            <span class="location-badge" id="land-ocean-badge">üåç</span>
                            <span class="location-coordinates" id="location-coords">0.00¬∞N, 0.00¬∞E</span>
                            <button class="coord-toggle-btn" id="coord-toggle-btn" onclick="toggleCoordinateFormat()" title="Toggle coordinate format">
                                <span class="coord-toggle-icon">üîÑ</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CARD 2: Quick Facts -->
            <div class="location-card" id="card-facts">
                <div class="card-header" onclick="toggleCard('card-facts')">
                    <h4>üåç Quick Facts</h4>
                    <span class="card-toggle">‚ñº</span>
                </div>
                <div class="card-content">
                    <div class="fact-grid" id="quick-facts-content">
                        <div class="fact-item">
                            <span class="fact-label">Country:</span>
                            <span class="fact-value" id="fact-country">‚Äî</span>
                        </div>
                        <div class="fact-item">
                            <span class="fact-label">Capital:</span>
                            <span class="fact-value" id="fact-capital">‚Äî</span>
                        </div>
                        <div class="fact-item">
                            <span class="fact-label">Population:</span>
                            <span class="fact-value" id="fact-population">‚Äî</span>
                        </div>
                        <div class="fact-item">
                            <span class="fact-label">Area:</span>
                            <span class="fact-value" id="fact-area">‚Äî</span>
                        </div>
                        <div class="fact-item">
                            <span class="fact-label">Continent:</span>
                            <span class="fact-value" id="fact-continent">‚Äî</span>
                        </div>
                        <div class="fact-item">
                            <span class="fact-label">Time Zone:</span>
                            <span class="fact-value" id="fact-timezone">‚Äî</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CARD 3: Comparison to Home -->
            <div class="location-card" id="card-comparison">
                <div class="card-header" onclick="toggleCard('card-comparison')">
                    <h4>üìè Distance from Home</h4>
                    <span class="card-toggle">‚ñº</span>
                </div>
                <div class="card-content">
                    <div class="comparison-content" id="comparison-content">
                        <div class="distance-display">
                            <span class="distance-value" id="distance-value">‚Äî</span>
                            <span class="distance-unit">miles away</span>
                        </div>
                        <div class="comparison-facts">
                            <div class="comparison-fact">
                                <span class="comparison-icon">üß≠</span>
                                <span id="bearing-text">‚Äî</span>
                            </div>
                            <div class="comparison-fact">
                                <span class="comparison-icon">‚è∞</span>
                                <span id="timezone-diff-text">‚Äî</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CARD 4: AI-Generated Content (Placeholder for Phase 4) -->
            <div class="location-card" id="card-ai-facts">
                <div class="card-header" onclick="toggleCard('card-ai-facts')">
                    <h4>üí° Did You Know?</h4>
                    <span class="card-toggle">‚ñº</span>
                </div>
                <div class="card-content">
                    <div class="ai-content" id="ai-facts-content">
                        <div class="loading-placeholder">
                            <span class="placeholder-icon">ü§ñ</span>
                            <p>AI-powered fun facts coming in Phase 4!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CARD 4.5: Geography in Real Life (NEW!) -->
            <div class="location-card" id="card-real-life-geography">
                <div class="card-header" onclick="toggleCard('card-real-life-geography')">
                    <h4>üåç Geography in Real Life</h4>
                    <span class="card-toggle">‚ñº</span>
                </div>
                <div class="card-content">
                    <div class="real-life-content" id="real-life-content">
                        <div class="loading-placeholder">
                            <span class="placeholder-icon">üéì</span>
                            <p>Connecting geography to your world...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CARD 5: Visual/Photo (Placeholder for Phase 3) -->
            <div class="location-card" id="card-photo">
                <div class="card-header" onclick="toggleCard('card-photo')">
                    <h4>üì∏ Photos</h4>
                    <span class="card-toggle">‚ñº</span>
                </div>
                <div class="card-content">
                    <div class="photo-content" id="photo-content">
                        <div class="loading-placeholder">
                            <span class="placeholder-icon">üì∑</span>
                            <p>Beautiful photos coming in Phase 3!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CARD 6: Weather (Placeholder for Phase 3) -->
            <div class="location-card" id="card-weather">
                <div class="card-header" onclick="toggleCard('card-weather')">
                    <h4>‚òÅÔ∏è Weather</h4>
                    <span class="card-toggle">‚ñº</span>
                </div>
                <div class="card-content">
                    <div class="weather-content" id="weather-content">
                        <div class="loading-placeholder">
                            <span class="placeholder-icon">üå§Ô∏è</span>
                            <p>Live weather data coming in Phase 3!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CARD 7: Nearby Places -->
            <div class="location-card" id="card-nearby">
                <div class="card-header" onclick="toggleCard('card-nearby')">
                    <h4>üó∫Ô∏è Nearby Places</h4>
                    <span class="card-toggle">‚ñº</span>
                </div>
                <div class="card-content">
                    <div class="nearby-content" id="nearby-content">
                        <div class="loading-placeholder">
                            <span class="placeholder-icon">üìç</span>
                            <p>Loading nearby places...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CARD 8: Challenges (Placeholder for Phase 4) -->
            <div class="location-card" id="card-challenges">
                <div class="card-header" onclick="toggleCard('card-challenges')">
                    <h4>üéØ Challenges</h4>
                    <span class="card-toggle">‚ñº</span>
                </div>
                <div class="card-content">
                    <div class="challenges-content" id="challenges-content">
                        <div class="loading-placeholder">
                            <span class="placeholder-icon">üéÆ</span>
                            <p>Mini-challenges coming in Phase 4!</p>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- End sidebar-content -->

        <!-- Sidebar Footer -->
        <div class="sidebar-footer">
            <button class="btn view-collection-btn" onclick="viewExploredLocations()">
                üóÇÔ∏è View My Collection
            </button>
        </div>
    </div> <!-- End location-explorer-sidebar -->

    <!-- Photo Enlargement Modal with AI Captions -->
    <div id="photo-modal" class="photo-modal" onclick="closePhotoModal()">
        <div class="photo-modal-content" onclick="event.stopPropagation()">
            <button class="photo-modal-close" onclick="closePhotoModal()" title="Close (ESC)">‚úï</button>
            
            <div class="photo-modal-image-container">
                <img id="photo-modal-image" src="" alt="" />
                <div class="photo-loading" id="photo-modal-loading">
                    <div class="spinner"></div>
                    <p>üß† AI is analyzing this photo...</p>
                </div>
            </div>
            
            <div class="photo-modal-info">
                <div class="photo-modal-credit">
                    <span class="credit-icon">üì∑</span>
                    <a id="photo-modal-photographer-link" href="#" target="_blank" rel="noopener">
                        <span id="photo-modal-photographer"></span>
                    </a>
                </div>
                
                <div class="photo-modal-caption">
                    <h3 id="photo-modal-title">Photo Details</h3>
                    <div id="photo-modal-description" class="photo-description">
                        <p>Generating educational caption...</p>
                    </div>
                    <div class="photo-relevance" id="photo-modal-relevance"></div>
                </div>
                
                <div class="photo-modal-meta">
                    <span class="photo-search-query" id="photo-search-query"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Reopen Button (appears when sidebar is closed) -->
    <button id="reopen-sidebar-btn" class="reopen-sidebar-btn" onclick="reopenLocationSidebar()" title="Reopen Location Explorer">
        <span class="reopen-icon">üìç</span>
        <span class="reopen-text">Info</span>
    </button>

    <!-- Photo Modal JavaScript Functions -->
    <script src="photo-modal-functions.js"></script>

</body>
</html>


